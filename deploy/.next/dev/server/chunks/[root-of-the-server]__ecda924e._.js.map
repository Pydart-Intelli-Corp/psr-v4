{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/user/reports/send-email/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport jwt from 'jsonwebtoken';\r\nimport nodemailer from 'nodemailer';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';\r\n\r\ninterface JWTPayload {\r\n  id: number;\r\n  userId: number;\r\n  email: string;\r\n  role: string;\r\n  dbKey?: string;\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Get auth token\r\n    const authHeader = request.headers.get('authorization');\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const token = authHeader.substring(7);\r\n    const decoded = jwt.verify(token, JWT_SECRET) as JWTPayload;\r\n\r\n    // Get request body\r\n    const body = await request.json();\r\n    const { email, csvContent, pdfContent, reportType, dateRange, stats } = body;\r\n\r\n    if (!email || !csvContent || !pdfContent) {\r\n      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });\r\n    }\r\n\r\n    // Validate email format\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(email)) {\r\n      return NextResponse.json({ error: 'Invalid email format' }, { status: 400 });\r\n    }\r\n\r\n    // Check SMTP configuration\r\n    const smtpUser = process.env.SMTP_USERNAME || process.env.EMAIL_USER;\r\n    const smtpPass = process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD;\r\n    \r\n    if (!smtpUser || !smtpPass) {\r\n      console.error('SMTP credentials not configured');\r\n      return NextResponse.json({ \r\n        error: 'Email service not configured. Please contact administrator.' \r\n      }, { status: 500 });\r\n    }\r\n\r\n    // Create transporter using same pattern as BMC delete OTP\r\n    const emailConfig = {\r\n      host: process.env.SMTP_HOST || process.env.EMAIL_HOST || 'smtp.gmail.com',\r\n      port: parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || '587'),\r\n      secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true',\r\n      auth: {\r\n        user: smtpUser,\r\n        pass: smtpPass,\r\n      },\r\n    };\r\n\r\n    const transporter = nodemailer.createTransport(emailConfig);\r\n\r\n    // Verify transporter\r\n    try {\r\n      await transporter.verify();\r\n    } catch (verifyError) {\r\n      console.error('SMTP verification failed:', verifyError);\r\n      return NextResponse.json({ \r\n        error: 'Email service connection failed. Please check SMTP configuration.' \r\n      }, { status: 500 });\r\n    }\r\n\r\n    // Generate filename with timestamp\r\n    const timestamp = new Date().toISOString().split('T')[0];\r\n    const csvFilename = `collection-report-${timestamp}.csv`;\r\n    const pdfFilename = `collection-report-${timestamp}.pdf`;\r\n\r\n    // Prepare email with attachments\r\n    const mailOptions = {\r\n      from: `\"Poornasree Equipments Cloud\" <${smtpUser}>`,\r\n      to: email,\r\n      subject: `${reportType} - ${dateRange}`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 24px;\">LactoConnect Report</h1>\r\n            <p style=\"color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 14px;\">Poornasree Equipments</p>\r\n          </div>\r\n          \r\n          <div style=\"background: #f7fafc; padding: 30px; border-radius: 0 0 10px 10px;\">\r\n            <h2 style=\"color: #2d3748; margin-top: 0;\">Collection Report</h2>\r\n            <p style=\"color: #4a5568; line-height: 1.6;\">\r\n              Hello,<br><br>\r\n              Please find attached the ${reportType.toLowerCase()} for the date range: <strong>${dateRange}</strong>.\r\n            </p>\r\n            \r\n            <div style=\"background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);\">\r\n              <h3 style=\"color: #2d3748; margin-top: 0; font-size: 16px;\">Report Summary</h3>\r\n              <table style=\"width: 100%; border-collapse: collapse;\">\r\n                <tr>\r\n                  <td style=\"padding: 8px 0; color: #718096; font-size: 14px;\">Total Collections:</td>\r\n                  <td style=\"padding: 8px 0; color: #2d3748; font-weight: bold; text-align: right; font-size: 14px;\">${stats.totalCollections}</td>\r\n                </tr>\r\n                <tr>\r\n                  <td style=\"padding: 8px 0; color: #718096; font-size: 14px;\">Total Quantity:</td>\r\n                  <td style=\"padding: 8px 0; color: #2d3748; font-weight: bold; text-align: right; font-size: 14px;\">${stats.totalQuantity.toFixed(2)} L</td>\r\n                </tr>\r\n                <tr>\r\n                  <td style=\"padding: 8px 0; color: #718096; font-size: 14px;\">Total Amount:</td>\r\n                  <td style=\"padding: 8px 0; color: #2d3748; font-weight: bold; text-align: right; font-size: 14px;\">â‚¹${stats.totalAmount.toFixed(2)}</td>\r\n                </tr>\r\n                <tr>\r\n                  <td style=\"padding: 8px 0; color: #718096; font-size: 14px;\">Average Rate:</td>\r\n                  <td style=\"padding: 8px 0; color: #2d3748; font-weight: bold; text-align: right; font-size: 14px;\">â‚¹${stats.averageRate.toFixed(2)}/L</td>\r\n                </tr>\r\n                <tr style=\"border-top: 1px solid #e2e8f0;\">\r\n                  <td style=\"padding: 8px 0; padding-top: 12px; color: #718096; font-size: 14px;\">Weighted FAT:</td>\r\n                  <td style=\"padding: 8px 0; padding-top: 12px; color: #2d3748; font-weight: bold; text-align: right; font-size: 14px;\">${stats.weightedFat.toFixed(2)}%</td>\r\n                </tr>\r\n                <tr>\r\n                  <td style=\"padding: 8px 0; color: #718096; font-size: 14px;\">Weighted SNF:</td>\r\n                  <td style=\"padding: 8px 0; color: #2d3748; font-weight: bold; text-align: right; font-size: 14px;\">${stats.weightedSnf.toFixed(2)}%</td>\r\n                </tr>\r\n                <tr>\r\n                  <td style=\"padding: 8px 0; color: #718096; font-size: 14px;\">Weighted CLR:</td>\r\n                  <td style=\"padding: 8px 0; color: #2d3748; font-weight: bold; text-align: right; font-size: 14px;\">${stats.weightedClr.toFixed(2)}</td>\r\n                </tr>\r\n              </table>\r\n            </div>\r\n            \r\n            <div style=\"background: #edf2f7; border-left: 4px solid #4299e1; padding: 15px; margin: 20px 0; border-radius: 4px;\">\r\n              <p style=\"color: #2d3748; margin: 0; font-size: 14px;\">\r\n                <strong>ðŸ“Ž Attachments:</strong><br>\r\n                â€¢ ${csvFilename} (CSV Format)<br>\r\n                â€¢ ${pdfFilename} (PDF Format)\r\n              </p>\r\n            </div>\r\n            \r\n            <p style=\"color: #718096; font-size: 13px; margin-top: 30px;\">\r\n              This is an automated email from LactoConnect. For support, please contact us at \r\n              <a href=\"mailto:marketing@poornasree.com\" style=\"color: #4299e1; text-decoration: none;\">marketing@poornasree.com</a>\r\n            </p>\r\n            \r\n            <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;\">\r\n              <p style=\"color: #a0aec0; font-size: 12px; margin: 0;\">\r\n                Â© ${new Date().getFullYear()} Poornasree Equipments. All rights reserved.\r\n              </p>\r\n              <p style=\"color: #a0aec0; font-size: 12px; margin: 5px 0 0 0;\">\r\n                <a href=\"https://www.poornasree.com\" style=\"color: #4299e1; text-decoration: none;\">www.poornasree.com</a>\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      `,\r\n      attachments: [\r\n        {\r\n          filename: csvFilename,\r\n          content: csvContent,\r\n          contentType: 'text/csv'\r\n        },\r\n        {\r\n          filename: pdfFilename,\r\n          content: Buffer.from(pdfContent, 'base64'),\r\n          contentType: 'application/pdf'\r\n        }\r\n      ]\r\n    };\r\n\r\n    // Send email\r\n    await transporter.sendMail(mailOptions);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: `Report sent successfully to ${email}`\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Error sending email:', error);\r\n    return NextResponse.json(\r\n      { error: error instanceof Error ? error.message : 'Failed to send email' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAUtC,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,iBAAiB;QACjB,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;QACvC,IAAI,CAAC,YAAY,WAAW,YAAY;YACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,QAAQ,WAAW,SAAS,CAAC;QACnC,MAAM,UAAU,kJAAG,CAAC,MAAM,CAAC,OAAO;QAElC,mBAAmB;QACnB,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,KAAK,EAAE,UAAU,EAAE,UAAU,EAAE,UAAU,EAAE,SAAS,EAAE,KAAK,EAAE,GAAG;QAExE,IAAI,CAAC,SAAS,CAAC,cAAc,CAAC,YAAY;YACxC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,wBAAwB;QACxB,MAAM,aAAa;QACnB,IAAI,CAAC,WAAW,IAAI,CAAC,QAAQ;YAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAuB,GAAG;gBAAE,QAAQ;YAAI;QAC5E;QAEA,2BAA2B;QAC3B,MAAM,WAAW,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU;QACpE,MAAM,WAAW,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,cAAc;QAExE,IAAI,CAAC,YAAY,CAAC,UAAU;YAC1B,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,0DAA0D;QAC1D,MAAM,cAAc;YAClB,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI;YACzD,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI;YAClE,QAAQ,CAAC,QAAQ,GAAG,CAAC,WAAW,IAAI,QAAQ,GAAG,CAAC,YAAY,MAAM;YAClE,MAAM;gBACJ,MAAM;gBACN,MAAM;YACR;QACF;QAEA,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;QAE/C,qBAAqB;QACrB,IAAI;YACF,MAAM,YAAY,MAAM;QAC1B,EAAE,OAAO,aAAa;YACpB,QAAQ,KAAK,CAAC,6BAA6B;YAC3C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,mCAAmC;QACnC,MAAM,YAAY,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QACxD,MAAM,cAAc,CAAC,kBAAkB,EAAE,UAAU,IAAI,CAAC;QACxD,MAAM,cAAc,CAAC,kBAAkB,EAAE,UAAU,IAAI,CAAC;QAExD,iCAAiC;QACjC,MAAM,cAAc;YAClB,MAAM,CAAC,+BAA+B,EAAE,SAAS,CAAC,CAAC;YACnD,IAAI;YACJ,SAAS,GAAG,WAAW,GAAG,EAAE,WAAW;YACvC,MAAM,CAAC;;;;;;;;;;;uCAW0B,EAAE,WAAW,WAAW,GAAG,6BAA6B,EAAE,UAAU;;;;;;;;qHAQU,EAAE,MAAM,gBAAgB,CAAC;;;;qHAIzB,EAAE,MAAM,aAAa,CAAC,OAAO,CAAC,GAAG;;;;sHAIhC,EAAE,MAAM,WAAW,CAAC,OAAO,CAAC,GAAG;;;;sHAI/B,EAAE,MAAM,WAAW,CAAC,OAAO,CAAC,GAAG;;;;wIAIb,EAAE,MAAM,WAAW,CAAC,OAAO,CAAC,GAAG;;;;qHAIlD,EAAE,MAAM,WAAW,CAAC,OAAO,CAAC,GAAG;;;;qHAI/B,EAAE,MAAM,WAAW,CAAC,OAAO,CAAC,GAAG;;;;;;;;kBAQlI,EAAE,YAAY;kBACd,EAAE,YAAY;;;;;;;;;;;kBAWd,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;;;;MAQvC,CAAC;YACD,aAAa;gBACX;oBACE,UAAU;oBACV,SAAS;oBACT,aAAa;gBACf;gBACA;oBACE,UAAU;oBACV,SAAS,OAAO,IAAI,CAAC,YAAY;oBACjC,aAAa;gBACf;aACD;QACH;QAEA,aAAa;QACb,MAAM,YAAY,QAAQ,CAAC;QAE3B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS,CAAC,4BAA4B,EAAE,OAAO;QACjD;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAAuB,GACzE;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}