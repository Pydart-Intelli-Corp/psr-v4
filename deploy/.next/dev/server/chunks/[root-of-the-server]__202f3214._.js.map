{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/middleware/auth.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyToken, JWTPayload } from '@/lib/auth';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// Types for authentication middleware\r\n\r\nexport interface AuthenticatedRequest extends NextRequest {\r\n  user?: JWTPayload;\r\n}\r\n\r\n// Authentication middleware\r\nexport const authenticateToken = (req: NextRequest): { \r\n  success: boolean; \r\n  user?: JWTPayload; \r\n  error?: string \r\n} => {\r\n  try {\r\n    const authHeader = req.headers.get('authorization');\r\n    const token = authHeader?.split(' ')[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return { success: false, error: 'Access token required' };\r\n    }\r\n\r\n    const decoded = verifyToken(token);\r\n    if (!decoded) {\r\n      return { success: false, error: 'Invalid or expired token' };\r\n    }\r\n\r\n    return { success: true, user: decoded };\r\n  } catch {\r\n    return { success: false, error: 'Authentication failed' };\r\n  }\r\n};\r\n\r\n// Role-based authorization middleware\r\nexport const authorizeRole = (requiredRoles: UserRole[]) => {\r\n  return (user: JWTPayload): { success: boolean; error?: string } => {\r\n    if (!user) {\r\n      return { success: false, error: 'User not authenticated' };\r\n    }\r\n\r\n    if (!requiredRoles.includes(user.role as UserRole)) {\r\n      return { success: false, error: 'Insufficient permissions' };\r\n    }\r\n\r\n    return { success: true };\r\n  };\r\n};\r\n\r\n// Super Admin authorization\r\nexport const requireSuperAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  if (user.role !== UserRole.SUPER_ADMIN && user.email !== (process.env.SUPER_ADMIN_USERNAME || 'admin')) {\r\n    return { success: false, error: 'Super Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Admin or higher authorization\r\nexport const requireAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  const adminRoles = [UserRole.SUPER_ADMIN, UserRole.ADMIN];\r\n  if (!adminRoles.includes(user.role as UserRole)) {\r\n    return { success: false, error: 'Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Hierarchy-based authorization\r\nexport const requireHierarchyAccess = (targetUserId: number, currentUser: JWTPayload): {\r\n  success: boolean; \r\n  error?: string \r\n} => {\r\n  // Super admin can access everything\r\n  if (currentUser.role === UserRole.SUPER_ADMIN) {\r\n    return { success: true };\r\n  }\r\n\r\n  // Admin can access users in their schema\r\n  if (currentUser.role === UserRole.ADMIN && currentUser.dbKey) {\r\n    // Additional logic would be needed to check if targetUser belongs to admin's schema\r\n    return { success: true };\r\n  }\r\n\r\n  // For other roles, implement specific hierarchy checks\r\n  // This would require database queries to verify parent-child relationships\r\n  \r\n  return { success: false, error: 'Access denied' };\r\n};\r\n\r\n// Response helpers\r\nexport const createErrorResponse = (message: string, status: number = 400) => {\r\n  return NextResponse.json(\r\n    { \r\n      success: false, \r\n      error: { message, code: status.toString() },\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\nexport const createSuccessResponse = (data: unknown, message: string = 'Success', status: number = 200) => {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      message,\r\n      data,\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\n// Validation helper\r\nexport const validateRequiredFields = (\r\n  body: Record<string, unknown>, \r\n  requiredFields: string[]\r\n): { success: boolean; missing?: string[] } => {\r\n  const missing = requiredFields.filter(field => \r\n    !body[field] || (typeof body[field] === 'string' && body[field].trim() === '')\r\n  );\r\n\r\n  if (missing.length > 0) {\r\n    return { success: false, missing };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Rate limiting (basic implementation)\r\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>();\r\n\r\nexport const checkRateLimit = (\r\n  identifier: string, \r\n  maxRequests: number = 100, \r\n  windowMs: number = 15 * 60 * 1000 // 15 minutes\r\n): { success: boolean; resetTime?: number } => {\r\n  const now = Date.now();\r\n  const record = rateLimitMap.get(identifier);\r\n\r\n  if (!record || now > record.resetTime) {\r\n    // Reset or create new record\r\n    rateLimitMap.set(identifier, { count: 1, resetTime: now + windowMs });\r\n    return { success: true };\r\n  }\r\n\r\n  if (record.count >= maxRequests) {\r\n    return { success: false, resetTime: record.resetTime };\r\n  }\r\n\r\n  record.count++;\r\n  return { success: true };\r\n};\r\n\r\n// CORS headers\r\nexport const setCorsHeaders = (response: NextResponse) => {\r\n  response.headers.set('Access-Control-Allow-Origin', process.env.CLIENT_URL || '*');\r\n  response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n  response.headers.set('Access-Control-Allow-Credentials', 'true');\r\n  return response;\r\n};\r\n\r\nconst middleware = {\r\n  authenticateToken,\r\n  authorizeRole,\r\n  requireSuperAdmin,\r\n  requireAdmin,\r\n  requireHierarchyAccess,\r\n  createErrorResponse,\r\n  createSuccessResponse,\r\n  validateRequiredFields,\r\n  checkRateLimit,\r\n  setCorsHeaders\r\n};\r\n\r\nexport default middleware;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 249, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/emailService.ts"],"sourcesContent":["import nodemailer from 'nodemailer';\r\n\r\n// Email configuration\r\n// Support both SMTP_* (local) and EMAIL_* (production) environment variables\r\nconst emailConfig = {\r\n  host: process.env.SMTP_HOST || process.env.EMAIL_HOST || 'smtp.gmail.com',\r\n  port: parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || '587'),\r\n  secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true', // true for 465, false for other ports\r\n  auth: {\r\n    user: process.env.SMTP_USERNAME || process.env.EMAIL_USER,\r\n    pass: process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD,\r\n  },\r\n};\r\n\r\n// Create transporter\r\nconst transporter = nodemailer.createTransport(emailConfig);\r\n\r\n// Generate OTP\r\nexport const generateOTP = (): string => {\r\n  return Math.floor(100000 + Math.random() * 900000).toString();\r\n};\r\n\r\n// Send OTP email\r\nexport const sendOTPEmail = async (\r\n  email: string, \r\n  otp: string, \r\n  name: string\r\n): Promise<void> => {\r\n  // Debug logging\r\n  console.log('Email config debug:', {\r\n    to: email,\r\n    from: process.env.SMTP_USERNAME || process.env.EMAIL_USER,\r\n    host: process.env.SMTP_HOST || process.env.EMAIL_HOST,\r\n    port: process.env.SMTP_PORT || process.env.EMAIL_PORT,\r\n    hasPassword: !!(process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD),\r\n    secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true'\r\n  });\r\n\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'Email Verification - Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Email Verification</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Hello ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Thank you for registering with Poornasree Equipments Cloud. Please verify your email address using the OTP below:\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <div style=\"display: inline-block; padding: 15px 30px; background: #667eea; color: white; font-size: 24px; font-weight: bold; letter-spacing: 3px; border-radius: 8px;\">\r\n              ${otp}\r\n            </div>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            This OTP is valid for 10 minutes. If you didn't create an account, please ignore this email.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send welcome email\r\nexport const sendWelcomeEmail = async (\r\n  email: string, \r\n  name: string, \r\n  role: string\r\n): Promise<void> => {\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'Welcome to Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Welcome!</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Welcome ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Your account has been successfully verified and activated. You can now access the Poornasree Equipments Cloud platform with your ${role} account.\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${process.env.FRONTEND_URL}/login\" style=\"display: inline-block; padding: 12px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;\">\r\n              Login to Dashboard\r\n            </a>\r\n          </div>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send admin welcome email with dbKey\r\nexport const sendAdminWelcomeEmail = async (\r\n  email: string, \r\n  name: string, \r\n  dbKey: string\r\n): Promise<void> => {\r\n  const apiUrl = `http://lactosure.azurewebsites.net/api/${dbKey}`;\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'üéâ Admin Account Approved - Your Personal Database Access',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">üéâ Congratulations!</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Your Admin Account is Approved</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Welcome ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Congratulations! Your admin account has been approved by the Super Admin. Your personal database schema has been created and is ready for use.\r\n          </p>\r\n          \r\n          <div style=\"background: #fff; border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px 0;\">\r\n            <h3 style=\"color: #ef4444; margin-top: 0; font-size: 18px;\">üîí CONFIDENTIAL - Database Access Key</h3>\r\n            <p style=\"color: #666; margin-bottom: 15px;\">Your unique database access key:</p>\r\n            <div style=\"background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; padding: 15px; text-align: center; font-family: 'Courier New', monospace; font-size: 24px; font-weight: bold; color: #1f2937; letter-spacing: 3px;\">\r\n              ${dbKey}\r\n            </div>\r\n            <p style=\"color: #ef4444; font-weight: bold; margin-top: 15px; margin-bottom: 0;\">\r\n              ‚ö†Ô∏è KEEP THIS KEY STRICTLY CONFIDENTIAL AND SECURE\r\n            </p>\r\n          </div>\r\n          \r\n          <div style=\"background: #fff; border: 1px solid #d1d5db; border-radius: 8px; padding: 20px; margin: 20px 0;\">\r\n            <h3 style=\"color: #333; margin-top: 0;\">üåê Your Personal API Endpoint</h3>\r\n            <p style=\"color: #666; margin-bottom: 10px;\">Use this URL on your machine to access your database:</p>\r\n            <div style=\"background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; word-break: break-all; color: #1f2937;\">\r\n              ${apiUrl}\r\n            </div>\r\n            <p style=\"color: #ef4444; font-size: 14px; margin-top: 10px; margin-bottom: 0;\">\r\n              <strong>Important:</strong> Only enter this URL on your designated work machine. Do not share this URL with anyone.\r\n            </p>\r\n          </div>\r\n          \r\n          <div style=\"background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 20px 0;\">\r\n            <h4 style=\"color: #92400e; margin-top: 0; margin-bottom: 10px;\">üõ°Ô∏è Security Guidelines:</h4>\r\n            <ul style=\"color: #92400e; margin: 0; padding-left: 20px; line-height: 1.6;\">\r\n              <li>Never share your dbKey with anyone</li>\r\n              <li>Only access the API from secure, trusted machines</li>\r\n              <li>Log out completely when finished working</li>\r\n              <li>Report any suspicious activity immediately</li>\r\n              <li>Change your password regularly</li>\r\n            </ul>\r\n          </div>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${process.env.FRONTEND_URL}/adminpanel\" style=\"display: inline-block; padding: 15px 30px; background: #10b981; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px;\">\r\n              üöÄ Access Admin Dashboard\r\n            </a>\r\n          </div>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p><strong>Support:</strong> If you have any questions or issues, please contact our support team.</p>\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send password reset email\r\nexport const sendPasswordResetEmail = async (\r\n  email: string, \r\n  name: string, \r\n  resetToken: string\r\n): Promise<void> => {\r\n  const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'Password Reset - Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Password Reset</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Hello ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            You have requested to reset your password. Click the button below to set a new password:\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${resetUrl}\" style=\"display: inline-block; padding: 12px 30px; background: #dc3545; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;\">\r\n              Reset Password\r\n            </a>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6; font-size: 14px;\">\r\n            This link is valid for 1 hour. If you didn't request a password reset, please ignore this email.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send admin approval request to super admin\r\nexport const sendAdminApprovalRequest = async (\r\n  adminEmail: string,\r\n  adminName: string,\r\n  companyName: string\r\n): Promise<void> => {\r\n  const approvalUrl = `${process.env.CLIENT_URL}/adminpanel/dashboard#pending-approvals`;\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: process.env.SUPER_ADMIN_EMAIL || 'admin@poornasreeequipments.com',\r\n    subject: 'New Admin Registration - Approval Required',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Admin Approval Required</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">New Admin Registration</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            A new admin has completed email verification and is requesting account activation:\r\n          </p>\r\n          \r\n          <div style=\"background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc3545;\">\r\n            <h3 style=\"color: #dc3545; margin-top: 0;\">Admin Details:</h3>\r\n            <p style=\"margin: 5px 0;\"><strong>Name:</strong> ${adminName}</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Email:</strong> ${adminEmail}</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Company:</strong> ${companyName}</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Role:</strong> Admin</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Status:</strong> <span style=\"color: #fd7e14;\">Pending Approval</span></p>\r\n          </div>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${approvalUrl}\" style=\"display: inline-block; padding: 15px 30px; background: #dc3545; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; margin-right: 10px;\">\r\n              Review & Approve\r\n            </a>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6; font-size: 14px; border-top: 1px solid #ddd; padding-top: 15px; margin-top: 25px;\">\r\n            <strong>Action Required:</strong> Please log in to the admin panel to review and approve/reject this admin registration request.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud System</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send admin rejection email\r\nexport const sendAdminRejectionEmail = async (\r\n  adminEmail: string,\r\n  adminName: string,\r\n  reason?: string\r\n): Promise<void> => {\r\n  const supportEmail = 'support@poornasreeequipments.com';\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: adminEmail,\r\n    subject: 'Admin Application Status - Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #6c757d 0%, #495057 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Application Status Update</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Hello ${adminName},</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Thank you for your interest in joining Poornasree Equipments Cloud as an administrator.\r\n          </p>\r\n          \r\n          <div style=\"background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;\">\r\n            <h3 style=\"color: #856404; margin-top: 0;\">Application Status: Not Approved</h3>\r\n            <p style=\"color: #856404; margin-bottom: 0;\">\r\n              After careful review, we are unable to approve your admin application at this time.\r\n            </p>\r\n          </div>\r\n          \r\n          ${reason ? `\r\n          <div style=\"background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6;\">\r\n            <h4 style=\"color: #495057; margin-top: 0;\">Reason:</h4>\r\n            <p style=\"color: #666; margin-bottom: 0;\">${reason}</p>\r\n          </div>\r\n          ` : ''}\r\n          \r\n          <div style=\"background: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #0dcaf0;\">\r\n            <h4 style=\"color: #055160; margin-top: 0;\">What's Next?</h4>\r\n            <p style=\"color: #055160; margin-bottom: 10px;\">\r\n              If you believe this decision was made in error or if you have additional information to provide, \r\n              please don't hesitate to contact our support team.\r\n            </p>\r\n            <div style=\"text-align: center; margin-top: 20px;\">\r\n              <a href=\"mailto:${supportEmail}\" style=\"display: inline-block; padding: 12px 24px; background: #0dcaf0; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;\">\r\n                Contact Support\r\n              </a>\r\n            </div>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            We appreciate your understanding and thank you for your interest in our platform.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send milk collection notification email\r\nexport const sendMilkCollectionEmail = async (\r\n  email: string,\r\n  farmerName: string,\r\n  collectionDetails: {\r\n    farmerId: string;\r\n    societyName?: string;\r\n    collectionDate: string;\r\n    collectionTime: string;\r\n    shiftType: string;\r\n    channel: string;\r\n    quantity: number;\r\n    fatPercentage: number;\r\n    snfPercentage: number;\r\n    clrValue: number;\r\n    proteinPercentage: number;\r\n    lactosePercentage: number;\r\n    waterPercentage: number;\r\n    temperature: number;\r\n    ratePerLiter: number;\r\n    totalAmount: number;\r\n    bonus: number;\r\n  }\r\n): Promise<void> => {\r\n  const formattedDate = new Date(collectionDetails.collectionDate).toLocaleDateString('en-IN', {\r\n    weekday: 'long',\r\n    year: 'numeric',\r\n    month: 'long',\r\n    day: 'numeric'\r\n  });\r\n\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: `Milk Collection Receipt - ${collectionDetails.farmerId} - ${formattedDate}`,\r\n    html: `\r\n      <div style=\"max-width: 650px; margin: 0 auto; padding: 20px; font-family: 'Segoe UI', Arial, sans-serif; background-color: #f5f5f5;\">\r\n        <!-- Header -->\r\n        <div style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 12px 12px 0 0; color: white; text-align: center;\">\r\n          <h1 style=\"margin: 0; font-size: 28px; font-weight: 600;\">ü•õ Milk Collection Receipt</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.95; font-size: 16px;\">Poornasree Equipments Cloud</p>\r\n        </div>\r\n        \r\n        <!-- Body -->\r\n        <div style=\"background: white; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\r\n          <!-- Greeting -->\r\n          <div style=\"margin-bottom: 25px;\">\r\n            <h2 style=\"color: #1f2937; margin: 0 0 10px 0; font-size: 22px;\">Hello ${farmerName},</h2>\r\n            <p style=\"color: #6b7280; margin: 0; line-height: 1.6;\">\r\n              Your milk collection has been successfully recorded. Here are the details:\r\n            </p>\r\n          </div>\r\n\r\n          <!-- Collection Details Card -->\r\n          <div style=\"background: #f9fafb; border-left: 4px solid #10b981; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <h3 style=\"color: #059669; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;\">üìã Collection Information</h3>\r\n            \r\n            <table style=\"width: 100%; border-collapse: collapse;\">\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280; width: 45%;\">Farmer ID:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.farmerId}</td>\r\n              </tr>\r\n              ${collectionDetails.societyName ? `\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Society:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.societyName}</td>\r\n              </tr>\r\n              ` : ''}\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Date:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${formattedDate}</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Time:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.collectionTime}</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Shift:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">\r\n                  <span style=\"background: ${collectionDetails.shiftType === 'morning' ? '#fef3c7' : '#dbeafe'}; color: ${collectionDetails.shiftType === 'morning' ? '#92400e' : '#1e40af'}; padding: 4px 12px; border-radius: 12px; font-size: 14px;\">\r\n                    ${collectionDetails.shiftType === 'morning' ? 'üåÖ Morning' : 'üåÜ Evening'}\r\n                  </span>\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Milk Type:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.channel}</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n\r\n          <!-- Quality Parameters Card -->\r\n          <div style=\"background: #eff6ff; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <h3 style=\"color: #1e40af; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;\">üî¨ Quality Parameters</h3>\r\n            \r\n            <table style=\"width: 100%; border-collapse: collapse;\">\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280; width: 45%;\">Fat:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.fatPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">SNF:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.snfPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">CLR:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.clrValue.toFixed(2)}</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Protein:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.proteinPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Lactose:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.lactosePercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Water:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.waterPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Temperature:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.temperature.toFixed(2)}¬∞C</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n\r\n          <!-- Payment Details Card -->\r\n          <div style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;\">\r\n            <h3 style=\"margin: 0 0 15px 0; font-size: 18px; font-weight: 600;\">üí∞ Payment Details</h3>\r\n            \r\n            <table style=\"width: 100%; border-collapse: collapse;\">\r\n              <tr>\r\n                <td style=\"padding: 8px 0; opacity: 0.9; width: 45%;\">Quantity:</td>\r\n                <td style=\"padding: 8px 0; font-weight: 600; font-size: 16px;\">${collectionDetails.quantity.toFixed(2)} Liters</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; opacity: 0.9;\">Rate per Liter:</td>\r\n                <td style=\"padding: 8px 0; font-weight: 600; font-size: 16px;\">‚Çπ${collectionDetails.ratePerLiter.toFixed(2)}</td>\r\n              </tr>\r\n              ${collectionDetails.bonus > 0 ? `\r\n              <tr>\r\n                <td style=\"padding: 8px 0; opacity: 0.9;\">Bonus:</td>\r\n                <td style=\"padding: 8px 0; font-weight: 600; font-size: 16px;\">‚Çπ${collectionDetails.bonus.toFixed(2)}</td>\r\n              </tr>\r\n              ` : ''}\r\n              <tr style=\"border-top: 1px solid rgba(255,255,255,0.3);\">\r\n                <td style=\"padding: 12px 0; font-size: 18px; font-weight: 600;\">Total Amount:</td>\r\n                <td style=\"padding: 12px 0; font-size: 24px; font-weight: 700;\">‚Çπ${collectionDetails.totalAmount.toFixed(2)}</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n\r\n          <!-- Footer Note -->\r\n          <div style=\"background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <p style=\"margin: 0; color: #92400e; line-height: 1.6; font-size: 14px;\">\r\n              <strong>üìù Note:</strong> This is an automated notification for your milk collection. Please keep this email for your records. For any discrepancies, contact your society office within 24 hours.\r\n            </p>\r\n          </div>\r\n\r\n          <!-- Footer -->\r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center;\">\r\n            <p style=\"color: #6b7280; margin: 0 0 10px 0; font-size: 14px;\">\r\n              Thank you for your continued support!\r\n            </p>\r\n            <p style=\"color: #9ca3af; margin: 0; font-size: 12px;\">\r\n              Best regards,<br>\r\n              <strong>Poornasree Equipments Cloud Team</strong>\r\n            </p>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Disclaimer -->\r\n        <div style=\"margin-top: 20px; text-align: center;\">\r\n          <p style=\"color: #9ca3af; font-size: 11px; line-height: 1.4; margin: 0;\">\r\n            This is an automated email. Please do not reply to this email.<br>\r\n            ¬© ${new Date().getFullYear()} Poornasree Equipments Cloud. All rights reserved.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  try {\r\n    await transporter.sendMail(mailOptions);\r\n    console.log(`‚úÖ Collection email sent to ${email}`);\r\n  } catch (error) {\r\n    console.error(`‚ùå Failed to send collection email to ${email}:`, error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport default transporter;"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;;AAEA,sBAAsB;AACtB,6EAA6E;AAC7E,MAAM,cAAc;IAClB,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI;IACzD,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI;IAClE,QAAQ,CAAC,QAAQ,GAAG,CAAC,WAAW,IAAI,QAAQ,GAAG,CAAC,YAAY,MAAM;IAClE,MAAM;QACJ,MAAM,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU;QACzD,MAAM,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,cAAc;IAC/D;AACF;AAEA,qBAAqB;AACrB,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;AAGxC,MAAM,cAAc;IACzB,OAAO,KAAK,KAAK,CAAC,SAAS,KAAK,MAAM,KAAK,QAAQ,QAAQ;AAC7D;AAGO,MAAM,eAAe,OAC1B,OACA,KACA;IAEA,gBAAgB;IAChB,QAAQ,GAAG,CAAC,uBAAuB;QACjC,IAAI;QACJ,MAAM,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU;QACzD,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,UAAU;QACrD,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,UAAU;QACrD,aAAa,CAAC,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,cAAc;QACvE,QAAQ,CAAC,QAAQ,GAAG,CAAC,WAAW,IAAI,QAAQ,GAAG,CAAC,YAAY,MAAM;IACpE;IAEA,MAAM,cAAc;QAClB,MAAM,CAAC,+BAA+B,EAAE,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;QAC9F,IAAI;QACJ,SAAS;QACT,MAAM,CAAC;;;;;;;;wDAQ6C,EAAE,KAAK;;;;;;;cAOjD,EAAE,IAAI;;;;;;;;;;;;;IAahB,CAAC;IACH;IAEA,MAAM,YAAY,QAAQ,CAAC;AAC7B;AAGO,MAAM,mBAAmB,OAC9B,OACA,MACA;IAEA,MAAM,cAAc;QAClB,MAAM,CAAC,+BAA+B,EAAE,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;QAC9F,IAAI;QACJ,SAAS;QACT,MAAM,CAAC;;;;;;;;0DAQ+C,EAAE,KAAK;;6IAE4E,EAAE,KAAK;;;;qBAI/H,EAAE,QAAQ,GAAG,CAAC,YAAY,CAAC;;;;;;;;;;IAU5C,CAAC;IACH;IAEA,MAAM,YAAY,QAAQ,CAAC;AAC7B;AAGO,MAAM,wBAAwB,OACnC,OACA,MACA;IAEA,MAAM,SAAS,CAAC,uCAAuC,EAAE,OAAO;IAEhE,MAAM,cAAc;QAClB,MAAM,CAAC,+BAA+B,EAAE,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;QAC9F,IAAI;QACJ,SAAS;QACT,MAAM,CAAC;;;;;;;;0DAQ+C,EAAE,KAAK;;;;;;;;;cASnD,EAAE,MAAM;;;;;;;;;;;cAWR,EAAE,OAAO;;;;;;;;;;;;;;;;;;;qBAmBF,EAAE,QAAQ,GAAG,CAAC,YAAY,CAAC;;;;;;;;;;;IAW5C,CAAC;IACH;IAEA,MAAM,YAAY,QAAQ,CAAC;AAC7B;AAGO,MAAM,yBAAyB,OACpC,OACA,MACA;IAEA,MAAM,WAAW,GAAG,QAAQ,GAAG,CAAC,YAAY,CAAC,sBAAsB,EAAE,YAAY;IAEjF,MAAM,cAAc;QAClB,MAAM,CAAC,+BAA+B,EAAE,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;QAC9F,IAAI;QACJ,SAAS;QACT,MAAM,CAAC;;;;;;;;wDAQ6C,EAAE,KAAK;;;;;;qBAM1C,EAAE,SAAS;;;;;;;;;;;;;;IAc5B,CAAC;IACH;IAEA,MAAM,YAAY,QAAQ,CAAC;AAC7B;AAGO,MAAM,2BAA2B,OACtC,YACA,WACA;IAEA,MAAM,cAAc,GAAG,QAAQ,GAAG,CAAC,UAAU,CAAC,uCAAuC,CAAC;IAEtF,MAAM,cAAc;QAClB,MAAM,CAAC,+BAA+B,EAAE,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;QAC9F,IAAI,QAAQ,GAAG,CAAC,iBAAiB,IAAI;QACrC,SAAS;QACT,MAAM,CAAC;;;;;;;;;;;;;;;6DAekD,EAAE,UAAU;8DACX,EAAE,WAAW;gEACX,EAAE,YAAY;;;;;;qBAMzD,EAAE,YAAY;;;;;;;;;;;;;;IAc/B,CAAC;IACH;IAEA,MAAM,YAAY,QAAQ,CAAC;AAC7B;AAGO,MAAM,0BAA0B,OACrC,YACA,WACA;IAEA,MAAM,eAAe;IAErB,MAAM,cAAc;QAClB,MAAM,CAAC,+BAA+B,EAAE,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;QAC9F,IAAI;QACJ,SAAS;QACT,MAAM,CAAC;;;;;;;;wDAQ6C,EAAE,UAAU;;;;;;;;;;;;UAY1D,EAAE,SAAS,CAAC;;;sDAGgC,EAAE,OAAO;;UAErD,CAAC,GAAG,GAAG;;;;;;;;;8BASa,EAAE,aAAa;;;;;;;;;;;;;;;IAezC,CAAC;IACH;IAEA,MAAM,YAAY,QAAQ,CAAC;AAC7B;AAGO,MAAM,0BAA0B,OACrC,OACA,YACA;IAoBA,MAAM,gBAAgB,IAAI,KAAK,kBAAkB,cAAc,EAAE,kBAAkB,CAAC,SAAS;QAC3F,SAAS;QACT,MAAM;QACN,OAAO;QACP,KAAK;IACP;IAEA,MAAM,cAAc;QAClB,MAAM,CAAC,+BAA+B,EAAE,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;QAC9F,IAAI;QACJ,SAAS,CAAC,0BAA0B,EAAE,kBAAkB,QAAQ,CAAC,GAAG,EAAE,eAAe;QACrF,MAAM,CAAC;;;;;;;;;;;;mFAYwE,EAAE,WAAW;;;;;;;;;;;;;8EAalB,EAAE,kBAAkB,QAAQ,CAAC;;cAE7F,EAAE,kBAAkB,WAAW,GAAG,CAAC;;;8EAG6B,EAAE,kBAAkB,WAAW,CAAC;;cAEhG,CAAC,GAAG,GAAG;;;8EAGyD,EAAE,cAAc;;;;8EAIhB,EAAE,kBAAkB,cAAc,CAAC;;;;;2CAKtE,EAAE,kBAAkB,SAAS,KAAK,YAAY,YAAY,UAAU,SAAS,EAAE,kBAAkB,SAAS,KAAK,YAAY,YAAY,UAAU;oBACxK,EAAE,kBAAkB,SAAS,KAAK,YAAY,eAAe,aAAa;;;;;;8EAMhB,EAAE,kBAAkB,OAAO,CAAC;;;;;;;;;;;;8EAY5B,EAAE,kBAAkB,aAAa,CAAC,OAAO,CAAC,GAAG;;;;8EAI7C,EAAE,kBAAkB,aAAa,CAAC,OAAO,CAAC,GAAG;;;;8EAI7C,EAAE,kBAAkB,QAAQ,CAAC,OAAO,CAAC,GAAG;;;;8EAIxC,EAAE,kBAAkB,iBAAiB,CAAC,OAAO,CAAC,GAAG;;;;8EAIjD,EAAE,kBAAkB,iBAAiB,CAAC,OAAO,CAAC,GAAG;;;;8EAIjD,EAAE,kBAAkB,eAAe,CAAC,OAAO,CAAC,GAAG;;;;8EAI/C,EAAE,kBAAkB,WAAW,CAAC,OAAO,CAAC,GAAG;;;;;;;;;;;;+EAY1C,EAAE,kBAAkB,QAAQ,CAAC,OAAO,CAAC,GAAG;;;;gFAIvC,EAAE,kBAAkB,YAAY,CAAC,OAAO,CAAC,GAAG;;cAE9G,EAAE,kBAAkB,KAAK,GAAG,IAAI,CAAC;;;gFAGiC,EAAE,kBAAkB,KAAK,CAAC,OAAO,CAAC,GAAG;;cAEvG,CAAC,GAAG,GAAG;;;iFAG4D,EAAE,kBAAkB,WAAW,CAAC,OAAO,CAAC,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;cA4B9G,EAAE,IAAI,OAAO,WAAW,GAAG;;;;IAIrC,CAAC;IACH;IAEA,IAAI;QACF,MAAM,YAAY,QAAQ,CAAC;QAC3B,QAAQ,GAAG,CAAC,CAAC,2BAA2B,EAAE,OAAO;IACnD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,qCAAqC,EAAE,MAAM,CAAC,CAAC,EAAE;QAChE,MAAM;IACR;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 749, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/user/bmc/send-delete-otp/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { verifyToken } from '@/lib/auth';\r\nimport { createErrorResponse, createSuccessResponse } from '@/middleware/auth';\r\nimport { connectDB } from '@/lib/database';\r\nimport { generateOTP } from '@/lib/emailService';\r\nimport nodemailer from 'nodemailer';\r\n\r\n// In-memory store for OTPs (you could also use Redis or database)\r\nconst otpStore = new Map<string, { otp: string; expires: Date; bmcId: number }>();\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return createErrorResponse('Authentication required', 401);\r\n    }\r\n\r\n    const payload = verifyToken(token);\r\n    if (!payload || payload.role !== 'admin') {\r\n      return createErrorResponse('Admin access required', 403);\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { bmcId, bmcName } = body;\r\n\r\n    if (!bmcId) {\r\n      return createErrorResponse('BMC ID is required', 400);\r\n    }\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { User } = getModels();\r\n\r\n    // Get admin details\r\n    const admin = await User.findByPk(payload.id);\r\n    if (!admin) {\r\n      return createErrorResponse('Admin not found', 404);\r\n    }\r\n\r\n    // Generate OTP\r\n    const otp = generateOTP();\r\n    const expires = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes\r\n\r\n    // Store OTP in memory\r\n    const otpKey = `${admin.id}_${bmcId}`;\r\n    otpStore.set(otpKey, { otp, expires, bmcId });\r\n\r\n    // Clean up expired OTPs\r\n    for (const [key, value] of otpStore.entries()) {\r\n      if (value.expires < new Date()) {\r\n        otpStore.delete(key);\r\n      }\r\n    }\r\n\r\n    // Send OTP email with custom message for deletion\r\n    try {\r\n      await sendDeleteConfirmationOTP(admin.email, otp, admin.fullName, bmcName);\r\n      console.log(`‚úÖ Delete confirmation OTP sent to ${admin.email} for BMC ${bmcName}`);\r\n    } catch (emailError) {\r\n      console.error('Failed to send OTP email:', emailError);\r\n      return createErrorResponse('Failed to send OTP email', 500);\r\n    }\r\n\r\n    return createSuccessResponse(\r\n      { expiresIn: 600 }, // 10 minutes\r\n      'OTP sent to your email. Please check and verify.'\r\n    );\r\n\r\n  } catch (error: unknown) {\r\n    console.error('Error sending delete OTP:', error);\r\n    return createErrorResponse('Failed to send OTP', 500);\r\n  }\r\n}\r\n\r\n// Custom email function for delete confirmation\r\nasync function sendDeleteConfirmationOTP(\r\n  email: string,\r\n  otp: string,\r\n  name: string,\r\n  bmcName: string\r\n): Promise<void> {\r\n  const emailConfig = {\r\n    host: process.env.SMTP_HOST || process.env.EMAIL_HOST || 'smtp.gmail.com',\r\n    port: parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || '587'),\r\n    secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true',\r\n    auth: {\r\n      user: process.env.SMTP_USERNAME || process.env.EMAIL_USER,\r\n      pass: process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD,\r\n    },\r\n  };\r\n\r\n  const transporter = nodemailer.createTransport(emailConfig);\r\n\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: '‚ö†Ô∏è CRITICAL: BMC Deletion Confirmation Required',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">‚ö†Ô∏è Critical Action Required</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">BMC Deletion Confirmation</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #fef2f2; border: 2px solid #dc2626; border-radius: 10px;\">\r\n          <h2 style=\"color: #dc2626; margin-top: 0;\">Hello ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            You have requested to <strong style=\"color: #dc2626;\">permanently delete</strong> the following BMC and all its associated data:\r\n          </p>\r\n          \r\n          <div style=\"background: white; padding: 15px; border-left: 4px solid #dc2626; margin: 20px 0;\">\r\n            <h3 style=\"margin: 0; color: #dc2626;\">${bmcName}</h3>\r\n            <p style=\"margin: 10px 0 0 0; color: #666; font-size: 14px;\">\r\n              This action will delete:\r\n            </p>\r\n            <ul style=\"color: #666; font-size: 14px; margin: 10px 0;\">\r\n              <li>All societies under this BMC</li>\r\n              <li>All farmers</li>\r\n              <li>All machines</li>\r\n              <li>All machine statistics</li>\r\n              <li>All machine corrections (admin & device saved)</li>\r\n              <li>All rate charts and rate chart data</li>\r\n              <li>All milk collections</li>\r\n              <li>All sales records</li>\r\n              <li>All dispatch records</li>\r\n              <li>All section pulse tracking data</li>\r\n            </ul>\r\n            <p style=\"margin: 10px 0 0 0; color: #dc2626; font-weight: bold; font-size: 14px;\">\r\n              ‚ö†Ô∏è THIS ACTION CANNOT BE UNDONE!\r\n            </p>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            To confirm this deletion, please enter the following OTP:\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <div style=\"display: inline-block; padding: 15px 30px; background: #dc2626; color: white; font-size: 32px; font-weight: bold; letter-spacing: 5px; border-radius: 8px; box-shadow: 0 4px 6px rgba(220, 38, 38, 0.3);\">\r\n              ${otp}\r\n            </div>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6; font-size: 14px;\">\r\n            This OTP is valid for <strong>10 minutes</strong>. If you didn't request this deletion, please ignore this email and contact support immediately.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #fca5a5; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n}\r\n\r\n// Export function to verify OTP (called from delete endpoint)\r\nexport function verifyDeleteOTP(adminId: number, bmcId: number, providedOtp: string): boolean {\r\n  const otpKey = `${adminId}_${bmcId}`;\r\n  const stored = otpStore.get(otpKey);\r\n\r\n  if (!stored) {\r\n    console.log('‚ùå No OTP found for this deletion request');\r\n    return false;\r\n  }\r\n\r\n  if (stored.expires < new Date()) {\r\n    otpStore.delete(otpKey);\r\n    console.log('‚ùå OTP expired');\r\n    return false;\r\n  }\r\n\r\n  if (stored.otp !== providedOtp) {\r\n    console.log('‚ùå Invalid OTP');\r\n    return false;\r\n  }\r\n\r\n  // OTP is valid, delete it so it can't be reused\r\n  otpStore.delete(otpKey);\r\n  console.log('‚úÖ OTP verified successfully');\r\n  return true;\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}