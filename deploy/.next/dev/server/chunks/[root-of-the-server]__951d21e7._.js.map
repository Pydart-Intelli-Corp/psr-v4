{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/database.ts"],"sourcesContent":["import { Sequelize } from 'sequelize';\r\nimport mysql2 from 'mysql2';\r\nimport path from 'path';\r\n\r\n// Database configuration for Azure MySQL\r\nlet sequelize: Sequelize | null = null;\r\n\r\nconst createSequelizeInstance = () => {\r\n    if (!sequelize) {\r\n    // Don't initialize during build time\r\n    if (process.env.NODE_ENV === 'development' || process.env.BUILDING !== 'true') {\r\n      // Determine SSL configuration based on environment\r\n      // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n      const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n        require: true,\r\n        rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n        ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n      } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n        require: true,\r\n        rejectUnauthorized: false,\r\n      } : false;      sequelize = new Sequelize(\r\n      process.env.DB_NAME || 'psr_v4_main',\r\n      process.env.DB_USER || 'psr_admin',\r\n      process.env.DB_PASSWORD || 'Access@404',\r\n      {\r\n        host: process.env.DB_HOST || 'localhost',\r\n        port: parseInt(process.env.DB_PORT || '3306'),\r\n        dialect: 'mysql',\r\n        dialectModule: mysql2,\r\n        timezone: '+05:30', // Use Indian Standard Time (IST)\r\n        dialectOptions: {\r\n          ssl: sslConfig,\r\n          connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        },\r\n        pool: {\r\n          max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n          min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n          acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n          idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n        },\r\n        logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n        benchmark: process.env.NODE_ENV === 'development',\r\n      }\r\n    );\r\n    }\r\n  }\r\n  return sequelize;\r\n};\r\n\r\n// Test database connection\r\nexport const testConnection = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('❌ Database not initialized');\r\n      return false;\r\n    }\r\n    await db.authenticate();\r\n    console.log('✅ Database connection established successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('❌ Unable to connect to the database:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Initialize database\r\nexport const initDatabase = async (useMigrations: boolean = false) => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('❌ Database not initialized');\r\n      return false;\r\n    }\r\n    \r\n    if (useMigrations) {\r\n      // Use migrations instead of sync for production\r\n      const { migrationRunner } = await import('./migrations');\r\n      await migrationRunner.initializeDatabase();\r\n    } else {\r\n      // Development mode - use sync\r\n      await db.sync({ alter: process.env.NODE_ENV === 'development' });\r\n    }\r\n    \r\n    console.log('✅ Database synchronized successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('❌ Database synchronization failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Connect to database\r\nexport const connectDB = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.authenticate();\r\n    return db;\r\n  } catch (error) {\r\n    console.error('❌ Database connection failed:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to create admin-specific schema\r\nexport const createAdminSchema = async (adminEmail: string): Promise<string> => {\r\n  try {\r\n    // Generate DB key: db-<first 3 letters of email><3 random numbers>\r\n    const emailPrefix = adminEmail.substring(0, 3).toLowerCase();\r\n    const randomSuffix = Math.floor(100 + Math.random() * 900).toString();\r\n    const dbKey = `db_${emailPrefix}${randomSuffix}`;\r\n    \r\n    // Create new database schema\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.query(`CREATE DATABASE IF NOT EXISTS \\`${dbKey}\\``);\r\n    \r\n    console.log(`✅ Created admin schema: ${dbKey}`);\r\n    return dbKey;\r\n  } catch (error) {\r\n    console.error('❌ Failed to create admin schema:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to get connection for specific admin schema\r\nexport const getAdminConnection = (dbKey: string): Sequelize => {\r\n  // Determine SSL configuration based on environment\r\n  // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n  const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n    require: true,\r\n    rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n    ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n  } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n    require: true,\r\n    rejectUnauthorized: false,\r\n  } : false;\r\n\r\n  return new Sequelize(\r\n    dbKey,\r\n    process.env.DB_USER || 'psr_admin',\r\n    process.env.DB_PASSWORD || '',\r\n    {\r\n      host: process.env.DB_HOST || 'localhost',\r\n      port: parseInt(process.env.DB_PORT || '3306'),\r\n      dialect: 'mysql',\r\n      dialectModule: mysql2,\r\n      dialectOptions: {\r\n        ssl: sslConfig,\r\n        connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        acquireTimeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n        timeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n      },\r\n      pool: {\r\n        max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n        min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n        acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n      },\r\n      logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n    }\r\n  );\r\n};\r\n\r\nexport default createSequelizeInstance;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 308, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/utils/response.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nexport interface ApiResponse<T = unknown> {\r\n  success: boolean;\r\n  message: string;\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\nexport function createSuccessResponse<T = unknown>(\r\n  message: string,\r\n  data?: T,\r\n  status: number = 200\r\n): NextResponse<ApiResponse<T>> {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      message,\r\n      data,\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\nexport function createErrorResponse<T = unknown>(\r\n  error: string,\r\n  status: number = 400,\r\n  data?: T\r\n): NextResponse<ApiResponse<T>> {\r\n  return NextResponse.json(\r\n    {\r\n      success: false,\r\n      message: 'Error occurred',\r\n      error,\r\n      data,\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\nexport function validateRequiredFields(\r\n  body: Record<string, unknown>,\r\n  requiredFields: string[]\r\n): { success: boolean; missing?: string[] } {\r\n  const missing = requiredFields.filter(field => !body[field]);\r\n  return {\r\n    success: missing.length === 0,\r\n    missing: missing.length > 0 ? missing : undefined\r\n  };\r\n}"],"names":[],"mappings":";;;;;;;;AAAA;;AASO,SAAS,sBACd,OAAe,EACf,IAAQ,EACR,SAAiB,GAAG;IAEpB,OAAO,gJAAY,CAAC,IAAI,CACtB;QACE,SAAS;QACT;QACA;IACF,GACA;QAAE;IAAO;AAEb;AAEO,SAAS,oBACd,KAAa,EACb,SAAiB,GAAG,EACpB,IAAQ;IAER,OAAO,gJAAY,CAAC,IAAI,CACtB;QACE,SAAS;QACT,SAAS;QACT;QACA;IACF,GACA;QAAE;IAAO;AAEb;AAEO,SAAS,uBACd,IAA6B,EAC7B,cAAwB;IAExB,MAAM,UAAU,eAAe,MAAM,CAAC,CAAA,QAAS,CAAC,IAAI,CAAC,MAAM;IAC3D,OAAO;QACL,SAAS,QAAQ,MAAM,KAAK;QAC5B,SAAS,QAAQ,MAAM,GAAG,IAAI,UAAU;IAC1C;AACF","debugId":null}},
    {"offset": {"line": 348, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/debug/search-email/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { connectDB } from '@/lib/database';\r\nimport { createSuccessResponse, createErrorResponse } from '@/lib/utils/response';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const email = searchParams.get('email');\r\n    \r\n    if (!email) {\r\n      return createErrorResponse('Email parameter required', 400);\r\n    }\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize } = getModels();\r\n\r\n    // Get all admin schemas\r\n    const [schemas] = await sequelize.query(`\r\n      SELECT DISTINCT TABLE_SCHEMA \r\n      FROM information_schema.TABLES \r\n      WHERE (TABLE_SCHEMA LIKE 'db_%' OR TABLE_SCHEMA LIKE 'tester_%' OR TABLE_SCHEMA LIKE 'tishnu_%') \r\n      ORDER BY TABLE_SCHEMA\r\n    `);\r\n    \r\n    const adminSchemas = (schemas as Array<{ TABLE_SCHEMA: string }>).map(s => s.TABLE_SCHEMA);\r\n    \r\n    let results = [];\r\n    \r\n    for (const schema of adminSchemas) {\r\n      try {\r\n        // Check farmers\r\n        const [farmers] = await sequelize.query(`\r\n          SELECT 'farmer' as type, farmer_id as id, name, email, '${schema}' as schema_name\r\n          FROM \\`${schema}\\`.farmers WHERE email = ?\r\n        `, { replacements: [email.toLowerCase()] });\r\n        \r\n        if (Array.isArray(farmers) && farmers.length > 0) {\r\n          results.push(...farmers);\r\n        }\r\n        \r\n        // Check societies\r\n        const [societies] = await sequelize.query(`\r\n          SELECT 'society' as type, society_id as id, name, email, '${schema}' as schema_name\r\n          FROM \\`${schema}\\`.societies WHERE email = ?\r\n        `, { replacements: [email.toLowerCase()] });\r\n        \r\n        if (Array.isArray(societies) && societies.length > 0) {\r\n          results.push(...societies);\r\n        }\r\n        \r\n      } catch (error) {\r\n        console.log(`Schema ${schema} not accessible or incomplete`);\r\n      }\r\n    }\r\n\r\n    return createSuccessResponse('Email search completed', {\r\n      email,\r\n      found: results.length > 0,\r\n      results,\r\n      totalSchemas: adminSchemas.length\r\n    });\r\n\r\n  } catch (error: unknown) {\r\n    console.error('Error searching email:', error);\r\n    return createErrorResponse('Failed to search email', 500);\r\n  }\r\n}"],"names":[],"mappings":";;;;AACA;AACA;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,QAAQ,aAAa,GAAG,CAAC;QAE/B,IAAI,CAAC,OAAO;YACV,OAAO,IAAA,wJAAmB,EAAC,4BAA4B;QACzD;QAEA,MAAM,IAAA,qIAAS;QACf,MAAM,EAAE,SAAS,EAAE,GAAG;QACtB,MAAM,EAAE,SAAS,EAAE,GAAG;QAEtB,wBAAwB;QACxB,MAAM,CAAC,QAAQ,GAAG,MAAM,UAAU,KAAK,CAAC,CAAC;;;;;IAKzC,CAAC;QAED,MAAM,eAAe,AAAC,QAA4C,GAAG,CAAC,CAAA,IAAK,EAAE,YAAY;QAEzF,IAAI,UAAU,EAAE;QAEhB,KAAK,MAAM,UAAU,aAAc;YACjC,IAAI;gBACF,gBAAgB;gBAChB,MAAM,CAAC,QAAQ,GAAG,MAAM,UAAU,KAAK,CAAC,CAAC;kEACiB,EAAE,OAAO;iBAC1D,EAAE,OAAO;QAClB,CAAC,EAAE;oBAAE,cAAc;wBAAC,MAAM,WAAW;qBAAG;gBAAC;gBAEzC,IAAI,MAAM,OAAO,CAAC,YAAY,QAAQ,MAAM,GAAG,GAAG;oBAChD,QAAQ,IAAI,IAAI;gBAClB;gBAEA,kBAAkB;gBAClB,MAAM,CAAC,UAAU,GAAG,MAAM,UAAU,KAAK,CAAC,CAAC;oEACiB,EAAE,OAAO;iBAC5D,EAAE,OAAO;QAClB,CAAC,EAAE;oBAAE,cAAc;wBAAC,MAAM,WAAW;qBAAG;gBAAC;gBAEzC,IAAI,MAAM,OAAO,CAAC,cAAc,UAAU,MAAM,GAAG,GAAG;oBACpD,QAAQ,IAAI,IAAI;gBAClB;YAEF,EAAE,OAAO,OAAO;gBACd,QAAQ,GAAG,CAAC,CAAC,OAAO,EAAE,OAAO,6BAA6B,CAAC;YAC7D;QACF;QAEA,OAAO,IAAA,0JAAqB,EAAC,0BAA0B;YACrD;YACA,OAAO,QAAQ,MAAM,GAAG;YACxB;YACA,cAAc,aAAa,MAAM;QACnC;IAEF,EAAE,OAAO,OAAgB;QACvB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,IAAA,wJAAmB,EAAC,0BAA0B;IACvD;AACF","debugId":null}}]
}