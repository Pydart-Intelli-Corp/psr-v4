{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/database.ts"],"sourcesContent":["import { Sequelize } from 'sequelize';\r\nimport mysql2 from 'mysql2';\r\nimport path from 'path';\r\n\r\n// Database configuration for Azure MySQL\r\nlet sequelize: Sequelize | null = null;\r\n\r\nconst createSequelizeInstance = () => {\r\n    if (!sequelize) {\r\n    // Don't initialize during build time\r\n    if (process.env.NODE_ENV === 'development' || process.env.BUILDING !== 'true') {\r\n      // Determine SSL configuration based on environment\r\n      // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n      const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n        require: true,\r\n        rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n        ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n      } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n        require: true,\r\n        rejectUnauthorized: false,\r\n      } : false;      sequelize = new Sequelize(\r\n      process.env.DB_NAME || 'psr_v4_main',\r\n      process.env.DB_USER || 'psr_admin',\r\n      process.env.DB_PASSWORD || 'Access@404',\r\n      {\r\n        host: process.env.DB_HOST || 'localhost',\r\n        port: parseInt(process.env.DB_PORT || '3306'),\r\n        dialect: 'mysql',\r\n        dialectModule: mysql2,\r\n        timezone: '+05:30', // Use Indian Standard Time (IST)\r\n        dialectOptions: {\r\n          ssl: sslConfig,\r\n          connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        },\r\n        pool: {\r\n          max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n          min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n          acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n          idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n        },\r\n        logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n        benchmark: process.env.NODE_ENV === 'development',\r\n      }\r\n    );\r\n    }\r\n  }\r\n  return sequelize;\r\n};\r\n\r\n// Test database connection\r\nexport const testConnection = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    await db.authenticate();\r\n    console.log('‚úÖ Database connection established successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Unable to connect to the database:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Initialize database\r\nexport const initDatabase = async (useMigrations: boolean = false) => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    \r\n    if (useMigrations) {\r\n      // Use migrations instead of sync for production\r\n      const { migrationRunner } = await import('./migrations');\r\n      await migrationRunner.initializeDatabase();\r\n    } else {\r\n      // Development mode - use sync\r\n      await db.sync({ alter: process.env.NODE_ENV === 'development' });\r\n    }\r\n    \r\n    console.log('‚úÖ Database synchronized successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Database synchronization failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Connect to database\r\nexport const connectDB = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.authenticate();\r\n    return db;\r\n  } catch (error) {\r\n    console.error('‚ùå Database connection failed:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to create admin-specific schema\r\nexport const createAdminSchema = async (adminEmail: string): Promise<string> => {\r\n  try {\r\n    // Generate DB key: db-<first 3 letters of email><3 random numbers>\r\n    const emailPrefix = adminEmail.substring(0, 3).toLowerCase();\r\n    const randomSuffix = Math.floor(100 + Math.random() * 900).toString();\r\n    const dbKey = `db_${emailPrefix}${randomSuffix}`;\r\n    \r\n    // Create new database schema\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.query(`CREATE DATABASE IF NOT EXISTS \\`${dbKey}\\``);\r\n    \r\n    console.log(`‚úÖ Created admin schema: ${dbKey}`);\r\n    return dbKey;\r\n  } catch (error) {\r\n    console.error('‚ùå Failed to create admin schema:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to get connection for specific admin schema\r\nexport const getAdminConnection = (dbKey: string): Sequelize => {\r\n  // Determine SSL configuration based on environment\r\n  // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n  const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n    require: true,\r\n    rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n    ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n  } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n    require: true,\r\n    rejectUnauthorized: false,\r\n  } : false;\r\n\r\n  return new Sequelize(\r\n    dbKey,\r\n    process.env.DB_USER || 'psr_admin',\r\n    process.env.DB_PASSWORD || '',\r\n    {\r\n      host: process.env.DB_HOST || 'localhost',\r\n      port: parseInt(process.env.DB_PORT || '3306'),\r\n      dialect: 'mysql',\r\n      dialectModule: mysql2,\r\n      dialectOptions: {\r\n        ssl: sslConfig,\r\n        connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        acquireTimeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n        timeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n      },\r\n      pool: {\r\n        max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n        min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n        acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n      },\r\n      logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n    }\r\n  );\r\n};\r\n\r\nexport default createSequelizeInstance;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 302, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/models/User.ts"],"sourcesContent":["import { DataTypes, Model, Sequelize } from 'sequelize';\r\nimport bcrypt from 'bcryptjs';\r\n\r\n// User roles in hierarchical order\r\nexport enum UserRole {\r\n  SUPER_ADMIN = 'super_admin',\r\n  ADMIN = 'admin',\r\n  DAIRY = 'dairy',\r\n  BMC = 'bmc',\r\n  SOCIETY = 'society',\r\n  FARMER = 'farmer'\r\n}\r\n\r\n// User status\r\nexport enum UserStatus {\r\n  PENDING = 'pending',\r\n  PENDING_APPROVAL = 'pending_approval', // Email verified, waiting for super admin approval\r\n  ACTIVE = 'active',\r\n  INACTIVE = 'inactive',\r\n  SUSPENDED = 'suspended'\r\n}\r\n\r\n// User attributes interface\r\nexport interface UserAttributes {\r\n  id?: number;\r\n  uid: string;\r\n  email: string;\r\n  password: string;\r\n  fullName: string;\r\n  role: UserRole;\r\n  status: UserStatus;\r\n  dbKey?: string; // For admins - their dedicated schema key\r\n  companyName?: string;\r\n  companyPincode?: string;\r\n  companyCity?: string;\r\n  companyState?: string;\r\n  parentId?: number; // Reference to parent user in hierarchy\r\n  isEmailVerified: boolean;\r\n  emailVerificationToken?: string;\r\n  emailVerificationExpires?: Date;\r\n  passwordResetToken?: string;\r\n  passwordResetExpires?: Date;\r\n  otpCode?: string;\r\n  otpExpires?: Date;\r\n  lastLogin?: Date;\r\n  loginAttempts: number;\r\n  lockUntil?: Date;\r\n  createdAt?: Date;\r\n  updatedAt?: Date;\r\n}\r\n\r\n// User model class\r\nclass User extends Model<UserAttributes> implements UserAttributes {\r\n  // Remove public class fields to avoid shadowing Sequelize getters/setters\r\n  declare id: number;\r\n  declare uid: string;\r\n  declare email: string;\r\n  declare password: string;\r\n  declare fullName: string;\r\n  declare role: UserRole;\r\n  declare status: UserStatus;\r\n  declare dbKey?: string;\r\n  declare companyName?: string;\r\n  declare companyPincode?: string;\r\n  declare companyCity?: string;\r\n  declare companyState?: string;\r\n  declare parentId?: number;\r\n  declare isEmailVerified: boolean;\r\n  declare emailVerificationToken?: string;\r\n  declare emailVerificationExpires?: Date;\r\n  declare passwordResetToken?: string;\r\n  declare passwordResetExpires?: Date;\r\n  declare otpCode?: string;\r\n  declare otpExpires?: Date;\r\n  declare lastLogin?: Date;\r\n  declare loginAttempts: number;\r\n  declare lockUntil?: Date;\r\n\r\n  // Timestamps\r\n  declare readonly createdAt: Date;\r\n  declare readonly updatedAt: Date;\r\n\r\n  // Instance methods\r\n  public async comparePassword(candidatePassword: string): Promise<boolean> {\r\n    return bcrypt.compare(candidatePassword, this.password);\r\n  }\r\n\r\n  public async incLoginAttempts(): Promise<void> {\r\n    // If we have a previous lock that has expired, restart at 1\r\n    if (this.lockUntil && this.lockUntil < new Date()) {\r\n      await this.update({\r\n        loginAttempts: 1,\r\n        lockUntil: undefined\r\n      });\r\n      return;\r\n    }\r\n\r\n    const updates: Partial<UserAttributes> = { loginAttempts: this.loginAttempts + 1 };\r\n\r\n    // Lock account after 5 failed attempts for 2 hours\r\n    if (this.loginAttempts + 1 >= 5 && !this.isLocked) {\r\n      updates.lockUntil = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours\r\n    }\r\n\r\n    await this.update(updates);\r\n  }\r\n\r\n  public async resetLoginAttempts(): Promise<void> {\r\n    await this.update({\r\n      loginAttempts: 0,\r\n      lockUntil: undefined\r\n    });\r\n  }\r\n\r\n  public get isLocked(): boolean {\r\n    return !!(this.lockUntil && this.lockUntil > new Date());\r\n  }\r\n\r\n\r\n\r\n  public canManageRole(targetRole: UserRole): boolean {\r\n    const roleHierarchy = [\r\n      UserRole.SUPER_ADMIN,\r\n      UserRole.ADMIN,\r\n      UserRole.DAIRY,\r\n      UserRole.BMC,\r\n      UserRole.SOCIETY,\r\n      UserRole.FARMER\r\n    ];\r\n\r\n    const currentRoleIndex = roleHierarchy.indexOf(this.role);\r\n    const targetRoleIndex = roleHierarchy.indexOf(targetRole);\r\n\r\n    return currentRoleIndex < targetRoleIndex;\r\n  }\r\n}\r\n\r\n// Initialize User model\r\nexport const initUserModel = (sequelize: Sequelize): typeof User => {\r\n  User.init(\r\n    {\r\n      id: {\r\n        type: DataTypes.INTEGER,\r\n        primaryKey: true,\r\n        autoIncrement: true,\r\n      },\r\n      uid: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: false,\r\n        unique: true,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [3, 50]\r\n        }\r\n      },\r\n      email: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: false,\r\n        unique: true,\r\n        validate: {\r\n          isEmail: true,\r\n          notEmpty: true\r\n        }\r\n      },\r\n      password: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: false,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [6, 255]\r\n        }\r\n      },\r\n      fullName: {\r\n        type: DataTypes.STRING(200),\r\n        allowNull: false,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [2, 200]\r\n        }\r\n      },\r\n      role: {\r\n        type: DataTypes.ENUM(...Object.values(UserRole)),\r\n        allowNull: false,\r\n        defaultValue: UserRole.FARMER\r\n      },\r\n      status: {\r\n        type: DataTypes.ENUM(...Object.values(UserStatus)),\r\n        allowNull: false,\r\n        defaultValue: UserStatus.PENDING\r\n      },\r\n      dbKey: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: true,\r\n        unique: true,\r\n        comment: 'Dedicated database schema key for admins'\r\n      },\r\n      companyName: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      companyPincode: {\r\n        type: DataTypes.STRING(10),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [5, 10]\r\n        }\r\n      },\r\n      companyCity: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [2, 100]\r\n        }\r\n      },\r\n      companyState: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [2, 100]\r\n        }\r\n      },\r\n      parentId: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: true,\r\n        references: {\r\n          model: 'users',\r\n          key: 'id'\r\n        }\r\n      },\r\n      isEmailVerified: {\r\n        type: DataTypes.BOOLEAN,\r\n        allowNull: false,\r\n        defaultValue: false\r\n      },\r\n      emailVerificationToken: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      emailVerificationExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      passwordResetToken: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      passwordResetExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      otpCode: {\r\n        type: DataTypes.STRING(10),\r\n        allowNull: true\r\n      },\r\n      otpExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      lastLogin: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      loginAttempts: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: false,\r\n        defaultValue: 0\r\n      },\r\n      lockUntil: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      }\r\n    },\r\n    {\r\n      sequelize,\r\n      modelName: 'User',\r\n      tableName: 'users',\r\n      timestamps: true,\r\n      hooks: {\r\n        beforeSave: async (user: User) => {\r\n          // Hash password if it's being modified\r\n          if (user.changed('password') && user.password) {\r\n            const salt = await bcrypt.genSalt(12);\r\n            user.password = await bcrypt.hash(user.password, salt);\r\n          }\r\n\r\n          // Generate UID if not provided\r\n          if (!user.uid && user.email) {\r\n            const timestamp = Date.now().toString().slice(-6);\r\n            const emailPrefix = user.email.substring(0, 3).toUpperCase();\r\n            user.uid = `${emailPrefix}${timestamp}`;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  );\r\n\r\n  // Define associations\r\n  User.hasMany(User, { \r\n    as: 'Children', \r\n    foreignKey: 'parentId',\r\n    onDelete: 'SET NULL'\r\n  });\r\n  \r\n  User.belongsTo(User, { \r\n    as: 'Parent', \r\n    foreignKey: 'parentId',\r\n    onDelete: 'SET NULL'\r\n  });\r\n\r\n  return User;\r\n};\r\n\r\nexport default User;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 569, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/models/AdminSchema.ts"],"sourcesContent":["import { DataTypes, Model, Sequelize } from 'sequelize';\r\n\r\nexport interface AdminSchemaAttributes {\r\n  id?: number;\r\n  adminId: number;\r\n  schemaKey: string;\r\n  schemaName: string;\r\n  status: 'active' | 'inactive' | 'suspended' | 'maintenance';\r\n  configuration?: Record<string, unknown>;\r\n  createdAt?: Date;\r\n  updatedAt?: Date;\r\n}\r\n\r\nexport class AdminSchema extends Model<AdminSchemaAttributes> implements AdminSchemaAttributes {\r\n  public id!: number;\r\n  public adminId!: number;\r\n  public schemaKey!: string;\r\n  public schemaName!: string;\r\n  public status!: 'active' | 'inactive' | 'suspended' | 'maintenance';\r\n  public configuration?: Record<string, unknown>;\r\n  public readonly createdAt!: Date;\r\n  public readonly updatedAt!: Date;\r\n\r\n  // Model associations\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  public static associate(models: Record<string, any>) {\r\n    AdminSchema.belongsTo(models.User, {\r\n      foreignKey: 'adminId',\r\n      as: 'admin'\r\n    });\r\n  }\r\n}\r\n\r\nexport const initAdminSchemaModel = (sequelize: Sequelize) => {\r\n  AdminSchema.init(\r\n    {\r\n      id: {\r\n        type: DataTypes.INTEGER,\r\n        autoIncrement: true,\r\n        primaryKey: true,\r\n      },\r\n      adminId: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: false,\r\n        references: {\r\n          model: 'Users',\r\n          key: 'id'\r\n        }\r\n      },\r\n      schemaKey: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: false,\r\n        unique: true,\r\n      },\r\n      schemaName: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: false,\r\n      },\r\n      status: {\r\n        type: DataTypes.ENUM('active', 'inactive', 'suspended', 'maintenance'),\r\n        allowNull: false,\r\n        defaultValue: 'active',\r\n      },\r\n      configuration: {\r\n        type: DataTypes.JSON,\r\n        allowNull: true,\r\n      }\r\n    },\r\n    {\r\n      sequelize,\r\n      modelName: 'AdminSchema',\r\n      tableName: 'AdminSchemas',\r\n      timestamps: true,\r\n      indexes: [\r\n        { fields: ['adminId'] },\r\n        { fields: ['schemaKey'] },\r\n        { fields: ['status'] }\r\n      ]\r\n    }\r\n  );\r\n\r\n  return AdminSchema;\r\n};\r\n\r\nexport default AdminSchema;"],"names":[],"mappings":";;;;;;;;AAAA;;AAaO,MAAM,oBAAoB,qJAAK;IAC7B,GAAY;IACZ,QAAiB;IACjB,UAAmB;IACnB,WAAoB;IACpB,OAA6D;IAC7D,cAAwC;IAC/B,UAAiB;IACjB,UAAiB;IAEjC,qBAAqB;IACrB,8DAA8D;IAC9D,OAAc,UAAU,MAA2B,EAAE;QACnD,YAAY,SAAS,CAAC,OAAO,IAAI,EAAE;YACjC,YAAY;YACZ,IAAI;QACN;IACF;AACF;AAEO,MAAM,uBAAuB,CAAC;IACnC,YAAY,IAAI,CACd;QACE,IAAI;YACF,MAAM,yJAAS,CAAC,OAAO;YACvB,eAAe;YACf,YAAY;QACd;QACA,SAAS;YACP,MAAM,yJAAS,CAAC,OAAO;YACvB,WAAW;YACX,YAAY;gBACV,OAAO;gBACP,KAAK;YACP;QACF;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,QAAQ;QACV;QACA,YAAY;YACV,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,QAAQ;YACN,MAAM,yJAAS,CAAC,IAAI,CAAC,UAAU,YAAY,aAAa;YACxD,WAAW;YACX,cAAc;QAChB;QACA,eAAe;YACb,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;IACF,GACA;QACE;QACA,WAAW;QACX,WAAW;QACX,YAAY;QACZ,SAAS;YACP;gBAAE,QAAQ;oBAAC;iBAAU;YAAC;YACtB;gBAAE,QAAQ;oBAAC;iBAAY;YAAC;YACxB;gBAAE,QAAQ;oBAAC;iBAAS;YAAC;SACtB;IACH;IAGF,OAAO;AACT;uCAEe","debugId":null}},
    {"offset": {"line": 660, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/models/AuditLog.ts"],"sourcesContent":["import { DataTypes, Model, Sequelize } from 'sequelize';\r\n\r\nexport interface AuditLogAttributes {\r\n  id?: number;\r\n  userId?: number;\r\n  action: string;\r\n  resource: string;\r\n  resourceId?: string;\r\n  oldValues?: Record<string, unknown>;\r\n  newValues?: Record<string, unknown>;\r\n  ipAddress?: string;\r\n  userAgent?: string;\r\n  timestamp?: Date;\r\n}\r\n\r\nexport class AuditLog extends Model<AuditLogAttributes> implements AuditLogAttributes {\r\n  public id!: number;\r\n  public userId?: number;\r\n  public action!: string;\r\n  public resource!: string;\r\n  public resourceId?: string;\r\n  public oldValues?: Record<string, unknown>;\r\n  public newValues?: Record<string, unknown>;\r\n  public ipAddress?: string;\r\n  public userAgent?: string;\r\n  public readonly timestamp!: Date;\r\n\r\n  // Model associations\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  public static associate(models: Record<string, any>) {\r\n    AuditLog.belongsTo(models.User, {\r\n      foreignKey: 'userId',\r\n      as: 'user'\r\n    });\r\n  }\r\n}\r\n\r\nexport const initAuditLogModel = (sequelize: Sequelize) => {\r\n  AuditLog.init(\r\n    {\r\n      id: {\r\n        type: DataTypes.INTEGER,\r\n        autoIncrement: true,\r\n        primaryKey: true,\r\n      },\r\n      userId: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: true,\r\n        references: {\r\n          model: 'Users',\r\n          key: 'id'\r\n        }\r\n      },\r\n      action: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: false,\r\n      },\r\n      resource: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: false,\r\n      },\r\n      resourceId: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: true,\r\n      },\r\n      oldValues: {\r\n        type: DataTypes.JSON,\r\n        allowNull: true,\r\n      },\r\n      newValues: {\r\n        type: DataTypes.JSON,\r\n        allowNull: true,\r\n      },\r\n      ipAddress: {\r\n        type: DataTypes.STRING(45),\r\n        allowNull: true,\r\n      },\r\n      userAgent: {\r\n        type: DataTypes.TEXT,\r\n        allowNull: true,\r\n      },\r\n      timestamp: {\r\n        type: DataTypes.DATE,\r\n        allowNull: false,\r\n        defaultValue: DataTypes.NOW,\r\n      }\r\n    },\r\n    {\r\n      sequelize,\r\n      modelName: 'AuditLog',\r\n      tableName: 'AuditLogs',\r\n      timestamps: false, // We use custom timestamp field\r\n      indexes: [\r\n        { fields: ['userId'] },\r\n        { fields: ['action'] },\r\n        { fields: ['resource'] },\r\n        { fields: ['resourceId'] },\r\n        { fields: ['timestamp'] },\r\n        { fields: ['ipAddress'] }\r\n      ]\r\n    }\r\n  );\r\n\r\n  return AuditLog;\r\n};\r\n\r\nexport default AuditLog;"],"names":[],"mappings":";;;;;;;;AAAA;;AAeO,MAAM,iBAAiB,qJAAK;IAC1B,GAAY;IACZ,OAAgB;IAChB,OAAgB;IAChB,SAAkB;IAClB,WAAoB;IACpB,UAAoC;IACpC,UAAoC;IACpC,UAAmB;IACnB,UAAmB;IACV,UAAiB;IAEjC,qBAAqB;IACrB,8DAA8D;IAC9D,OAAc,UAAU,MAA2B,EAAE;QACnD,SAAS,SAAS,CAAC,OAAO,IAAI,EAAE;YAC9B,YAAY;YACZ,IAAI;QACN;IACF;AACF;AAEO,MAAM,oBAAoB,CAAC;IAChC,SAAS,IAAI,CACX;QACE,IAAI;YACF,MAAM,yJAAS,CAAC,OAAO;YACvB,eAAe;YACf,YAAY;QACd;QACA,QAAQ;YACN,MAAM,yJAAS,CAAC,OAAO;YACvB,WAAW;YACX,YAAY;gBACV,OAAO;gBACP,KAAK;YACP;QACF;QACA,QAAQ;YACN,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,UAAU;YACR,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,YAAY;YACV,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;YACX,cAAc,yJAAS,CAAC,GAAG;QAC7B;IACF,GACA;QACE;QACA,WAAW;QACX,WAAW;QACX,YAAY;QACZ,SAAS;YACP;gBAAE,QAAQ;oBAAC;iBAAS;YAAC;YACrB;gBAAE,QAAQ;oBAAC;iBAAS;YAAC;YACrB;gBAAE,QAAQ;oBAAC;iBAAW;YAAC;YACvB;gBAAE,QAAQ;oBAAC;iBAAa;YAAC;YACzB;gBAAE,QAAQ;oBAAC;iBAAY;YAAC;YACxB;gBAAE,QAAQ;oBAAC;iBAAY;YAAC;SACzB;IACH;IAGF,OAAO;AACT;uCAEe","debugId":null}},
    {"offset": {"line": 783, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/models/Machine.ts"],"sourcesContent":["import { DataTypes, Model, Sequelize } from 'sequelize';\r\n\r\nexport interface MachineAttributes {\r\n  id?: number;\r\n  machineType: string;\r\n  description?: string;\r\n  isActive: boolean;\r\n}\r\n\r\nexport class Machine extends Model<MachineAttributes> implements MachineAttributes {\r\n  public id!: number;\r\n  public machineType!: string;\r\n  public description?: string;\r\n  public isActive!: boolean;\r\n}\r\n\r\nexport const initMachineModel = (sequelize: Sequelize) => {\r\n  Machine.init(\r\n    {\r\n      id: {\r\n        type: DataTypes.INTEGER,\r\n        autoIncrement: true,\r\n        primaryKey: true,\r\n      },\r\n      machineType: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: false,\r\n        unique: true,\r\n        field: 'machine_type',\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [1, 100]\r\n        },\r\n        comment: 'Machine type/model identifier'\r\n      },\r\n      description: {\r\n        type: DataTypes.TEXT,\r\n        allowNull: true,\r\n        comment: 'Optional description of the machine type'\r\n      },\r\n      isActive: {\r\n        type: DataTypes.BOOLEAN,\r\n        allowNull: false,\r\n        defaultValue: true,\r\n        field: 'is_active',\r\n        comment: 'Whether this machine type is active'\r\n      }\r\n    },\r\n    {\r\n      sequelize,\r\n      modelName: 'Machine',\r\n      tableName: 'machinetype',\r\n      timestamps: false,\r\n      indexes: [\r\n        {\r\n          unique: true,\r\n          fields: ['machine_type']\r\n        },\r\n        {\r\n          fields: ['is_active']\r\n        }\r\n      ]\r\n    }\r\n  );\r\n\r\n  return Machine;\r\n};\r\n\r\nexport default Machine;"],"names":[],"mappings":";;;;;;;;AAAA;;AASO,MAAM,gBAAgB,qJAAK;IACzB,GAAY;IACZ,YAAqB;IACrB,YAAqB;IACrB,SAAmB;AAC5B;AAEO,MAAM,mBAAmB,CAAC;IAC/B,QAAQ,IAAI,CACV;QACE,IAAI;YACF,MAAM,yJAAS,CAAC,OAAO;YACvB,eAAe;YACf,YAAY;QACd;QACA,aAAa;YACX,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,QAAQ;YACR,OAAO;YACP,UAAU;gBACR,UAAU;gBACV,KAAK;oBAAC;oBAAG;iBAAI;YACf;YACA,SAAS;QACX;QACA,aAAa;YACX,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;YACX,SAAS;QACX;QACA,UAAU;YACR,MAAM,yJAAS,CAAC,OAAO;YACvB,WAAW;YACX,cAAc;YACd,OAAO;YACP,SAAS;QACX;IACF,GACA;QACE;QACA,WAAW;QACX,WAAW;QACX,YAAY;QACZ,SAAS;YACP;gBACE,QAAQ;gBACR,QAAQ;oBAAC;iBAAe;YAC1B;YACA;gBACE,QAAQ;oBAAC;iBAAY;YACvB;SACD;IACH;IAGF,OAAO;AACT;uCAEe","debugId":null}},
    {"offset": {"line": 858, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/models/index.ts"],"sourcesContent":["import createSequelizeInstance from '@/lib/database';\r\nimport { initUserModel } from './User';\r\nimport { initAdminSchemaModel } from './AdminSchema';\r\nimport { initAuditLogModel } from './AuditLog';\r\nimport { initMachineModel } from './Machine';\r\n\r\n// Get models - lazy initialization\r\nexport const getModels = () => {\r\n  const sequelize = createSequelizeInstance();\r\n  if (!sequelize) {\r\n    throw new Error('Database not initialized');\r\n  }\r\n  \r\n  const User = initUserModel(sequelize);\r\n  const AdminSchema = initAdminSchemaModel(sequelize);\r\n  const AuditLog = initAuditLogModel(sequelize);\r\n  const Machine = initMachineModel(sequelize);\r\n  \r\n  // Set up associations\r\n  const models = { User, AdminSchema, AuditLog, Machine };\r\n  \r\n  // Initialize associations if they exist\r\n  type AssociateFn = (models: Record<string, unknown>) => void;\r\n  type ModelWithAssociate = { associate?: AssociateFn };\r\n  \r\n  if ((User as unknown as ModelWithAssociate).associate) {\r\n    (User as unknown as ModelWithAssociate).associate!(models);\r\n  }\r\n  if ((AdminSchema as unknown as ModelWithAssociate).associate) {\r\n    (AdminSchema as unknown as ModelWithAssociate).associate!(models);\r\n  }\r\n  if ((AuditLog as unknown as ModelWithAssociate).associate) {\r\n    (AuditLog as unknown as ModelWithAssociate).associate!(models);\r\n  }\r\n  \r\n  return {\r\n    User,\r\n    AdminSchema,\r\n    AuditLog,\r\n    Machine,\r\n    sequelize\r\n  };\r\n};\r\n\r\n// Export types\r\nexport * from './User';\r\nexport * from './Machine';"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAGO,MAAM,YAAY;IACvB,MAAM,YAAY,IAAA,mIAAuB;IACzC,IAAI,CAAC,WAAW;QACd,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,OAAO,IAAA,wIAAa,EAAC;IAC3B,MAAM,cAAc,IAAA,sJAAoB,EAAC;IACzC,MAAM,WAAW,IAAA,gJAAiB,EAAC;IACnC,MAAM,UAAU,IAAA,8IAAgB,EAAC;IAEjC,sBAAsB;IACtB,MAAM,SAAS;QAAE;QAAM;QAAa;QAAU;IAAQ;IAMtD,IAAI,AAAC,KAAuC,SAAS,EAAE;QACpD,KAAuC,SAAS,CAAE;IACrD;IACA,IAAI,AAAC,YAA8C,SAAS,EAAE;QAC3D,YAA8C,SAAS,CAAE;IAC5D;IACA,IAAI,AAAC,SAA2C,SAAS,EAAE;QACxD,SAA2C,SAAS,CAAE;IACzD;IAEA,OAAO;QACL;QACA;QACA;QACA;QACA;IACF;AACF","debugId":null}},
    {"offset": {"line": 935, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/emailService.ts"],"sourcesContent":["import nodemailer from 'nodemailer';\r\n\r\n// Email configuration\r\n// Support both SMTP_* (local) and EMAIL_* (production) environment variables\r\nconst emailConfig = {\r\n  host: process.env.SMTP_HOST || process.env.EMAIL_HOST || 'smtp.gmail.com',\r\n  port: parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || '587'),\r\n  secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true', // true for 465, false for other ports\r\n  auth: {\r\n    user: process.env.SMTP_USERNAME || process.env.EMAIL_USER,\r\n    pass: process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD,\r\n  },\r\n};\r\n\r\n// Create transporter\r\nconst transporter = nodemailer.createTransport(emailConfig);\r\n\r\n// Generate OTP\r\nexport const generateOTP = (): string => {\r\n  return Math.floor(100000 + Math.random() * 900000).toString();\r\n};\r\n\r\n// Send OTP email\r\nexport const sendOTPEmail = async (\r\n  email: string, \r\n  otp: string, \r\n  name: string\r\n): Promise<void> => {\r\n  // Debug logging\r\n  console.log('Email config debug:', {\r\n    to: email,\r\n    from: process.env.SMTP_USERNAME || process.env.EMAIL_USER,\r\n    host: process.env.SMTP_HOST || process.env.EMAIL_HOST,\r\n    port: process.env.SMTP_PORT || process.env.EMAIL_PORT,\r\n    hasPassword: !!(process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD),\r\n    secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true'\r\n  });\r\n\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'Email Verification - Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Email Verification</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Hello ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Thank you for registering with Poornasree Equipments Cloud. Please verify your email address using the OTP below:\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <div style=\"display: inline-block; padding: 15px 30px; background: #667eea; color: white; font-size: 24px; font-weight: bold; letter-spacing: 3px; border-radius: 8px;\">\r\n              ${otp}\r\n            </div>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            This OTP is valid for 10 minutes. If you didn't create an account, please ignore this email.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send welcome email\r\nexport const sendWelcomeEmail = async (\r\n  email: string, \r\n  name: string, \r\n  role: string\r\n): Promise<void> => {\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'Welcome to Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Welcome!</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Welcome ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Your account has been successfully verified and activated. You can now access the Poornasree Equipments Cloud platform with your ${role} account.\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${process.env.FRONTEND_URL}/login\" style=\"display: inline-block; padding: 12px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;\">\r\n              Login to Dashboard\r\n            </a>\r\n          </div>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send admin welcome email with dbKey\r\nexport const sendAdminWelcomeEmail = async (\r\n  email: string, \r\n  name: string, \r\n  dbKey: string\r\n): Promise<void> => {\r\n  const apiUrl = `http://lactosure.azurewebsites.net/api/${dbKey}`;\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'üéâ Admin Account Approved - Your Personal Database Access',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">üéâ Congratulations!</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Your Admin Account is Approved</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Welcome ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Congratulations! Your admin account has been approved by the Super Admin. Your personal database schema has been created and is ready for use.\r\n          </p>\r\n          \r\n          <div style=\"background: #fff; border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px 0;\">\r\n            <h3 style=\"color: #ef4444; margin-top: 0; font-size: 18px;\">üîí CONFIDENTIAL - Database Access Key</h3>\r\n            <p style=\"color: #666; margin-bottom: 15px;\">Your unique database access key:</p>\r\n            <div style=\"background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; padding: 15px; text-align: center; font-family: 'Courier New', monospace; font-size: 24px; font-weight: bold; color: #1f2937; letter-spacing: 3px;\">\r\n              ${dbKey}\r\n            </div>\r\n            <p style=\"color: #ef4444; font-weight: bold; margin-top: 15px; margin-bottom: 0;\">\r\n              ‚ö†Ô∏è KEEP THIS KEY STRICTLY CONFIDENTIAL AND SECURE\r\n            </p>\r\n          </div>\r\n          \r\n          <div style=\"background: #fff; border: 1px solid #d1d5db; border-radius: 8px; padding: 20px; margin: 20px 0;\">\r\n            <h3 style=\"color: #333; margin-top: 0;\">üåê Your Personal API Endpoint</h3>\r\n            <p style=\"color: #666; margin-bottom: 10px;\">Use this URL on your machine to access your database:</p>\r\n            <div style=\"background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; word-break: break-all; color: #1f2937;\">\r\n              ${apiUrl}\r\n            </div>\r\n            <p style=\"color: #ef4444; font-size: 14px; margin-top: 10px; margin-bottom: 0;\">\r\n              <strong>Important:</strong> Only enter this URL on your designated work machine. Do not share this URL with anyone.\r\n            </p>\r\n          </div>\r\n          \r\n          <div style=\"background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 20px 0;\">\r\n            <h4 style=\"color: #92400e; margin-top: 0; margin-bottom: 10px;\">üõ°Ô∏è Security Guidelines:</h4>\r\n            <ul style=\"color: #92400e; margin: 0; padding-left: 20px; line-height: 1.6;\">\r\n              <li>Never share your dbKey with anyone</li>\r\n              <li>Only access the API from secure, trusted machines</li>\r\n              <li>Log out completely when finished working</li>\r\n              <li>Report any suspicious activity immediately</li>\r\n              <li>Change your password regularly</li>\r\n            </ul>\r\n          </div>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${process.env.FRONTEND_URL}/adminpanel\" style=\"display: inline-block; padding: 15px 30px; background: #10b981; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px;\">\r\n              üöÄ Access Admin Dashboard\r\n            </a>\r\n          </div>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p><strong>Support:</strong> If you have any questions or issues, please contact our support team.</p>\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send password reset email\r\nexport const sendPasswordResetEmail = async (\r\n  email: string, \r\n  name: string, \r\n  resetToken: string\r\n): Promise<void> => {\r\n  const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: 'Password Reset - Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Password Reset</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Hello ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            You have requested to reset your password. Click the button below to set a new password:\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${resetUrl}\" style=\"display: inline-block; padding: 12px 30px; background: #dc3545; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;\">\r\n              Reset Password\r\n            </a>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6; font-size: 14px;\">\r\n            This link is valid for 1 hour. If you didn't request a password reset, please ignore this email.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send admin approval request to super admin\r\nexport const sendAdminApprovalRequest = async (\r\n  adminEmail: string,\r\n  adminName: string,\r\n  companyName: string\r\n): Promise<void> => {\r\n  const approvalUrl = `${process.env.CLIENT_URL}/adminpanel/dashboard#pending-approvals`;\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: process.env.SUPER_ADMIN_EMAIL || 'admin@poornasreeequipments.com',\r\n    subject: 'New Admin Registration - Approval Required',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Admin Approval Required</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">New Admin Registration</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            A new admin has completed email verification and is requesting account activation:\r\n          </p>\r\n          \r\n          <div style=\"background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc3545;\">\r\n            <h3 style=\"color: #dc3545; margin-top: 0;\">Admin Details:</h3>\r\n            <p style=\"margin: 5px 0;\"><strong>Name:</strong> ${adminName}</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Email:</strong> ${adminEmail}</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Company:</strong> ${companyName}</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Role:</strong> Admin</p>\r\n            <p style=\"margin: 5px 0;\"><strong>Status:</strong> <span style=\"color: #fd7e14;\">Pending Approval</span></p>\r\n          </div>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${approvalUrl}\" style=\"display: inline-block; padding: 15px 30px; background: #dc3545; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; margin-right: 10px;\">\r\n              Review & Approve\r\n            </a>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6; font-size: 14px; border-top: 1px solid #ddd; padding-top: 15px; margin-top: 25px;\">\r\n            <strong>Action Required:</strong> Please log in to the admin panel to review and approve/reject this admin registration request.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud System</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send admin rejection email\r\nexport const sendAdminRejectionEmail = async (\r\n  adminEmail: string,\r\n  adminName: string,\r\n  reason?: string\r\n): Promise<void> => {\r\n  const supportEmail = 'support@poornasreeequipments.com';\r\n  \r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: adminEmail,\r\n    subject: 'Admin Application Status - Poornasree Equipments Cloud',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #6c757d 0%, #495057 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">Poornasree Equipments Cloud</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Application Status Update</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #f8f9fa; border-radius: 10px;\">\r\n          <h2 style=\"color: #333; margin-top: 0;\">Hello ${adminName},</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            Thank you for your interest in joining Poornasree Equipments Cloud as an administrator.\r\n          </p>\r\n          \r\n          <div style=\"background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;\">\r\n            <h3 style=\"color: #856404; margin-top: 0;\">Application Status: Not Approved</h3>\r\n            <p style=\"color: #856404; margin-bottom: 0;\">\r\n              After careful review, we are unable to approve your admin application at this time.\r\n            </p>\r\n          </div>\r\n          \r\n          ${reason ? `\r\n          <div style=\"background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6;\">\r\n            <h4 style=\"color: #495057; margin-top: 0;\">Reason:</h4>\r\n            <p style=\"color: #666; margin-bottom: 0;\">${reason}</p>\r\n          </div>\r\n          ` : ''}\r\n          \r\n          <div style=\"background: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #0dcaf0;\">\r\n            <h4 style=\"color: #055160; margin-top: 0;\">What's Next?</h4>\r\n            <p style=\"color: #055160; margin-bottom: 10px;\">\r\n              If you believe this decision was made in error or if you have additional information to provide, \r\n              please don't hesitate to contact our support team.\r\n            </p>\r\n            <div style=\"text-align: center; margin-top: 20px;\">\r\n              <a href=\"mailto:${supportEmail}\" style=\"display: inline-block; padding: 12px 24px; background: #0dcaf0; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;\">\r\n                Contact Support\r\n              </a>\r\n            </div>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            We appreciate your understanding and thank you for your interest in our platform.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n};\r\n\r\n// Send milk collection notification email\r\nexport const sendMilkCollectionEmail = async (\r\n  email: string,\r\n  farmerName: string,\r\n  collectionDetails: {\r\n    farmerId: string;\r\n    societyName?: string;\r\n    collectionDate: string;\r\n    collectionTime: string;\r\n    shiftType: string;\r\n    channel: string;\r\n    quantity: number;\r\n    fatPercentage: number;\r\n    snfPercentage: number;\r\n    clrValue: number;\r\n    proteinPercentage: number;\r\n    lactosePercentage: number;\r\n    waterPercentage: number;\r\n    temperature: number;\r\n    ratePerLiter: number;\r\n    totalAmount: number;\r\n    bonus: number;\r\n  }\r\n): Promise<void> => {\r\n  const formattedDate = new Date(collectionDetails.collectionDate).toLocaleDateString('en-IN', {\r\n    weekday: 'long',\r\n    year: 'numeric',\r\n    month: 'long',\r\n    day: 'numeric'\r\n  });\r\n\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: `Milk Collection Receipt - ${collectionDetails.farmerId} - ${formattedDate}`,\r\n    html: `\r\n      <div style=\"max-width: 650px; margin: 0 auto; padding: 20px; font-family: 'Segoe UI', Arial, sans-serif; background-color: #f5f5f5;\">\r\n        <!-- Header -->\r\n        <div style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 12px 12px 0 0; color: white; text-align: center;\">\r\n          <h1 style=\"margin: 0; font-size: 28px; font-weight: 600;\">ü•õ Milk Collection Receipt</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.95; font-size: 16px;\">Poornasree Equipments Cloud</p>\r\n        </div>\r\n        \r\n        <!-- Body -->\r\n        <div style=\"background: white; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\r\n          <!-- Greeting -->\r\n          <div style=\"margin-bottom: 25px;\">\r\n            <h2 style=\"color: #1f2937; margin: 0 0 10px 0; font-size: 22px;\">Hello ${farmerName},</h2>\r\n            <p style=\"color: #6b7280; margin: 0; line-height: 1.6;\">\r\n              Your milk collection has been successfully recorded. Here are the details:\r\n            </p>\r\n          </div>\r\n\r\n          <!-- Collection Details Card -->\r\n          <div style=\"background: #f9fafb; border-left: 4px solid #10b981; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <h3 style=\"color: #059669; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;\">üìã Collection Information</h3>\r\n            \r\n            <table style=\"width: 100%; border-collapse: collapse;\">\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280; width: 45%;\">Farmer ID:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.farmerId}</td>\r\n              </tr>\r\n              ${collectionDetails.societyName ? `\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Society:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.societyName}</td>\r\n              </tr>\r\n              ` : ''}\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Date:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${formattedDate}</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Time:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.collectionTime}</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Shift:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">\r\n                  <span style=\"background: ${collectionDetails.shiftType === 'morning' ? '#fef3c7' : '#dbeafe'}; color: ${collectionDetails.shiftType === 'morning' ? '#92400e' : '#1e40af'}; padding: 4px 12px; border-radius: 12px; font-size: 14px;\">\r\n                    ${collectionDetails.shiftType === 'morning' ? 'üåÖ Morning' : 'üåÜ Evening'}\r\n                  </span>\r\n                </td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Milk Type:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.channel}</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n\r\n          <!-- Quality Parameters Card -->\r\n          <div style=\"background: #eff6ff; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <h3 style=\"color: #1e40af; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;\">üî¨ Quality Parameters</h3>\r\n            \r\n            <table style=\"width: 100%; border-collapse: collapse;\">\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280; width: 45%;\">Fat:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.fatPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">SNF:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.snfPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">CLR:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.clrValue.toFixed(2)}</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Protein:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.proteinPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Lactose:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.lactosePercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Water:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.waterPercentage.toFixed(2)}%</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; color: #6b7280;\">Temperature:</td>\r\n                <td style=\"padding: 8px 0; color: #1f2937; font-weight: 600;\">${collectionDetails.temperature.toFixed(2)}¬∞C</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n\r\n          <!-- Payment Details Card -->\r\n          <div style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;\">\r\n            <h3 style=\"margin: 0 0 15px 0; font-size: 18px; font-weight: 600;\">üí∞ Payment Details</h3>\r\n            \r\n            <table style=\"width: 100%; border-collapse: collapse;\">\r\n              <tr>\r\n                <td style=\"padding: 8px 0; opacity: 0.9; width: 45%;\">Quantity:</td>\r\n                <td style=\"padding: 8px 0; font-weight: 600; font-size: 16px;\">${collectionDetails.quantity.toFixed(2)} Liters</td>\r\n              </tr>\r\n              <tr>\r\n                <td style=\"padding: 8px 0; opacity: 0.9;\">Rate per Liter:</td>\r\n                <td style=\"padding: 8px 0; font-weight: 600; font-size: 16px;\">‚Çπ${collectionDetails.ratePerLiter.toFixed(2)}</td>\r\n              </tr>\r\n              ${collectionDetails.bonus > 0 ? `\r\n              <tr>\r\n                <td style=\"padding: 8px 0; opacity: 0.9;\">Bonus:</td>\r\n                <td style=\"padding: 8px 0; font-weight: 600; font-size: 16px;\">‚Çπ${collectionDetails.bonus.toFixed(2)}</td>\r\n              </tr>\r\n              ` : ''}\r\n              <tr style=\"border-top: 1px solid rgba(255,255,255,0.3);\">\r\n                <td style=\"padding: 12px 0; font-size: 18px; font-weight: 600;\">Total Amount:</td>\r\n                <td style=\"padding: 12px 0; font-size: 24px; font-weight: 700;\">‚Çπ${collectionDetails.totalAmount.toFixed(2)}</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n\r\n          <!-- Footer Note -->\r\n          <div style=\"background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <p style=\"margin: 0; color: #92400e; line-height: 1.6; font-size: 14px;\">\r\n              <strong>üìù Note:</strong> This is an automated notification for your milk collection. Please keep this email for your records. For any discrepancies, contact your society office within 24 hours.\r\n            </p>\r\n          </div>\r\n\r\n          <!-- Footer -->\r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center;\">\r\n            <p style=\"color: #6b7280; margin: 0 0 10px 0; font-size: 14px;\">\r\n              Thank you for your continued support!\r\n            </p>\r\n            <p style=\"color: #9ca3af; margin: 0; font-size: 12px;\">\r\n              Best regards,<br>\r\n              <strong>Poornasree Equipments Cloud Team</strong>\r\n            </p>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Disclaimer -->\r\n        <div style=\"margin-top: 20px; text-align: center;\">\r\n          <p style=\"color: #9ca3af; font-size: 11px; line-height: 1.4; margin: 0;\">\r\n            This is an automated email. Please do not reply to this email.<br>\r\n            ¬© ${new Date().getFullYear()} Poornasree Equipments Cloud. All rights reserved.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  try {\r\n    await transporter.sendMail(mailOptions);\r\n    console.log(`‚úÖ Collection email sent to ${email}`);\r\n  } catch (error) {\r\n    console.error(`‚ùå Failed to send collection email to ${email}:`, error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport default transporter;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1441, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/auth.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport crypto from 'crypto';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// JWT configuration\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-super-secret-jwt-key';\r\nconst JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || 'your-super-secret-refresh-jwt-key';\r\n\r\n// JWT payload interface\r\nexport interface JWTPayload {\r\n  id: number;\r\n  uid: string;\r\n  email: string;\r\n  role: UserRole;\r\n  dbKey?: string;\r\n}\r\n\r\n// Generate JWT tokens\r\nexport const generateTokens = (user: JWTPayload) => {\r\n  const payload = {\r\n    id: user.id,\r\n    uid: user.uid,\r\n    email: user.email,\r\n    role: user.role,\r\n    dbKey: user.dbKey\r\n  };\r\n\r\n  const token = jwt.sign(payload, JWT_SECRET as string, {\r\n    expiresIn: '7d',\r\n    issuer: 'poornasree-equipments-cloud',\r\n    audience: 'psr-client'\r\n  });\r\n\r\n  const refreshToken = jwt.sign(payload, JWT_REFRESH_SECRET as string, {\r\n    expiresIn: '30d',\r\n    issuer: 'poornasree-equipments-cloud',\r\n    audience: 'psr-client'\r\n  });\r\n\r\n  return { token, refreshToken };\r\n};\r\n\r\n// Verify JWT token\r\nexport const verifyToken = (token: string): JWTPayload | null => {\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET as string, {\r\n      issuer: 'poornasree-equipments-cloud',\r\n      audience: 'psr-client'\r\n    }) as JWTPayload;\r\n    return decoded;\r\n  } catch (error) {\r\n    console.error('JWT verification failed:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Verify refresh token\r\nexport const verifyRefreshToken = (token: string): JWTPayload | null => {\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_REFRESH_SECRET as string, {\r\n      issuer: 'poornasree-equipments-cloud',\r\n      audience: 'psr-client'\r\n    }) as JWTPayload;\r\n    return decoded;\r\n  } catch (error) {\r\n    console.error('Refresh token verification failed:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Generate random token\r\nexport const generateRandomToken = (length: number = 32): string => {\r\n  return crypto.randomBytes(length).toString('hex');\r\n};\r\n\r\n// Generate OTP\r\nexport const generateOTP = (length: number = 6): string => {\r\n  const digits = '0123456789';\r\n  let otp = '';\r\n  for (let i = 0; i < length; i++) {\r\n    otp += digits[Math.floor(Math.random() * digits.length)];\r\n  }\r\n  return otp;\r\n};\r\n\r\n// Hash token for database storage\r\nexport const hashToken = (token: string): string => {\r\n  return crypto.createHash('sha256').update(token).digest('hex');\r\n};\r\n\r\n// Role hierarchy checker\r\nexport const canManageRole = (userRole: UserRole, targetRole: UserRole): boolean => {\r\n  const roleHierarchy: Record<UserRole, number> = {\r\n    [UserRole.SUPER_ADMIN]: 0,\r\n    [UserRole.ADMIN]: 1,\r\n    [UserRole.DAIRY]: 2,\r\n    [UserRole.BMC]: 3,\r\n    [UserRole.SOCIETY]: 4,\r\n    [UserRole.FARMER]: 5\r\n  };\r\n\r\n  return roleHierarchy[userRole] < roleHierarchy[targetRole];\r\n};\r\n\r\n// Get allowed roles for user\r\nexport const getAllowedRoles = (userRole: UserRole): UserRole[] => {\r\n  const allRoles = [\r\n    UserRole.SUPER_ADMIN,\r\n    UserRole.ADMIN,\r\n    UserRole.DAIRY,\r\n    UserRole.BMC,\r\n    UserRole.SOCIETY,\r\n    UserRole.FARMER\r\n  ];\r\n\r\n  const roleHierarchy: Record<UserRole, number> = {\r\n    [UserRole.SUPER_ADMIN]: 0,\r\n    [UserRole.ADMIN]: 1,\r\n    [UserRole.DAIRY]: 2,\r\n    [UserRole.BMC]: 3,\r\n    [UserRole.SOCIETY]: 4,\r\n    [UserRole.FARMER]: 5\r\n  };\r\n\r\n  const userLevel = roleHierarchy[userRole];\r\n  return allRoles.filter(role => roleHierarchy[role] > userLevel);\r\n};\r\n\r\n// Check if user is super admin\r\nexport const isSuperAdmin = (user: { email?: string; role?: UserRole }): boolean => {\r\n  const superAdminEmail = process.env.SUPER_ADMIN_USERNAME || 'admin';\r\n  return (\r\n    user.email === superAdminEmail || \r\n    user.role === UserRole.SUPER_ADMIN\r\n  );\r\n};\r\n\r\n// Validate password strength\r\nexport const validatePassword = (password: string): { \r\n  isValid: boolean; \r\n  errors: string[] \r\n} => {\r\n  const errors: string[] = [];\r\n  \r\n  if (password.length < 8) {\r\n    errors.push('Password must be at least 8 characters long');\r\n  }\r\n  \r\n  if (!/[A-Z]/.test(password)) {\r\n    errors.push('Password must contain at least one uppercase letter');\r\n  }\r\n  \r\n  if (!/[a-z]/.test(password)) {\r\n    errors.push('Password must contain at least one lowercase letter');\r\n  }\r\n  \r\n  if (!/\\d/.test(password)) {\r\n    errors.push('Password must contain at least one number');\r\n  }\r\n  \r\n  if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\r\n    errors.push('Password must contain at least one special character');\r\n  }\r\n\r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors\r\n  };\r\n};\r\n\r\n// Generate secure session ID\r\nexport const generateSessionId = (): string => {\r\n  return crypto.randomBytes(64).toString('hex');\r\n};\r\n\r\nconst authUtils = {\r\n  generateTokens,\r\n  verifyToken,\r\n  verifyRefreshToken,\r\n  generateRandomToken,\r\n  generateOTP,\r\n  hashToken,\r\n  canManageRole,\r\n  getAllowedRoles,\r\n  isSuperAdmin,\r\n  validatePassword,\r\n  generateSessionId\r\n};\r\n\r\nexport default authUtils;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1615, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/middleware/auth.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyToken, JWTPayload } from '@/lib/auth';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// Types for authentication middleware\r\n\r\nexport interface AuthenticatedRequest extends NextRequest {\r\n  user?: JWTPayload;\r\n}\r\n\r\n// Authentication middleware\r\nexport const authenticateToken = (req: NextRequest): { \r\n  success: boolean; \r\n  user?: JWTPayload; \r\n  error?: string \r\n} => {\r\n  try {\r\n    const authHeader = req.headers.get('authorization');\r\n    const token = authHeader?.split(' ')[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return { success: false, error: 'Access token required' };\r\n    }\r\n\r\n    const decoded = verifyToken(token);\r\n    if (!decoded) {\r\n      return { success: false, error: 'Invalid or expired token' };\r\n    }\r\n\r\n    return { success: true, user: decoded };\r\n  } catch {\r\n    return { success: false, error: 'Authentication failed' };\r\n  }\r\n};\r\n\r\n// Role-based authorization middleware\r\nexport const authorizeRole = (requiredRoles: UserRole[]) => {\r\n  return (user: JWTPayload): { success: boolean; error?: string } => {\r\n    if (!user) {\r\n      return { success: false, error: 'User not authenticated' };\r\n    }\r\n\r\n    if (!requiredRoles.includes(user.role)) {\r\n      return { success: false, error: 'Insufficient permissions' };\r\n    }\r\n\r\n    return { success: true };\r\n  };\r\n};\r\n\r\n// Super Admin authorization\r\nexport const requireSuperAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  if (user.role !== UserRole.SUPER_ADMIN && user.email !== (process.env.SUPER_ADMIN_USERNAME || 'admin')) {\r\n    return { success: false, error: 'Super Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Admin or higher authorization\r\nexport const requireAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  const adminRoles = [UserRole.SUPER_ADMIN, UserRole.ADMIN];\r\n  if (!adminRoles.includes(user.role)) {\r\n    return { success: false, error: 'Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Hierarchy-based authorization\r\nexport const requireHierarchyAccess = (targetUserId: number, currentUser: JWTPayload): {\r\n  success: boolean; \r\n  error?: string \r\n} => {\r\n  // Super admin can access everything\r\n  if (currentUser.role === UserRole.SUPER_ADMIN) {\r\n    return { success: true };\r\n  }\r\n\r\n  // Admin can access users in their schema\r\n  if (currentUser.role === UserRole.ADMIN && currentUser.dbKey) {\r\n    // Additional logic would be needed to check if targetUser belongs to admin's schema\r\n    return { success: true };\r\n  }\r\n\r\n  // For other roles, implement specific hierarchy checks\r\n  // This would require database queries to verify parent-child relationships\r\n  \r\n  return { success: false, error: 'Access denied' };\r\n};\r\n\r\n// Response helpers\r\nexport const createErrorResponse = (message: string, status: number = 400) => {\r\n  return NextResponse.json(\r\n    { \r\n      success: false, \r\n      error: { message, code: status.toString() },\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\nexport const createSuccessResponse = (data: unknown, message: string = 'Success', status: number = 200) => {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      message,\r\n      data,\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\n// Validation helper\r\nexport const validateRequiredFields = (\r\n  body: Record<string, unknown>, \r\n  requiredFields: string[]\r\n): { success: boolean; missing?: string[] } => {\r\n  const missing = requiredFields.filter(field => \r\n    !body[field] || (typeof body[field] === 'string' && body[field].trim() === '')\r\n  );\r\n\r\n  if (missing.length > 0) {\r\n    return { success: false, missing };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Rate limiting (basic implementation)\r\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>();\r\n\r\nexport const checkRateLimit = (\r\n  identifier: string, \r\n  maxRequests: number = 100, \r\n  windowMs: number = 15 * 60 * 1000 // 15 minutes\r\n): { success: boolean; resetTime?: number } => {\r\n  const now = Date.now();\r\n  const record = rateLimitMap.get(identifier);\r\n\r\n  if (!record || now > record.resetTime) {\r\n    // Reset or create new record\r\n    rateLimitMap.set(identifier, { count: 1, resetTime: now + windowMs });\r\n    return { success: true };\r\n  }\r\n\r\n  if (record.count >= maxRequests) {\r\n    return { success: false, resetTime: record.resetTime };\r\n  }\r\n\r\n  record.count++;\r\n  return { success: true };\r\n};\r\n\r\n// CORS headers\r\nexport const setCorsHeaders = (response: NextResponse) => {\r\n  response.headers.set('Access-Control-Allow-Origin', process.env.CLIENT_URL || '*');\r\n  response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n  response.headers.set('Access-Control-Allow-Credentials', 'true');\r\n  return response;\r\n};\r\n\r\nconst middleware = {\r\n  authenticateToken,\r\n  authorizeRole,\r\n  requireSuperAdmin,\r\n  requireAdmin,\r\n  requireHierarchyAccess,\r\n  createErrorResponse,\r\n  createSuccessResponse,\r\n  validateRequiredFields,\r\n  checkRateLimit,\r\n  setCorsHeaders\r\n};\r\n\r\nexport default middleware;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1836, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/adminSchema.ts"],"sourcesContent":["import { connectDB } from '@/lib/database';\r\nimport { UserAttributes } from '@/models/User';\r\n\r\n/**\r\n * Generates a unique dbKey for an admin user\r\n * Format: 3 letters from name + 4 random digits\r\n */\r\nexport function generateDbKey(fullName: string): string {\r\n  // Extract first 3 letters from name (remove spaces, convert to uppercase)\r\n  const cleanName = fullName.replace(/[^a-zA-Z]/g, '').toUpperCase();\r\n  const namePrefix = cleanName.substring(0, 3).padEnd(3, 'X'); // Pad with X if less than 3 letters\r\n  \r\n  // Generate 4 random digits\r\n  const digits = Math.floor(1000 + Math.random() * 9000); // Ensures 4 digits\r\n  \r\n  return `${namePrefix}${digits}`;\r\n}\r\n\r\n/**\r\n * Checks if a dbKey already exists in the database\r\n */\r\nexport async function isDbKeyUnique(dbKey: string): Promise<boolean> {\r\n  try {\r\n    await connectDB();\r\n    const { User } = await import('@/models').then(m => m.getModels());\r\n    \r\n    const existingUser = await User.findOne({\r\n      where: { dbKey }\r\n    });\r\n    \r\n    return !existingUser;\r\n  } catch (error) {\r\n    console.error('Error checking dbKey uniqueness:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Generates a unique dbKey by retrying if duplicates are found\r\n */\r\nexport async function generateUniqueDbKey(fullName: string): Promise<string> {\r\n  let dbKey: string;\r\n  let attempts = 0;\r\n  const maxAttempts = 10;\r\n  \r\n  do {\r\n    dbKey = generateDbKey(fullName);\r\n    attempts++;\r\n    \r\n    if (attempts >= maxAttempts) {\r\n      throw new Error('Failed to generate unique dbKey after maximum attempts');\r\n    }\r\n  } while (!(await isDbKeyUnique(dbKey)));\r\n  \r\n  return dbKey;\r\n}\r\n\r\n/**\r\n * Creates a new database schema for an admin user\r\n */\r\nexport async function createAdminSchema(adminUser: UserAttributes, dbKey: string): Promise<void> {\r\n  try {\r\n    await connectDB();\r\n    \r\n    // Generate schema name: adminName + dbKey\r\n    const cleanAdminName = adminUser.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${dbKey.toLowerCase()}`;\r\n    \r\n    console.log(`üèóÔ∏è Creating schema: ${schemaName} for admin: ${adminUser.fullName}`);\r\n    \r\n    // Get the database connection\r\n    const { sequelize } = await import('@/models').then(m => m.getModels());\r\n    \r\n    // Create the schema\r\n    await sequelize.query(`CREATE SCHEMA IF NOT EXISTS \\`${schemaName}\\``);\r\n    \r\n    console.log(`‚úÖ Schema created successfully: ${schemaName}`);\r\n    \r\n    // Create tables in the new schema\r\n    // This includes creating admin-specific tables like:\r\n    // - dairy_farms\r\n    // - bmcs  \r\n    // - societies\r\n    // - farmers\r\n    // - milk_collections\r\n    // - machines\r\n    \r\n    await createAdminTables(schemaName);\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Error creating admin schema:', error);\r\n    throw new Error(`Failed to create schema for admin: ${error}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Creates the necessary tables in the admin's schema\r\n */\r\nasync function createAdminTables(schemaName: string): Promise<void> {\r\n  try {\r\n    const { sequelize } = await import('@/models').then(m => m.getModels());\r\n    \r\n    // Example table creation - customize based on your needs\r\n    const tables = [\r\n      // Dairy Farms table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`dairy_farms\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`name\\` VARCHAR(255) NOT NULL,\r\n        \\`dairy_id\\` VARCHAR(50) UNIQUE NOT NULL,\r\n        \\`password\\` VARCHAR(255) NOT NULL,\r\n        \\`location\\` VARCHAR(255),\r\n        \\`contact_person\\` VARCHAR(255),\r\n        \\`phone\\` VARCHAR(20),\r\n        \\`email\\` VARCHAR(255),\r\n        \\`capacity\\` INT DEFAULT 5000 COMMENT 'Storage capacity in liters',\r\n        \\`status\\` ENUM('active', 'inactive', 'maintenance', 'suspended') DEFAULT 'active',\r\n        \\`monthly_target\\` INT DEFAULT 5000 COMMENT 'Monthly production target in liters',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\r\n      )`,\r\n      \r\n      // BMCs (Bulk Milk Cooling Centers) table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`bmcs\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`name\\` VARCHAR(255) NOT NULL,\r\n        \\`bmc_id\\` VARCHAR(50) UNIQUE NOT NULL,\r\n        \\`password\\` VARCHAR(255) NOT NULL,\r\n        \\`location\\` VARCHAR(255),\r\n        \\`contactPerson\\` VARCHAR(255),\r\n        \\`phone\\` VARCHAR(20),\r\n        \\`email\\` VARCHAR(255),\r\n        \\`capacity\\` INT DEFAULT 10000 COMMENT 'Storage capacity in liters',\r\n        \\`status\\` ENUM('active', 'inactive', 'maintenance', 'suspended') DEFAULT 'active',\r\n        \\`monthly_target\\` DECIMAL(10,2) DEFAULT 10000 COMMENT 'Monthly collection target in liters',\r\n        \\`dairy_farm_id\\` INT,\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`dairy_farm_id\\`) REFERENCES \\`${schemaName}\\`.\\`dairy_farms\\`(\\`id\\`) ON DELETE SET NULL ON UPDATE CASCADE,\r\n        INDEX \\`idx_bmc_id\\` (\\`bmc_id\\`),\r\n        INDEX \\`idx_dairy_farm_id\\` (\\`dairy_farm_id\\`),\r\n        INDEX \\`idx_status\\` (\\`status\\`)\r\n      )`,\r\n      \r\n      // Societies table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`societies\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`name\\` VARCHAR(255) NOT NULL,\r\n        \\`society_id\\` VARCHAR(50) UNIQUE NOT NULL,\r\n        \\`password\\` VARCHAR(255) NOT NULL,\r\n        \\`location\\` VARCHAR(255),\r\n        \\`president_name\\` VARCHAR(255),\r\n        \\`contact_phone\\` VARCHAR(20),\r\n        \\`email\\` VARCHAR(255) NOT NULL,\r\n        \\`bmc_id\\` INT,\r\n        \\`status\\` ENUM('active', 'inactive', 'maintenance', 'suspended') DEFAULT 'active',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`bmc_id\\`) REFERENCES \\`${schemaName}\\`.\\`bmcs\\`(\\`id\\`),\r\n        UNIQUE KEY \\`unique_society_email\\` (\\`email\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_bmc_id\\` (\\`bmc_id\\`),\r\n        INDEX \\`idx_status\\` (\\`status\\`)\r\n      )`,\r\n      \r\n      // Machines table (MUST be created before farmers table due to FK constraint)\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`machines\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`machine_id\\` VARCHAR(50) NOT NULL,\r\n        \\`machine_type\\` VARCHAR(100) NOT NULL,\r\n        \\`society_id\\` INT,\r\n        \\`location\\` VARCHAR(255),\r\n        \\`installation_date\\` DATE,\r\n        \\`operator_name\\` VARCHAR(100),\r\n        \\`contact_phone\\` VARCHAR(15),\r\n        \\`status\\` ENUM('active', 'inactive', 'maintenance', 'suspended') DEFAULT 'active',\r\n        \\`notes\\` TEXT,\r\n        \\`is_master_machine\\` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'Master machine flag: 1 = master, 0 = normal',\r\n        \\`user_password\\` VARCHAR(255) COMMENT 'User password for external API access',\r\n        \\`supervisor_password\\` VARCHAR(255) COMMENT 'Supervisor password for external API access',\r\n        \\`statusU\\` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'User password status: 0 = not set, 1 = set',\r\n        \\`statusS\\` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'Supervisor password status: 0 = not set, 1 = set',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE SET NULL ON UPDATE CASCADE,\r\n        UNIQUE KEY \\`unique_machine_per_society\\` (\\`machine_id\\`, \\`society_id\\`),\r\n        INDEX \\`idx_machine_type\\` (\\`machine_type\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_status\\` (\\`status\\`),\r\n        INDEX \\`idx_is_master\\` (\\`is_master_machine\\`),\r\n        INDEX \\`idx_statusU\\` (\\`statusU\\`),\r\n        INDEX \\`idx_statusS\\` (\\`statusS\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`)\r\n      )`,\r\n      \r\n      // Farmers table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`farmers\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`name\\` VARCHAR(255) NOT NULL,\r\n        \\`farmer_id\\` VARCHAR(50) NOT NULL,\r\n        \\`rf_id\\` VARCHAR(50),\r\n        \\`phone\\` VARCHAR(20),\r\n        \\`email\\` VARCHAR(255),\r\n        \\`sms_enabled\\` ENUM('ON', 'OFF') DEFAULT 'OFF',\r\n        \\`email_notifications_enabled\\` ENUM('ON', 'OFF') DEFAULT 'ON',\r\n        \\`bonus\\` DECIMAL(10,2) DEFAULT 0.00,\r\n        \\`address\\` TEXT,\r\n        \\`bank_name\\` VARCHAR(100),\r\n        \\`bank_account_number\\` VARCHAR(50),\r\n        \\`ifsc_code\\` VARCHAR(15),\r\n        \\`status\\` ENUM('active', 'inactive', 'suspended', 'maintenance') DEFAULT 'active',\r\n        \\`notes\\` TEXT,\r\n        \\`password\\` VARCHAR(255),\r\n        \\`society_id\\` INT,\r\n        \\`machine_id\\` INT,\r\n        \\`cattle_count\\` INT,\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE SET NULL ON UPDATE CASCADE,\r\n        FOREIGN KEY (\\`machine_id\\`) REFERENCES \\`${schemaName}\\`.\\`machines\\`(\\`id\\`) ON DELETE SET NULL ON UPDATE CASCADE,\r\n        UNIQUE KEY \\`unique_farmer_per_society\\` (\\`farmer_id\\`, \\`society_id\\`),\r\n        UNIQUE KEY \\`unique_rf_id\\` (\\`rf_id\\`),\r\n        UNIQUE KEY \\`unique_email\\` (\\`email\\`),\r\n        INDEX \\`idx_farmer_id\\` (\\`farmer_id\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_machine_id\\` (\\`machine_id\\`),\r\n        INDEX \\`idx_status\\` (\\`status\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`)\r\n      )`,\r\n      \r\n      // Milk Collections table (updated for machine collection data)\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`milk_collections\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`farmer_id\\` VARCHAR(50),\r\n        \\`society_id\\` INT,\r\n        \\`machine_id\\` INT,\r\n        \\`collection_date\\` DATE,\r\n        \\`collection_time\\` TIME,\r\n        \\`shift_type\\` ENUM('morning', 'evening'),\r\n        \\`farmer_name\\` VARCHAR(255) DEFAULT NULL,\r\n        \\`channel\\` VARCHAR(50) DEFAULT 'COW',\r\n        \\`quantity\\` DECIMAL(10,2) DEFAULT 0,\r\n        \\`fat_percentage\\` DECIMAL(5,2),\r\n        \\`snf_percentage\\` DECIMAL(5,2),\r\n        \\`clr_value\\` DECIMAL(5,2) DEFAULT 0,\r\n        \\`protein_percentage\\` DECIMAL(5,2) DEFAULT 0,\r\n        \\`lactose_percentage\\` DECIMAL(5,2) DEFAULT 0,\r\n        \\`salt_percentage\\` DECIMAL(5,2) DEFAULT 0,\r\n        \\`water_percentage\\` DECIMAL(5,2) DEFAULT 0,\r\n        \\`temperature\\` DECIMAL(5,2) DEFAULT 0,\r\n        \\`rate_per_liter\\` DECIMAL(10,2),\r\n        \\`total_amount\\` DECIMAL(10,2),\r\n        \\`bonus\\` DECIMAL(10,2) DEFAULT 0,\r\n        \\`machine_type\\` VARCHAR(100),\r\n        \\`machine_version\\` VARCHAR(50),\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        INDEX \\`idx_farmer_id\\` (\\`farmer_id\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_machine_id\\` (\\`machine_id\\`),\r\n        INDEX \\`idx_collection_date\\` (\\`collection_date\\`),\r\n        INDEX \\`idx_collection_time\\` (\\`collection_time\\`),\r\n        INDEX \\`idx_shift_type\\` (\\`shift_type\\`),\r\n        INDEX \\`idx_channel\\` (\\`channel\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`),\r\n        UNIQUE KEY \\`unique_collection\\` (\\`farmer_id\\`, \\`society_id\\`, \\`machine_id\\`, \\`collection_date\\`, \\`collection_time\\`, \\`shift_type\\`)\r\n      )`,\r\n\r\n      // Milk Dispatches table (milk dispatch records from machines)\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`milk_dispatches\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`dispatch_id\\` VARCHAR(50) NOT NULL,\r\n        \\`society_id\\` INT NOT NULL,\r\n        \\`machine_id\\` INT NOT NULL,\r\n        \\`dispatch_date\\` DATE,\r\n        \\`dispatch_time\\` TIME,\r\n        \\`shift_type\\` ENUM('morning', 'evening') NOT NULL,\r\n        \\`channel\\` VARCHAR(50) DEFAULT 'COW',\r\n        \\`fat_percentage\\` DECIMAL(5,2),\r\n        \\`snf_percentage\\` DECIMAL(5,2),\r\n        \\`clr_value\\` DECIMAL(5,2) DEFAULT 0,\r\n        \\`quantity\\` DECIMAL(10,2) DEFAULT 0,\r\n        \\`rate_per_liter\\` DECIMAL(10,2),\r\n        \\`total_amount\\` DECIMAL(10,2),\r\n        \\`machine_type\\` VARCHAR(100),\r\n        \\`machine_version\\` VARCHAR(50),\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        INDEX \\`idx_dispatch_id\\` (\\`dispatch_id\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_machine_id\\` (\\`machine_id\\`),\r\n        INDEX \\`idx_dispatch_date\\` (\\`dispatch_date\\`),\r\n        INDEX \\`idx_dispatch_time\\` (\\`dispatch_time\\`),\r\n        INDEX \\`idx_shift_type\\` (\\`shift_type\\`),\r\n        INDEX \\`idx_channel\\` (\\`channel\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`),\r\n        UNIQUE KEY \\`unique_dispatch\\` (\\`dispatch_id\\`, \\`society_id\\`, \\`machine_id\\`, \\`dispatch_date\\`, \\`dispatch_time\\`, \\`shift_type\\`)\r\n      )`,\r\n\r\n      // Milk Sales table (milk sales records from machines)\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`milk_sales\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`count\\` VARCHAR(50) NOT NULL,\r\n        \\`society_id\\` INT NOT NULL,\r\n        \\`machine_id\\` INT NOT NULL,\r\n        \\`sales_date\\` DATE,\r\n        \\`sales_time\\` TIME,\r\n        \\`shift_type\\` VARCHAR(10) DEFAULT 'EV',\r\n        \\`channel\\` VARCHAR(50) DEFAULT 'COW',\r\n        \\`quantity\\` DECIMAL(10,2) DEFAULT 0,\r\n        \\`rate_per_liter\\` DECIMAL(10,2),\r\n        \\`total_amount\\` DECIMAL(10,2),\r\n        \\`machine_type\\` VARCHAR(100),\r\n        \\`machine_version\\` VARCHAR(50),\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        INDEX \\`idx_count\\` (\\`count\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_machine_id\\` (\\`machine_id\\`),\r\n        INDEX \\`idx_sales_date\\` (\\`sales_date\\`),\r\n        INDEX \\`idx_sales_time\\` (\\`sales_time\\`),\r\n        INDEX \\`idx_shift_type\\` (\\`shift_type\\`),\r\n        INDEX \\`idx_channel\\` (\\`channel\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`),\r\n        UNIQUE KEY \\`unique_sales\\` (\\`count\\`, \\`society_id\\`, \\`machine_id\\`, \\`sales_date\\`, \\`sales_time\\`)\r\n      )`,\r\n\r\n      // Machine Corrections table (Admin-saved corrections)\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`machine_corrections\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`machine_id\\` INT NOT NULL COMMENT 'Reference to machines table',\r\n        \\`society_id\\` INT NOT NULL COMMENT 'Reference to societies table',\r\n        \\`machine_type\\` VARCHAR(100) COMMENT 'Machine type/model for reference',\r\n        \\`channel1_fat\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 1 Fat value',\r\n        \\`channel1_snf\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 1 SNF (Solid Not Fat) value',\r\n        \\`channel1_clr\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 1 CLR value',\r\n        \\`channel1_temp\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 1 Temperature',\r\n        \\`channel1_water\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 1 Water content',\r\n        \\`channel1_protein\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 1 Protein value',\r\n        \\`channel2_fat\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 2 Fat value',\r\n        \\`channel2_snf\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 2 SNF (Solid Not Fat) value',\r\n        \\`channel2_clr\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 2 CLR value',\r\n        \\`channel2_temp\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 2 Temperature',\r\n        \\`channel2_water\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 2 Water content',\r\n        \\`channel2_protein\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 2 Protein value',\r\n        \\`channel3_fat\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 3 Fat value',\r\n        \\`channel3_snf\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 3 SNF (Solid Not Fat) value',\r\n        \\`channel3_clr\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 3 CLR value',\r\n        \\`channel3_temp\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 3 Temperature',\r\n        \\`channel3_water\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 3 Water content',\r\n        \\`channel3_protein\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Channel 3 Protein value',\r\n        \\`status\\` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Status: 1 = Active/Current, 0 = Inactive/Old',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        INDEX \\`idx_machine_id\\` (\\`machine_id\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_machine_type\\` (\\`machine_type\\`),\r\n        INDEX \\`idx_status\\` (\\`status\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`)\r\n      )`,\r\n\r\n      // Machine Corrections From Machine table (ESP32 device corrections)\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`machine_corrections_from_machine\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`machine_id\\` INT NOT NULL COMMENT 'Machine database ID',\r\n        \\`society_id\\` INT NOT NULL COMMENT 'Society database ID',\r\n        \\`machine_type\\` VARCHAR(50) DEFAULT NULL COMMENT 'Machine type',\r\n        \\`channel1_fat\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Fat correction for channel 1',\r\n        \\`channel1_snf\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'SNF correction for channel 1',\r\n        \\`channel1_clr\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'CLR correction for channel 1',\r\n        \\`channel1_temp\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Temperature correction for channel 1',\r\n        \\`channel1_water\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Water correction for channel 1',\r\n        \\`channel1_protein\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Protein correction for channel 1',\r\n        \\`channel2_fat\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Fat correction for channel 2',\r\n        \\`channel2_snf\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'SNF correction for channel 2',\r\n        \\`channel2_clr\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'CLR correction for channel 2',\r\n        \\`channel2_temp\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Temperature correction for channel 2',\r\n        \\`channel2_water\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Water correction for channel 2',\r\n        \\`channel2_protein\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Protein correction for channel 2',\r\n        \\`channel3_fat\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Fat correction for channel 3',\r\n        \\`channel3_snf\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'SNF correction for channel 3',\r\n        \\`channel3_clr\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'CLR correction for channel 3',\r\n        \\`channel3_temp\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Temperature correction for channel 3',\r\n        \\`channel3_water\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Water correction for channel 3',\r\n        \\`channel3_protein\\` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'Protein correction for channel 3',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'When correction was received from ESP32',\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Last update timestamp',\r\n        INDEX \\`idx_machine_id\\` (\\`machine_id\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`),\r\n        INDEX \\`idx_machine_society\\` (\\`machine_id\\`, \\`society_id\\`)\r\n      )`,\r\n\r\n      // Rate Charts table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`rate_charts\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`shared_chart_id\\` INT NULL COMMENT 'Reference to master rate chart for shared data',\r\n        \\`society_id\\` INT NOT NULL COMMENT 'Reference to societies table',\r\n        \\`channel\\` ENUM('COW', 'BUF', 'MIX') NOT NULL COMMENT 'Milk channel type',\r\n        \\`uploaded_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`uploaded_by\\` VARCHAR(255) NOT NULL COMMENT 'Admin user who uploaded',\r\n        \\`file_name\\` VARCHAR(255) NOT NULL COMMENT 'Original CSV file name',\r\n        \\`record_count\\` INT NOT NULL DEFAULT 0 COMMENT 'Number of rate records',\r\n        \\`status\\` TINYINT(1) DEFAULT 1 COMMENT '1=Active/Ready to download, 0=Downloaded by machine',\r\n        FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        UNIQUE KEY \\`unique_society_channel\\` (\\`society_id\\`, \\`channel\\`),\r\n        INDEX \\`idx_shared_chart_id\\` (\\`shared_chart_id\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_channel\\` (\\`channel\\`),\r\n        INDEX \\`idx_uploaded_at\\` (\\`uploaded_at\\`),\r\n        INDEX \\`idx_status\\` (\\`status\\`)\r\n      )`,\r\n\r\n      // Rate Chart Data table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`rate_chart_data\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`rate_chart_id\\` INT NOT NULL COMMENT 'Reference to rate_charts table',\r\n        \\`clr\\` DECIMAL(5,2) NOT NULL COMMENT 'Color/Degree value',\r\n        \\`fat\\` DECIMAL(5,2) NOT NULL COMMENT 'Fat percentage',\r\n        \\`snf\\` DECIMAL(5,2) NOT NULL COMMENT 'Solids-Not-Fat percentage',\r\n        \\`rate\\` DECIMAL(10,2) NOT NULL COMMENT 'Rate per liter',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`rate_chart_id\\`) REFERENCES \\`${schemaName}\\`.\\`rate_charts\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        INDEX \\`idx_rate_chart_id\\` (\\`rate_chart_id\\`),\r\n        INDEX \\`idx_clr_fat_snf\\` (\\`clr\\`, \\`fat\\`, \\`snf\\`)\r\n      )`,\r\n\r\n      // Rate Chart Download History table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`rate_chart_download_history\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`rate_chart_id\\` INT NOT NULL COMMENT 'Reference to rate_charts table',\r\n        \\`machine_id\\` INT NOT NULL COMMENT 'Reference to machines table',\r\n        \\`society_id\\` INT NOT NULL COMMENT 'Reference to societies table',\r\n        \\`channel\\` ENUM('COW', 'BUF', 'MIX') NOT NULL COMMENT 'Milk channel type',\r\n        \\`downloaded_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`rate_chart_id\\`) REFERENCES \\`${schemaName}\\`.\\`rate_charts\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        FOREIGN KEY (\\`machine_id\\`) REFERENCES \\`${schemaName}\\`.\\`machines\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        UNIQUE KEY \\`unique_machine_chart_channel\\` (\\`machine_id\\`, \\`rate_chart_id\\`, \\`channel\\`),\r\n        INDEX \\`idx_machine_society_channel\\` (\\`machine_id\\`, \\`society_id\\`, \\`channel\\`),\r\n        INDEX \\`idx_rate_chart_id\\` (\\`rate_chart_id\\`),\r\n        INDEX \\`idx_downloaded_at\\` (\\`downloaded_at\\`)\r\n      )`,\r\n\r\n      // Machine Statistics table\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`machine_statistics\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`machine_id\\` INT NOT NULL COMMENT 'Reference to machines table',\r\n        \\`society_id\\` INT NOT NULL COMMENT 'Reference to societies table',\r\n        \\`machine_type\\` VARCHAR(50) NOT NULL COMMENT 'Machine type',\r\n        \\`version\\` VARCHAR(20) NOT NULL COMMENT 'Machine version',\r\n        \\`total_test\\` INT DEFAULT 0 COMMENT 'Total tests (T parameter)',\r\n        \\`daily_cleaning\\` INT DEFAULT 0 COMMENT 'Daily cleaning count (D parameter)',\r\n        \\`weekly_cleaning\\` INT DEFAULT 0 COMMENT 'Weekly cleaning count (W parameter)',\r\n        \\`cleaning_skip\\` INT DEFAULT 0 COMMENT 'Cleaning skip count (S parameter)',\r\n        \\`gain\\` INT DEFAULT 0 COMMENT 'Gain value (G parameter)',\r\n        \\`auto_channel\\` VARCHAR(20) DEFAULT NULL COMMENT 'Auto channel status (ENABLE/DISABLE)',\r\n        \\`statistics_date\\` DATE NOT NULL COMMENT 'Date of statistics',\r\n        \\`statistics_time\\` TIME NOT NULL COMMENT 'Time of statistics',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`machine_id\\`) REFERENCES \\`${schemaName}\\`.\\`machines\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        INDEX \\`idx_machine_id\\` (\\`machine_id\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_statistics_date\\` (\\`statistics_date\\`),\r\n        INDEX \\`idx_created_at\\` (\\`created_at\\`)\r\n      )`,\r\n\r\n      // Section Pulse table (Tracks section start/end pulse and inactivity)\r\n      `CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`section_pulse\\` (\r\n        \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n        \\`society_id\\` INT NOT NULL,\r\n        \\`pulse_date\\` DATE NOT NULL,\r\n        \\`first_collection_time\\` DATETIME DEFAULT NULL COMMENT 'Section start pulse - first collection of the day',\r\n        \\`last_collection_time\\` DATETIME DEFAULT NULL COMMENT 'Last collection recorded',\r\n        \\`section_end_time\\` DATETIME DEFAULT NULL COMMENT 'Section end pulse - 60 min after last collection',\r\n        \\`pulse_status\\` ENUM('not_started', 'active', 'paused', 'ended', 'inactive') DEFAULT 'not_started' COMMENT 'Current pulse status',\r\n        \\`total_collections\\` INT DEFAULT 0 COMMENT 'Total collections for the day',\r\n        \\`total_farmers\\` INT DEFAULT 0 COMMENT 'Total registered farmers in society',\r\n        \\`present_farmers\\` INT DEFAULT 0 COMMENT 'Number of farmers who made collections',\r\n        \\`absent_farmers\\` INT DEFAULT 0 COMMENT 'Number of farmers who did not make collections',\r\n        \\`inactive_days\\` INT DEFAULT 0 COMMENT 'Number of consecutive days without pulse',\r\n        \\`last_checked\\` DATETIME DEFAULT NULL COMMENT 'Last time status was checked/updated',\r\n        \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n        FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE CASCADE ON UPDATE CASCADE,\r\n        UNIQUE KEY \\`unique_society_date\\` (\\`society_id\\`, \\`pulse_date\\`),\r\n        INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n        INDEX \\`idx_pulse_date\\` (\\`pulse_date\\`),\r\n        INDEX \\`idx_pulse_status\\` (\\`pulse_status\\`),\r\n        INDEX \\`idx_last_checked\\` (\\`last_checked\\`)\r\n      )`\r\n    ];\r\n    \r\n    // Execute table creation queries\r\n    for (const tableQuery of tables) {\r\n      await sequelize.query(tableQuery);\r\n    }\r\n    \r\n    console.log(`‚úÖ Admin tables created successfully in schema: ${schemaName}`);\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Error creating admin tables:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Updates existing admin schemas with the new farmers table structure\r\n */\r\nexport async function updateAdminSchemasWithFarmersTable(): Promise<void> {\r\n  try {\r\n    await connectDB();\r\n    const { sequelize, User } = await import('@/models').then(m => m.getModels());\r\n\r\n    // Get all admin users\r\n    const admins = await User.findAll({\r\n      where: { role: 'admin' },\r\n      attributes: ['id', 'fullName', 'dbKey']\r\n    });\r\n\r\n    console.log(`üîÑ Updating ${admins.length} admin schemas with new farmers table structure...`);\r\n\r\n    for (const admin of admins) {\r\n      if (!admin.dbKey) {\r\n        console.log(`‚ö†Ô∏è Skipping admin ${admin.fullName} - no dbKey`);\r\n        continue;\r\n      }\r\n\r\n      const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n      const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n      console.log(`üîß Updating farmers table in schema: ${schemaName}`);\r\n\r\n      // Check if schema exists\r\n      const [schemas] = await sequelize.query(`\r\n        SELECT SCHEMA_NAME \r\n        FROM INFORMATION_SCHEMA.SCHEMATA \r\n        WHERE SCHEMA_NAME = '${schemaName}'\r\n      `);\r\n\r\n      if (schemas.length === 0) {\r\n        console.log(`‚ö†Ô∏è Schema ${schemaName} does not exist, skipping...`);\r\n        continue;\r\n      }\r\n\r\n      // Check if old farmers table exists\r\n      const [existingTables] = await sequelize.query(`\r\n        SELECT TABLE_NAME, COLUMN_NAME\r\n        FROM INFORMATION_SCHEMA.COLUMNS \r\n        WHERE TABLE_SCHEMA = '${schemaName}' AND TABLE_NAME = 'farmers'\r\n      `);\r\n\r\n      if (existingTables.length === 0) {\r\n        // No farmers table exists, create new one\r\n        console.log(`üìù Creating new farmers table in schema: ${schemaName}`);\r\n        await sequelize.query(`\r\n          CREATE TABLE IF NOT EXISTS \\`${schemaName}\\`.\\`farmers\\` (\r\n            \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n            \\`name\\` VARCHAR(255) NOT NULL,\r\n            \\`farmer_id\\` VARCHAR(50) NOT NULL,\r\n            \\`rf_id\\` VARCHAR(50),\r\n            \\`phone\\` VARCHAR(20),\r\n            \\`sms_enabled\\` ENUM('ON', 'OFF') DEFAULT 'OFF',\r\n            \\`bonus\\` DECIMAL(10,2) DEFAULT 0.00,\r\n            \\`address\\` TEXT,\r\n            \\`bank_name\\` VARCHAR(100),\r\n            \\`bank_account_number\\` VARCHAR(50),\r\n            \\`ifsc_code\\` VARCHAR(15),\r\n            \\`status\\` ENUM('active', 'inactive', 'suspended', 'maintenance') DEFAULT 'active',\r\n            \\`notes\\` TEXT,\r\n            \\`password\\` VARCHAR(255),\r\n            \\`society_id\\` INT,\r\n            \\`cattle_count\\` INT,\r\n            \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n            \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n            FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE SET NULL ON UPDATE CASCADE,\r\n            UNIQUE KEY \\`unique_farmer_per_society\\` (\\`farmer_id\\`, \\`society_id\\`),\r\n            UNIQUE KEY \\`unique_rf_id\\` (\\`rf_id\\`),\r\n            INDEX \\`idx_farmer_id\\` (\\`farmer_id\\`),\r\n            INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n            INDEX \\`idx_status\\` (\\`status\\`),\r\n            INDEX \\`idx_created_at\\` (\\`created_at\\`)\r\n          )\r\n        `);\r\n      } else {\r\n        // Check if table has new structure\r\n        const columns = existingTables as Array<{ COLUMN_NAME: string }>;\r\n        const hasPassword = columns.some(col => col.COLUMN_NAME === 'password');\r\n        const hasRfId = columns.some(col => col.COLUMN_NAME === 'rf_id');\r\n        \r\n        if (!hasPassword || !hasRfId) {\r\n          console.log(`üîÑ Migrating existing farmers table in schema: ${schemaName}`);\r\n          \r\n          // Backup existing data\r\n          const [existingData] = await sequelize.query(`\r\n            SELECT * FROM \\`${schemaName}\\`.\\`farmers\\`\r\n          `);\r\n          \r\n          // Drop and recreate table with new structure\r\n          await sequelize.query(`DROP TABLE \\`${schemaName}\\`.\\`farmers\\``);\r\n          \r\n          await sequelize.query(`\r\n            CREATE TABLE \\`${schemaName}\\`.\\`farmers\\` (\r\n              \\`id\\` INT PRIMARY KEY AUTO_INCREMENT,\r\n              \\`name\\` VARCHAR(255) NOT NULL,\r\n              \\`farmer_id\\` VARCHAR(50) NOT NULL,\r\n              \\`rf_id\\` VARCHAR(50),\r\n              \\`phone\\` VARCHAR(20),\r\n              \\`sms_enabled\\` ENUM('ON', 'OFF') DEFAULT 'OFF',\r\n              \\`bonus\\` DECIMAL(10,2) DEFAULT 0.00,\r\n              \\`address\\` TEXT,\r\n              \\`bank_name\\` VARCHAR(100),\r\n              \\`bank_account_number\\` VARCHAR(50),\r\n              \\`ifsc_code\\` VARCHAR(15),\r\n              \\`status\\` ENUM('active', 'inactive', 'suspended', 'maintenance') DEFAULT 'active',\r\n              \\`notes\\` TEXT,\r\n              \\`password\\` VARCHAR(255),\r\n              \\`society_id\\` INT,\r\n              \\`cattle_count\\` INT,\r\n              \\`created_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n              \\`updated_at\\` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n              FOREIGN KEY (\\`society_id\\`) REFERENCES \\`${schemaName}\\`.\\`societies\\`(\\`id\\`) ON DELETE SET NULL ON UPDATE CASCADE,\r\n              UNIQUE KEY \\`unique_farmer_per_society\\` (\\`farmer_id\\`, \\`society_id\\`),\r\n              UNIQUE KEY \\`unique_rf_id\\` (\\`rf_id\\`),\r\n              INDEX \\`idx_farmer_id\\` (\\`farmer_id\\`),\r\n              INDEX \\`idx_society_id\\` (\\`society_id\\`),\r\n              INDEX \\`idx_status\\` (\\`status\\`),\r\n              INDEX \\`idx_created_at\\` (\\`created_at\\`)\r\n            )\r\n          `);\r\n          \r\n          // Restore data with mapping to new structure\r\n          for (const row of existingData as Array<Record<string, unknown>>) {\r\n            await sequelize.query(`\r\n              INSERT INTO \\`${schemaName}\\`.\\`farmers\\` \r\n              (\\`farmer_id\\`, \\`name\\`, \\`phone\\`, \\`address\\`, \\`society_id\\`, \\`status\\`, \\`created_at\\`)\r\n              VALUES (?, ?, ?, ?, ?, 'active', ?)\r\n            `, {\r\n              replacements: [\r\n                row.farmer_id || `FARMER_${row.id}`,\r\n                row.name || row.farmer_name || 'Unknown Farmer',\r\n                row.phone || row.contact_number,\r\n                row.address,\r\n                row.society_id,\r\n                row.created_at\r\n              ]\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      console.log(`‚úÖ Farmers table updated successfully in schema: ${schemaName}`);\r\n    }\r\n\r\n    console.log('üéâ All admin schemas updated with new farmers table structure!');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error updating admin schemas:', error);\r\n    throw error;\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2448, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/superadmin/approvals/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { getModels } from '@/models';\r\nimport { sendAdminRejectionEmail, sendAdminWelcomeEmail } from '@/lib/emailService';\r\nimport { createErrorResponse, createSuccessResponse, validateRequiredFields } from '@/middleware/auth';\r\nimport { connectDB } from '@/lib/database';\r\nimport { UserStatus } from '@/models/User';\r\nimport { generateUniqueDbKey, createAdminSchema } from '@/lib/adminSchema';\r\n\r\n// Get pending admin approvals\r\nexport async function GET() {\r\n  try {\r\n    await connectDB();\r\n    const { User } = getModels();\r\n\r\n    // Get all pending admin approvals\r\n    const pendingAdmins = await User.findAll({\r\n      where: {\r\n        role: 'admin',\r\n        status: UserStatus.PENDING_APPROVAL,\r\n        isEmailVerified: true\r\n      },\r\n      attributes: [\r\n        'id', 'uid', 'email', 'fullName', 'companyName', \r\n        'companyPincode', 'companyCity', 'companyState', \r\n        'createdAt', 'updatedAt'\r\n      ],\r\n      order: [['createdAt', 'DESC']]\r\n    });\r\n\r\n    return createSuccessResponse(\r\n      pendingAdmins,\r\n      'Pending admin approvals retrieved successfully'\r\n    );\r\n\r\n  } catch (error: unknown) {\r\n    console.error('Get pending approvals error:', error);\r\n    return createErrorResponse('Failed to retrieve pending approvals', 500);\r\n  }\r\n}\r\n\r\n// Approve or reject admin\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    await connectDB();\r\n    const { User } = getModels();\r\n    \r\n    const body = await request.json();\r\n    const { adminId, action, reason } = body; // action: 'approve' or 'reject'\r\n\r\n    // Validate required fields\r\n    const validation = validateRequiredFields(body, ['adminId', 'action']);\r\n    if (!validation.success) {\r\n      const missingFields = validation.missing?.join(', ') || 'Required fields missing';\r\n      return createErrorResponse(`Missing required fields: ${missingFields}`, 400);\r\n    }\r\n\r\n    if (!['approve', 'reject'].includes(action)) {\r\n      return createErrorResponse('Invalid action. Must be \"approve\" or \"reject\"', 400);\r\n    }\r\n\r\n    // Find the admin user\r\n    const adminUser = await User.findOne({\r\n      where: {\r\n        id: adminId,\r\n        role: 'admin',\r\n        status: UserStatus.PENDING_APPROVAL,\r\n        isEmailVerified: true\r\n      }\r\n    });\r\n\r\n    if (!adminUser) {\r\n      return createErrorResponse('Admin user not found or not pending approval', 404);\r\n    }\r\n\r\n    if (action === 'approve') {\r\n      // Generate unique dbKey for the admin\r\n      const dbKey = await generateUniqueDbKey(adminUser.fullName);\r\n      \r\n      // Update admin with dbKey and activate account\r\n      await adminUser.update({\r\n        status: UserStatus.ACTIVE,\r\n        dbKey: dbKey\r\n      });\r\n\r\n      console.log(`üîë Generated dbKey for ${adminUser.fullName}: ${dbKey}`);\r\n\r\n      // Create dedicated schema for the admin\r\n      try {\r\n        await createAdminSchema(adminUser.toJSON(), dbKey);\r\n        console.log(`‚úÖ Schema created successfully for admin: ${adminUser.fullName}`);\r\n      } catch (schemaError) {\r\n        console.error('‚ùå Failed to create admin schema:', schemaError);\r\n        // Rollback the approval if schema creation fails\r\n        await adminUser.update({\r\n          status: UserStatus.PENDING_APPROVAL,\r\n          dbKey: undefined\r\n        });\r\n        return createErrorResponse('Failed to create admin database schema. Please try again.', 500);\r\n      }\r\n\r\n      // Send welcome email with dbKey\r\n      try {\r\n        await sendAdminWelcomeEmail(\r\n          adminUser.email,\r\n          adminUser.fullName,\r\n          dbKey\r\n        );\r\n        console.log('‚úÖ Admin welcome email with dbKey sent successfully');\r\n      } catch (emailError) {\r\n        console.error('‚ö†Ô∏è Failed to send admin welcome email:', emailError);\r\n        // Don't rollback approval just for email failure, but log it\r\n      }\r\n\r\n      // Return success response\r\n      const userResponse = {\r\n        id: adminUser.id,\r\n        uid: adminUser.uid,\r\n        fullName: adminUser.fullName,\r\n        email: adminUser.email,\r\n        role: adminUser.role,\r\n        status: adminUser.status,\r\n        companyName: adminUser.companyName\r\n      };\r\n\r\n      return createSuccessResponse(\r\n        'Admin account approved successfully',\r\n        JSON.stringify(userResponse)\r\n      );\r\n\r\n    } else {\r\n      // Reject the admin\r\n      await adminUser.update({\r\n        status: UserStatus.INACTIVE\r\n      });\r\n\r\n      // Send rejection email with reason\r\n      try {\r\n        await sendAdminRejectionEmail(\r\n          adminUser.email,\r\n          adminUser.fullName,\r\n          reason // Optional rejection reason\r\n        );\r\n        console.log('‚úÖ Rejection email sent to admin');\r\n      } catch (emailError) {\r\n        console.error('‚ö†Ô∏è Failed to send rejection email:', emailError);\r\n      }\r\n      \r\n      return createSuccessResponse(\r\n        'Admin account rejected successfully',\r\n        JSON.stringify({ id: adminUser.id, status: 'rejected', reason })\r\n      );\r\n    }\r\n\r\n  } catch (error: unknown) {\r\n    console.error('Admin approval error:', error);\r\n    return createErrorResponse('Failed to process admin approval', 500);\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}