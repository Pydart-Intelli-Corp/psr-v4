{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/database.ts"],"sourcesContent":["import { Sequelize } from 'sequelize';\r\nimport mysql2 from 'mysql2';\r\nimport path from 'path';\r\n\r\n// Database configuration for Azure MySQL\r\nlet sequelize: Sequelize | null = null;\r\n\r\nconst createSequelizeInstance = () => {\r\n    if (!sequelize) {\r\n    // Don't initialize during build time\r\n    if (process.env.NODE_ENV === 'development' || process.env.BUILDING !== 'true') {\r\n      // Determine SSL configuration based on environment\r\n      // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n      const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n        require: true,\r\n        rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n        ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n      } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n        require: true,\r\n        rejectUnauthorized: false,\r\n      } : false;      sequelize = new Sequelize(\r\n      process.env.DB_NAME || 'psr_v4_main',\r\n      process.env.DB_USER || 'psr_admin',\r\n      process.env.DB_PASSWORD || 'Access@404',\r\n      {\r\n        host: process.env.DB_HOST || 'localhost',\r\n        port: parseInt(process.env.DB_PORT || '3306'),\r\n        dialect: 'mysql',\r\n        dialectModule: mysql2,\r\n        timezone: '+05:30', // Use Indian Standard Time (IST)\r\n        dialectOptions: {\r\n          ssl: sslConfig,\r\n          connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        },\r\n        pool: {\r\n          max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n          min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n          acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n          idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n        },\r\n        logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n        benchmark: process.env.NODE_ENV === 'development',\r\n      }\r\n    );\r\n    }\r\n  }\r\n  return sequelize;\r\n};\r\n\r\n// Test database connection\r\nexport const testConnection = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    await db.authenticate();\r\n    console.log('‚úÖ Database connection established successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Unable to connect to the database:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Initialize database\r\nexport const initDatabase = async (useMigrations: boolean = false) => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    \r\n    if (useMigrations) {\r\n      // Use migrations instead of sync for production\r\n      const { migrationRunner } = await import('./migrations');\r\n      await migrationRunner.initializeDatabase();\r\n    } else {\r\n      // Development mode - use sync\r\n      await db.sync({ alter: process.env.NODE_ENV === 'development' });\r\n    }\r\n    \r\n    console.log('‚úÖ Database synchronized successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Database synchronization failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Connect to database\r\nexport const connectDB = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.authenticate();\r\n    return db;\r\n  } catch (error) {\r\n    console.error('‚ùå Database connection failed:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to create admin-specific schema\r\nexport const createAdminSchema = async (adminEmail: string): Promise<string> => {\r\n  try {\r\n    // Generate DB key: db-<first 3 letters of email><3 random numbers>\r\n    const emailPrefix = adminEmail.substring(0, 3).toLowerCase();\r\n    const randomSuffix = Math.floor(100 + Math.random() * 900).toString();\r\n    const dbKey = `db_${emailPrefix}${randomSuffix}`;\r\n    \r\n    // Create new database schema\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.query(`CREATE DATABASE IF NOT EXISTS \\`${dbKey}\\``);\r\n    \r\n    console.log(`‚úÖ Created admin schema: ${dbKey}`);\r\n    return dbKey;\r\n  } catch (error) {\r\n    console.error('‚ùå Failed to create admin schema:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to get connection for specific admin schema\r\nexport const getAdminConnection = (dbKey: string): Sequelize => {\r\n  // Determine SSL configuration based on environment\r\n  // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n  const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n    require: true,\r\n    rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n    ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n  } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n    require: true,\r\n    rejectUnauthorized: false,\r\n  } : false;\r\n\r\n  return new Sequelize(\r\n    dbKey,\r\n    process.env.DB_USER || 'psr_admin',\r\n    process.env.DB_PASSWORD || '',\r\n    {\r\n      host: process.env.DB_HOST || 'localhost',\r\n      port: parseInt(process.env.DB_PORT || '3306'),\r\n      dialect: 'mysql',\r\n      dialectModule: mysql2,\r\n      dialectOptions: {\r\n        ssl: sslConfig,\r\n        connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        acquireTimeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n        timeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n      },\r\n      pool: {\r\n        max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n        min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n        acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n      },\r\n      logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n    }\r\n  );\r\n};\r\n\r\nexport default createSequelizeInstance;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 302, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/BaseExternalAPI.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\n\r\n/**\r\n * Base input structure for all external API endpoints\r\n */\r\nexport interface BaseInputParts {\r\n  societyId: string;\r\n  machineType: string;\r\n  version: string;\r\n  machineId: string;\r\n}\r\n\r\n/**\r\n * Validation result interface\r\n */\r\nexport interface ValidationResult {\r\n  isValid: boolean;\r\n  error?: string;\r\n  parsedSocietyId?: string;\r\n  parsedMachineId?: number;\r\n}\r\n\r\n/**\r\n * Configuration interface for external API endpoints\r\n */\r\nexport interface ExternalAPIConfig {\r\n  endpointName: string;\r\n  requiresExactPartCount?: boolean;\r\n  expectedPartCounts: number[];\r\n  filterLineEndings: boolean;\r\n  standardErrorMessage: string;\r\n}\r\n\r\n/**\r\n * Abstract base class for external API endpoints following InputString pattern\r\n */\r\nexport abstract class BaseExternalAPI<TInput extends BaseInputParts, TResult> {\r\n  protected config: ExternalAPIConfig;\r\n\r\n  constructor(config: ExternalAPIConfig) {\r\n    this.config = config;\r\n  }\r\n\r\n  /**\r\n   * Parse InputString into typed input structure\r\n   */\r\n  abstract parseInput(inputString: string): TInput | null;\r\n\r\n  /**\r\n   * Validate parsed input parts\r\n   */\r\n  abstract validateInput(input: TInput, dbKey: string): Promise<ValidationResult>;\r\n\r\n  /**\r\n   * Execute the main business logic\r\n   */\r\n  abstract executeBusinessLogic(input: TInput, schemaName: string, sequelize: unknown): Promise<TResult>;\r\n\r\n  /**\r\n   * Format the result into response string\r\n   */\r\n  abstract formatResponse(result: TResult): string;\r\n\r\n  /**\r\n   * Get error message for this endpoint\r\n   */\r\n  getErrorMessage(): string {\r\n    return this.config.standardErrorMessage;\r\n  }\r\n\r\n  /**\r\n   * Main request handler - implements common flow\r\n   */\r\n  async handleRequest(\r\n    request: NextRequest,\r\n    { params }: { params: Promise<Record<string, string>> }\r\n  ): Promise<Response> {\r\n    try {\r\n      // Step 1: Extract InputString from GET/POST\r\n      let inputString = await this.extractInputString(request);\r\n      \r\n      // Step 2: Resolve dynamic params\r\n      const resolvedParams = await params;\r\n      const dbKey = resolvedParams['db-key'] || resolvedParams.dbKey || resolvedParams['dbkey'];\r\n\r\n      this.logRequest(request, dbKey, inputString);\r\n\r\n      // Step 3: Filter line endings if configured\r\n      if (this.config.filterLineEndings && inputString) {\r\n        inputString = this.filterLineEndings(inputString);\r\n      }\r\n\r\n      // Step 4: Basic validation\r\n      if (!this.validateBasicInputs(dbKey, inputString)) {\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 5: Parse InputString\r\n      const parsedInput = this.parseInput(inputString!);\r\n      if (!parsedInput) {\r\n        console.log(`‚ùå ${this.config.endpointName}: Failed to parse InputString: \"${inputString}\"`);\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 6: Connect to database and validate\r\n      const { sequelize, schemaName } = await this.connectAndValidate(dbKey);\r\n      if (!sequelize || !schemaName) {\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 7: Validate parsed input\r\n      const validation = await this.validateInput(parsedInput, dbKey);\r\n      if (!validation.isValid) {\r\n        console.log(`‚ùå ${this.config.endpointName}: Input validation failed: ${validation.error}`);\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 8: Execute business logic\r\n      const result = await this.executeBusinessLogic(parsedInput, schemaName, sequelize);\r\n\r\n      // Step 9: Format and return response\r\n      const formattedResponse = this.formatResponse(result);\r\n      return this.successResponse(formattedResponse);\r\n\r\n    } catch (error) {\r\n      console.error(`‚ùå Error in ${this.config.endpointName} API:`, error);\r\n      return this.errorResponse();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Extract InputString from request (GET query param or POST body)\r\n   */\r\n  private async extractInputString(request: NextRequest): Promise<string | null> {\r\n    let inputString: string | null = null;\r\n    \r\n    if (request.method === 'GET') {\r\n      const { searchParams } = new URL(request.url);\r\n      inputString = searchParams.get('InputString');\r\n    } else if (request.method === 'POST') {\r\n      try {\r\n        const body = await request.json();\r\n        inputString = body.InputString || null;\r\n      } catch (error) {\r\n        try {\r\n          const formData = await request.formData();\r\n          inputString = formData.get('InputString') as string || null;\r\n        } catch {\r\n          console.log(`‚ùå Failed to parse POST body:`, error);\r\n        }\r\n      }\r\n    }\r\n    \r\n    return inputString;\r\n  }\r\n\r\n  /**\r\n   * Filter line ending characters from InputString\r\n   */\r\n  private filterLineEndings(inputString: string): string {\r\n    const originalInputString = inputString;\r\n    \r\n    // Remove common line ending patterns: $0D (CR), $0A (LF), $0D$0A (CRLF)\r\n    const filtered = inputString\r\n      .replace(/\\$0D\\$0A/g, '')  // Remove $0D$0A (CRLF)\r\n      .replace(/\\$0D/g, '')      // Remove $0D (CR) \r\n      .replace(/\\$0A/g, '')      // Remove $0A (LF)\r\n      .replace(/\\r\\n/g, '')      // Remove actual CRLF characters\r\n      .replace(/\\r/g, '')        // Remove actual CR characters\r\n      .replace(/\\n/g, '');       // Remove actual LF characters\r\n    \r\n    if (originalInputString !== filtered) {\r\n      console.log(`üßπ ${this.config.endpointName}: Filtered line endings: \"${originalInputString}\" -> \"${filtered}\"`);\r\n    }\r\n    \r\n    return filtered;\r\n  }\r\n\r\n  /**\r\n   * Basic input validation\r\n   */\r\n  private validateBasicInputs(dbKey: string, inputString: string | null): boolean {\r\n    if (!dbKey || dbKey.trim() === '') {\r\n      console.log(`‚ùå ${this.config.endpointName}: DB Key validation failed - dbKey: \"${dbKey}\"`);\r\n      return false;\r\n    }\r\n\r\n    if (!inputString) {\r\n      console.log(`‚ùå ${this.config.endpointName}: InputString is required`);\r\n      return false;\r\n    }\r\n\r\n    // Validate InputString part count\r\n    const parts = inputString.split('|');\r\n    if (!this.config.expectedPartCounts.includes(parts.length)) {\r\n      console.log(`‚ùå ${this.config.endpointName}: Invalid InputString part count. Expected: ${this.config.expectedPartCounts.join(' or ')}, Got: ${parts.length}`);\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Connect to database and get admin schema\r\n   */\r\n  private async connectAndValidate(dbKey: string): Promise<{ sequelize: unknown, schemaName: string | null }> {\r\n    try {\r\n      const { connectDB } = await import('@/lib/database');\r\n      await connectDB();\r\n      \r\n      const { getModels } = await import('@/models');\r\n      const { sequelize, User } = getModels();\r\n\r\n      // Find admin by dbKey to get schema name\r\n      const admin = await User.findOne({ \r\n        where: { dbKey: dbKey.toUpperCase() } \r\n      });\r\n\r\n      if (!admin || !admin.dbKey) {\r\n        console.log(`‚ùå ${this.config.endpointName}: Admin not found or missing DB Key for: ${dbKey}`);\r\n        return { sequelize: null, schemaName: null };\r\n      }\r\n\r\n      // Generate admin-specific schema name\r\n      const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n      const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n      console.log(`‚úÖ ${this.config.endpointName}: Using schema: ${schemaName}`);\r\n      \r\n      return { sequelize, schemaName };\r\n    } catch (error) {\r\n      console.error(`‚ùå ${this.config.endpointName}: Database connection failed:`, error);\r\n      return { sequelize: null, schemaName: null };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log request details\r\n   */\r\n  private logRequest(request: NextRequest, dbKey: string, inputString: string | null): void {\r\n    console.log(`üîç ${this.config.endpointName} External API Request - Full URL: ${request.url}`);\r\n    console.log(`üîç DB Key: \"${dbKey}\", InputString: \"${inputString}\"`);\r\n    console.log(`üîç DB Key type: ${typeof dbKey}, length: ${dbKey?.length}`);\r\n  }\r\n\r\n  /**\r\n   * Create success response\r\n   */\r\n  protected successResponse(data: string, additionalHeaders?: Record<string, string>): Response {\r\n    return new Response(`\"${data}\"`, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'text/plain',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n        ...additionalHeaders\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create error response\r\n   */\r\n  protected errorResponse(): Response {\r\n    return new Response(`\"${this.getErrorMessage()}\"`, {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'text/plain' }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle OPTIONS request for CORS\r\n   */\r\n  async handleOptions(): Promise<Response> {\r\n    return new Response(null, {\r\n      status: 200,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n      },\r\n    });\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 503, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/InputValidator.ts"],"sourcesContent":["/**\r\n * Utility class for validating and parsing InputString components\r\n */\r\nexport class InputValidator {\r\n  /**\r\n   * Validate and parse society ID (handles S- prefix format)\r\n   */\r\n  static validateSocietyId(societyIdStr: string): { \r\n    isValid: boolean; \r\n    id: string; \r\n    fallback: string; \r\n    numericId?: number;\r\n    error?: string;\r\n  } {\r\n    if (!societyIdStr || (typeof societyIdStr === 'string' && societyIdStr.trim() === '')) {\r\n      return {\r\n        isValid: false,\r\n        id: societyIdStr,\r\n        fallback: societyIdStr,\r\n        error: 'Society ID cannot be empty'\r\n      };\r\n    }\r\n\r\n    // Preserve original format for database lookup\r\n    const id = societyIdStr;\r\n    \r\n    // Extract fallback ID (remove S- prefix if present)\r\n    let fallback = societyIdStr;\r\n    if (societyIdStr.startsWith('S-')) {\r\n      fallback = societyIdStr.substring(2);\r\n    }\r\n\r\n    // Try to parse numeric ID for fallback matching\r\n    let numericId: number | undefined;\r\n    const numericPart = parseInt(fallback);\r\n    if (!isNaN(numericPart)) {\r\n      numericId = numericPart;\r\n    }\r\n\r\n    return {\r\n      isValid: true,\r\n      id,\r\n      fallback,\r\n      numericId\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validate and parse machine ID (handles M prefix format with optional letter)\r\n   * \r\n   * Supports multiple formats:\r\n   * - M00001 -> 1 (numeric)\r\n   * - Mm00001 -> m1 (alphanumeric with letter)\r\n   * - Ma00005 -> a5 (alphanumeric with letter)\r\n   * - M0000df -> df (fully alphanumeric)\r\n   * \r\n   * @param machineId - Machine ID with M prefix\r\n   * @returns Validation result with parsed IDs and variants\r\n   */\r\n  static validateMachineId(machineId: string): {\r\n    isValid: boolean;\r\n    numericId?: number;\r\n    alphanumericId?: string;\r\n    withoutPrefix?: string;\r\n    strippedId?: string;\r\n    variants?: (string | number)[];\r\n    isNumeric?: boolean;\r\n    error?: string;\r\n  } {\r\n    if (!machineId || machineId.trim() === '') {\r\n      return {\r\n        isValid: false,\r\n        error: 'Machine ID is required but not provided'\r\n      };\r\n    }\r\n\r\n    // Validate machine ID format (must start with M)\r\n    if (!machineId.startsWith('M') || machineId.length < 2) {\r\n      return {\r\n        isValid: false,\r\n        error: `Invalid machine ID format: \"${machineId}\"`\r\n      };\r\n    }\r\n\r\n    // Remove first 'M' prefix and extract actual machine ID\r\n    // Format: M + optional_letter + numbers\r\n    // Examples: Mm00001 -> m00001, M00001 -> 00001, Ma00005 -> a00005\r\n    const withoutPrefix = machineId.substring(1);\r\n    \r\n    // Validate that remaining part is alphanumeric\r\n    if (!/^[a-zA-Z0-9]+$/.test(withoutPrefix)) {\r\n      return {\r\n        isValid: false,\r\n        error: `Invalid machine ID format: \"${machineId}\" - contains invalid characters`\r\n      };\r\n    }\r\n    \r\n    let processedId: string;\r\n    let isNumeric = false;\r\n    let numericId: number | undefined;\r\n    let alphanumericId: string | undefined;\r\n    \r\n    // Check if withoutPrefix contains any letters\r\n    const hasLetters = /[a-zA-Z]/.test(withoutPrefix);\r\n    \r\n    if (hasLetters) {\r\n      // Contains letters - treat as alphanumeric\r\n      // Examples: m00001, 000m1, 0000df, abc123\r\n      const strippedId = withoutPrefix.replace(/^0+/, '') || withoutPrefix;\r\n      \r\n      // Check if it starts with a letter after removing zeros\r\n      if (/^[a-zA-Z]/.test(strippedId)) {\r\n        const letter = strippedId.charAt(0).toLowerCase();\r\n        const remainingPart = strippedId.substring(1);\r\n        \r\n        // Check if remaining part is numeric\r\n        if (/^\\d+$/.test(remainingPart)) {\r\n          // Letter + numbers: m00001 -> m1, 000m1 -> m1\r\n          const cleanedNumber = remainingPart.replace(/^0+/, '') || '0';\r\n          processedId = letter + cleanedNumber;\r\n          alphanumericId = processedId;\r\n        } else {\r\n          // Mixed alphanumeric: df, abc123\r\n          processedId = strippedId;\r\n          alphanumericId = processedId;\r\n        }\r\n      } else {\r\n        // Starts with number but has letters: should not happen after strip\r\n        processedId = strippedId;\r\n        alphanumericId = processedId;\r\n      }\r\n    } else {\r\n      // No letter, just numbers (e.g., 00001 -> 1)\r\n      processedId = withoutPrefix.replace(/^0+/, '') || '0';\r\n      const parsed = parseInt(processedId);\r\n      \r\n      if (!isNaN(parsed) && parsed > 0) {\r\n        isNumeric = true;\r\n        numericId = parsed;\r\n      } else {\r\n        return {\r\n          isValid: false,\r\n          error: `Invalid machine ID: \"${machineId}\" - invalid numeric format`\r\n        };\r\n      }\r\n    }\r\n\r\n    console.log(`üîÑ Machine ID conversion: \"${machineId}\" -> \"${withoutPrefix}\" -> \"${processedId}\"`);\r\n\r\n    // Create variants for flexible database matching\r\n    const variants: (string | number)[] = [];\r\n    \r\n    if (isNumeric && numericId) {\r\n      // Numeric ID variants\r\n      variants.push(numericId);           // Numeric: 1\r\n      variants.push(machineId);           // Original: M00001\r\n      variants.push(withoutPrefix);       // Without M: 00001\r\n      variants.push(processedId);         // Stripped: 1\r\n      variants.push(String(numericId));   // String numeric: \"1\"\r\n    } else if (alphanumericId) {\r\n      // Alphanumeric ID variants\r\n      variants.push(alphanumericId);      // Processed: m1, df\r\n      variants.push(withoutPrefix);       // Without M: m00001, 0000df\r\n      \r\n      // Add stripped version if different\r\n      const strippedVersion = withoutPrefix.replace(/^0+/, '');\r\n      if (strippedVersion && strippedVersion !== alphanumericId && strippedVersion !== withoutPrefix) {\r\n        variants.push(strippedVersion);\r\n      }\r\n    }\r\n\r\n    return {\r\n      isValid: true,\r\n      numericId,\r\n      alphanumericId,\r\n      withoutPrefix,\r\n      strippedId: processedId,\r\n      variants,\r\n      isNumeric\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validate DB Key format\r\n   */\r\n  static validateDbKey(dbKey: string): { isValid: boolean; error?: string } {\r\n    if (!dbKey || dbKey.trim() === '') {\r\n      return {\r\n        isValid: false,\r\n        error: 'DB Key is required'\r\n      };\r\n    }\r\n\r\n    // Add additional DB key format validation if needed\r\n    if (dbKey.length < 2) {\r\n      return {\r\n        isValid: false,\r\n        error: 'DB Key must be at least 2 characters'\r\n      };\r\n    }\r\n\r\n    return { isValid: true };\r\n  }\r\n\r\n  /**\r\n   * Validate machine model/type (basic validation)\r\n   */\r\n  static validateMachineModel(machineModel: string): { \r\n    isValid: boolean; \r\n    warning?: string; \r\n  } {\r\n    if (!machineModel || machineModel.trim() === '') {\r\n      return {\r\n        isValid: true, // Not blocking for now\r\n        warning: `Machine model is empty: \"${machineModel}\"`\r\n      };\r\n    }\r\n\r\n    return { isValid: true };\r\n  }\r\n\r\n  /**\r\n   * Validate password type for machine password endpoints\r\n   */\r\n  static validatePasswordType(passwordType: string): {\r\n    isValid: boolean;\r\n    isUser: boolean;\r\n    isSupervisor: boolean;\r\n    error?: string;\r\n  } {\r\n    if (!passwordType) {\r\n      return {\r\n        isValid: false,\r\n        isUser: false,\r\n        isSupervisor: false,\r\n        error: 'Password type is required'\r\n      };\r\n    }\r\n\r\n    // Accept both full formats (U$0D, S$0D) and short formats (U, S)\r\n    const isUser = passwordType.startsWith('U');\r\n    const isSupervisor = passwordType.startsWith('S');\r\n\r\n    if (!isUser && !isSupervisor) {\r\n      return {\r\n        isValid: false,\r\n        isUser: false,\r\n        isSupervisor: false,\r\n        error: `Invalid password type: \"${passwordType}\"`\r\n      };\r\n    }\r\n\r\n    return {\r\n      isValid: true,\r\n      isUser,\r\n      isSupervisor\r\n    };\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 717, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/QueryBuilder.ts"],"sourcesContent":["/**\r\n * Utility class for building database queries for external APIs\r\n */\r\nexport class QueryBuilder {\r\n  /**\r\n   * Build society filter conditions for WHERE clause\r\n   */\r\n  static buildSocietyFilter(\r\n    societyId: string, \r\n    fallbackId: string, \r\n    numericId?: number\r\n  ): {\r\n    condition: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    // Support multiple society ID formats:\r\n    // 1. String matching (s.society_id = 'S-s12')\r\n    // 2. Fallback string matching (s.society_id = 's12') \r\n    // 3. Numeric matching (m.society_id = 12)\r\n    \r\n    const condition = '(s.society_id = ? OR s.society_id = ? OR m.society_id = ?)';\r\n    const societyIdNumeric = numericId || fallbackId;\r\n    \r\n    return {\r\n      condition,\r\n      replacements: [societyId, fallbackId, societyIdNumeric]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Build machine filter conditions for WHERE clause\r\n   * Supports both numeric and alphanumeric machine IDs\r\n   * \r\n   * @param machineValidation - Result from InputValidator.validateMachineId()\r\n   * @param useNumericId - Whether to use numeric ID (m.id) or string ID (m.machine_id)\r\n   */\r\n  static buildMachineFilter(\r\n    machineValidation: {\r\n      numericId?: number;\r\n      alphanumericId?: string;\r\n      variants?: (string | number)[];\r\n      isNumeric?: boolean;\r\n    },\r\n    useNumericId: boolean = true\r\n  ): {\r\n    condition: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    // For numeric machine IDs (backward compatibility)\r\n    if (machineValidation.isNumeric && machineValidation.numericId && useNumericId) {\r\n      // Direct numeric ID matching: m.id = 1\r\n      return {\r\n        condition: 'm.id = ?',\r\n        replacements: [machineValidation.numericId]\r\n      };\r\n    }\r\n    \r\n    // For alphanumeric machine IDs or string-based matching\r\n    if (machineValidation.variants && machineValidation.variants.length > 0) {\r\n      // Use IN clause with all variants\r\n      const placeholders = machineValidation.variants.map(() => '?').join(', ');\r\n      \r\n      return {\r\n        condition: `m.machine_id IN (${placeholders})`,\r\n        replacements: machineValidation.variants\r\n      };\r\n    }\r\n\r\n    // Fallback to direct alphanumeric matching\r\n    if (machineValidation.alphanumericId) {\r\n      return {\r\n        condition: 'm.machine_id = ?',\r\n        replacements: [machineValidation.alphanumericId]\r\n      };\r\n    }\r\n\r\n    // Final fallback - should not reach here if validation passed\r\n    throw new Error('Invalid machine validation result for query building');\r\n  }\r\n\r\n  /**\r\n   * Build base query with schema, table, and joins\r\n   */\r\n  static buildBaseQuery(schemaName: string, tableName: string): string {\r\n    const escapedSchema = QueryBuilder.escapeIdentifier(schemaName);\r\n    \r\n    if (tableName === 'farmers') {\r\n      return `\r\n        FROM ${escapedSchema}.farmers f\r\n        LEFT JOIN ${escapedSchema}.societies s ON f.society_id = s.id\r\n        LEFT JOIN ${escapedSchema}.machines m ON f.machine_id = m.id\r\n      `;\r\n    } else if (tableName === 'machines') {\r\n      return `\r\n        FROM ${escapedSchema}.machines m\r\n        LEFT JOIN ${escapedSchema}.societies s ON m.society_id = s.id\r\n      `;\r\n    } else {\r\n      throw new Error(`Unsupported table name: ${tableName}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build complete SELECT query for farmer info\r\n   */\r\n  static buildFarmerQuery(\r\n    schemaName: string,\r\n    societyFilter: ReturnType<typeof QueryBuilder.buildSocietyFilter>,\r\n    machineFilter: ReturnType<typeof QueryBuilder.buildMachineFilter>,\r\n    pagination?: { limit: number; offset: number }\r\n  ): {\r\n    query: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    const baseQuery = QueryBuilder.buildBaseQuery(schemaName, 'farmers');\r\n    \r\n    let query = `\r\n      SELECT \r\n        f.id, \r\n        f.farmer_id,\r\n        f.rf_id, \r\n        f.name, \r\n        f.phone, \r\n        f.sms_enabled, \r\n        f.bonus\r\n      ${baseQuery}\r\n      WHERE ${societyFilter.condition}\r\n        AND f.status = 'active'\r\n        AND ${machineFilter.condition}\r\n      ORDER BY f.farmer_id\r\n    `;\r\n\r\n    let replacements = [\r\n      ...societyFilter.replacements,\r\n      ...machineFilter.replacements\r\n    ];\r\n\r\n    if (pagination) {\r\n      query += ' LIMIT ? OFFSET ?';\r\n      replacements = [...replacements, pagination.limit, pagination.offset];\r\n    }\r\n\r\n    return { query, replacements };\r\n  }\r\n\r\n  /**\r\n   * Build complete SELECT query for machine password\r\n   */\r\n  static buildMachinePasswordQuery(\r\n    schemaName: string,\r\n    societyFilter: ReturnType<typeof QueryBuilder.buildSocietyFilter>,\r\n    machineFilter: ReturnType<typeof QueryBuilder.buildMachineFilter>\r\n  ): {\r\n    query: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    const baseQuery = QueryBuilder.buildBaseQuery(schemaName, 'machines');\r\n    \r\n    const query = `\r\n      SELECT \r\n        m.id, \r\n        m.machine_id, \r\n        m.user_password, \r\n        m.supervisor_password, \r\n        m.statusU, \r\n        m.statusS,\r\n        s.society_id as society_string_id\r\n      ${baseQuery}\r\n      WHERE ${societyFilter.condition}\r\n        AND ${machineFilter.condition}\r\n        AND m.status = 'active'\r\n    `;\r\n\r\n    const replacements = [\r\n      ...societyFilter.replacements,\r\n      ...machineFilter.replacements\r\n    ];\r\n\r\n    return { query, replacements };\r\n  }\r\n\r\n  /**\r\n   * Build society lookup query to get database ID from society_id string\r\n   */\r\n  static buildSocietyLookupQuery(\r\n    schemaName: string,\r\n    societyIdStr: string\r\n  ): {\r\n    query: string;\r\n    replacements: string[];\r\n  } {\r\n    const escapedSchema = QueryBuilder.escapeIdentifier(schemaName);\r\n    \r\n    // Try both with and without S- prefix\r\n    const lookupParams = societyIdStr.startsWith('S-') \r\n      ? [societyIdStr, societyIdStr.substring(2)]\r\n      : [`S-${societyIdStr}`, societyIdStr];\r\n    \r\n    const query = `\r\n      SELECT id FROM ${escapedSchema}.societies \r\n      WHERE society_id = ? OR society_id = ?\r\n      LIMIT 1\r\n    `;\r\n\r\n    return {\r\n      query,\r\n      replacements: lookupParams\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Safely escape database identifiers (schema/table names)\r\n   */\r\n  static escapeIdentifier(identifier: string): string {\r\n    // Remove any non-alphanumeric characters except underscores\r\n    const cleaned = identifier.replace(/[^a-zA-Z0-9_]/g, '');\r\n    return `\\`${cleaned}\\``;\r\n  }\r\n\r\n  /**\r\n   * Build pagination parameters\r\n   */\r\n  static buildPagination(pageNumber: number, pageSize: number = 5): {\r\n    limit: number;\r\n    offset: number;\r\n    pageNumber: number;\r\n  } {\r\n    const normalizedPageNumber = Math.max(1, pageNumber);\r\n    const offset = (normalizedPageNumber - 1) * pageSize;\r\n    \r\n    return {\r\n      limit: pageSize,\r\n      offset,\r\n      pageNumber: normalizedPageNumber\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Extract page number from C parameter format (C00001 = page 1, C00002 = page 2)\r\n   */\r\n  static parsePageNumber(lengthParam: string): number {\r\n    if (!lengthParam || !lengthParam.startsWith('C')) {\r\n      return 1;\r\n    }\r\n    \r\n    const pageNumber = parseInt(lengthParam.replace(/^C0*/, '')) || 1;\r\n    return Math.max(1, pageNumber);\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 916, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/ResponseFormatter.ts"],"sourcesContent":["/**\r\n * Response formatting utilities for external APIs\r\n */\r\nexport class ResponseFormatter {\r\n  /**\r\n   * Format farmer data for CSV download\r\n   */\r\n  static formatFarmerCSV(farmers: Array<{\r\n    id: number;\r\n    farmer_id: string;\r\n    name: string;\r\n    phone: string | null;\r\n    sms_enabled: 'ON' | 'OFF' | null;\r\n    bonus: number | null;\r\n  }>): string {\r\n    const csvHeader = 'ID,RF-ID,NAME,MOBILE,SMS,BONUS\\n';\r\n    \r\n    const csvData = farmers.map(farmer => {\r\n      const phone = farmer.phone || '';\r\n      const smsEnabled = farmer.sms_enabled || 'OFF';\r\n      \r\n      // Convert bonus to number and format without decimal places (matching sample format)\r\n      let bonus = '0';\r\n      if (farmer.bonus !== null && farmer.bonus !== undefined) {\r\n        const bonusNum = Number(farmer.bonus);\r\n        bonus = isNaN(bonusNum) ? '0' : Math.round(bonusNum).toString();\r\n      }\r\n      \r\n      // Escape CSV values that contain commas or quotes\r\n      const escapeCsv = (value: string) => {\r\n        if (value.includes(',') || value.includes('\"')) {\r\n          return `\"${value.replace(/\"/g, '\"\"')}\"`;\r\n        }\r\n        return value;\r\n      };\r\n      \r\n      return `${farmer.id},${escapeCsv(farmer.farmer_id)},${escapeCsv(farmer.name)},${escapeCsv(phone)},${smsEnabled},${bonus}`;\r\n    }).join('\\n');\r\n\r\n    return csvHeader + csvData;\r\n  }\r\n\r\n  /**\r\n   * Format farmer data for pagination response (pipe-delimited)\r\n   */\r\n  static formatFarmerPagination(farmers: Array<{\r\n    id: number;\r\n    farmer_id: string;\r\n    name: string;\r\n    phone: string | null;\r\n    sms_enabled: 'ON' | 'OFF' | null;\r\n    bonus: number | null;\r\n  }>): string {\r\n    // Format: id|farmer_id|name|phone|sms_enabled|bonus||\r\n    // Each farmer separated by ||, fields separated by |\r\n    const responseData = farmers.map(farmer => {\r\n      const phone = farmer.phone || '';\r\n      const smsEnabled = farmer.sms_enabled || 'OFF';\r\n      \r\n      // Convert bonus to number and format with 2 decimal places\r\n      let bonus = '0.00';\r\n      if (farmer.bonus !== null && farmer.bonus !== undefined) {\r\n        const bonusNum = Number(farmer.bonus);\r\n        bonus = isNaN(bonusNum) ? '0.00' : bonusNum.toFixed(2);\r\n      }\r\n      \r\n      return `${farmer.id}|${farmer.farmer_id}|${farmer.name}|${phone}|${smsEnabled}|${bonus}`;\r\n    }).join('||');\r\n\r\n    return responseData;\r\n  }\r\n\r\n  /**\r\n   * Format machine password response\r\n   */\r\n  static formatMachinePassword(\r\n    passwordType: { isUser: boolean; isSupervisor: boolean },\r\n    password: string\r\n  ): string {\r\n    if (passwordType.isUser) {\r\n      return `PU|${password}`;\r\n    } else if (passwordType.isSupervisor) {\r\n      return `PS|${password}`;\r\n    }\r\n    \r\n    throw new Error('Invalid password type for formatting');\r\n  }\r\n\r\n  /**\r\n   * Create standard success response with proper headers\r\n   */\r\n  static createSuccessResponse(\r\n    data: string, \r\n    contentType: 'text/plain' | 'text/csv' = 'text/plain',\r\n    additionalHeaders?: Record<string, string>\r\n  ): Response {\r\n    const headers: Record<string, string> = {\r\n      'Content-Type': contentType,\r\n      'Access-Control-Allow-Origin': '*',\r\n      'Access-Control-Allow-Methods': 'GET, POST',\r\n      'Access-Control-Allow-Headers': 'Content-Type',\r\n      ...additionalHeaders\r\n    };\r\n\r\n    // Add CSV-specific headers\r\n    if (contentType === 'text/csv') {\r\n      headers['Content-Disposition'] = 'attachment; filename=\"FarmerDetails.csv\"';\r\n    }\r\n\r\n    return new Response(`\"${data}\"`, {\r\n      status: 200,\r\n      headers\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create standard error response\r\n   */\r\n  static createErrorResponse(errorMessage: string): Response {\r\n    return new Response(`\"${errorMessage}\"`, {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'text/plain' }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create CORS preflight response\r\n   */\r\n  static createCORSResponse(): Response {\r\n    return new Response(null, {\r\n      status: 200,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Wrap response data in quotes (external API standard)\r\n   */\r\n  static wrapInQuotes(data: string): string {\r\n    return `\"${data}\"`;\r\n  }\r\n\r\n  /**\r\n   * Log response details for debugging\r\n   */\r\n  static logResponse(\r\n    endpointName: string,\r\n    dataType: string,\r\n    itemCount: number,\r\n    responsePreview?: string\r\n  ): void {\r\n    console.log(`üì§ ${endpointName}: Returning ${dataType} for ${itemCount} items`);\r\n    \r\n    if (responsePreview) {\r\n      const preview = responsePreview.length > 100 \r\n        ? `${responsePreview.substring(0, 100)}...` \r\n        : responsePreview;\r\n      console.log(`üì§ Response preview: ${preview}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log CSV response details\r\n   */\r\n  static logCSVResponse(endpointName: string, itemCount: number, csvSize: number): void {\r\n    console.log(`üìÅ ${endpointName}: Returning CSV data for ${itemCount} items`);\r\n    console.log(`üìÅ CSV size: ${csvSize} characters`);\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1041, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/ESP32ResponseHelper.ts"],"sourcesContent":["/**\r\n * ESP32-Friendly Response Helper\r\n * \r\n * Utilities for creating responses compatible with ESP32 WiFi modules\r\n * \r\n * Key Requirements:\r\n * - Always return HTTP 200 status (even for errors)\r\n * - No quotes around response text for simple messages\r\n * - Specific headers: charset=utf-8, Content-Length, Connection: close\r\n * - Cache-Control: no-cache for fresh data\r\n */\r\n\r\nexport class ESP32ResponseHelper {\r\n  /**\r\n   * Create ESP32-friendly success response\r\n   * @param data - Response data (will be quoted by default)\r\n   * @param options - Additional options\r\n   */\r\n  static createResponse(\r\n    data: string, \r\n    options?: {\r\n      contentType?: string;\r\n      addQuotes?: boolean;\r\n      additionalHeaders?: Record<string, string>;\r\n    }\r\n  ): Response {\r\n    const { \r\n      contentType = 'text/plain; charset=utf-8',\r\n      addQuotes = true, // Changed default to true\r\n      additionalHeaders = {}\r\n    } = options || {};\r\n\r\n    // Wrap response in double quotes by default for ESP32 compatibility\r\n    const responseBody = addQuotes ? `\"${data}\"` : data;\r\n    const contentLength = Buffer.byteLength(responseBody, 'utf8');\r\n\r\n    return new Response(responseBody, {\r\n      status: 200, // Always 200 for ESP32 compatibility\r\n      headers: {\r\n        'Content-Type': contentType,\r\n        'Content-Length': contentLength.toString(),\r\n        'Connection': 'close',\r\n        'Cache-Control': 'no-cache',\r\n        'Access-Control-Allow-Origin': '*',\r\n        ...additionalHeaders\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create ESP32-friendly error response (still returns 200 status)\r\n   */\r\n  static createErrorResponse(errorMessage: string): Response {\r\n    return ESP32ResponseHelper.createResponse(errorMessage);\r\n  }\r\n\r\n  /**\r\n   * Create success response with structured data (pipe-delimited format)\r\n   */\r\n  static createDataResponse(data: string): Response {\r\n    return ESP32ResponseHelper.createResponse(data, {\r\n      additionalHeaders: {\r\n        'Access-Control-Allow-Methods': 'GET, POST',\r\n        'Access-Control-Allow-Headers': 'Content-Type'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create CSV response with proper headers\r\n   */\r\n  static createCSVResponse(csvData: string, filename: string = 'data.csv'): Response {\r\n    return new Response(csvData, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'text/csv; charset=utf-8',\r\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\r\n        'Content-Length': Buffer.byteLength(csvData, 'utf8').toString(),\r\n        'Connection': 'close',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST',\r\n        'Access-Control-Allow-Headers': 'Content-Type'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create CORS preflight response\r\n   */\r\n  static createCORSResponse(): Response {\r\n    return new Response(null, {\r\n      status: 200,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Extract InputString from request (handles malformed URLs from ESP32)\r\n   */\r\n  static async extractInputString(request: Request): Promise<string | null> {\r\n    let inputString: string | null = null;\r\n\r\n    if (request.method === 'GET') {\r\n      const { searchParams } = new URL(request.url);\r\n      inputString = searchParams.get('InputString');\r\n\r\n      // Handle malformed URLs from ESP32 (e.g., \"?,InputString=...\")\r\n      if (!inputString) {\r\n        // Check if any param key contains \"InputString\" (handles \",InputString\" case)\r\n        for (const [key, value] of searchParams.entries()) {\r\n          if (key.includes('InputString')) {\r\n            inputString = value;\r\n            console.log(`   ‚úÖ ESP32: Found InputString in malformed param key: \"${key}\"`);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    } else if (request.method === 'POST') {\r\n      try {\r\n        const body = await request.json();\r\n        inputString = body.InputString || null;\r\n      } catch {\r\n        try {\r\n          const formData = await request.formData();\r\n          inputString = formData.get('InputString') as string || null;\r\n        } catch (error) {\r\n          console.log(`‚ùå ESP32: Failed to parse POST body:`, error);\r\n        }\r\n      }\r\n    }\r\n\r\n    return inputString;\r\n  }\r\n\r\n  /**\r\n   * Filter line ending characters from InputString\r\n   * ESP32 sends $0D, $0A, $0D$0A patterns\r\n   */\r\n  static filterLineEndings(inputString: string): string {\r\n    if (!inputString) return inputString;\r\n\r\n    const original = inputString;\r\n    \r\n    // Remove common line ending patterns\r\n    const filtered = inputString\r\n      .replace(/\\$0D\\$0A/g, '')  // CRLF\r\n      .replace(/\\$0D/g, '')      // CR\r\n      .replace(/\\$0A/g, '')      // LF\r\n      .replace(/\\r\\n/g, '')      // Actual CRLF\r\n      .replace(/\\r/g, '')        // Actual CR\r\n      .replace(/\\n/g, '');       // Actual LF\r\n    \r\n    if (original !== filtered) {\r\n      console.log(`üßπ ESP32: Filtered line endings: \"${original}\" -> \"${filtered}\"`);\r\n    }\r\n\r\n    return filtered;\r\n  }\r\n\r\n  /**\r\n   * Log ESP32 request details for debugging\r\n   */\r\n  static logRequest(request: Request, dbKey: string, inputString: string | null): void {\r\n    console.log(`\\n${'='.repeat(80)}`);\r\n    console.log(`üì° ESP32 External API Request:`);\r\n    console.log(`   Timestamp: ${new Date().toISOString()}`);\r\n    console.log(`   Method: ${request.method}`);\r\n    console.log(`   Full URL: ${request.url}`);\r\n    console.log(`   DB Key: \"${dbKey}\"`);\r\n    console.log(`   InputString: \"${inputString}\"`);\r\n    console.log(`   Headers:`, {\r\n      'user-agent': request.headers.get('user-agent'),\r\n      'content-type': request.headers.get('content-type'),\r\n      'connection': request.headers.get('connection'),\r\n      'host': request.headers.get('host')\r\n    });\r\n    console.log(`${'='.repeat(80)}\\n`);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1194, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/index.ts"],"sourcesContent":["// External API pattern base classes and utilities\r\nexport { BaseExternalAPI } from './BaseExternalAPI';\r\nexport type { \r\n  BaseInputParts, \r\n  ValidationResult, \r\n  ExternalAPIConfig \r\n} from './BaseExternalAPI';\r\n\r\n// Input validation utilities\r\nexport { InputValidator } from './InputValidator';\r\n\r\n// Database query building utilities\r\nexport { QueryBuilder } from './QueryBuilder';\r\n\r\n// Response formatting utilities  \r\nexport { ResponseFormatter } from './ResponseFormatter';\r\n\r\n// ESP32-specific response utilities\r\nexport { ESP32ResponseHelper } from './ESP32ResponseHelper';\r\n\r\n// Re-import for interface extension\r\nimport type { BaseInputParts } from './BaseExternalAPI';\r\n\r\n// Common interfaces for external APIs\r\nexport interface FarmerInfoInput extends BaseInputParts {\r\n  pageNumber?: string; // Optional 5th part for pagination\r\n}\r\n\r\nexport interface MachinePasswordInput extends BaseInputParts {\r\n  passwordType: string; // Required 5th part for password type\r\n}\r\n\r\nexport interface MachineUpdateInput extends BaseInputParts {\r\n  datetime?: string; // Optional datetime parameter\r\n}\r\n\r\nexport interface MachineCorrectionInput extends BaseInputParts {\r\n  // Standard 4 parts only (societyId, machineType, version, machineId)\r\n  _marker?: never; // Type marker to prevent linting error\r\n}\r\n\r\nexport interface FarmerResult {\r\n  id: number;\r\n  farmer_id: string;\r\n  rf_id: string;\r\n  name: string;\r\n  phone: string | null;\r\n  sms_enabled: 'ON' | 'OFF' | null;\r\n  bonus: number | null;\r\n}\r\n\r\nexport interface MachinePasswordResult {\r\n  id: number;\r\n  machine_id: string;\r\n  user_password: string | null;\r\n  supervisor_password: string | null;\r\n  statusU: number;\r\n  statusS: number;\r\n  society_string_id?: string;\r\n}\r\n\r\nexport interface MachineCorrectionResult {\r\n  id: number;\r\n  machine_id: number;\r\n  channel1_fat: number;\r\n  channel1_snf: number;\r\n  channel1_clr: number;\r\n  channel1_temp: number;\r\n  channel1_water: number;\r\n  channel1_protein: number;\r\n  channel2_fat: number;\r\n  channel2_snf: number;\r\n  channel2_clr: number;\r\n  channel2_temp: number;\r\n  channel2_water: number;\r\n  channel2_protein: number;\r\n  channel3_fat: number;\r\n  channel3_snf: number;\r\n  channel3_clr: number;\r\n  channel3_temp: number;\r\n  channel3_water: number;\r\n  channel3_protein: number;\r\n  status: number;\r\n  created_at: Date;\r\n  updated_at: Date;\r\n}"],"names":[],"mappings":"AAAA,kDAAkD;;AAClD;AAOA,6BAA6B;AAC7B;AAEA,oCAAoC;AACpC;AAEA,kCAAkC;AAClC;AAEA,oCAAoC;AACpC","debugId":null}},
    {"offset": {"line": 1214, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/%5Bdb-key%5D/MachineStatistics/SaveMachineStatisticsFromMachine/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { connectDB } from '@/lib/database';\r\nimport { \r\n  ESP32ResponseHelper, \r\n  InputValidator, \r\n  QueryBuilder \r\n} from '@/lib/external-api';\r\n\r\ninterface SocietyLookupResult {\r\n  id: number;\r\n}\r\n\r\ninterface MachineResult {\r\n  id: number;\r\n  machine_id: string;\r\n  society_id: number;\r\n}\r\n\r\n/**\r\n * SaveMachineStatisticsFromMachine API Endpoint\r\n * \r\n * Purpose: Save machine statistics data from ESP32 machines\r\n * InputString format: societyId|machineType|version|machineId|T30|D1|W1|S8|G2|ENABLE|D2025-11-15_12:31:04\r\n * \r\n * Parameters:\r\n * - societyId: Society identifier (e.g., S-101)\r\n * - machineType: Machine type (e.g., LSE-SVWTBQ-12AH)\r\n * - version: Machine version (e.g., LE3.36)\r\n * - machineId: Machine identifier (e.g., MM223202)\r\n * - T30: Total tests count\r\n * - D1: Daily cleaning count\r\n * - W1: Weekly cleaning count\r\n * - S8: Cleaning skip count\r\n * - G2: Gain value\r\n * - ENABLE/DISABLE: Auto channel status\r\n * - D2025-11-15_12:31:04: Date and time stamp\r\n * \r\n * Endpoint: GET/POST /api/[db-key]/MachineStatistics/SaveMachineStatisticsFromMachine\r\n */\r\n\r\nasync function handleRequest(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<Record<string, string>> }\r\n) {\r\n  try {\r\n    // Extract InputString using helper\r\n    let inputString = await ESP32ResponseHelper.extractInputString(request);\r\n    \r\n    // Await the params Promise\r\n    const resolvedParams = await params;\r\n    const dbKey = resolvedParams['db-key'] || resolvedParams.dbKey || resolvedParams['dbkey'];\r\n\r\n    // Filter line endings from InputString\r\n    if (inputString) {\r\n      inputString = ESP32ResponseHelper.filterLineEndings(inputString);\r\n    }\r\n\r\n    // Log request\r\n    console.log(`\\n${'='.repeat(80)}`);\r\n    console.log(`üìä SaveMachineStatisticsFromMachine API Request:`);\r\n    console.log(`   Timestamp: ${new Date().toISOString()}`);\r\n    ESP32ResponseHelper.logRequest(request, dbKey, inputString);\r\n\r\n    // Validate DB Key\r\n    const dbKeyValidation = InputValidator.validateDbKey(dbKey);\r\n    if (!dbKeyValidation.isValid) {\r\n      console.log(`‚ùå DB Key validation failed`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid DB Key');\r\n    }\r\n\r\n    // Validate InputString is provided\r\n    if (!inputString) {\r\n      console.log(`‚ùå InputString is missing`);\r\n      return ESP32ResponseHelper.createErrorResponse('InputString parameter is required');\r\n    }\r\n\r\n    // Connect to database and validate DB Key\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    // Find admin by dbKey to get schema name\r\n    const admin = await User.findOne({ \r\n      where: { dbKey: dbKey.toUpperCase() } \r\n    });\r\n\r\n    if (!admin || !admin.dbKey) {\r\n      console.log(`‚ùå Admin not found for DB Key: ${dbKey}`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid DB Key');\r\n    }\r\n\r\n    // Parse input string format: S-101|LSE-SVWTBQ-12AH|LE3.36|MM223202|T30|D1|W1|S8|G2|ENABLE|D2025-11-15_12:31:04\r\n    const inputParts = inputString.split('|');\r\n    \r\n    if (inputParts.length !== 11) {\r\n      console.log(`‚ùå Invalid InputString format. Expected 11 parts, got ${inputParts.length}`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid InputString format');\r\n    }\r\n\r\n    const [\r\n      societyIdStr, \r\n      machineType, \r\n      version, \r\n      machineId, \r\n      totalTestStr, \r\n      dailyCleaningStr, \r\n      weeklyCleaningStr, \r\n      cleaningSkipStr, \r\n      gainStr, \r\n      autoChannel, \r\n      dateTimeStr\r\n    ] = inputParts;\r\n    \r\n    console.log(`üîç Parsed InputString:`, { \r\n      societyIdStr, \r\n      machineType, \r\n      version, \r\n      machineId,\r\n      totalTestStr,\r\n      dailyCleaningStr,\r\n      weeklyCleaningStr,\r\n      cleaningSkipStr,\r\n      gainStr,\r\n      autoChannel,\r\n      dateTimeStr\r\n    });\r\n\r\n    // Validate Society ID\r\n    const societyValidation = InputValidator.validateSocietyId(societyIdStr);\r\n    if (!societyValidation.isValid) {\r\n      console.log(`‚ùå Invalid society ID: ${societyIdStr}`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid society ID');\r\n    }\r\n\r\n    // Validate Machine ID\r\n    const machineValidation = InputValidator.validateMachineId(machineId);\r\n    if (!machineValidation.isValid) {\r\n      console.log(`‚ùå Invalid machine ID: ${machineId}`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid machine ID format');\r\n    }\r\n\r\n    // Parse statistics values\r\n    const totalTest = parseInt(totalTestStr.substring(1)) || 0; // Remove 'T' prefix\r\n    const dailyCleaning = parseInt(dailyCleaningStr.substring(1)) || 0; // Remove 'D' prefix\r\n    const weeklyCleaning = parseInt(weeklyCleaningStr.substring(1)) || 0; // Remove 'W' prefix\r\n    const cleaningSkip = parseInt(cleaningSkipStr.substring(1)) || 0; // Remove 'S' prefix\r\n    const gain = parseInt(gainStr.substring(1)) || 0; // Remove 'G' prefix\r\n\r\n    // Parse date and time from format: D2025-11-15_12:31:04\r\n    const dateTimePart = dateTimeStr.substring(1); // Remove 'D' prefix\r\n    const [datePart, timePart] = dateTimePart.split('_');\r\n    const statisticsDate = datePart; // 2025-11-15\r\n    const statisticsTime = timePart; // 12:31:04\r\n\r\n    console.log(`üìä Parsed statistics:`, {\r\n      totalTest,\r\n      dailyCleaning,\r\n      weeklyCleaning,\r\n      cleaningSkip,\r\n      gain,\r\n      autoChannel,\r\n      statisticsDate,\r\n      statisticsTime\r\n    });\r\n\r\n    // Build schema name\r\n    const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n    \r\n    console.log(`üîç Using schema: ${schemaName}`);\r\n\r\n    // Look up society\r\n    const { query: societyQuery, replacements: societyReplacements } = QueryBuilder.buildSocietyLookupQuery(\r\n      schemaName,\r\n      societyIdStr\r\n    );\r\n    \r\n    const [societyResults] = await sequelize.query(societyQuery, { replacements: societyReplacements });\r\n    \r\n    if (!Array.isArray(societyResults) || societyResults.length === 0) {\r\n      console.log(`‚ùå Society not found: \"${societyIdStr}\"`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid society ID');\r\n    }\r\n    \r\n    const actualSocietyId = (societyResults[0] as SocietyLookupResult).id;\r\n    console.log(`‚úÖ Found society: \"${societyIdStr}\" -> database ID: ${actualSocietyId}`);\r\n\r\n    // Look up machine to verify it exists\r\n    const machineIdVariants = (machineValidation.variants || []).map(v => String(v));\r\n    \r\n    if (machineIdVariants.length === 0) {\r\n      const machineIdCleaned = machineValidation.alphanumericId || machineValidation.numericId?.toString() || machineValidation.strippedId || '';\r\n      machineIdVariants.push(machineIdCleaned);\r\n    }\r\n    \r\n    const placeholders = machineIdVariants.map(() => '?').join(', ');\r\n    const machineQuery = `\r\n      SELECT id, machine_id, society_id \r\n      FROM \\`${schemaName}\\`.machines \r\n      WHERE machine_id IN (${placeholders}) AND society_id = ?\r\n      LIMIT 1\r\n    `;\r\n    \r\n    const [machineResults] = await sequelize.query(machineQuery, { \r\n      replacements: [...machineIdVariants, actualSocietyId] \r\n    });\r\n    \r\n    if (!Array.isArray(machineResults) || machineResults.length === 0) {\r\n      console.log(`‚ùå Machine not found: \"${machineId}\" for society ${actualSocietyId}`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid machine ID');\r\n    }\r\n    \r\n    const machineData = machineResults[0] as MachineResult;\r\n    console.log(`‚úÖ Found machine: \"${machineId}\" -> database ID: ${machineData.id}`);\r\n\r\n    // Check if statistics already exist for today\r\n    const checkQuery = `\r\n      SELECT id FROM \\`${schemaName}\\`.machine_statistics \r\n      WHERE machine_id = ? AND DATE(created_at) = CURDATE()\r\n      LIMIT 1\r\n    `;\r\n\r\n    const [existingResults] = await sequelize.query(checkQuery, {\r\n      replacements: [machineData.id]\r\n    });\r\n\r\n    if (Array.isArray(existingResults) && existingResults.length > 0) {\r\n      // Update existing record for today\r\n      console.log(`üìù Updating today's statistics for machine ${machineData.id}`);\r\n      \r\n      const updateQuery = `\r\n        UPDATE \\`${schemaName}\\`.machine_statistics \r\n        SET \r\n          society_id = ?,\r\n          machine_type = ?,\r\n          version = ?,\r\n          total_test = ?,\r\n          daily_cleaning = ?,\r\n          weekly_cleaning = ?,\r\n          cleaning_skip = ?,\r\n          gain = ?,\r\n          auto_channel = ?,\r\n          statistics_date = ?,\r\n          statistics_time = ?\r\n        WHERE machine_id = ? AND DATE(created_at) = CURDATE()\r\n      `;\r\n\r\n      await sequelize.query(updateQuery, {\r\n        replacements: [\r\n          actualSocietyId,\r\n          machineType,\r\n          version,\r\n          totalTest,\r\n          dailyCleaning,\r\n          weeklyCleaning,\r\n          cleaningSkip,\r\n          gain,\r\n          autoChannel,\r\n          statisticsDate,\r\n          statisticsTime,\r\n          machineData.id\r\n        ]\r\n      });\r\n\r\n      console.log(`‚úÖ Today's machine statistics updated successfully`);\r\n    } else {\r\n      // Insert new record for today\r\n      console.log(`üìù Creating new statistics record for machine ${machineData.id}`);\r\n      \r\n      const insertQuery = `\r\n        INSERT INTO \\`${schemaName}\\`.machine_statistics \r\n        (\r\n          machine_id, \r\n          society_id, \r\n          machine_type, \r\n          version, \r\n          total_test, \r\n          daily_cleaning, \r\n          weekly_cleaning, \r\n          cleaning_skip, \r\n          gain, \r\n          auto_channel, \r\n          statistics_date, \r\n          statistics_time\r\n        )\r\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `;\r\n\r\n      await sequelize.query(insertQuery, {\r\n        replacements: [\r\n          machineData.id,\r\n          actualSocietyId,\r\n          machineType,\r\n          version,\r\n          totalTest,\r\n          dailyCleaning,\r\n          weeklyCleaning,\r\n          cleaningSkip,\r\n          gain,\r\n          autoChannel,\r\n          statisticsDate,\r\n          statisticsTime\r\n        ]\r\n      });\r\n\r\n      console.log(`‚úÖ New machine statistics created successfully`);\r\n    }\r\n    console.log(`${'='.repeat(80)}\\n`);\r\n\r\n    // Return success response\r\n    return ESP32ResponseHelper.createDataResponse('Machine statistics saved successfully.');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå SaveMachineStatisticsFromMachine API Error:', error);\r\n    console.error('Stack trace:', error instanceof Error ? error.stack : 'No stack trace');\r\n    console.log(`${'='.repeat(80)}\\n`);\r\n    \r\n    return ESP32ResponseHelper.createErrorResponse('Failed to save machine statistics');\r\n  }\r\n}\r\n\r\n// Export both GET and POST methods\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<Record<string, string>> }\r\n) {\r\n  return handleRequest(request, context);\r\n}\r\n\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<Record<string, string>> }\r\n) {\r\n  return handleRequest(request, context);\r\n}\r\n\r\nexport async function OPTIONS() {\r\n  return ESP32ResponseHelper.createCORSResponse();\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}