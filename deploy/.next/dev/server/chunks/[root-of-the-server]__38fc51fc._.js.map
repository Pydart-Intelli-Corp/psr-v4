{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/models/User.ts"],"sourcesContent":["import { DataTypes, Model, Sequelize } from 'sequelize';\r\nimport bcrypt from 'bcryptjs';\r\n\r\n// User roles in hierarchical order\r\nexport enum UserRole {\r\n  SUPER_ADMIN = 'super_admin',\r\n  ADMIN = 'admin',\r\n  DAIRY = 'dairy',\r\n  BMC = 'bmc',\r\n  SOCIETY = 'society',\r\n  FARMER = 'farmer'\r\n}\r\n\r\n// User status\r\nexport enum UserStatus {\r\n  PENDING = 'pending',\r\n  PENDING_APPROVAL = 'pending_approval', // Email verified, waiting for super admin approval\r\n  ACTIVE = 'active',\r\n  INACTIVE = 'inactive',\r\n  SUSPENDED = 'suspended'\r\n}\r\n\r\n// User attributes interface\r\nexport interface UserAttributes {\r\n  id?: number;\r\n  uid: string;\r\n  email: string;\r\n  password: string;\r\n  fullName: string;\r\n  role: UserRole;\r\n  status: UserStatus;\r\n  dbKey?: string; // For admins - their dedicated schema key\r\n  companyName?: string;\r\n  companyPincode?: string;\r\n  companyCity?: string;\r\n  companyState?: string;\r\n  parentId?: number; // Reference to parent user in hierarchy\r\n  isEmailVerified: boolean;\r\n  emailVerificationToken?: string;\r\n  emailVerificationExpires?: Date;\r\n  passwordResetToken?: string;\r\n  passwordResetExpires?: Date;\r\n  otpCode?: string;\r\n  otpExpires?: Date;\r\n  lastLogin?: Date;\r\n  loginAttempts: number;\r\n  lockUntil?: Date;\r\n  createdAt?: Date;\r\n  updatedAt?: Date;\r\n}\r\n\r\n// User model class\r\nclass User extends Model<UserAttributes> implements UserAttributes {\r\n  // Remove public class fields to avoid shadowing Sequelize getters/setters\r\n  declare id: number;\r\n  declare uid: string;\r\n  declare email: string;\r\n  declare password: string;\r\n  declare fullName: string;\r\n  declare role: UserRole;\r\n  declare status: UserStatus;\r\n  declare dbKey?: string;\r\n  declare companyName?: string;\r\n  declare companyPincode?: string;\r\n  declare companyCity?: string;\r\n  declare companyState?: string;\r\n  declare parentId?: number;\r\n  declare isEmailVerified: boolean;\r\n  declare emailVerificationToken?: string;\r\n  declare emailVerificationExpires?: Date;\r\n  declare passwordResetToken?: string;\r\n  declare passwordResetExpires?: Date;\r\n  declare otpCode?: string;\r\n  declare otpExpires?: Date;\r\n  declare lastLogin?: Date;\r\n  declare loginAttempts: number;\r\n  declare lockUntil?: Date;\r\n\r\n  // Timestamps\r\n  declare readonly createdAt: Date;\r\n  declare readonly updatedAt: Date;\r\n\r\n  // Instance methods\r\n  public async comparePassword(candidatePassword: string): Promise<boolean> {\r\n    return bcrypt.compare(candidatePassword, this.password);\r\n  }\r\n\r\n  public async incLoginAttempts(): Promise<void> {\r\n    // If we have a previous lock that has expired, restart at 1\r\n    if (this.lockUntil && this.lockUntil < new Date()) {\r\n      await this.update({\r\n        loginAttempts: 1,\r\n        lockUntil: undefined\r\n      });\r\n      return;\r\n    }\r\n\r\n    const updates: Partial<UserAttributes> = { loginAttempts: this.loginAttempts + 1 };\r\n\r\n    // Lock account after 5 failed attempts for 2 hours\r\n    if (this.loginAttempts + 1 >= 5 && !this.isLocked) {\r\n      updates.lockUntil = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours\r\n    }\r\n\r\n    await this.update(updates);\r\n  }\r\n\r\n  public async resetLoginAttempts(): Promise<void> {\r\n    await this.update({\r\n      loginAttempts: 0,\r\n      lockUntil: undefined\r\n    });\r\n  }\r\n\r\n  public get isLocked(): boolean {\r\n    return !!(this.lockUntil && this.lockUntil > new Date());\r\n  }\r\n\r\n\r\n\r\n  public canManageRole(targetRole: UserRole): boolean {\r\n    const roleHierarchy = [\r\n      UserRole.SUPER_ADMIN,\r\n      UserRole.ADMIN,\r\n      UserRole.DAIRY,\r\n      UserRole.BMC,\r\n      UserRole.SOCIETY,\r\n      UserRole.FARMER\r\n    ];\r\n\r\n    const currentRoleIndex = roleHierarchy.indexOf(this.role);\r\n    const targetRoleIndex = roleHierarchy.indexOf(targetRole);\r\n\r\n    return currentRoleIndex < targetRoleIndex;\r\n  }\r\n}\r\n\r\n// Initialize User model\r\nexport const initUserModel = (sequelize: Sequelize): typeof User => {\r\n  User.init(\r\n    {\r\n      id: {\r\n        type: DataTypes.INTEGER,\r\n        primaryKey: true,\r\n        autoIncrement: true,\r\n      },\r\n      uid: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: false,\r\n        unique: true,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [3, 50]\r\n        }\r\n      },\r\n      email: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: false,\r\n        unique: true,\r\n        validate: {\r\n          isEmail: true,\r\n          notEmpty: true\r\n        }\r\n      },\r\n      password: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: false,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [6, 255]\r\n        }\r\n      },\r\n      fullName: {\r\n        type: DataTypes.STRING(200),\r\n        allowNull: false,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [2, 200]\r\n        }\r\n      },\r\n      role: {\r\n        type: DataTypes.ENUM(...Object.values(UserRole)),\r\n        allowNull: false,\r\n        defaultValue: UserRole.FARMER\r\n      },\r\n      status: {\r\n        type: DataTypes.ENUM(...Object.values(UserStatus)),\r\n        allowNull: false,\r\n        defaultValue: UserStatus.PENDING\r\n      },\r\n      dbKey: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: true,\r\n        unique: true,\r\n        comment: 'Dedicated database schema key for admins'\r\n      },\r\n      companyName: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      companyPincode: {\r\n        type: DataTypes.STRING(10),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [5, 10]\r\n        }\r\n      },\r\n      companyCity: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [2, 100]\r\n        }\r\n      },\r\n      companyState: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [2, 100]\r\n        }\r\n      },\r\n      parentId: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: true,\r\n        references: {\r\n          model: 'users',\r\n          key: 'id'\r\n        }\r\n      },\r\n      isEmailVerified: {\r\n        type: DataTypes.BOOLEAN,\r\n        allowNull: false,\r\n        defaultValue: false\r\n      },\r\n      emailVerificationToken: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      emailVerificationExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      passwordResetToken: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      passwordResetExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      otpCode: {\r\n        type: DataTypes.STRING(10),\r\n        allowNull: true\r\n      },\r\n      otpExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      lastLogin: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      loginAttempts: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: false,\r\n        defaultValue: 0\r\n      },\r\n      lockUntil: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      }\r\n    },\r\n    {\r\n      sequelize,\r\n      modelName: 'User',\r\n      tableName: 'users',\r\n      timestamps: true,\r\n      hooks: {\r\n        beforeSave: async (user: User) => {\r\n          // Hash password if it's being modified\r\n          if (user.changed('password') && user.password) {\r\n            const salt = await bcrypt.genSalt(12);\r\n            user.password = await bcrypt.hash(user.password, salt);\r\n          }\r\n\r\n          // Generate UID if not provided\r\n          if (!user.uid && user.email) {\r\n            const timestamp = Date.now().toString().slice(-6);\r\n            const emailPrefix = user.email.substring(0, 3).toUpperCase();\r\n            user.uid = `${emailPrefix}${timestamp}`;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  );\r\n\r\n  // Define associations\r\n  User.hasMany(User, { \r\n    as: 'Children', \r\n    foreignKey: 'parentId',\r\n    onDelete: 'SET NULL'\r\n  });\r\n  \r\n  User.belongsTo(User, { \r\n    as: 'Parent', \r\n    foreignKey: 'parentId',\r\n    onDelete: 'SET NULL'\r\n  });\r\n\r\n  return User;\r\n};\r\n\r\nexport default User;"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAGO,IAAA,AAAK,kCAAA;;;;;;;WAAA;;AAUL,IAAA,AAAK,oCAAA;;;;;;WAAA;;AAqCZ,mBAAmB;AACnB,MAAM,aAAa,qJAAK;IA8BtB,mBAAmB;IACnB,MAAa,gBAAgB,iBAAyB,EAAoB;QACxE,OAAO,8IAAM,CAAC,OAAO,CAAC,mBAAmB,IAAI,CAAC,QAAQ;IACxD;IAEA,MAAa,mBAAkC;QAC7C,4DAA4D;QAC5D,IAAI,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,SAAS,GAAG,IAAI,QAAQ;YACjD,MAAM,IAAI,CAAC,MAAM,CAAC;gBAChB,eAAe;gBACf,WAAW;YACb;YACA;QACF;QAEA,MAAM,UAAmC;YAAE,eAAe,IAAI,CAAC,aAAa,GAAG;QAAE;QAEjF,mDAAmD;QACnD,IAAI,IAAI,CAAC,aAAa,GAAG,KAAK,KAAK,CAAC,IAAI,CAAC,QAAQ,EAAE;YACjD,QAAQ,SAAS,GAAG,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK,KAAK,OAAO,UAAU;QAC3E;QAEA,MAAM,IAAI,CAAC,MAAM,CAAC;IACpB;IAEA,MAAa,qBAAoC;QAC/C,MAAM,IAAI,CAAC,MAAM,CAAC;YAChB,eAAe;YACf,WAAW;QACb;IACF;IAEA,IAAW,WAAoB;QAC7B,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,SAAS,GAAG,IAAI,MAAM;IACzD;IAIO,cAAc,UAAoB,EAAW;QAClD,MAAM,gBAAgB;;;;;;;SAOrB;QAED,MAAM,mBAAmB,cAAc,OAAO,CAAC,IAAI,CAAC,IAAI;QACxD,MAAM,kBAAkB,cAAc,OAAO,CAAC;QAE9C,OAAO,mBAAmB;IAC5B;AACF;AAGO,MAAM,gBAAgB,CAAC;IAC5B,KAAK,IAAI,CACP;QACE,IAAI;YACF,MAAM,yJAAS,CAAC,OAAO;YACvB,YAAY;YACZ,eAAe;QACjB;QACA,KAAK;YACH,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,QAAQ;YACR,UAAU;gBACR,UAAU;gBACV,KAAK;oBAAC;oBAAG;iBAAG;YACd;QACF;QACA,OAAO;YACL,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,QAAQ;YACR,UAAU;gBACR,SAAS;gBACT,UAAU;YACZ;QACF;QACA,UAAU;YACR,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,UAAU;gBACR,UAAU;gBACV,KAAK;oBAAC;oBAAG;iBAAI;YACf;QACF;QACA,UAAU;YACR,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,UAAU;gBACR,UAAU;gBACV,KAAK;oBAAC;oBAAG;iBAAI;YACf;QACF;QACA,MAAM;YACJ,MAAM,yJAAS,CAAC,IAAI,IAAI,OAAO,MAAM,CAAC;YACtC,WAAW;YACX,YAAY;QACd;QACA,QAAQ;YACN,MAAM,yJAAS,CAAC,IAAI,IAAI,OAAO,MAAM,CAAC;YACtC,WAAW;YACX,YAAY;QACd;QACA,OAAO;YACL,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,QAAQ;YACR,SAAS;QACX;QACA,aAAa;YACX,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,gBAAgB;YACd,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,UAAU;gBACR,KAAK;oBAAC;oBAAG;iBAAG;YACd;QACF;QACA,aAAa;YACX,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,UAAU;gBACR,KAAK;oBAAC;oBAAG;iBAAI;YACf;QACF;QACA,cAAc;YACZ,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;YACX,UAAU;gBACR,KAAK;oBAAC;oBAAG;iBAAI;YACf;QACF;QACA,UAAU;YACR,MAAM,yJAAS,CAAC,OAAO;YACvB,WAAW;YACX,YAAY;gBACV,OAAO;gBACP,KAAK;YACP;QACF;QACA,iBAAiB;YACf,MAAM,yJAAS,CAAC,OAAO;YACvB,WAAW;YACX,cAAc;QAChB;QACA,wBAAwB;YACtB,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,0BAA0B;YACxB,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;QACA,oBAAoB;YAClB,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,sBAAsB;YACpB,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;QACA,SAAS;YACP,MAAM,yJAAS,CAAC,MAAM,CAAC;YACvB,WAAW;QACb;QACA,YAAY;YACV,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;QACA,eAAe;YACb,MAAM,yJAAS,CAAC,OAAO;YACvB,WAAW;YACX,cAAc;QAChB;QACA,WAAW;YACT,MAAM,yJAAS,CAAC,IAAI;YACpB,WAAW;QACb;IACF,GACA;QACE;QACA,WAAW;QACX,WAAW;QACX,YAAY;QACZ,OAAO;YACL,YAAY,OAAO;gBACjB,uCAAuC;gBACvC,IAAI,KAAK,OAAO,CAAC,eAAe,KAAK,QAAQ,EAAE;oBAC7C,MAAM,OAAO,MAAM,8IAAM,CAAC,OAAO,CAAC;oBAClC,KAAK,QAAQ,GAAG,MAAM,8IAAM,CAAC,IAAI,CAAC,KAAK,QAAQ,EAAE;gBACnD;gBAEA,+BAA+B;gBAC/B,IAAI,CAAC,KAAK,GAAG,IAAI,KAAK,KAAK,EAAE;oBAC3B,MAAM,YAAY,KAAK,GAAG,GAAG,QAAQ,GAAG,KAAK,CAAC,CAAC;oBAC/C,MAAM,cAAc,KAAK,KAAK,CAAC,SAAS,CAAC,GAAG,GAAG,WAAW;oBAC1D,KAAK,GAAG,GAAG,GAAG,cAAc,WAAW;gBACzC;YACF;QACF;IACF;IAGF,sBAAsB;IACtB,KAAK,OAAO,CAAC,MAAM;QACjB,IAAI;QACJ,YAAY;QACZ,UAAU;IACZ;IAEA,KAAK,SAAS,CAAC,MAAM;QACnB,IAAI;QACJ,YAAY;QACZ,UAAU;IACZ;IAEA,OAAO;AACT;uCAEe","debugId":null}},
    {"offset": {"line": 367, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/auth.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport crypto from 'crypto';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// JWT configuration\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-super-secret-jwt-key';\r\nconst JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || 'your-super-secret-refresh-jwt-key';\r\n\r\n// JWT payload interface\r\nexport interface JWTPayload {\r\n  id: number;\r\n  uid: string;\r\n  email: string;\r\n  role: UserRole | string; // Allow string for external auth entity types\r\n  dbKey?: string;\r\n  entityType?: 'society' | 'farmer' | 'dairy' | 'bmc'; // For external auth\r\n  schemaName?: string; // For external auth\r\n}\r\n\r\n// Generate JWT tokens\r\nexport const generateTokens = (user: JWTPayload) => {\r\n  const payload = {\r\n    id: user.id,\r\n    uid: user.uid,\r\n    email: user.email,\r\n    role: user.role,\r\n    dbKey: user.dbKey,\r\n    entityType: user.entityType,\r\n    schemaName: user.schemaName\r\n  };\r\n\r\n  const token = jwt.sign(payload, JWT_SECRET as string, {\r\n    expiresIn: '7d',\r\n    issuer: 'poornasree-equipments-cloud',\r\n    audience: 'psr-client'\r\n  });\r\n\r\n  const refreshToken = jwt.sign(payload, JWT_REFRESH_SECRET as string, {\r\n    expiresIn: '30d',\r\n    issuer: 'poornasree-equipments-cloud',\r\n    audience: 'psr-client'\r\n  });\r\n\r\n  return { token, refreshToken };\r\n};\r\n\r\n// Verify JWT token\r\nexport const verifyToken = (token: string): JWTPayload | null => {\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET as string, {\r\n      issuer: 'poornasree-equipments-cloud',\r\n      audience: 'psr-client'\r\n    }) as JWTPayload;\r\n    return decoded;\r\n  } catch (error) {\r\n    console.error('JWT verification failed:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Verify refresh token\r\nexport const verifyRefreshToken = (token: string): JWTPayload | null => {\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_REFRESH_SECRET as string, {\r\n      issuer: 'poornasree-equipments-cloud',\r\n      audience: 'psr-client'\r\n    }) as JWTPayload;\r\n    return decoded;\r\n  } catch (error) {\r\n    console.error('Refresh token verification failed:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Generate random token\r\nexport const generateRandomToken = (length: number = 32): string => {\r\n  return crypto.randomBytes(length).toString('hex');\r\n};\r\n\r\n// Generate OTP\r\nexport const generateOTP = (length: number = 6): string => {\r\n  const digits = '0123456789';\r\n  let otp = '';\r\n  for (let i = 0; i < length; i++) {\r\n    otp += digits[Math.floor(Math.random() * digits.length)];\r\n  }\r\n  return otp;\r\n};\r\n\r\n// Hash token for database storage\r\nexport const hashToken = (token: string): string => {\r\n  return crypto.createHash('sha256').update(token).digest('hex');\r\n};\r\n\r\n// Role hierarchy checker\r\nexport const canManageRole = (userRole: UserRole, targetRole: UserRole): boolean => {\r\n  const roleHierarchy: Record<UserRole, number> = {\r\n    [UserRole.SUPER_ADMIN]: 0,\r\n    [UserRole.ADMIN]: 1,\r\n    [UserRole.DAIRY]: 2,\r\n    [UserRole.BMC]: 3,\r\n    [UserRole.SOCIETY]: 4,\r\n    [UserRole.FARMER]: 5\r\n  };\r\n\r\n  return roleHierarchy[userRole] < roleHierarchy[targetRole];\r\n};\r\n\r\n// Get allowed roles for user\r\nexport const getAllowedRoles = (userRole: UserRole): UserRole[] => {\r\n  const allRoles = [\r\n    UserRole.SUPER_ADMIN,\r\n    UserRole.ADMIN,\r\n    UserRole.DAIRY,\r\n    UserRole.BMC,\r\n    UserRole.SOCIETY,\r\n    UserRole.FARMER\r\n  ];\r\n\r\n  const roleHierarchy: Record<UserRole, number> = {\r\n    [UserRole.SUPER_ADMIN]: 0,\r\n    [UserRole.ADMIN]: 1,\r\n    [UserRole.DAIRY]: 2,\r\n    [UserRole.BMC]: 3,\r\n    [UserRole.SOCIETY]: 4,\r\n    [UserRole.FARMER]: 5\r\n  };\r\n\r\n  const userLevel = roleHierarchy[userRole];\r\n  return allRoles.filter(role => roleHierarchy[role] > userLevel);\r\n};\r\n\r\n// Check if user is super admin\r\nexport const isSuperAdmin = (user: { email?: string; role?: UserRole }): boolean => {\r\n  const superAdminEmail = process.env.SUPER_ADMIN_USERNAME || 'admin';\r\n  return (\r\n    user.email === superAdminEmail || \r\n    user.role === UserRole.SUPER_ADMIN\r\n  );\r\n};\r\n\r\n// Validate password strength\r\nexport const validatePassword = (password: string): { \r\n  isValid: boolean; \r\n  errors: string[] \r\n} => {\r\n  const errors: string[] = [];\r\n  \r\n  if (password.length < 8) {\r\n    errors.push('Password must be at least 8 characters long');\r\n  }\r\n  \r\n  if (!/[A-Z]/.test(password)) {\r\n    errors.push('Password must contain at least one uppercase letter');\r\n  }\r\n  \r\n  if (!/[a-z]/.test(password)) {\r\n    errors.push('Password must contain at least one lowercase letter');\r\n  }\r\n  \r\n  if (!/\\d/.test(password)) {\r\n    errors.push('Password must contain at least one number');\r\n  }\r\n  \r\n  if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\r\n    errors.push('Password must contain at least one special character');\r\n  }\r\n\r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors\r\n  };\r\n};\r\n\r\n// Generate secure session ID\r\nexport const generateSessionId = (): string => {\r\n  return crypto.randomBytes(64).toString('hex');\r\n};\r\n\r\nconst authUtils = {\r\n  generateTokens,\r\n  verifyToken,\r\n  verifyRefreshToken,\r\n  generateRandomToken,\r\n  generateOTP,\r\n  hashToken,\r\n  canManageRole,\r\n  getAllowedRoles,\r\n  isSuperAdmin,\r\n  validatePassword,\r\n  generateSessionId\r\n};\r\n\r\nexport default authUtils;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 585, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/database.ts"],"sourcesContent":["import { Sequelize } from 'sequelize';\r\nimport mysql2 from 'mysql2';\r\nimport path from 'path';\r\n\r\n// Database configuration for Azure MySQL\r\nlet sequelize: Sequelize | null = null;\r\n\r\nconst createSequelizeInstance = () => {\r\n    if (!sequelize) {\r\n    // Don't initialize during build time\r\n    if (process.env.NODE_ENV === 'development' || process.env.BUILDING !== 'true') {\r\n      // Determine SSL configuration based on environment\r\n      // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n      const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n        require: true,\r\n        rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n        ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n      } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n        require: true,\r\n        rejectUnauthorized: false,\r\n      } : false;      sequelize = new Sequelize(\r\n      process.env.DB_NAME || 'psr_v4_main',\r\n      process.env.DB_USER || 'psr_admin',\r\n      process.env.DB_PASSWORD || 'Access@404',\r\n      {\r\n        host: process.env.DB_HOST || 'localhost',\r\n        port: parseInt(process.env.DB_PORT || '3306'),\r\n        dialect: 'mysql',\r\n        dialectModule: mysql2,\r\n        timezone: '+05:30', // Use Indian Standard Time (IST)\r\n        dialectOptions: {\r\n          ssl: sslConfig,\r\n          connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        },\r\n        pool: {\r\n          max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n          min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n          acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n          idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n        },\r\n        logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n        benchmark: process.env.NODE_ENV === 'development',\r\n      }\r\n    );\r\n    }\r\n  }\r\n  return sequelize;\r\n};\r\n\r\n// Test database connection\r\nexport const testConnection = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    await db.authenticate();\r\n    console.log('‚úÖ Database connection established successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Unable to connect to the database:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Initialize database\r\nexport const initDatabase = async (useMigrations: boolean = false) => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    \r\n    if (useMigrations) {\r\n      // Use migrations instead of sync for production\r\n      const { migrationRunner } = await import('./migrations');\r\n      await migrationRunner.initializeDatabase();\r\n    } else {\r\n      // Development mode - use sync\r\n      await db.sync({ alter: process.env.NODE_ENV === 'development' });\r\n    }\r\n    \r\n    console.log('‚úÖ Database synchronized successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Database synchronization failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Connect to database\r\nexport const connectDB = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.authenticate();\r\n    return db;\r\n  } catch (error) {\r\n    console.error('‚ùå Database connection failed:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to create admin-specific schema\r\nexport const createAdminSchema = async (adminEmail: string): Promise<string> => {\r\n  try {\r\n    // Generate DB key: db-<first 3 letters of email><3 random numbers>\r\n    const emailPrefix = adminEmail.substring(0, 3).toLowerCase();\r\n    const randomSuffix = Math.floor(100 + Math.random() * 900).toString();\r\n    const dbKey = `db_${emailPrefix}${randomSuffix}`;\r\n    \r\n    // Create new database schema\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.query(`CREATE DATABASE IF NOT EXISTS \\`${dbKey}\\``);\r\n    \r\n    console.log(`‚úÖ Created admin schema: ${dbKey}`);\r\n    return dbKey;\r\n  } catch (error) {\r\n    console.error('‚ùå Failed to create admin schema:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to get connection for specific admin schema\r\nexport const getAdminConnection = (dbKey: string): Sequelize => {\r\n  // Determine SSL configuration based on environment\r\n  // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n  const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n    require: true,\r\n    rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n    ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n  } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n    require: true,\r\n    rejectUnauthorized: false,\r\n  } : false;\r\n\r\n  return new Sequelize(\r\n    dbKey,\r\n    process.env.DB_USER || 'psr_admin',\r\n    process.env.DB_PASSWORD || '',\r\n    {\r\n      host: process.env.DB_HOST || 'localhost',\r\n      port: parseInt(process.env.DB_PORT || '3306'),\r\n      dialect: 'mysql',\r\n      dialectModule: mysql2,\r\n      dialectOptions: {\r\n        ssl: sslConfig,\r\n        connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        acquireTimeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n        timeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n      },\r\n      pool: {\r\n        max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n        min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n        acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n      },\r\n      logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n    }\r\n  );\r\n};\r\n\r\nexport default createSequelizeInstance;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 751, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/utils/response.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nexport interface ApiResponse<T = unknown> {\r\n  success: boolean;\r\n  message: string;\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\nexport function createSuccessResponse<T = unknown>(\r\n  message: string,\r\n  data?: T,\r\n  status: number = 200\r\n): NextResponse<ApiResponse<T>> {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      message,\r\n      data,\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\nexport function createErrorResponse<T = unknown>(\r\n  error: string,\r\n  status: number = 400,\r\n  data?: T\r\n): NextResponse<ApiResponse<T>> {\r\n  return NextResponse.json(\r\n    {\r\n      success: false,\r\n      message: 'Error occurred',\r\n      error,\r\n      data,\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\nexport function validateRequiredFields(\r\n  body: Record<string, unknown>,\r\n  requiredFields: string[]\r\n): { success: boolean; missing?: string[] } {\r\n  const missing = requiredFields.filter(field => !body[field]);\r\n  return {\r\n    success: missing.length === 0,\r\n    missing: missing.length > 0 ? missing : undefined\r\n  };\r\n}"],"names":[],"mappings":";;;;;;;;AAAA;;AASO,SAAS,sBACd,OAAe,EACf,IAAQ,EACR,SAAiB,GAAG;IAEpB,OAAO,gJAAY,CAAC,IAAI,CACtB;QACE,SAAS;QACT;QACA;IACF,GACA;QAAE;IAAO;AAEb;AAEO,SAAS,oBACd,KAAa,EACb,SAAiB,GAAG,EACpB,IAAQ;IAER,OAAO,gJAAY,CAAC,IAAI,CACtB;QACE,SAAS;QACT,SAAS;QACT;QACA;IACF,GACA;QAAE;IAAO;AAEb;AAEO,SAAS,uBACd,IAA6B,EAC7B,cAAwB;IAExB,MAAM,UAAU,eAAe,MAAM,CAAC,CAAA,QAAS,CAAC,IAAI,CAAC,MAAM;IAC3D,OAAO;QACL,SAAS,QAAQ,MAAM,KAAK;QAC5B,SAAS,QAAQ,MAAM,GAAG,IAAI,UAAU;IAC1C;AACF","debugId":null}},
    {"offset": {"line": 791, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/user/farmer/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { verifyToken } from '@/lib/auth';\r\nimport { connectDB } from '@/lib/database';\r\nimport { createSuccessResponse, createErrorResponse } from '@/lib/utils/response';\r\n\r\n// Helper function to check farmer email uniqueness across all admin schemas\r\nasync function checkGlobalFarmerEmailUniqueness(email: string, excludeFarmerId?: number, currentSchemaName?: string): Promise<{ isUnique: boolean; existingSchema?: string }> {\r\n  const { sequelize, User } = await import('@/models').then(m => m.getModels());\r\n  \r\n  // Get all admin schemas\r\n  const [schemas] = await sequelize.query(`\r\n    SELECT DISTINCT TABLE_SCHEMA \r\n    FROM information_schema.TABLES \r\n    WHERE (TABLE_SCHEMA LIKE 'db_%' OR TABLE_SCHEMA LIKE 'tester_%') \r\n    AND TABLE_NAME = 'farmers'\r\n    ORDER BY TABLE_SCHEMA\r\n  `);\r\n  \r\n  const adminSchemas = (schemas as Array<{ TABLE_SCHEMA: string }>).map(s => s.TABLE_SCHEMA);\r\n  \r\n  for (const schema of adminSchemas) {\r\n    try {\r\n      let query = `SELECT farmer_id, name FROM \\`${schema}\\`.\\`farmers\\` WHERE email = ?`;\r\n      const replacements: any[] = [email.trim().toLowerCase()];\r\n      \r\n      // If checking for update (exclude current farmer)\r\n      if (excludeFarmerId && currentSchemaName && schema === currentSchemaName) {\r\n        query += ' AND id != ?';\r\n        replacements.push(excludeFarmerId);\r\n      }\r\n      \r\n      const [existingEmail] = await sequelize.query(query, { replacements });\r\n      \r\n      if (Array.isArray(existingEmail) && existingEmail.length > 0) {\r\n        return { isUnique: false, existingSchema: schema };\r\n      }\r\n    } catch (error) {\r\n      console.log(`‚ö†Ô∏è Schema ${schema} not accessible or doesn't have farmers table`);\r\n      continue;\r\n    }\r\n  }\r\n  \r\n  return { isUnique: true };\r\n}\r\n\r\ninterface FarmerData {\r\n  farmerId: string;\r\n  rfId?: string;\r\n  farmerName: string;\r\n  password?: string;\r\n  contactNumber?: string;\r\n  email?: string;\r\n  smsEnabled?: 'ON' | 'OFF';  emailNotificationsEnabled?: string;  bonus?: number;\r\n  address?: string;\r\n  bankName?: string;\r\n  bankAccountNumber?: string;\r\n  ifscCode?: string;\r\n  societyId?: number;\r\n  machineId?: number;\r\n  status?: 'active' | 'inactive' | 'suspended' | 'maintenance';\r\n  notes?: string;\r\n}\r\n\r\ninterface FarmerQueryResult {\r\n  id: number;\r\n  farmer_id: string;\r\n  rf_id?: string;\r\n  name: string;\r\n  password?: string;\r\n  phone?: string;\r\n  email?: string;\r\n  sms_enabled?: 'ON' | 'OFF';\r\n  email_notifications_enabled?: 'ON' | 'OFF';\r\n  bonus?: number;\r\n  address?: string;\r\n  bank_name?: string;\r\n  bank_account_number?: string;\r\n  ifsc_code?: string;\r\n  society_id?: number;\r\n  society_name?: string;\r\n  society_identifier?: string;\r\n  machine_id?: number;\r\n  machine_name?: string;\r\n  machine_type?: string;\r\n  status?: 'active' | 'inactive' | 'suspended' | 'maintenance';\r\n  notes?: string;\r\n  cattle_count?: number;\r\n  created_at: string;\r\n  updated_at?: string;\r\n}\r\n\r\n// GET - Retrieve farmers\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return createErrorResponse('Authentication required', 401);\r\n    }\r\n\r\n    const payload = verifyToken(token);\r\n    if (!payload || payload.role !== 'admin') {\r\n      return createErrorResponse('Admin access required', 403);\r\n    }\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const id = searchParams.get('id');\r\n\r\n    // Get admin's dbKey\r\n    const admin = await User.findByPk(payload.id);\r\n    if (!admin || !admin.dbKey) {\r\n      return createErrorResponse('Admin not found or database not configured', 404);\r\n    }\r\n\r\n    // Generate admin-specific schema name  \r\n    const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n    console.log(`üîç Fetching farmers from schema: ${schemaName}`);\r\n\r\n    let query: string;\r\n    let replacements: (string | number)[] = [];\r\n\r\n    if (id) {\r\n      // Query single farmer\r\n      query = `\r\n        SELECT \r\n          f.id, f.farmer_id, f.rf_id, f.name, f.password, f.phone, f.email, f.sms_enabled, \r\n          f.email_notifications_enabled, f.bonus, f.address, f.bank_name, f.bank_account_number, f.ifsc_code, \r\n          f.society_id, f.machine_id, f.status, f.notes, f.cattle_count, f.created_at, f.updated_at,\r\n          s.name as society_name, s.society_id as society_identifier,\r\n          m.machine_id as machine_name, m.machine_type\r\n        FROM \\`${schemaName}\\`.farmers f\r\n        LEFT JOIN \\`${schemaName}\\`.societies s ON f.society_id = s.id\r\n        LEFT JOIN \\`${schemaName}\\`.machines m ON f.machine_id = m.id\r\n        WHERE f.id = ?\r\n      `;\r\n      replacements = [id];\r\n    } else {\r\n      // Query all farmers\r\n      query = `\r\n        SELECT \r\n          f.id, f.farmer_id, f.rf_id, f.name, f.password, f.phone, f.email, f.sms_enabled, \r\n          f.email_notifications_enabled, f.bonus, f.address, f.bank_name, f.bank_account_number, f.ifsc_code, \r\n          f.society_id, f.machine_id, f.status, f.notes, f.cattle_count, f.created_at, f.updated_at,\r\n          s.name as society_name, s.society_id as society_identifier,\r\n          m.machine_id as machine_name, m.machine_type\r\n        FROM \\`${schemaName}\\`.farmers f\r\n        LEFT JOIN \\`${schemaName}\\`.societies s ON f.society_id = s.id\r\n        LEFT JOIN \\`${schemaName}\\`.machines m ON f.machine_id = m.id\r\n        ORDER BY f.created_at DESC\r\n      `;\r\n    }\r\n\r\n    const [results] = await sequelize.query(query, { replacements });\r\n\r\n    const farmers = (results as FarmerQueryResult[]).map((farmer) => ({\r\n      id: farmer.id,\r\n      farmerId: farmer.farmer_id,\r\n      rfId: farmer.rf_id,\r\n      farmerName: farmer.name,\r\n      password: farmer.password,\r\n      contactNumber: farmer.phone,\r\n      email: farmer.email,\r\n      smsEnabled: farmer.sms_enabled || 'OFF',\r\n      emailNotificationsEnabled: farmer.email_notifications_enabled || 'ON',\r\n      bonus: Number(farmer.bonus) || 0,\r\n      address: farmer.address,\r\n      bankName: farmer.bank_name,\r\n      bankAccountNumber: farmer.bank_account_number,\r\n      ifscCode: farmer.ifsc_code,\r\n      societyId: farmer.society_id,\r\n      societyName: farmer.society_name,\r\n      societyIdentifier: farmer.society_identifier,\r\n      machineId: farmer.machine_id,\r\n      machineName: farmer.machine_name,\r\n      machineType: farmer.machine_type,\r\n      status: farmer.status || 'active',\r\n      notes: farmer.notes,\r\n      cattleCount: farmer.cattle_count,\r\n      createdAt: farmer.created_at,\r\n      updatedAt: farmer.updated_at\r\n    }));\r\n\r\n    if (id) {\r\n      console.log(`‚úÖ Retrieved farmer ${id} from schema: ${schemaName}`);\r\n      return createSuccessResponse('Farmer retrieved successfully', farmers);\r\n    } else {\r\n      console.log(`‚úÖ Retrieved ${farmers.length} farmers from schema: ${schemaName}`);\r\n      return createSuccessResponse('Farmers retrieved successfully', farmers);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('Error fetching farmers:', error);\r\n    return createErrorResponse('Failed to fetch farmers', 500);\r\n  }\r\n}\r\n\r\n// POST - Create new farmer or bulk upload\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return createErrorResponse('Authentication required', 401);\r\n    }\r\n\r\n    const payload = verifyToken(token);\r\n    if (!payload || payload.role !== 'admin') {\r\n      return createErrorResponse('Admin access required', 403);\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { farmers: bulkFarmers, ...singleFarmer } = body;\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    // Get admin's dbKey\r\n    const admin = await User.findByPk(payload.id);\r\n    if (!admin || !admin.dbKey) {\r\n      return createErrorResponse('Admin not found or database not configured', 404);\r\n    }\r\n\r\n    // Generate admin-specific schema name  \r\n    const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n    if (bulkFarmers && Array.isArray(bulkFarmers)) {\r\n      // Bulk upload\r\n      console.log(`üîÑ Processing bulk upload of ${bulkFarmers.length} farmers...`);\r\n      \r\n      const insertData = bulkFarmers.map((farmer: FarmerData) => [\r\n        farmer.farmerId,\r\n        farmer.rfId || null,\r\n        farmer.farmerName,\r\n        farmer.password || null,\r\n        farmer.contactNumber || null,\r\n        farmer.email || null,\r\n        farmer.smsEnabled || 'OFF',\r\n        farmer.emailNotificationsEnabled || 'ON',\r\n        farmer.bonus || 0,\r\n        farmer.address || null,\r\n        farmer.bankName || null,\r\n        farmer.bankAccountNumber || null,\r\n        farmer.ifscCode || null,\r\n        farmer.societyId || null,\r\n        farmer.machineId || null,\r\n        farmer.status || 'active',\r\n        farmer.notes || null\r\n      ]);\r\n\r\n      const query = `\r\n        INSERT INTO \\`${schemaName}\\`.farmers \r\n        (farmer_id, rf_id, name, password, phone, email, sms_enabled, email_notifications_enabled, bonus, address,\r\n         bank_name, bank_account_number, ifsc_code, society_id, machine_id, status, notes)\r\n        VALUES ${insertData.map(() => '(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)').join(', ')}\r\n      `;\r\n\r\n      const replacements = insertData.flat();\r\n      await sequelize.query(query, { replacements });\r\n      \r\n      console.log(`‚úÖ Successfully uploaded ${bulkFarmers.length} farmers to schema: ${schemaName}`);\r\n      return createSuccessResponse(`Successfully uploaded ${bulkFarmers.length} farmers`, null);\r\n\r\n    } else {\r\n      // Single farmer creation\r\n      const { \r\n        farmerId, rfId, farmerName, password, contactNumber, email, smsEnabled, \r\n        emailNotificationsEnabled, bonus, address, bankName, bankAccountNumber, ifscCode, societyId, \r\n        machineId, status, notes \r\n      }: FarmerData = singleFarmer;\r\n\r\n      if (!farmerId || !farmerName) {\r\n        return createErrorResponse('Farmer ID and name are required', 400);\r\n      }\r\n\r\n      // Check for global farmer email uniqueness across all admin schemas if provided\r\n      if (email && email.trim() !== '') {\r\n        const emailCheck = await checkGlobalFarmerEmailUniqueness(email);\r\n        if (!emailCheck.isUnique) {\r\n          console.log(`üìß Global duplicate farmer email detected: ${email} (exists in schema: ${emailCheck.existingSchema})`);\r\n          return createErrorResponse('Email address already exists in the system. Please use a different email.', 400);\r\n        }\r\n      }\r\n\r\n      const query = `\r\n        INSERT INTO \\`${schemaName}\\`.farmers \r\n        (farmer_id, rf_id, name, password, phone, email, sms_enabled, email_notifications_enabled, bonus, address, \r\n         bank_name, bank_account_number, ifsc_code, society_id, machine_id, status, notes)\r\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `;\r\n\r\n      const replacements = [\r\n        farmerId, rfId || null, farmerName, password || null, contactNumber || null,\r\n        email || null, smsEnabled || 'OFF', emailNotificationsEnabled || 'ON', bonus || 0, address || null, bankName || null,\r\n        bankAccountNumber || null, ifscCode || null, societyId || null,\r\n        machineId || null, status || 'active', notes || null\r\n      ];\r\n\r\n      await sequelize.query(query, { replacements });\r\n      \r\n      console.log(`‚úÖ Successfully created farmer: ${farmerId} in schema: ${schemaName}`);\r\n      return createSuccessResponse('Farmer created successfully', null);\r\n    }\r\n\r\n  } catch (error: any) {\r\n    console.error('Error creating farmer(s):', error);\r\n    \r\n    // Check for duplicate key errors (raw SQL queries)\r\n    const errorMessage = error?.message || error?.original?.sqlMessage || error?.parent?.sqlMessage || '';\r\n    const errorCode = error?.original?.code || error?.code || error?.parent?.code || '';\r\n    const errno = error?.original?.errno || error?.errno || error?.parent?.errno || '';\r\n    \r\n    // MySQL duplicate entry error code is ER_DUP_ENTRY or 1062\r\n    if (errorCode === 'ER_DUP_ENTRY' || errno === 1062 || errorMessage.includes('Duplicate entry')) {\r\n      // Check which field caused the duplicate\r\n      if (errorMessage.includes('farmer_id') || errorMessage.includes('unique_farmer_id')) {\r\n        return createErrorResponse('Farmer ID already exists', 400);\r\n      }\r\n      if (errorMessage.includes('email') || errorMessage.includes('unique_email')) {\r\n        return createErrorResponse('Email address already exists. Please use a different email.', 400);\r\n      }\r\n      if (errorMessage.includes('rf_id')) {\r\n        return createErrorResponse('RF-ID already exists', 400);\r\n      }\r\n      return createErrorResponse('Farmer ID, RF-ID, or Email already exists', 400);\r\n    }\r\n    \r\n    // Check for Sequelize unique constraint error\r\n    if (error?.name === 'SequelizeUniqueConstraintError') {\r\n      if (error?.original?.sqlMessage) {\r\n        if (error.original.sqlMessage.includes('farmer_id')) {\r\n          return createErrorResponse('Farmer ID already exists', 400);\r\n        }\r\n        if (error.original.sqlMessage.includes('email') || error.original.sqlMessage.includes('unique_email')) {\r\n          return createErrorResponse('Email address already exists. Please use a different email.', 400);\r\n        }\r\n      }\r\n      return createErrorResponse('Farmer ID, RF-ID, or Email already exists', 400);\r\n    }\r\n    \r\n    return createErrorResponse('Failed to create farmer(s)', 500);\r\n  }\r\n}\r\n\r\n// PUT - Update farmer (single or bulk)\r\nexport async function PUT(request: NextRequest) {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return createErrorResponse('Authentication required', 401);\r\n    }\r\n\r\n    const payload = verifyToken(token);\r\n    if (!payload || payload.role !== 'admin') {\r\n      return createErrorResponse('Admin access required', 403);\r\n    }\r\n\r\n    const body = await request.json();\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    // Get admin's dbKey\r\n    const admin = await User.findByPk(payload.id);\r\n    if (!admin || !admin.dbKey) {\r\n      return createErrorResponse('Admin not found or database not configured', 404);\r\n    }\r\n\r\n    // Generate admin-specific schema name  \r\n    const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n    // Check if this is a bulk status update\r\n    if (body.bulkStatusUpdate && Array.isArray(body.farmerIds)) {\r\n      const { farmerIds, status: newStatus } = body;\r\n      \r\n      if (!newStatus || farmerIds.length === 0) {\r\n        return createErrorResponse('Status and farmer IDs are required for bulk update', 400);\r\n      }\r\n\r\n      console.log(`üîÑ Processing bulk status update for ${farmerIds.length} farmers to status: ${newStatus}`);\r\n\r\n      // Use a single UPDATE query with IN clause for better performance\r\n      const placeholders = farmerIds.map(() => '?').join(',');\r\n      const query = `\r\n        UPDATE \\`${schemaName}\\`.farmers \r\n        SET status = ?, updated_at = CURRENT_TIMESTAMP\r\n        WHERE id IN (${placeholders})\r\n      `;\r\n\r\n      const replacements = [newStatus, ...farmerIds];\r\n      const [result] = await sequelize.query(query, { replacements });\r\n\r\n      // Check affected rows\r\n      const affectedRows = (result as any).affectedRows || 0;\r\n      \r\n      console.log(`‚úÖ Successfully updated status for ${affectedRows} farmers in schema: ${schemaName}`);\r\n      \r\n      if (affectedRows === 0) {\r\n        return createErrorResponse('No farmers were updated', 404);\r\n      }\r\n\r\n      return createSuccessResponse(\r\n        `Successfully updated status to \"${newStatus}\" for ${affectedRows} farmer(s)`, \r\n        { updated: affectedRows }\r\n      );\r\n    }\r\n\r\n    // Single farmer update\r\n    const { \r\n      id, farmerId, rfId, farmerName, password, contactNumber, email, smsEnabled, \r\n      emailNotificationsEnabled, bonus, address, bankName, bankAccountNumber, ifscCode, societyId, \r\n      machineId, status, notes \r\n    } = body;\r\n\r\n    if (!id || !farmerId || !farmerName) {\r\n      return createErrorResponse('ID, Farmer ID and name are required', 400);\r\n    }\r\n\r\n    // Check for global farmer email uniqueness across all admin schemas if provided (exclude current farmer)\r\n    if (email && email.trim() !== '') {\r\n      const emailCheck = await checkGlobalFarmerEmailUniqueness(email, id, schemaName);\r\n      if (!emailCheck.isUnique) {\r\n        console.log(`üìß Global duplicate farmer email detected: ${email} (exists in schema: ${emailCheck.existingSchema})`);\r\n        return createErrorResponse('Email address already exists in the system. Please use a different email.', 400);\r\n      }\r\n    }\r\n\r\n    const query = `\r\n      UPDATE \\`${schemaName}\\`.farmers \r\n      SET farmer_id = ?, rf_id = ?, name = ?, password = ?, phone = ?, email = ?,\r\n          sms_enabled = ?, email_notifications_enabled = ?, bonus = ?, address = ?, bank_name = ?,\r\n          bank_account_number = ?, ifsc_code = ?, society_id = ?, \r\n          machine_id = ?, status = ?, notes = ?, updated_at = CURRENT_TIMESTAMP\r\n      WHERE id = ?\r\n    `;\r\n\r\n    const replacements = [\r\n      farmerId, rfId || null, farmerName, password || null, contactNumber || null,\r\n      email || null, smsEnabled || 'OFF', emailNotificationsEnabled || 'ON', bonus || 0, address || null, bankName || null,\r\n      bankAccountNumber || null, ifscCode || null, societyId || null,\r\n      machineId || null, status || 'active', notes || null, id\r\n    ];\r\n\r\n    await sequelize.query(query, { replacements });\r\n\r\n    // Query to verify the update was successful\r\n    const verifyQuery = `SELECT id FROM \\`${schemaName}\\`.farmers WHERE id = ?`;\r\n    const [verification] = await sequelize.query(verifyQuery, { replacements: [id] });\r\n    \r\n    if (Array.isArray(verification) && verification.length === 0) {\r\n      return createErrorResponse('Farmer not found', 404);\r\n    }\r\n\r\n    console.log(`‚úÖ Successfully updated farmer: ${farmerId} in schema: ${schemaName}`);\r\n    return createSuccessResponse('Farmer updated successfully', null);\r\n\r\n  } catch (error: any) {\r\n    console.error('Error updating farmer:', error);\r\n    \r\n    // Check for duplicate key errors (raw SQL queries)\r\n    const errorMessage = error?.message || error?.original?.sqlMessage || '';\r\n    const errorCode = error?.original?.code || error?.code || '';\r\n    \r\n    // MySQL duplicate entry error code is ER_DUP_ENTRY or 1062\r\n    if (errorCode === 'ER_DUP_ENTRY' || errorCode === 1062 || errorMessage.includes('Duplicate entry')) {\r\n      // Check which field caused the duplicate\r\n      if (errorMessage.includes('farmer_id') || errorMessage.includes('unique_farmer_id')) {\r\n        return createErrorResponse('Farmer ID already exists', 400);\r\n      }\r\n      if (errorMessage.includes('email') || errorMessage.includes('unique_email')) {\r\n        return createErrorResponse('Email address already exists. Please use a different email.', 400);\r\n      }\r\n      if (errorMessage.includes('rf_id')) {\r\n        return createErrorResponse('RF-ID already exists', 400);\r\n      }\r\n      return createErrorResponse('Farmer ID, RF-ID, or Email already exists', 400);\r\n    }\r\n    \r\n    // Check for Sequelize unique constraint error\r\n    if (error?.name === 'SequelizeUniqueConstraintError') {\r\n      if (error?.original?.sqlMessage) {\r\n        if (error.original.sqlMessage.includes('farmer_id')) {\r\n          return createErrorResponse('Farmer ID already exists', 400);\r\n        }\r\n        if (error.original.sqlMessage.includes('email') || error.original.sqlMessage.includes('unique_email')) {\r\n          return createErrorResponse('Email address already exists. Please use a different email.', 400);\r\n        }\r\n      }\r\n      return createErrorResponse('Farmer ID, RF-ID, or Email already exists', 400);\r\n    }\r\n    \r\n    return createErrorResponse('Failed to update farmer', 500);\r\n  }\r\n}\r\n\r\n// DELETE - Delete farmer\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return createErrorResponse('Authentication required', 401);\r\n    }\r\n\r\n    const payload = verifyToken(token);\r\n    if (!payload || payload.role !== 'admin') {\r\n      return createErrorResponse('Admin access required', 403);\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const id = searchParams.get('id');\r\n    const idsParam = searchParams.get('ids');\r\n\r\n    if (!id && !idsParam) {\r\n      return createErrorResponse('Farmer ID(s) required', 400);\r\n    }\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    // Get admin's dbKey\r\n    const admin = await User.findByPk(payload.id);\r\n    if (!admin || !admin.dbKey) {\r\n      return createErrorResponse('Admin not found or database not configured', 404);\r\n    }\r\n\r\n    // Generate admin-specific schema name  \r\n    const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n    if (idsParam) {\r\n      // Bulk delete\r\n      const ids = JSON.parse(idsParam).map((id: string) => parseInt(id)).filter((id: number) => !isNaN(id));\r\n      \r\n      if (ids.length === 0) {\r\n        return createErrorResponse('No valid farmer IDs provided', 400);\r\n      }\r\n\r\n      // First verify all farmers exist\r\n      const placeholders = ids.map(() => '?').join(',');\r\n      const verifyQuery = `SELECT id FROM \\`${schemaName}\\`.farmers WHERE id IN (${placeholders})`;\r\n      const [verification] = await sequelize.query(verifyQuery, { replacements: ids });\r\n      \r\n      if (!Array.isArray(verification) || verification.length !== ids.length) {\r\n        return createErrorResponse('One or more farmers not found', 404);\r\n      }\r\n\r\n      // Delete the farmers\r\n      const deleteQuery = `DELETE FROM \\`${schemaName}\\`.farmers WHERE id IN (${placeholders})`;\r\n      await sequelize.query(deleteQuery, { replacements: ids });\r\n\r\n      console.log(`‚úÖ Successfully deleted ${ids.length} farmers from schema: ${schemaName}`);\r\n      return createSuccessResponse(`Successfully deleted ${ids.length} farmers`, null);\r\n    } else {\r\n      // Single delete\r\n      // First verify the farmer exists\r\n      const verifyQuery = `SELECT id FROM \\`${schemaName}\\`.farmers WHERE id = ?`;\r\n      const [verification] = await sequelize.query(verifyQuery, { replacements: [id] });\r\n      \r\n      if (Array.isArray(verification) && verification.length === 0) {\r\n        return createErrorResponse('Farmer not found', 404);\r\n      }\r\n\r\n      // Delete the farmer\r\n      const query = `DELETE FROM \\`${schemaName}\\`.farmers WHERE id = ?`;\r\n      await sequelize.query(query, { replacements: [id] });\r\n\r\n      console.log(`‚úÖ Successfully deleted farmer with ID: ${id} from schema: ${schemaName}`);\r\n      return createSuccessResponse('Farmer deleted successfully', null);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('Error deleting farmer:', error);\r\n    return createErrorResponse('Failed to delete farmer', 500);\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}