{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/database.ts"],"sourcesContent":["import { Sequelize } from 'sequelize';\r\nimport mysql2 from 'mysql2';\r\nimport path from 'path';\r\n\r\n// Database configuration for Azure MySQL\r\nlet sequelize: Sequelize | null = null;\r\n\r\nconst createSequelizeInstance = () => {\r\n    if (!sequelize) {\r\n    // Don't initialize during build time\r\n    if (process.env.NODE_ENV === 'development' || process.env.BUILDING !== 'true') {\r\n      // Determine SSL configuration based on environment\r\n      // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n      const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n        require: true,\r\n        rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n        ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n      } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n        require: true,\r\n        rejectUnauthorized: false,\r\n      } : false;      sequelize = new Sequelize(\r\n      process.env.DB_NAME || 'psr_v4_main',\r\n      process.env.DB_USER || 'psr_admin',\r\n      process.env.DB_PASSWORD || 'Access@404',\r\n      {\r\n        host: process.env.DB_HOST || 'localhost',\r\n        port: parseInt(process.env.DB_PORT || '3306'),\r\n        dialect: 'mysql',\r\n        dialectModule: mysql2,\r\n        timezone: '+05:30', // Use Indian Standard Time (IST)\r\n        dialectOptions: {\r\n          ssl: sslConfig,\r\n          connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        },\r\n        pool: {\r\n          max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n          min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n          acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n          idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n        },\r\n        logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n        benchmark: process.env.NODE_ENV === 'development',\r\n      }\r\n    );\r\n    }\r\n  }\r\n  return sequelize;\r\n};\r\n\r\n// Test database connection\r\nexport const testConnection = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    await db.authenticate();\r\n    console.log('‚úÖ Database connection established successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Unable to connect to the database:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Initialize database\r\nexport const initDatabase = async (useMigrations: boolean = false) => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    \r\n    if (useMigrations) {\r\n      // Use migrations instead of sync for production\r\n      const { migrationRunner } = await import('./migrations');\r\n      await migrationRunner.initializeDatabase();\r\n    } else {\r\n      // Development mode - use sync\r\n      await db.sync({ alter: process.env.NODE_ENV === 'development' });\r\n    }\r\n    \r\n    console.log('‚úÖ Database synchronized successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Database synchronization failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Connect to database\r\nexport const connectDB = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.authenticate();\r\n    return db;\r\n  } catch (error) {\r\n    console.error('‚ùå Database connection failed:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to create admin-specific schema\r\nexport const createAdminSchema = async (adminEmail: string): Promise<string> => {\r\n  try {\r\n    // Generate DB key: db-<first 3 letters of email><3 random numbers>\r\n    const emailPrefix = adminEmail.substring(0, 3).toLowerCase();\r\n    const randomSuffix = Math.floor(100 + Math.random() * 900).toString();\r\n    const dbKey = `db_${emailPrefix}${randomSuffix}`;\r\n    \r\n    // Create new database schema\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.query(`CREATE DATABASE IF NOT EXISTS \\`${dbKey}\\``);\r\n    \r\n    console.log(`‚úÖ Created admin schema: ${dbKey}`);\r\n    return dbKey;\r\n  } catch (error) {\r\n    console.error('‚ùå Failed to create admin schema:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to get connection for specific admin schema\r\nexport const getAdminConnection = (dbKey: string): Sequelize => {\r\n  // Determine SSL configuration based on environment\r\n  // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n  const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n    require: true,\r\n    rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n    ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n  } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n    require: true,\r\n    rejectUnauthorized: false,\r\n  } : false;\r\n\r\n  return new Sequelize(\r\n    dbKey,\r\n    process.env.DB_USER || 'psr_admin',\r\n    process.env.DB_PASSWORD || '',\r\n    {\r\n      host: process.env.DB_HOST || 'localhost',\r\n      port: parseInt(process.env.DB_PORT || '3306'),\r\n      dialect: 'mysql',\r\n      dialectModule: mysql2,\r\n      dialectOptions: {\r\n        ssl: sslConfig,\r\n        connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        acquireTimeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n        timeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n      },\r\n      pool: {\r\n        max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n        min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n        acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n      },\r\n      logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n    }\r\n  );\r\n};\r\n\r\nexport default createSequelizeInstance;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 302, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/sectionPulseTracker.ts"],"sourcesContent":["import { Sequelize, QueryTypes } from 'sequelize';\r\n\r\n/**\r\n * Section Pulse Tracker\r\n * \r\n * Tracks first and last milk collections per society per day\r\n * Manages section start/end pulse and inactivity periods\r\n */\r\n\r\ninterface PulseUpdateResult {\r\n  societyId: number;\r\n  pulseDate: string;\r\n  firstCollectionTime: Date | null;\r\n  lastCollectionTime: Date | null;\r\n  sectionEndTime: Date | null;\r\n  pulseStatus: 'not_started' | 'active' | 'paused' | 'ended' | 'inactive';\r\n  totalCollections: number;\r\n  inactiveDays: number;\r\n  createdAt?: Date | string | null;\r\n}\r\n\r\nexport class SectionPulseTracker {\r\n  /**\r\n   * Update pulse on new milk collection\r\n   * - Records first collection time (section start pulse)\r\n   * - Updates last collection time\r\n   * - Increments total collections counter (only for new collections)\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   * @param societyId Society database ID\r\n   * @param collectionDateTime Collection datetime (YYYY-MM-DD HH:MM:SS)\r\n   * @param isNewCollection Whether this is a new collection (not a duplicate update)\r\n   */\r\n  static async updatePulseOnCollection(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    societyId: number,\r\n    collectionDateTime: Date | string,\r\n    isNewCollection: boolean = true\r\n  ): Promise<void> {\r\n    try {\r\n      // Parse collection datetime - handle both string and Date\r\n      // Store as string to preserve IST timezone when passing to MySQL\r\n      let collectionDateStr: string;\r\n      let dateStr: string;\r\n      \r\n      if (typeof collectionDateTime === 'string') {\r\n        // If it's a string like \"2025-12-02 01:00:26\", use it directly\r\n        collectionDateStr = collectionDateTime;\r\n        dateStr = collectionDateTime.split(' ')[0]; // Get \"2025-12-02\"\r\n      } else {\r\n        // Convert Date to IST string format: YYYY-MM-DD HH:MM:SS\r\n        const offset = 5.5 * 60 * 60 * 1000; // IST offset in milliseconds\r\n        const istDate = new Date(collectionDateTime.getTime() + offset);\r\n        collectionDateStr = istDate.toISOString().slice(0, 19).replace('T', ' ');\r\n        dateStr = collectionDateStr.split(' ')[0];\r\n      }\r\n\r\n      console.log(`üìç Updating pulse for society ${societyId} on ${dateStr} at ${collectionDateStr}`);\r\n      console.log(`   üî¢ isNewCollection flag: ${isNewCollection} (will ${isNewCollection ? 'INCREMENT' : 'NOT INCREMENT'} total_collections)`);\r\n\r\n      // Check if pulse record exists for today\r\n      const existingPulse = await sequelize.query<{\r\n        id: number;\r\n        first_collection_time: Date | null;\r\n        total_collections: number;\r\n        pulse_status: string;\r\n      }>(`\r\n        SELECT id, first_collection_time, total_collections, pulse_status\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE society_id = ? AND DATE(pulse_date) = ?\r\n      `, {\r\n        replacements: [societyId, dateStr],\r\n        type: QueryTypes.SELECT\r\n      });\r\n\r\n      console.log(`üîç Query result:`, { length: existingPulse?.length, data: existingPulse });\r\n\r\n      if (!existingPulse || existingPulse.length === 0) {\r\n        // First collection of the day - create new pulse record\r\n        await sequelize.query(`\r\n          INSERT INTO \\`${schemaName}\\`.section_pulse (\r\n            society_id,\r\n            pulse_date,\r\n            first_collection_time,\r\n            last_collection_time,\r\n            pulse_status,\r\n            total_collections,\r\n            inactive_days,\r\n            last_checked,\r\n            created_at,\r\n            updated_at\r\n          ) VALUES (?, ?, ?, ?, 'active', 1, 0, NOW(), CONVERT_TZ(NOW(), '+00:00', '+05:30'), CONVERT_TZ(NOW(), '+00:00', '+05:30'))\r\n        `, {\r\n          replacements: [\r\n            societyId,\r\n            dateStr,\r\n            collectionDateStr,\r\n            collectionDateStr\r\n          ]\r\n        });\r\n\r\n        console.log(`üü¢ Section start pulse recorded at ${collectionDateStr}`);\r\n      } else {\r\n        // Update existing pulse record - restart if paused or ended\r\n        const currentStatus = existingPulse[0].pulse_status;\r\n        \r\n        // Only increment total_collections if this is a new collection (not a duplicate update)\r\n        const updateQuery = isNewCollection \r\n          ? `UPDATE \\`${schemaName}\\`.section_pulse\r\n             SET \r\n               last_collection_time = ?,\r\n               total_collections = total_collections + 1,\r\n               pulse_status = 'active',\r\n               section_end_time = NULL,\r\n               last_checked = NOW(),\r\n               updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n             WHERE society_id = ? AND DATE(pulse_date) = ?`\r\n          : `UPDATE \\`${schemaName}\\`.section_pulse\r\n             SET \r\n               last_collection_time = ?,\r\n               pulse_status = 'active',\r\n               section_end_time = NULL,\r\n               last_checked = NOW(),\r\n               updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n             WHERE society_id = ? AND DATE(pulse_date) = ?`;\r\n        \r\n        await sequelize.query(updateQuery, {\r\n          replacements: [collectionDateStr, societyId, dateStr]\r\n        });\r\n\r\n        if (currentStatus === 'paused') {\r\n          console.log(`‚ñ∂Ô∏è Section restarted from pause - collection at ${collectionDateStr}`);\r\n        } else if (currentStatus === 'ended') {\r\n          console.log(`üîÑ Section restarted from ended state - collection at ${collectionDateStr}`);\r\n        } else {\r\n          console.log(`üîµ Pulse updated - last collection at ${collectionDateStr}${isNewCollection ? '' : ' (duplicate, count unchanged)'}`);\r\n        }\r\n      }\r\n\r\n      // Reset inactive days counter since we have activity\r\n      await this.resetInactiveDays(sequelize, schemaName, societyId, dateStr);\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error updating pulse on collection:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check for section pause (5 minutes of inactivity) and section end (60 minutes)\r\n   * Should be called periodically (e.g., every 1-2 minutes)\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   */\r\n  static async checkSectionPauseAndEnd(\r\n    sequelize: Sequelize,\r\n    schemaName: string\r\n  ): Promise<void> {\r\n    try {\r\n      const now = new Date();\r\n      const today = now.toISOString().split('T')[0];\r\n      const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);\r\n      const sixtyMinutesAgo = new Date(now.getTime() - 60 * 60 * 1000);\r\n\r\n      // 1. End all active/paused sections from previous days\r\n      const [oldPulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status IN ('active', 'paused')\r\n        AND DATE(pulse_date) < ?\r\n        AND section_end_time IS NULL\r\n      `, {\r\n        replacements: [today],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      // Mark old sections as ended\r\n      for (const pulse of (oldPulses || [])) {\r\n        const sectionEndTime = pulse.last_collection_time ? \r\n          new Date(new Date(pulse.last_collection_time).getTime() + 60 * 60 * 1000) : null;\r\n\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            section_end_time = ?,\r\n            pulse_status = 'ended',\r\n            last_checked = NOW(),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [sectionEndTime, pulse.id]\r\n        });\r\n\r\n        console.log(`üî¥ Old section ended for society ${pulse.society_id} (date: ${pulse.pulse_date})`);\r\n      }\r\n\r\n      // 2. Check for sections to pause (5 minutes inactive, currently active, TODAY only)\r\n      const [activePulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status = 'active'\r\n        AND DATE(pulse_date) = ?\r\n        AND last_collection_time IS NOT NULL\r\n        AND last_collection_time <= ?\r\n        AND last_collection_time > ?\r\n      `, {\r\n        replacements: [today, fiveMinutesAgo, sixtyMinutesAgo],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      // Mark sections as paused\r\n      for (const pulse of (activePulses || [])) {\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            pulse_status = 'paused',\r\n            last_checked = NOW(),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [pulse.id]\r\n        });\r\n\r\n        console.log(`‚è∏Ô∏è Section paused for society ${pulse.society_id} - no collection for 5 minutes`);\r\n      }\r\n\r\n      // 3. Check for sections to end (60 minutes inactive, currently active or paused, TODAY only)\r\n      const [inactivePulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status IN ('active', 'paused')\r\n        AND DATE(pulse_date) = ?\r\n        AND last_collection_time IS NOT NULL\r\n        AND last_collection_time <= ?\r\n        AND section_end_time IS NULL\r\n      `, {\r\n        replacements: [today, sixtyMinutesAgo],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      // Mark sections as ended\r\n      for (const pulse of (inactivePulses || [])) {\r\n        const sectionEndTime = new Date(pulse.last_collection_time.getTime() + 60 * 60 * 1000);\r\n\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            section_end_time = ?,\r\n            pulse_status = 'ended',\r\n            last_checked = CONVERT_TZ(NOW(), '+00:00', '+05:30'),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [sectionEndTime, pulse.id]\r\n        });\r\n\r\n        console.log(`üî¥ Section end pulse recorded for society ${pulse.society_id} at ${sectionEndTime.toISOString()}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error checking section pause and end:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check for section end (60 minutes of inactivity after last collection)\r\n   * Should be called periodically (e.g., every 10-15 minutes)\r\n   * \r\n   * @deprecated Use checkSectionPauseAndEnd instead for better granularity\r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   */\r\n  static async checkSectionEnd(\r\n    sequelize: Sequelize,\r\n    schemaName: string\r\n  ): Promise<void> {\r\n    try {\r\n      const now = new Date();\r\n      const sixtyMinutesAgo = new Date(now.getTime() - 60 * 60 * 1000);\r\n\r\n      // Find active pulses where last collection was > 60 minutes ago\r\n      const [activePulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status = 'active'\r\n        AND last_collection_time IS NOT NULL\r\n        AND last_collection_time <= ?\r\n        AND section_end_time IS NULL\r\n      `, {\r\n        replacements: [sixtyMinutesAgo],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      for (const pulse of (activePulses || [])) {\r\n        const sectionEndTime = new Date(pulse.last_collection_time.getTime() + 60 * 60 * 1000);\r\n\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            section_end_time = ?,\r\n            pulse_status = 'ended',\r\n            last_checked = CONVERT_TZ(NOW(), '+00:00', '+05:30'),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [sectionEndTime, pulse.id]\r\n        });\r\n\r\n        console.log(`üî¥ Section end pulse recorded for society ${pulse.society_id} at ${sectionEndTime.toISOString()}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error checking section end:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check for multi-day inactivity\r\n   * Updates inactive_days counter for societies without collections\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   */\r\n  static async checkInactivity(\r\n    sequelize: Sequelize,\r\n    schemaName: string\r\n  ): Promise<void> {\r\n    try {\r\n      const today = new Date().toISOString().split('T')[0];\r\n      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];\r\n\r\n      // Get all societies\r\n      const [societies] = await sequelize.query<{ id: number }>(`\r\n        SELECT id FROM \\`${schemaName}\\`.societies\r\n        WHERE status = 'active'\r\n      `, {\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{ id: number }[]];\r\n\r\n      for (const society of (societies || [])) {\r\n        // Check if society has pulse record for today\r\n        const [todayPulse] = await sequelize.query<{ id: number }>(`\r\n          SELECT id FROM \\`${schemaName}\\`.section_pulse\r\n          WHERE society_id = ? AND DATE(pulse_date) = ?\r\n        `, {\r\n          replacements: [society.id, today],\r\n          type: QueryTypes.SELECT\r\n        }) as unknown as [{ id: number }[]];\r\n\r\n        if (!todayPulse || todayPulse.length === 0) {\r\n          // No pulse today - check yesterday's pulse\r\n          const [yesterdayPulse] = await sequelize.query<{\r\n            inactive_days: number;\r\n            pulse_status: string;\r\n          }>(`\r\n            SELECT inactive_days, pulse_status\r\n            FROM \\`${schemaName}\\`.section_pulse\r\n            WHERE society_id = ? AND DATE(pulse_date) = ?\r\n          `, {\r\n            replacements: [society.id, yesterday],\r\n            type: QueryTypes.SELECT\r\n          }) as unknown as [{\r\n            inactive_days: number;\r\n            pulse_status: string;\r\n          }[]];\r\n\r\n          let inactiveDays = 1;\r\n          if (yesterdayPulse && yesterdayPulse.length > 0) {\r\n            inactiveDays = (yesterdayPulse[0].inactive_days || 0) + 1;\r\n          }\r\n\r\n          // Create today's pulse record with inactive status\r\n          await sequelize.query(`\r\n            INSERT INTO \\`${schemaName}\\`.section_pulse (\r\n              society_id,\r\n              pulse_date,\r\n              pulse_status,\r\n              inactive_days,\r\n              last_checked,\r\n              created_at,\r\n              updated_at\r\n            ) VALUES (?, ?, 'inactive', ?, NOW(), CONVERT_TZ(NOW(), '+00:00', '+05:30'), CONVERT_TZ(NOW(), '+00:00', '+05:30'))\r\n            ON DUPLICATE KEY UPDATE\r\n              pulse_status = 'inactive',\r\n              inactive_days = ?,\r\n              last_checked = NOW(),\r\n              updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          `, {\r\n            replacements: [society.id, today, inactiveDays, inactiveDays]\r\n          });\r\n\r\n          console.log(`‚ö™ No pulse for society ${society.id} - ${inactiveDays} day(s) inactive`);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error checking inactivity:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Reset inactive days counter\r\n   */\r\n  private static async resetInactiveDays(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    societyId: number,\r\n    pulseDate: string\r\n  ): Promise<void> {\r\n    await sequelize.query(`\r\n      UPDATE \\`${schemaName}\\`.section_pulse\r\n      SET inactive_days = 0\r\n      WHERE society_id = ? AND DATE(pulse_date) = ?\r\n    `, {\r\n      replacements: [societyId, pulseDate]\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get pulse status for a society\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   * @param societyId Society database ID\r\n   * @param date Date string (YYYY-MM-DD) - defaults to today\r\n   */\r\n  static async getPulseStatus(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    societyId: number,\r\n    date?: string\r\n  ): Promise<PulseUpdateResult | null> {\r\n    try {\r\n      const pulseDate = date || new Date().toISOString().split('T')[0];\r\n\r\n      const pulseRecords = await sequelize.query(`\r\n        SELECT \r\n          society_id,\r\n          pulse_date,\r\n          first_collection_time,\r\n          last_collection_time,\r\n          section_end_time,\r\n          pulse_status,\r\n          total_collections,\r\n          inactive_days,\r\n          created_at\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE society_id = ? AND DATE(pulse_date) = ?\r\n      `, {\r\n        replacements: [societyId, pulseDate],\r\n        type: QueryTypes.SELECT\r\n      }) as {\r\n        society_id: number;\r\n        pulse_date: string;\r\n        first_collection_time: Date | null;\r\n        last_collection_time: Date | null;\r\n        section_end_time: Date | null;\r\n        pulse_status: 'not_started' | 'active' | 'paused' | 'ended' | 'inactive';\r\n        total_collections: number;\r\n        inactive_days: number;\r\n        created_at: Date | null;\r\n      }[];\r\n\r\n      if (!pulseRecords || pulseRecords.length === 0) {\r\n        // No pulse record exists - section not started\r\n        return {\r\n          societyId,\r\n          pulseDate,\r\n          firstCollectionTime: null,\r\n          lastCollectionTime: null,\r\n          sectionEndTime: null,\r\n          pulseStatus: 'not_started',\r\n          totalCollections: 0,\r\n          inactiveDays: 0,\r\n          createdAt: null\r\n        };\r\n      }\r\n\r\n      const pulse = pulseRecords[0];\r\n      return {\r\n        societyId: pulse.society_id,\r\n        pulseDate: pulse.pulse_date,\r\n        firstCollectionTime: pulse.first_collection_time,\r\n        lastCollectionTime: pulse.last_collection_time,\r\n        sectionEndTime: pulse.section_end_time,\r\n        pulseStatus: pulse.pulse_status,\r\n        totalCollections: pulse.total_collections,\r\n        inactiveDays: pulse.inactive_days,\r\n        createdAt: pulse.created_at\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error getting pulse status:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get pulse status for all societies\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   * @param date Date string (YYYY-MM-DD) - defaults to today\r\n   */\r\n  static async getAllPulseStatuses(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    date?: string\r\n  ): Promise<PulseUpdateResult[]> {\r\n    try {\r\n      const pulseDate = date || new Date().toISOString().split('T')[0];\r\n\r\n      const pulseRecords = await sequelize.query(`\r\n        SELECT \r\n          s.id as society_id,\r\n          s.name as society_name,\r\n          COALESCE(sp.pulse_date, ?) as pulse_date,\r\n          sp.first_collection_time,\r\n          sp.last_collection_time,\r\n          sp.section_end_time,\r\n          COALESCE(sp.pulse_status, 'not_started') as pulse_status,\r\n          COALESCE(sp.total_collections, 0) as total_collections,\r\n          COALESCE(sp.inactive_days, 0) as inactive_days,\r\n          sp.created_at\r\n        FROM \\`${schemaName}\\`.societies s\r\n        LEFT JOIN \\`${schemaName}\\`.section_pulse sp \r\n          ON s.id = sp.society_id AND DATE(sp.pulse_date) = ?\r\n        WHERE s.status = 'active'\r\n        ORDER BY s.name\r\n      `, {\r\n        replacements: [pulseDate, pulseDate],\r\n        type: QueryTypes.SELECT\r\n      }) as {\r\n        society_id: number;\r\n        society_name: string;\r\n        pulse_date: string;\r\n        first_collection_time: Date | null;\r\n        last_collection_time: Date | null;\r\n        section_end_time: Date | null;\r\n        pulse_status: 'not_started' | 'active' | 'ended' | 'inactive';\r\n        total_collections: number;\r\n        inactive_days: number;\r\n        created_at: Date | null;\r\n      }[];\r\n\r\n      return (pulseRecords || []).map(pulse => ({\r\n        societyId: pulse.society_id,\r\n        pulseDate: pulse.pulse_date,\r\n        firstCollectionTime: pulse.first_collection_time,\r\n        lastCollectionTime: pulse.last_collection_time,\r\n        sectionEndTime: pulse.section_end_time,\r\n        pulseStatus: pulse.pulse_status,\r\n        totalCollections: pulse.total_collections,\r\n        inactiveDays: pulse.inactive_days,\r\n        createdAt: pulse.created_at\r\n      }));\r\n    } catch (error) {\r\n      console.error('‚ùå Error getting all pulse statuses:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 799, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/models/User.ts"],"sourcesContent":["import { DataTypes, Model, Sequelize } from 'sequelize';\r\nimport bcrypt from 'bcryptjs';\r\n\r\n// User roles in hierarchical order\r\nexport enum UserRole {\r\n  SUPER_ADMIN = 'super_admin',\r\n  ADMIN = 'admin',\r\n  DAIRY = 'dairy',\r\n  BMC = 'bmc',\r\n  SOCIETY = 'society',\r\n  FARMER = 'farmer'\r\n}\r\n\r\n// User status\r\nexport enum UserStatus {\r\n  PENDING = 'pending',\r\n  PENDING_APPROVAL = 'pending_approval', // Email verified, waiting for super admin approval\r\n  ACTIVE = 'active',\r\n  INACTIVE = 'inactive',\r\n  SUSPENDED = 'suspended'\r\n}\r\n\r\n// User attributes interface\r\nexport interface UserAttributes {\r\n  id?: number;\r\n  uid: string;\r\n  email: string;\r\n  password: string;\r\n  fullName: string;\r\n  role: UserRole;\r\n  status: UserStatus;\r\n  dbKey?: string; // For admins - their dedicated schema key\r\n  companyName?: string;\r\n  companyPincode?: string;\r\n  companyCity?: string;\r\n  companyState?: string;\r\n  parentId?: number; // Reference to parent user in hierarchy\r\n  isEmailVerified: boolean;\r\n  emailVerificationToken?: string;\r\n  emailVerificationExpires?: Date;\r\n  passwordResetToken?: string;\r\n  passwordResetExpires?: Date;\r\n  otpCode?: string;\r\n  otpExpires?: Date;\r\n  lastLogin?: Date;\r\n  loginAttempts: number;\r\n  lockUntil?: Date;\r\n  createdAt?: Date;\r\n  updatedAt?: Date;\r\n}\r\n\r\n// User model class\r\nclass User extends Model<UserAttributes> implements UserAttributes {\r\n  // Remove public class fields to avoid shadowing Sequelize getters/setters\r\n  declare id: number;\r\n  declare uid: string;\r\n  declare email: string;\r\n  declare password: string;\r\n  declare fullName: string;\r\n  declare role: UserRole;\r\n  declare status: UserStatus;\r\n  declare dbKey?: string;\r\n  declare companyName?: string;\r\n  declare companyPincode?: string;\r\n  declare companyCity?: string;\r\n  declare companyState?: string;\r\n  declare parentId?: number;\r\n  declare isEmailVerified: boolean;\r\n  declare emailVerificationToken?: string;\r\n  declare emailVerificationExpires?: Date;\r\n  declare passwordResetToken?: string;\r\n  declare passwordResetExpires?: Date;\r\n  declare otpCode?: string;\r\n  declare otpExpires?: Date;\r\n  declare lastLogin?: Date;\r\n  declare loginAttempts: number;\r\n  declare lockUntil?: Date;\r\n\r\n  // Timestamps\r\n  declare readonly createdAt: Date;\r\n  declare readonly updatedAt: Date;\r\n\r\n  // Instance methods\r\n  public async comparePassword(candidatePassword: string): Promise<boolean> {\r\n    return bcrypt.compare(candidatePassword, this.password);\r\n  }\r\n\r\n  public async incLoginAttempts(): Promise<void> {\r\n    // If we have a previous lock that has expired, restart at 1\r\n    if (this.lockUntil && this.lockUntil < new Date()) {\r\n      await this.update({\r\n        loginAttempts: 1,\r\n        lockUntil: undefined\r\n      });\r\n      return;\r\n    }\r\n\r\n    const updates: Partial<UserAttributes> = { loginAttempts: this.loginAttempts + 1 };\r\n\r\n    // Lock account after 5 failed attempts for 2 hours\r\n    if (this.loginAttempts + 1 >= 5 && !this.isLocked) {\r\n      updates.lockUntil = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours\r\n    }\r\n\r\n    await this.update(updates);\r\n  }\r\n\r\n  public async resetLoginAttempts(): Promise<void> {\r\n    await this.update({\r\n      loginAttempts: 0,\r\n      lockUntil: undefined\r\n    });\r\n  }\r\n\r\n  public get isLocked(): boolean {\r\n    return !!(this.lockUntil && this.lockUntil > new Date());\r\n  }\r\n\r\n\r\n\r\n  public canManageRole(targetRole: UserRole): boolean {\r\n    const roleHierarchy = [\r\n      UserRole.SUPER_ADMIN,\r\n      UserRole.ADMIN,\r\n      UserRole.DAIRY,\r\n      UserRole.BMC,\r\n      UserRole.SOCIETY,\r\n      UserRole.FARMER\r\n    ];\r\n\r\n    const currentRoleIndex = roleHierarchy.indexOf(this.role);\r\n    const targetRoleIndex = roleHierarchy.indexOf(targetRole);\r\n\r\n    return currentRoleIndex < targetRoleIndex;\r\n  }\r\n}\r\n\r\n// Initialize User model\r\nexport const initUserModel = (sequelize: Sequelize): typeof User => {\r\n  User.init(\r\n    {\r\n      id: {\r\n        type: DataTypes.INTEGER,\r\n        primaryKey: true,\r\n        autoIncrement: true,\r\n      },\r\n      uid: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: false,\r\n        unique: true,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [3, 50]\r\n        }\r\n      },\r\n      email: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: false,\r\n        unique: true,\r\n        validate: {\r\n          isEmail: true,\r\n          notEmpty: true\r\n        }\r\n      },\r\n      password: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: false,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [6, 255]\r\n        }\r\n      },\r\n      fullName: {\r\n        type: DataTypes.STRING(200),\r\n        allowNull: false,\r\n        validate: {\r\n          notEmpty: true,\r\n          len: [2, 200]\r\n        }\r\n      },\r\n      role: {\r\n        type: DataTypes.ENUM(...Object.values(UserRole)),\r\n        allowNull: false,\r\n        defaultValue: UserRole.FARMER\r\n      },\r\n      status: {\r\n        type: DataTypes.ENUM(...Object.values(UserStatus)),\r\n        allowNull: false,\r\n        defaultValue: UserStatus.PENDING\r\n      },\r\n      dbKey: {\r\n        type: DataTypes.STRING(50),\r\n        allowNull: true,\r\n        unique: true,\r\n        comment: 'Dedicated database schema key for admins'\r\n      },\r\n      companyName: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      companyPincode: {\r\n        type: DataTypes.STRING(10),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [5, 10]\r\n        }\r\n      },\r\n      companyCity: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [2, 100]\r\n        }\r\n      },\r\n      companyState: {\r\n        type: DataTypes.STRING(100),\r\n        allowNull: true,\r\n        validate: {\r\n          len: [2, 100]\r\n        }\r\n      },\r\n      parentId: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: true,\r\n        references: {\r\n          model: 'users',\r\n          key: 'id'\r\n        }\r\n      },\r\n      isEmailVerified: {\r\n        type: DataTypes.BOOLEAN,\r\n        allowNull: false,\r\n        defaultValue: false\r\n      },\r\n      emailVerificationToken: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      emailVerificationExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      passwordResetToken: {\r\n        type: DataTypes.STRING(255),\r\n        allowNull: true\r\n      },\r\n      passwordResetExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      otpCode: {\r\n        type: DataTypes.STRING(10),\r\n        allowNull: true\r\n      },\r\n      otpExpires: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      lastLogin: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      },\r\n      loginAttempts: {\r\n        type: DataTypes.INTEGER,\r\n        allowNull: false,\r\n        defaultValue: 0\r\n      },\r\n      lockUntil: {\r\n        type: DataTypes.DATE,\r\n        allowNull: true\r\n      }\r\n    },\r\n    {\r\n      sequelize,\r\n      modelName: 'User',\r\n      tableName: 'users',\r\n      timestamps: true,\r\n      hooks: {\r\n        beforeSave: async (user: User) => {\r\n          // Hash password if it's being modified\r\n          if (user.changed('password') && user.password) {\r\n            const salt = await bcrypt.genSalt(12);\r\n            user.password = await bcrypt.hash(user.password, salt);\r\n          }\r\n\r\n          // Generate UID if not provided\r\n          if (!user.uid && user.email) {\r\n            const timestamp = Date.now().toString().slice(-6);\r\n            const emailPrefix = user.email.substring(0, 3).toUpperCase();\r\n            user.uid = `${emailPrefix}${timestamp}`;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  );\r\n\r\n  // Define associations\r\n  User.hasMany(User, { \r\n    as: 'Children', \r\n    foreignKey: 'parentId',\r\n    onDelete: 'SET NULL'\r\n  });\r\n  \r\n  User.belongsTo(User, { \r\n    as: 'Parent', \r\n    foreignKey: 'parentId',\r\n    onDelete: 'SET NULL'\r\n  });\r\n\r\n  return User;\r\n};\r\n\r\nexport default User;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1066, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/auth.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport crypto from 'crypto';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// JWT configuration\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-super-secret-jwt-key';\r\nconst JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || 'your-super-secret-refresh-jwt-key';\r\n\r\n// JWT payload interface\r\nexport interface JWTPayload {\r\n  id: number;\r\n  uid: string;\r\n  email: string;\r\n  role: UserRole;\r\n  dbKey?: string;\r\n}\r\n\r\n// Generate JWT tokens\r\nexport const generateTokens = (user: JWTPayload) => {\r\n  const payload = {\r\n    id: user.id,\r\n    uid: user.uid,\r\n    email: user.email,\r\n    role: user.role,\r\n    dbKey: user.dbKey\r\n  };\r\n\r\n  const token = jwt.sign(payload, JWT_SECRET as string, {\r\n    expiresIn: '7d',\r\n    issuer: 'poornasree-equipments-cloud',\r\n    audience: 'psr-client'\r\n  });\r\n\r\n  const refreshToken = jwt.sign(payload, JWT_REFRESH_SECRET as string, {\r\n    expiresIn: '30d',\r\n    issuer: 'poornasree-equipments-cloud',\r\n    audience: 'psr-client'\r\n  });\r\n\r\n  return { token, refreshToken };\r\n};\r\n\r\n// Verify JWT token\r\nexport const verifyToken = (token: string): JWTPayload | null => {\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET as string, {\r\n      issuer: 'poornasree-equipments-cloud',\r\n      audience: 'psr-client'\r\n    }) as JWTPayload;\r\n    return decoded;\r\n  } catch (error) {\r\n    console.error('JWT verification failed:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Verify refresh token\r\nexport const verifyRefreshToken = (token: string): JWTPayload | null => {\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_REFRESH_SECRET as string, {\r\n      issuer: 'poornasree-equipments-cloud',\r\n      audience: 'psr-client'\r\n    }) as JWTPayload;\r\n    return decoded;\r\n  } catch (error) {\r\n    console.error('Refresh token verification failed:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// Generate random token\r\nexport const generateRandomToken = (length: number = 32): string => {\r\n  return crypto.randomBytes(length).toString('hex');\r\n};\r\n\r\n// Generate OTP\r\nexport const generateOTP = (length: number = 6): string => {\r\n  const digits = '0123456789';\r\n  let otp = '';\r\n  for (let i = 0; i < length; i++) {\r\n    otp += digits[Math.floor(Math.random() * digits.length)];\r\n  }\r\n  return otp;\r\n};\r\n\r\n// Hash token for database storage\r\nexport const hashToken = (token: string): string => {\r\n  return crypto.createHash('sha256').update(token).digest('hex');\r\n};\r\n\r\n// Role hierarchy checker\r\nexport const canManageRole = (userRole: UserRole, targetRole: UserRole): boolean => {\r\n  const roleHierarchy: Record<UserRole, number> = {\r\n    [UserRole.SUPER_ADMIN]: 0,\r\n    [UserRole.ADMIN]: 1,\r\n    [UserRole.DAIRY]: 2,\r\n    [UserRole.BMC]: 3,\r\n    [UserRole.SOCIETY]: 4,\r\n    [UserRole.FARMER]: 5\r\n  };\r\n\r\n  return roleHierarchy[userRole] < roleHierarchy[targetRole];\r\n};\r\n\r\n// Get allowed roles for user\r\nexport const getAllowedRoles = (userRole: UserRole): UserRole[] => {\r\n  const allRoles = [\r\n    UserRole.SUPER_ADMIN,\r\n    UserRole.ADMIN,\r\n    UserRole.DAIRY,\r\n    UserRole.BMC,\r\n    UserRole.SOCIETY,\r\n    UserRole.FARMER\r\n  ];\r\n\r\n  const roleHierarchy: Record<UserRole, number> = {\r\n    [UserRole.SUPER_ADMIN]: 0,\r\n    [UserRole.ADMIN]: 1,\r\n    [UserRole.DAIRY]: 2,\r\n    [UserRole.BMC]: 3,\r\n    [UserRole.SOCIETY]: 4,\r\n    [UserRole.FARMER]: 5\r\n  };\r\n\r\n  const userLevel = roleHierarchy[userRole];\r\n  return allRoles.filter(role => roleHierarchy[role] > userLevel);\r\n};\r\n\r\n// Check if user is super admin\r\nexport const isSuperAdmin = (user: { email?: string; role?: UserRole }): boolean => {\r\n  const superAdminEmail = process.env.SUPER_ADMIN_USERNAME || 'admin';\r\n  return (\r\n    user.email === superAdminEmail || \r\n    user.role === UserRole.SUPER_ADMIN\r\n  );\r\n};\r\n\r\n// Validate password strength\r\nexport const validatePassword = (password: string): { \r\n  isValid: boolean; \r\n  errors: string[] \r\n} => {\r\n  const errors: string[] = [];\r\n  \r\n  if (password.length < 8) {\r\n    errors.push('Password must be at least 8 characters long');\r\n  }\r\n  \r\n  if (!/[A-Z]/.test(password)) {\r\n    errors.push('Password must contain at least one uppercase letter');\r\n  }\r\n  \r\n  if (!/[a-z]/.test(password)) {\r\n    errors.push('Password must contain at least one lowercase letter');\r\n  }\r\n  \r\n  if (!/\\d/.test(password)) {\r\n    errors.push('Password must contain at least one number');\r\n  }\r\n  \r\n  if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\r\n    errors.push('Password must contain at least one special character');\r\n  }\r\n\r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors\r\n  };\r\n};\r\n\r\n// Generate secure session ID\r\nexport const generateSessionId = (): string => {\r\n  return crypto.randomBytes(64).toString('hex');\r\n};\r\n\r\nconst authUtils = {\r\n  generateTokens,\r\n  verifyToken,\r\n  verifyRefreshToken,\r\n  generateRandomToken,\r\n  generateOTP,\r\n  hashToken,\r\n  canManageRole,\r\n  getAllowedRoles,\r\n  isSuperAdmin,\r\n  validatePassword,\r\n  generateSessionId\r\n};\r\n\r\nexport default authUtils;"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;;;;AAEA,oBAAoB;AACpB,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,kBAAkB,IAAI;AAYtD,MAAM,iBAAiB,CAAC;IAC7B,MAAM,UAAU;QACd,IAAI,KAAK,EAAE;QACX,KAAK,KAAK,GAAG;QACb,OAAO,KAAK,KAAK;QACjB,MAAM,KAAK,IAAI;QACf,OAAO,KAAK,KAAK;IACnB;IAEA,MAAM,QAAQ,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAsB;QACpD,WAAW;QACX,QAAQ;QACR,UAAU;IACZ;IAEA,MAAM,eAAe,kJAAG,CAAC,IAAI,CAAC,SAAS,oBAA8B;QACnE,WAAW;QACX,QAAQ;QACR,UAAU;IACZ;IAEA,OAAO;QAAE;QAAO;IAAa;AAC/B;AAGO,MAAM,cAAc,CAAC;IAC1B,IAAI;QACF,MAAM,UAAU,kJAAG,CAAC,MAAM,CAAC,OAAO,YAAsB;YACtD,QAAQ;YACR,UAAU;QACZ;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO;IACT;AACF;AAGO,MAAM,qBAAqB,CAAC;IACjC,IAAI;QACF,MAAM,UAAU,kJAAG,CAAC,MAAM,CAAC,OAAO,oBAA8B;YAC9D,QAAQ;YACR,UAAU;QACZ;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sCAAsC;QACpD,OAAO;IACT;AACF;AAGO,MAAM,sBAAsB,CAAC,SAAiB,EAAE;IACrD,OAAO,gHAAM,CAAC,WAAW,CAAC,QAAQ,QAAQ,CAAC;AAC7C;AAGO,MAAM,cAAc,CAAC,SAAiB,CAAC;IAC5C,MAAM,SAAS;IACf,IAAI,MAAM;IACV,IAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,IAAK;QAC/B,OAAO,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,OAAO,MAAM,EAAE;IAC1D;IACA,OAAO;AACT;AAGO,MAAM,YAAY,CAAC;IACxB,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,OAAO,MAAM,CAAC;AAC1D;AAGO,MAAM,gBAAgB,CAAC,UAAoB;IAChD,MAAM,gBAA0C;QAC9C,CAAC,mIAAQ,CAAC,WAAW,CAAC,EAAE;QACxB,CAAC,mIAAQ,CAAC,KAAK,CAAC,EAAE;QAClB,CAAC,mIAAQ,CAAC,KAAK,CAAC,EAAE;QAClB,CAAC,mIAAQ,CAAC,GAAG,CAAC,EAAE;QAChB,CAAC,mIAAQ,CAAC,OAAO,CAAC,EAAE;QACpB,CAAC,mIAAQ,CAAC,MAAM,CAAC,EAAE;IACrB;IAEA,OAAO,aAAa,CAAC,SAAS,GAAG,aAAa,CAAC,WAAW;AAC5D;AAGO,MAAM,kBAAkB,CAAC;IAC9B,MAAM,WAAW;QACf,mIAAQ,CAAC,WAAW;QACpB,mIAAQ,CAAC,KAAK;QACd,mIAAQ,CAAC,KAAK;QACd,mIAAQ,CAAC,GAAG;QACZ,mIAAQ,CAAC,OAAO;QAChB,mIAAQ,CAAC,MAAM;KAChB;IAED,MAAM,gBAA0C;QAC9C,CAAC,mIAAQ,CAAC,WAAW,CAAC,EAAE;QACxB,CAAC,mIAAQ,CAAC,KAAK,CAAC,EAAE;QAClB,CAAC,mIAAQ,CAAC,KAAK,CAAC,EAAE;QAClB,CAAC,mIAAQ,CAAC,GAAG,CAAC,EAAE;QAChB,CAAC,mIAAQ,CAAC,OAAO,CAAC,EAAE;QACpB,CAAC,mIAAQ,CAAC,MAAM,CAAC,EAAE;IACrB;IAEA,MAAM,YAAY,aAAa,CAAC,SAAS;IACzC,OAAO,SAAS,MAAM,CAAC,CAAA,OAAQ,aAAa,CAAC,KAAK,GAAG;AACvD;AAGO,MAAM,eAAe,CAAC;IAC3B,MAAM,kBAAkB,QAAQ,GAAG,CAAC,oBAAoB,IAAI;IAC5D,OACE,KAAK,KAAK,KAAK,mBACf,KAAK,IAAI,KAAK,mIAAQ,CAAC,WAAW;AAEtC;AAGO,MAAM,mBAAmB,CAAC;IAI/B,MAAM,SAAmB,EAAE;IAE3B,IAAI,SAAS,MAAM,GAAG,GAAG;QACvB,OAAO,IAAI,CAAC;IACd;IAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,WAAW;QAC3B,OAAO,IAAI,CAAC;IACd;IAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,WAAW;QAC3B,OAAO,IAAI,CAAC;IACd;IAEA,IAAI,CAAC,KAAK,IAAI,CAAC,WAAW;QACxB,OAAO,IAAI,CAAC;IACd;IAEA,IAAI,CAAC,wCAAwC,IAAI,CAAC,WAAW;QAC3D,OAAO,IAAI,CAAC;IACd;IAEA,OAAO;QACL,SAAS,OAAO,MAAM,KAAK;QAC3B;IACF;AACF;AAGO,MAAM,oBAAoB;IAC/B,OAAO,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;AACzC;AAEA,MAAM,YAAY;IAChB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 1240, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/middleware/auth.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyToken, JWTPayload } from '@/lib/auth';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// Types for authentication middleware\r\n\r\nexport interface AuthenticatedRequest extends NextRequest {\r\n  user?: JWTPayload;\r\n}\r\n\r\n// Authentication middleware\r\nexport const authenticateToken = (req: NextRequest): { \r\n  success: boolean; \r\n  user?: JWTPayload; \r\n  error?: string \r\n} => {\r\n  try {\r\n    const authHeader = req.headers.get('authorization');\r\n    const token = authHeader?.split(' ')[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return { success: false, error: 'Access token required' };\r\n    }\r\n\r\n    const decoded = verifyToken(token);\r\n    if (!decoded) {\r\n      return { success: false, error: 'Invalid or expired token' };\r\n    }\r\n\r\n    return { success: true, user: decoded };\r\n  } catch {\r\n    return { success: false, error: 'Authentication failed' };\r\n  }\r\n};\r\n\r\n// Role-based authorization middleware\r\nexport const authorizeRole = (requiredRoles: UserRole[]) => {\r\n  return (user: JWTPayload): { success: boolean; error?: string } => {\r\n    if (!user) {\r\n      return { success: false, error: 'User not authenticated' };\r\n    }\r\n\r\n    if (!requiredRoles.includes(user.role)) {\r\n      return { success: false, error: 'Insufficient permissions' };\r\n    }\r\n\r\n    return { success: true };\r\n  };\r\n};\r\n\r\n// Super Admin authorization\r\nexport const requireSuperAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  if (user.role !== UserRole.SUPER_ADMIN && user.email !== (process.env.SUPER_ADMIN_USERNAME || 'admin')) {\r\n    return { success: false, error: 'Super Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Admin or higher authorization\r\nexport const requireAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  const adminRoles = [UserRole.SUPER_ADMIN, UserRole.ADMIN];\r\n  if (!adminRoles.includes(user.role)) {\r\n    return { success: false, error: 'Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Hierarchy-based authorization\r\nexport const requireHierarchyAccess = (targetUserId: number, currentUser: JWTPayload): {\r\n  success: boolean; \r\n  error?: string \r\n} => {\r\n  // Super admin can access everything\r\n  if (currentUser.role === UserRole.SUPER_ADMIN) {\r\n    return { success: true };\r\n  }\r\n\r\n  // Admin can access users in their schema\r\n  if (currentUser.role === UserRole.ADMIN && currentUser.dbKey) {\r\n    // Additional logic would be needed to check if targetUser belongs to admin's schema\r\n    return { success: true };\r\n  }\r\n\r\n  // For other roles, implement specific hierarchy checks\r\n  // This would require database queries to verify parent-child relationships\r\n  \r\n  return { success: false, error: 'Access denied' };\r\n};\r\n\r\n// Response helpers\r\nexport const createErrorResponse = (message: string, status: number = 400) => {\r\n  return NextResponse.json(\r\n    { \r\n      success: false, \r\n      error: { message, code: status.toString() },\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\nexport const createSuccessResponse = (data: unknown, message: string = 'Success', status: number = 200) => {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      message,\r\n      data,\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\n// Validation helper\r\nexport const validateRequiredFields = (\r\n  body: Record<string, unknown>, \r\n  requiredFields: string[]\r\n): { success: boolean; missing?: string[] } => {\r\n  const missing = requiredFields.filter(field => \r\n    !body[field] || (typeof body[field] === 'string' && body[field].trim() === '')\r\n  );\r\n\r\n  if (missing.length > 0) {\r\n    return { success: false, missing };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Rate limiting (basic implementation)\r\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>();\r\n\r\nexport const checkRateLimit = (\r\n  identifier: string, \r\n  maxRequests: number = 100, \r\n  windowMs: number = 15 * 60 * 1000 // 15 minutes\r\n): { success: boolean; resetTime?: number } => {\r\n  const now = Date.now();\r\n  const record = rateLimitMap.get(identifier);\r\n\r\n  if (!record || now > record.resetTime) {\r\n    // Reset or create new record\r\n    rateLimitMap.set(identifier, { count: 1, resetTime: now + windowMs });\r\n    return { success: true };\r\n  }\r\n\r\n  if (record.count >= maxRequests) {\r\n    return { success: false, resetTime: record.resetTime };\r\n  }\r\n\r\n  record.count++;\r\n  return { success: true };\r\n};\r\n\r\n// CORS headers\r\nexport const setCorsHeaders = (response: NextResponse) => {\r\n  response.headers.set('Access-Control-Allow-Origin', process.env.CLIENT_URL || '*');\r\n  response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n  response.headers.set('Access-Control-Allow-Credentials', 'true');\r\n  return response;\r\n};\r\n\r\nconst middleware = {\r\n  authenticateToken,\r\n  authorizeRole,\r\n  requireSuperAdmin,\r\n  requireAdmin,\r\n  requireHierarchyAccess,\r\n  createErrorResponse,\r\n  createSuccessResponse,\r\n  validateRequiredFields,\r\n  checkRateLimit,\r\n  setCorsHeaders\r\n};\r\n\r\nexport default middleware;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1461, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/user/pulse/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { connectDB } from '@/lib/database';\r\nimport { SectionPulseTracker } from '@/lib/sectionPulseTracker';\r\nimport { createErrorResponse, createSuccessResponse } from '@/middleware/auth';\r\n\r\n/**\r\n * Get Section Pulse Status API\r\n * \r\n * GET /api/user/pulse - Get pulse status for all societies (current date)\r\n * GET /api/user/pulse?date=YYYY-MM-DD - Get pulse status for specific date\r\n * GET /api/user/pulse?societyId=123 - Get pulse status for specific society\r\n * GET /api/user/pulse?societyId=123&date=YYYY-MM-DD - Specific society and date\r\n * \r\n * Returns pulse status with indicators:\r\n * - not_started: Section has not started (no collections yet today)\r\n * - active: Section is currently active (collections happening)\r\n * - ended: Section has ended (60+ minutes since last collection)\r\n * - inactive: No pulse for multiple days\r\n */\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    // Get user from session/token\r\n    const userId = request.headers.get('x-user-id');\r\n    if (!userId) {\r\n      return createErrorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    const user = await User.findByPk(parseInt(userId));\r\n    if (!user) {\r\n      return createErrorResponse('User not found', 404);\r\n    }\r\n\r\n    // Get admin's schema name\r\n    let dbKey: string;\r\n    let adminUser;\r\n\r\n    if (user.role === 'admin') {\r\n      dbKey = user.dbKey || '';\r\n      adminUser = user;\r\n    } else {\r\n      // Get admin user for non-admin users\r\n      adminUser = await User.findByPk(user.parentId || 0);\r\n      if (!adminUser || !adminUser.dbKey) {\r\n        return createErrorResponse('Admin user not found', 404);\r\n      }\r\n      dbKey = adminUser.dbKey;\r\n    }\r\n\r\n    const cleanAdminName = adminUser.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${dbKey.toLowerCase()}`;\r\n\r\n    // Get query parameters\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const societyIdParam = searchParams.get('societyId');\r\n    const dateParam = searchParams.get('date');\r\n\r\n    // Validate date format if provided\r\n    if (dateParam && !/^\\d{4}-\\d{2}-\\d{2}$/.test(dateParam)) {\r\n      return createErrorResponse('Invalid date format. Use YYYY-MM-DD', 400);\r\n    }\r\n\r\n    let pulseData;\r\n\r\n    if (societyIdParam) {\r\n      // Get pulse status for specific society\r\n      const societyId = parseInt(societyIdParam);\r\n      if (isNaN(societyId)) {\r\n        return createErrorResponse('Invalid society ID', 400);\r\n      }\r\n\r\n      pulseData = await SectionPulseTracker.getPulseStatus(\r\n        sequelize,\r\n        schemaName,\r\n        societyId,\r\n        dateParam || undefined\r\n      );\r\n\r\n      if (!pulseData) {\r\n        return createErrorResponse('Pulse status not found', 404);\r\n      }\r\n\r\n      // Get society name\r\n      const [societies] = await sequelize.query(`\r\n        SELECT name, society_id FROM \\`${schemaName}\\`.societies WHERE id = ?\r\n      `, { replacements: [societyId] }) as unknown as [{\r\n        name: string;\r\n        society_id: string;\r\n      }[]];\r\n\r\n      const society = societies && societies[0];\r\n\r\n      return createSuccessResponse({\r\n        pulse: {\r\n          ...pulseData,\r\n          societyName: society?.name,\r\n          societyCode: society?.society_id,\r\n          statusMessage: getPulseStatusMessage(pulseData)\r\n        }\r\n      }, 'Pulse status retrieved successfully');\r\n    } else {\r\n      // Get pulse status for all societies\r\n      pulseData = await SectionPulseTracker.getAllPulseStatuses(\r\n        sequelize,\r\n        schemaName,\r\n        dateParam || undefined\r\n      );\r\n\r\n      // Add status messages\r\n      const pulseWithMessages = pulseData.map(pulse => ({\r\n        ...pulse,\r\n        statusMessage: getPulseStatusMessage(pulse)\r\n      }));\r\n\r\n      return createSuccessResponse({\r\n        date: dateParam || new Date().toISOString().split('T')[0],\r\n        totalSocieties: pulseData.length,\r\n        active: pulseData.filter(p => p.pulseStatus === 'active').length,\r\n        ended: pulseData.filter(p => p.pulseStatus === 'ended').length,\r\n        notStarted: pulseData.filter(p => p.pulseStatus === 'not_started').length,\r\n        inactive: pulseData.filter(p => p.pulseStatus === 'inactive').length,\r\n        pulses: pulseWithMessages\r\n      }, 'Pulse statuses retrieved successfully');\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error getting pulse status:', error);\r\n    console.error('Error details:', {\r\n      message: error instanceof Error ? error.message : 'Unknown error',\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n      error\r\n    });\r\n    return createErrorResponse('Failed to get pulse status', 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Helper function to generate human-readable pulse status message\r\n */\r\nfunction getPulseStatusMessage(pulse: {\r\n  pulseStatus: 'not_started' | 'active' | 'ended' | 'inactive' | 'paused';\r\n  firstCollectionTime: Date | null;\r\n  lastCollectionTime: Date | null;\r\n  sectionEndTime: Date | null;\r\n  totalCollections: number;\r\n  inactiveDays: number;\r\n}): string {\r\n  switch (pulse.pulseStatus) {\r\n    case 'not_started':\r\n      return 'Section not started';\r\n    \r\n    case 'active':\r\n      if (pulse.lastCollectionTime) {\r\n        const minutesAgo = Math.floor((Date.now() - new Date(pulse.lastCollectionTime).getTime()) / 60000);\r\n        return `Active - Last collection ${minutesAgo} min ago`;\r\n      }\r\n      return 'Active';\r\n    \r\n    case 'paused':\r\n      return 'Section paused';\r\n    \r\n    case 'ended':\r\n      if (pulse.sectionEndTime) {\r\n        const endTime = new Date(pulse.sectionEndTime).toLocaleTimeString('en-US', {\r\n          hour: '2-digit',\r\n          minute: '2-digit'\r\n        });\r\n        return `Section ended at ${endTime}`;\r\n      }\r\n      return 'Section ended';\r\n    \r\n    case 'inactive':\r\n      if (pulse.inactiveDays === 1) {\r\n        return 'No pulse for 1 day';\r\n      } else if (pulse.inactiveDays > 1) {\r\n        return `No pulse for ${pulse.inactiveDays} days`;\r\n      }\r\n      return 'Inactive';\r\n    \r\n    default:\r\n      return 'Unknown status';\r\n  }\r\n}\r\n\r\n/**\r\n * Manual pulse check endpoint\r\n * Triggers check for section end and inactivity\r\n * \r\n * POST /api/user/pulse/check\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    // Get user from session/token\r\n    const userId = request.headers.get('x-user-id');\r\n    if (!userId) {\r\n      return createErrorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    const user = await User.findByPk(parseInt(userId));\r\n    if (!user) {\r\n      return createErrorResponse('User not found', 404);\r\n    }\r\n\r\n    // Only allow admin to manually trigger pulse checks\r\n    if (user.role !== 'admin' && user.role !== 'super_admin') {\r\n      return createErrorResponse('Insufficient permissions', 403);\r\n    }\r\n\r\n    // Get admin's schema name\r\n    let dbKey: string;\r\n    let adminUser;\r\n\r\n    if (user.role === 'admin') {\r\n      dbKey = user.dbKey || '';\r\n      adminUser = user;\r\n    } else {\r\n      adminUser = await User.findByPk(user.parentId || 0);\r\n      if (!adminUser || !adminUser.dbKey) {\r\n        return createErrorResponse('Admin user not found', 404);\r\n      }\r\n      dbKey = adminUser.dbKey;\r\n    }\r\n\r\n    const cleanAdminName = adminUser.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${dbKey.toLowerCase()}`;\r\n\r\n    // Run pulse checks\r\n    console.log('üîç Running manual pulse checks...');\r\n    \r\n    await SectionPulseTracker.checkSectionEnd(sequelize, schemaName);\r\n    console.log('‚úÖ Section end check completed');\r\n    \r\n    await SectionPulseTracker.checkInactivity(sequelize, schemaName);\r\n    console.log('‚úÖ Inactivity check completed');\r\n\r\n    // Get updated pulse statuses\r\n    const pulseData = await SectionPulseTracker.getAllPulseStatuses(\r\n      sequelize,\r\n      schemaName\r\n    );\r\n\r\n    return createSuccessResponse({\r\n      checksRun: ['section_end', 'inactivity'],\r\n      totalSocieties: pulseData.length,\r\n      active: pulseData.filter(p => p.pulseStatus === 'active').length,\r\n      ended: pulseData.filter(p => p.pulseStatus === 'ended').length,\r\n      notStarted: pulseData.filter(p => p.pulseStatus === 'not_started').length,\r\n      inactive: pulseData.filter(p => p.pulseStatus === 'inactive').length\r\n    }, 'Pulse checks completed successfully');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error running pulse checks:', error);\r\n    return createErrorResponse('Failed to run pulse checks', 500);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}