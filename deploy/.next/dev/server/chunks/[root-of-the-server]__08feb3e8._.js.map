{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/database.ts"],"sourcesContent":["import { Sequelize } from 'sequelize';\r\nimport mysql2 from 'mysql2';\r\nimport path from 'path';\r\n\r\n// Database configuration for Azure MySQL\r\nlet sequelize: Sequelize | null = null;\r\n\r\nconst createSequelizeInstance = () => {\r\n    if (!sequelize) {\r\n    // Don't initialize during build time\r\n    if (process.env.NODE_ENV === 'development' || process.env.BUILDING !== 'true') {\r\n      // Determine SSL configuration based on environment\r\n      // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n      const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n        require: true,\r\n        rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n        ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n      } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n        require: true,\r\n        rejectUnauthorized: false,\r\n      } : false;      sequelize = new Sequelize(\r\n      process.env.DB_NAME || 'psr_v4_main',\r\n      process.env.DB_USER || 'psr_admin',\r\n      process.env.DB_PASSWORD || 'Access@404',\r\n      {\r\n        host: process.env.DB_HOST || 'localhost',\r\n        port: parseInt(process.env.DB_PORT || '3306'),\r\n        dialect: 'mysql',\r\n        dialectModule: mysql2,\r\n        timezone: '+05:30', // Use Indian Standard Time (IST)\r\n        dialectOptions: {\r\n          ssl: sslConfig,\r\n          connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        },\r\n        pool: {\r\n          max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n          min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n          acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n          idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n        },\r\n        logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n        benchmark: process.env.NODE_ENV === 'development',\r\n      }\r\n    );\r\n    }\r\n  }\r\n  return sequelize;\r\n};\r\n\r\n// Test database connection\r\nexport const testConnection = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    await db.authenticate();\r\n    console.log('‚úÖ Database connection established successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Unable to connect to the database:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Initialize database\r\nexport const initDatabase = async (useMigrations: boolean = false) => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      console.error('‚ùå Database not initialized');\r\n      return false;\r\n    }\r\n    \r\n    if (useMigrations) {\r\n      // Use migrations instead of sync for production\r\n      const { migrationRunner } = await import('./migrations');\r\n      await migrationRunner.initializeDatabase();\r\n    } else {\r\n      // Development mode - use sync\r\n      await db.sync({ alter: process.env.NODE_ENV === 'development' });\r\n    }\r\n    \r\n    console.log('‚úÖ Database synchronized successfully.');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Database synchronization failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Connect to database\r\nexport const connectDB = async () => {\r\n  try {\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.authenticate();\r\n    return db;\r\n  } catch (error) {\r\n    console.error('‚ùå Database connection failed:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to create admin-specific schema\r\nexport const createAdminSchema = async (adminEmail: string): Promise<string> => {\r\n  try {\r\n    // Generate DB key: db-<first 3 letters of email><3 random numbers>\r\n    const emailPrefix = adminEmail.substring(0, 3).toLowerCase();\r\n    const randomSuffix = Math.floor(100 + Math.random() * 900).toString();\r\n    const dbKey = `db_${emailPrefix}${randomSuffix}`;\r\n    \r\n    // Create new database schema\r\n    const db = createSequelizeInstance();\r\n    if (!db) {\r\n      throw new Error('Database not initialized');\r\n    }\r\n    await db.query(`CREATE DATABASE IF NOT EXISTS \\`${dbKey}\\``);\r\n    \r\n    console.log(`‚úÖ Created admin schema: ${dbKey}`);\r\n    return dbKey;\r\n  } catch (error) {\r\n    console.error('‚ùå Failed to create admin schema:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Function to get connection for specific admin schema\r\nexport const getAdminConnection = (dbKey: string): Sequelize => {\r\n  // Determine SSL configuration based on environment\r\n  // Only use SSL if DB_SSL_CA is explicitly set and not empty\r\n  const sslConfig = (process.env.DB_SSL_CA && process.env.DB_SSL_CA.trim() !== '') ? {\r\n    require: true,\r\n    rejectUnauthorized: process.env.DB_REJECT_UNAUTHORIZED !== 'false',\r\n    ca: path.join(process.cwd(), process.env.DB_SSL_CA),\r\n  } : (process.env.NODE_ENV === 'production' && process.env.DB_HOST?.includes('azure')) ? {\r\n    require: true,\r\n    rejectUnauthorized: false,\r\n  } : false;\r\n\r\n  return new Sequelize(\r\n    dbKey,\r\n    process.env.DB_USER || 'psr_admin',\r\n    process.env.DB_PASSWORD || '',\r\n    {\r\n      host: process.env.DB_HOST || 'localhost',\r\n      port: parseInt(process.env.DB_PORT || '3306'),\r\n      dialect: 'mysql',\r\n      dialectModule: mysql2,\r\n      dialectOptions: {\r\n        ssl: sslConfig,\r\n        connectTimeout: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        acquireTimeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n        timeout: parseInt(process.env.DB_COMMAND_TIMEOUT || '60') * 1000,\r\n      },\r\n      pool: {\r\n        max: parseInt(process.env.DB_POOL_MAX || '10'),\r\n        min: parseInt(process.env.DB_POOL_MIN || '0'),\r\n        acquire: parseInt(process.env.DB_CONNECTION_TIMEOUT || '30') * 1000,\r\n        idle: parseInt(process.env.DB_CONNECTION_LIFETIME || '300') * 1000,\r\n      },\r\n      logging: process.env.NODE_ENV === 'development' ? console.log : false,\r\n    }\r\n  );\r\n};\r\n\r\nexport default createSequelizeInstance;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 302, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/BaseExternalAPI.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\n\r\n/**\r\n * Base input structure for all external API endpoints\r\n */\r\nexport interface BaseInputParts {\r\n  societyId: string;\r\n  machineType: string;\r\n  version: string;\r\n  machineId: string;\r\n}\r\n\r\n/**\r\n * Validation result interface\r\n */\r\nexport interface ValidationResult {\r\n  isValid: boolean;\r\n  error?: string;\r\n  parsedSocietyId?: string;\r\n  parsedMachineId?: number;\r\n}\r\n\r\n/**\r\n * Configuration interface for external API endpoints\r\n */\r\nexport interface ExternalAPIConfig {\r\n  endpointName: string;\r\n  requiresExactPartCount?: boolean;\r\n  expectedPartCounts: number[];\r\n  filterLineEndings: boolean;\r\n  standardErrorMessage: string;\r\n}\r\n\r\n/**\r\n * Abstract base class for external API endpoints following InputString pattern\r\n */\r\nexport abstract class BaseExternalAPI<TInput extends BaseInputParts, TResult> {\r\n  protected config: ExternalAPIConfig;\r\n\r\n  constructor(config: ExternalAPIConfig) {\r\n    this.config = config;\r\n  }\r\n\r\n  /**\r\n   * Parse InputString into typed input structure\r\n   */\r\n  abstract parseInput(inputString: string): TInput | null;\r\n\r\n  /**\r\n   * Validate parsed input parts\r\n   */\r\n  abstract validateInput(input: TInput, dbKey: string): Promise<ValidationResult>;\r\n\r\n  /**\r\n   * Execute the main business logic\r\n   */\r\n  abstract executeBusinessLogic(input: TInput, schemaName: string, sequelize: unknown): Promise<TResult>;\r\n\r\n  /**\r\n   * Format the result into response string\r\n   */\r\n  abstract formatResponse(result: TResult): string;\r\n\r\n  /**\r\n   * Get error message for this endpoint\r\n   */\r\n  getErrorMessage(): string {\r\n    return this.config.standardErrorMessage;\r\n  }\r\n\r\n  /**\r\n   * Main request handler - implements common flow\r\n   */\r\n  async handleRequest(\r\n    request: NextRequest,\r\n    { params }: { params: Promise<Record<string, string>> }\r\n  ): Promise<Response> {\r\n    try {\r\n      // Step 1: Extract InputString from GET/POST\r\n      let inputString = await this.extractInputString(request);\r\n      \r\n      // Step 2: Resolve dynamic params\r\n      const resolvedParams = await params;\r\n      const dbKey = resolvedParams['db-key'] || resolvedParams.dbKey || resolvedParams['dbkey'];\r\n\r\n      this.logRequest(request, dbKey, inputString);\r\n\r\n      // Step 3: Filter line endings if configured\r\n      if (this.config.filterLineEndings && inputString) {\r\n        inputString = this.filterLineEndings(inputString);\r\n      }\r\n\r\n      // Step 4: Basic validation\r\n      if (!this.validateBasicInputs(dbKey, inputString)) {\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 5: Parse InputString\r\n      const parsedInput = this.parseInput(inputString!);\r\n      if (!parsedInput) {\r\n        console.log(`‚ùå ${this.config.endpointName}: Failed to parse InputString: \"${inputString}\"`);\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 6: Connect to database and validate\r\n      const { sequelize, schemaName } = await this.connectAndValidate(dbKey);\r\n      if (!sequelize || !schemaName) {\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 7: Validate parsed input\r\n      const validation = await this.validateInput(parsedInput, dbKey);\r\n      if (!validation.isValid) {\r\n        console.log(`‚ùå ${this.config.endpointName}: Input validation failed: ${validation.error}`);\r\n        return this.errorResponse();\r\n      }\r\n\r\n      // Step 8: Execute business logic\r\n      const result = await this.executeBusinessLogic(parsedInput, schemaName, sequelize);\r\n\r\n      // Step 9: Format and return response\r\n      const formattedResponse = this.formatResponse(result);\r\n      return this.successResponse(formattedResponse);\r\n\r\n    } catch (error) {\r\n      console.error(`‚ùå Error in ${this.config.endpointName} API:`, error);\r\n      return this.errorResponse();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Extract InputString from request (GET query param or POST body)\r\n   */\r\n  private async extractInputString(request: NextRequest): Promise<string | null> {\r\n    let inputString: string | null = null;\r\n    \r\n    if (request.method === 'GET') {\r\n      const { searchParams } = new URL(request.url);\r\n      inputString = searchParams.get('InputString');\r\n    } else if (request.method === 'POST') {\r\n      try {\r\n        const body = await request.json();\r\n        inputString = body.InputString || null;\r\n      } catch (error) {\r\n        try {\r\n          const formData = await request.formData();\r\n          inputString = formData.get('InputString') as string || null;\r\n        } catch {\r\n          console.log(`‚ùå Failed to parse POST body:`, error);\r\n        }\r\n      }\r\n    }\r\n    \r\n    return inputString;\r\n  }\r\n\r\n  /**\r\n   * Filter line ending characters from InputString\r\n   */\r\n  private filterLineEndings(inputString: string): string {\r\n    const originalInputString = inputString;\r\n    \r\n    // Remove common line ending patterns: $0D (CR), $0A (LF), $0D$0A (CRLF)\r\n    const filtered = inputString\r\n      .replace(/\\$0D\\$0A/g, '')  // Remove $0D$0A (CRLF)\r\n      .replace(/\\$0D/g, '')      // Remove $0D (CR) \r\n      .replace(/\\$0A/g, '')      // Remove $0A (LF)\r\n      .replace(/\\r\\n/g, '')      // Remove actual CRLF characters\r\n      .replace(/\\r/g, '')        // Remove actual CR characters\r\n      .replace(/\\n/g, '');       // Remove actual LF characters\r\n    \r\n    if (originalInputString !== filtered) {\r\n      console.log(`üßπ ${this.config.endpointName}: Filtered line endings: \"${originalInputString}\" -> \"${filtered}\"`);\r\n    }\r\n    \r\n    return filtered;\r\n  }\r\n\r\n  /**\r\n   * Basic input validation\r\n   */\r\n  private validateBasicInputs(dbKey: string, inputString: string | null): boolean {\r\n    if (!dbKey || dbKey.trim() === '') {\r\n      console.log(`‚ùå ${this.config.endpointName}: DB Key validation failed - dbKey: \"${dbKey}\"`);\r\n      return false;\r\n    }\r\n\r\n    if (!inputString) {\r\n      console.log(`‚ùå ${this.config.endpointName}: InputString is required`);\r\n      return false;\r\n    }\r\n\r\n    // Validate InputString part count\r\n    const parts = inputString.split('|');\r\n    if (!this.config.expectedPartCounts.includes(parts.length)) {\r\n      console.log(`‚ùå ${this.config.endpointName}: Invalid InputString part count. Expected: ${this.config.expectedPartCounts.join(' or ')}, Got: ${parts.length}`);\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Connect to database and get admin schema\r\n   */\r\n  private async connectAndValidate(dbKey: string): Promise<{ sequelize: unknown, schemaName: string | null }> {\r\n    try {\r\n      const { connectDB } = await import('@/lib/database');\r\n      await connectDB();\r\n      \r\n      const { getModels } = await import('@/models');\r\n      const { sequelize, User } = getModels();\r\n\r\n      // Find admin by dbKey to get schema name\r\n      const admin = await User.findOne({ \r\n        where: { dbKey: dbKey.toUpperCase() } \r\n      });\r\n\r\n      if (!admin || !admin.dbKey) {\r\n        console.log(`‚ùå ${this.config.endpointName}: Admin not found or missing DB Key for: ${dbKey}`);\r\n        return { sequelize: null, schemaName: null };\r\n      }\r\n\r\n      // Generate admin-specific schema name\r\n      const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n      const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n      console.log(`‚úÖ ${this.config.endpointName}: Using schema: ${schemaName}`);\r\n      \r\n      return { sequelize, schemaName };\r\n    } catch (error) {\r\n      console.error(`‚ùå ${this.config.endpointName}: Database connection failed:`, error);\r\n      return { sequelize: null, schemaName: null };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log request details\r\n   */\r\n  private logRequest(request: NextRequest, dbKey: string, inputString: string | null): void {\r\n    console.log(`üîç ${this.config.endpointName} External API Request - Full URL: ${request.url}`);\r\n    console.log(`üîç DB Key: \"${dbKey}\", InputString: \"${inputString}\"`);\r\n    console.log(`üîç DB Key type: ${typeof dbKey}, length: ${dbKey?.length}`);\r\n  }\r\n\r\n  /**\r\n   * Create success response\r\n   */\r\n  protected successResponse(data: string, additionalHeaders?: Record<string, string>): Response {\r\n    return new Response(`\"${data}\"`, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'text/plain',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n        ...additionalHeaders\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create error response\r\n   */\r\n  protected errorResponse(): Response {\r\n    return new Response(`\"${this.getErrorMessage()}\"`, {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'text/plain' }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle OPTIONS request for CORS\r\n   */\r\n  async handleOptions(): Promise<Response> {\r\n    return new Response(null, {\r\n      status: 200,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n      },\r\n    });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAoCO,MAAe;IACV,OAA0B;IAEpC,YAAY,MAAyB,CAAE;QACrC,IAAI,CAAC,MAAM,GAAG;IAChB;IAsBA;;GAEC,GACD,kBAA0B;QACxB,OAAO,IAAI,CAAC,MAAM,CAAC,oBAAoB;IACzC;IAEA;;GAEC,GACD,MAAM,cACJ,OAAoB,EACpB,EAAE,MAAM,EAA+C,EACpC;QACnB,IAAI;YACF,4CAA4C;YAC5C,IAAI,cAAc,MAAM,IAAI,CAAC,kBAAkB,CAAC;YAEhD,iCAAiC;YACjC,MAAM,iBAAiB,MAAM;YAC7B,MAAM,QAAQ,cAAc,CAAC,SAAS,IAAI,eAAe,KAAK,IAAI,cAAc,CAAC,QAAQ;YAEzF,IAAI,CAAC,UAAU,CAAC,SAAS,OAAO;YAEhC,4CAA4C;YAC5C,IAAI,IAAI,CAAC,MAAM,CAAC,iBAAiB,IAAI,aAAa;gBAChD,cAAc,IAAI,CAAC,iBAAiB,CAAC;YACvC;YAEA,2BAA2B;YAC3B,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,OAAO,cAAc;gBACjD,OAAO,IAAI,CAAC,aAAa;YAC3B;YAEA,4BAA4B;YAC5B,MAAM,cAAc,IAAI,CAAC,UAAU,CAAC;YACpC,IAAI,CAAC,aAAa;gBAChB,QAAQ,GAAG,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,gCAAgC,EAAE,YAAY,CAAC,CAAC;gBAC1F,OAAO,IAAI,CAAC,aAAa;YAC3B;YAEA,2CAA2C;YAC3C,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC;YAChE,IAAI,CAAC,aAAa,CAAC,YAAY;gBAC7B,OAAO,IAAI,CAAC,aAAa;YAC3B;YAEA,gCAAgC;YAChC,MAAM,aAAa,MAAM,IAAI,CAAC,aAAa,CAAC,aAAa;YACzD,IAAI,CAAC,WAAW,OAAO,EAAE;gBACvB,QAAQ,GAAG,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,2BAA2B,EAAE,WAAW,KAAK,EAAE;gBACzF,OAAO,IAAI,CAAC,aAAa;YAC3B;YAEA,iCAAiC;YACjC,MAAM,SAAS,MAAM,IAAI,CAAC,oBAAoB,CAAC,aAAa,YAAY;YAExE,qCAAqC;YACrC,MAAM,oBAAoB,IAAI,CAAC,cAAc,CAAC;YAC9C,OAAO,IAAI,CAAC,eAAe,CAAC;QAE9B,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,WAAW,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,KAAK,CAAC,EAAE;YAC7D,OAAO,IAAI,CAAC,aAAa;QAC3B;IACF;IAEA;;GAEC,GACD,MAAc,mBAAmB,OAAoB,EAA0B;QAC7E,IAAI,cAA6B;QAEjC,IAAI,QAAQ,MAAM,KAAK,OAAO;YAC5B,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;YAC5C,cAAc,aAAa,GAAG,CAAC;QACjC,OAAO,IAAI,QAAQ,MAAM,KAAK,QAAQ;YACpC,IAAI;gBACF,MAAM,OAAO,MAAM,QAAQ,IAAI;gBAC/B,cAAc,KAAK,WAAW,IAAI;YACpC,EAAE,OAAO,OAAO;gBACd,IAAI;oBACF,MAAM,WAAW,MAAM,QAAQ,QAAQ;oBACvC,cAAc,SAAS,GAAG,CAAC,kBAA4B;gBACzD,EAAE,OAAM;oBACN,QAAQ,GAAG,CAAC,CAAC,4BAA4B,CAAC,EAAE;gBAC9C;YACF;QACF;QAEA,OAAO;IACT;IAEA;;GAEC,GACD,AAAQ,kBAAkB,WAAmB,EAAU;QACrD,MAAM,sBAAsB;QAE5B,wEAAwE;QACxE,MAAM,WAAW,YACd,OAAO,CAAC,aAAa,IAAK,uBAAuB;SACjD,OAAO,CAAC,SAAS,IAAS,mBAAmB;SAC7C,OAAO,CAAC,SAAS,IAAS,kBAAkB;SAC5C,OAAO,CAAC,SAAS,IAAS,gCAAgC;SAC1D,OAAO,CAAC,OAAO,IAAW,8BAA8B;SACxD,OAAO,CAAC,OAAO,KAAW,8BAA8B;QAE3D,IAAI,wBAAwB,UAAU;YACpC,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,0BAA0B,EAAE,oBAAoB,MAAM,EAAE,SAAS,CAAC,CAAC;QAChH;QAEA,OAAO;IACT;IAEA;;GAEC,GACD,AAAQ,oBAAoB,KAAa,EAAE,WAA0B,EAAW;QAC9E,IAAI,CAAC,SAAS,MAAM,IAAI,OAAO,IAAI;YACjC,QAAQ,GAAG,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,qCAAqC,EAAE,MAAM,CAAC,CAAC;YACzF,OAAO;QACT;QAEA,IAAI,CAAC,aAAa;YAChB,QAAQ,GAAG,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,yBAAyB,CAAC;YACpE,OAAO;QACT;QAEA,kCAAkC;QAClC,MAAM,QAAQ,YAAY,KAAK,CAAC;QAChC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,kBAAkB,CAAC,QAAQ,CAAC,MAAM,MAAM,GAAG;YAC1D,QAAQ,GAAG,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,4CAA4C,EAAE,IAAI,CAAC,MAAM,CAAC,kBAAkB,CAAC,IAAI,CAAC,QAAQ,OAAO,EAAE,MAAM,MAAM,EAAE;YAC3J,OAAO;QACT;QAEA,OAAO;IACT;IAEA;;GAEC,GACD,MAAc,mBAAmB,KAAa,EAA8D;QAC1G,IAAI;YACF,MAAM,EAAE,SAAS,EAAE,GAAG;YACtB,MAAM;YAEN,MAAM,EAAE,SAAS,EAAE,GAAG;YACtB,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG;YAE5B,yCAAyC;YACzC,MAAM,QAAQ,MAAM,KAAK,OAAO,CAAC;gBAC/B,OAAO;oBAAE,OAAO,MAAM,WAAW;gBAAG;YACtC;YAEA,IAAI,CAAC,SAAS,CAAC,MAAM,KAAK,EAAE;gBAC1B,QAAQ,GAAG,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,yCAAyC,EAAE,OAAO;gBAC5F,OAAO;oBAAE,WAAW;oBAAM,YAAY;gBAAK;YAC7C;YAEA,sCAAsC;YACtC,MAAM,iBAAiB,MAAM,QAAQ,CAAC,OAAO,CAAC,iBAAiB,IAAI,WAAW;YAC9E,MAAM,aAAa,GAAG,eAAe,CAAC,EAAE,MAAM,KAAK,CAAC,WAAW,IAAI;YAEnE,QAAQ,GAAG,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,gBAAgB,EAAE,YAAY;YAExE,OAAO;gBAAE;gBAAW;YAAW;QACjC,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,6BAA6B,CAAC,EAAE;YAC5E,OAAO;gBAAE,WAAW;gBAAM,YAAY;YAAK;QAC7C;IACF;IAEA;;GAEC,GACD,AAAQ,WAAW,OAAoB,EAAE,KAAa,EAAE,WAA0B,EAAQ;QACxF,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,kCAAkC,EAAE,QAAQ,GAAG,EAAE;QAC5F,QAAQ,GAAG,CAAC,CAAC,YAAY,EAAE,MAAM,iBAAiB,EAAE,YAAY,CAAC,CAAC;QAClE,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,OAAO,MAAM,UAAU,EAAE,OAAO,QAAQ;IACzE;IAEA;;GAEC,GACD,AAAU,gBAAgB,IAAY,EAAE,iBAA0C,EAAY;QAC5F,OAAO,IAAI,SAAS,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,EAAE;YAC/B,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,+BAA+B;gBAC/B,gCAAgC;gBAChC,gCAAgC;gBAChC,GAAG,iBAAiB;YACtB;QACF;IACF;IAEA;;GAEC,GACD,AAAU,gBAA0B;QAClC,OAAO,IAAI,SAAS,CAAC,CAAC,EAAE,IAAI,CAAC,eAAe,GAAG,CAAC,CAAC,EAAE;YACjD,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAa;QAC1C;IACF;IAEA;;GAEC,GACD,MAAM,gBAAmC;QACvC,OAAO,IAAI,SAAS,MAAM;YACxB,QAAQ;YACR,SAAS;gBACP,+BAA+B;gBAC/B,gCAAgC;gBAChC,gCAAgC;YAClC;QACF;IACF;AACF","debugId":null}},
    {"offset": {"line": 503, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/InputValidator.ts"],"sourcesContent":["/**\r\n * Utility class for validating and parsing InputString components\r\n */\r\nexport class InputValidator {\r\n  /**\r\n   * Validate and parse society ID (handles S- prefix format)\r\n   */\r\n  static validateSocietyId(societyIdStr: string): { \r\n    isValid: boolean; \r\n    id: string; \r\n    fallback: string; \r\n    numericId?: number;\r\n    error?: string;\r\n  } {\r\n    if (!societyIdStr || (typeof societyIdStr === 'string' && societyIdStr.trim() === '')) {\r\n      return {\r\n        isValid: false,\r\n        id: societyIdStr,\r\n        fallback: societyIdStr,\r\n        error: 'Society ID cannot be empty'\r\n      };\r\n    }\r\n\r\n    // Preserve original format for database lookup\r\n    const id = societyIdStr;\r\n    \r\n    // Extract fallback ID (remove S- prefix if present)\r\n    let fallback = societyIdStr;\r\n    if (societyIdStr.startsWith('S-')) {\r\n      fallback = societyIdStr.substring(2);\r\n    }\r\n\r\n    // Try to parse numeric ID for fallback matching\r\n    let numericId: number | undefined;\r\n    const numericPart = parseInt(fallback);\r\n    if (!isNaN(numericPart)) {\r\n      numericId = numericPart;\r\n    }\r\n\r\n    return {\r\n      isValid: true,\r\n      id,\r\n      fallback,\r\n      numericId\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validate and parse machine ID (handles M prefix format with optional letter)\r\n   * \r\n   * Supports multiple formats:\r\n   * - M00001 -> 1 (numeric)\r\n   * - Mm00001 -> m1 (alphanumeric with letter)\r\n   * - Ma00005 -> a5 (alphanumeric with letter)\r\n   * - M0000df -> df (fully alphanumeric)\r\n   * \r\n   * @param machineId - Machine ID with M prefix\r\n   * @returns Validation result with parsed IDs and variants\r\n   */\r\n  static validateMachineId(machineId: string): {\r\n    isValid: boolean;\r\n    numericId?: number;\r\n    alphanumericId?: string;\r\n    withoutPrefix?: string;\r\n    strippedId?: string;\r\n    variants?: (string | number)[];\r\n    isNumeric?: boolean;\r\n    error?: string;\r\n  } {\r\n    if (!machineId || machineId.trim() === '') {\r\n      return {\r\n        isValid: false,\r\n        error: 'Machine ID is required but not provided'\r\n      };\r\n    }\r\n\r\n    // Validate machine ID format (must start with M)\r\n    if (!machineId.startsWith('M') || machineId.length < 2) {\r\n      return {\r\n        isValid: false,\r\n        error: `Invalid machine ID format: \"${machineId}\"`\r\n      };\r\n    }\r\n\r\n    // Remove first 'M' prefix and extract actual machine ID\r\n    // Format: M + optional_letter + numbers\r\n    // Examples: Mm00001 -> m00001, M00001 -> 00001, Ma00005 -> a00005\r\n    const withoutPrefix = machineId.substring(1);\r\n    \r\n    // Validate that remaining part is alphanumeric\r\n    if (!/^[a-zA-Z0-9]+$/.test(withoutPrefix)) {\r\n      return {\r\n        isValid: false,\r\n        error: `Invalid machine ID format: \"${machineId}\" - contains invalid characters`\r\n      };\r\n    }\r\n    \r\n    let processedId: string;\r\n    let isNumeric = false;\r\n    let numericId: number | undefined;\r\n    let alphanumericId: string | undefined;\r\n    \r\n    // Check if withoutPrefix contains any letters\r\n    const hasLetters = /[a-zA-Z]/.test(withoutPrefix);\r\n    \r\n    if (hasLetters) {\r\n      // Contains letters - treat as alphanumeric\r\n      // Examples: m00001, 000m1, 0000df, abc123\r\n      const strippedId = withoutPrefix.replace(/^0+/, '') || withoutPrefix;\r\n      \r\n      // Check if it starts with a letter after removing zeros\r\n      if (/^[a-zA-Z]/.test(strippedId)) {\r\n        const letter = strippedId.charAt(0).toLowerCase();\r\n        const remainingPart = strippedId.substring(1);\r\n        \r\n        // Check if remaining part is numeric\r\n        if (/^\\d+$/.test(remainingPart)) {\r\n          // Letter + numbers: m00001 -> m1, 000m1 -> m1\r\n          const cleanedNumber = remainingPart.replace(/^0+/, '') || '0';\r\n          processedId = letter + cleanedNumber;\r\n          alphanumericId = processedId;\r\n        } else {\r\n          // Mixed alphanumeric: df, abc123\r\n          processedId = strippedId;\r\n          alphanumericId = processedId;\r\n        }\r\n      } else {\r\n        // Starts with number but has letters: should not happen after strip\r\n        processedId = strippedId;\r\n        alphanumericId = processedId;\r\n      }\r\n    } else {\r\n      // No letter, just numbers (e.g., 00001 -> 1)\r\n      processedId = withoutPrefix.replace(/^0+/, '') || '0';\r\n      const parsed = parseInt(processedId);\r\n      \r\n      if (!isNaN(parsed) && parsed > 0) {\r\n        isNumeric = true;\r\n        numericId = parsed;\r\n      } else {\r\n        return {\r\n          isValid: false,\r\n          error: `Invalid machine ID: \"${machineId}\" - invalid numeric format`\r\n        };\r\n      }\r\n    }\r\n\r\n    console.log(`üîÑ Machine ID conversion: \"${machineId}\" -> \"${withoutPrefix}\" -> \"${processedId}\"`);\r\n\r\n    // Create variants for flexible database matching\r\n    const variants: (string | number)[] = [];\r\n    \r\n    if (isNumeric && numericId) {\r\n      // Numeric ID variants\r\n      variants.push(numericId);           // Numeric: 1\r\n      variants.push(machineId);           // Original: M00001\r\n      variants.push(withoutPrefix);       // Without M: 00001\r\n      variants.push(processedId);         // Stripped: 1\r\n      variants.push(String(numericId));   // String numeric: \"1\"\r\n    } else if (alphanumericId) {\r\n      // Alphanumeric ID variants\r\n      variants.push(alphanumericId);      // Processed: m1, df\r\n      variants.push(withoutPrefix);       // Without M: m00001, 0000df\r\n      \r\n      // Add stripped version if different\r\n      const strippedVersion = withoutPrefix.replace(/^0+/, '');\r\n      if (strippedVersion && strippedVersion !== alphanumericId && strippedVersion !== withoutPrefix) {\r\n        variants.push(strippedVersion);\r\n      }\r\n    }\r\n\r\n    return {\r\n      isValid: true,\r\n      numericId,\r\n      alphanumericId,\r\n      withoutPrefix,\r\n      strippedId: processedId,\r\n      variants,\r\n      isNumeric\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validate DB Key format\r\n   */\r\n  static validateDbKey(dbKey: string): { isValid: boolean; error?: string } {\r\n    if (!dbKey || dbKey.trim() === '') {\r\n      return {\r\n        isValid: false,\r\n        error: 'DB Key is required'\r\n      };\r\n    }\r\n\r\n    // Add additional DB key format validation if needed\r\n    if (dbKey.length < 2) {\r\n      return {\r\n        isValid: false,\r\n        error: 'DB Key must be at least 2 characters'\r\n      };\r\n    }\r\n\r\n    return { isValid: true };\r\n  }\r\n\r\n  /**\r\n   * Validate machine model/type (basic validation)\r\n   */\r\n  static validateMachineModel(machineModel: string): { \r\n    isValid: boolean; \r\n    warning?: string; \r\n  } {\r\n    if (!machineModel || machineModel.trim() === '') {\r\n      return {\r\n        isValid: true, // Not blocking for now\r\n        warning: `Machine model is empty: \"${machineModel}\"`\r\n      };\r\n    }\r\n\r\n    return { isValid: true };\r\n  }\r\n\r\n  /**\r\n   * Validate password type for machine password endpoints\r\n   */\r\n  static validatePasswordType(passwordType: string): {\r\n    isValid: boolean;\r\n    isUser: boolean;\r\n    isSupervisor: boolean;\r\n    error?: string;\r\n  } {\r\n    if (!passwordType) {\r\n      return {\r\n        isValid: false,\r\n        isUser: false,\r\n        isSupervisor: false,\r\n        error: 'Password type is required'\r\n      };\r\n    }\r\n\r\n    // Accept both full formats (U$0D, S$0D) and short formats (U, S)\r\n    const isUser = passwordType.startsWith('U');\r\n    const isSupervisor = passwordType.startsWith('S');\r\n\r\n    if (!isUser && !isSupervisor) {\r\n      return {\r\n        isValid: false,\r\n        isUser: false,\r\n        isSupervisor: false,\r\n        error: `Invalid password type: \"${passwordType}\"`\r\n      };\r\n    }\r\n\r\n    return {\r\n      isValid: true,\r\n      isUser,\r\n      isSupervisor\r\n    };\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 717, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/QueryBuilder.ts"],"sourcesContent":["/**\r\n * Utility class for building database queries for external APIs\r\n */\r\nexport class QueryBuilder {\r\n  /**\r\n   * Build society filter conditions for WHERE clause\r\n   */\r\n  static buildSocietyFilter(\r\n    societyId: string, \r\n    fallbackId: string, \r\n    numericId?: number\r\n  ): {\r\n    condition: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    // Support multiple society ID formats:\r\n    // 1. String matching (s.society_id = 'S-s12')\r\n    // 2. Fallback string matching (s.society_id = 's12') \r\n    // 3. Numeric matching (m.society_id = 12)\r\n    \r\n    const condition = '(s.society_id = ? OR s.society_id = ? OR m.society_id = ?)';\r\n    const societyIdNumeric = numericId || fallbackId;\r\n    \r\n    return {\r\n      condition,\r\n      replacements: [societyId, fallbackId, societyIdNumeric]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Build machine filter conditions for WHERE clause\r\n   * Supports both numeric and alphanumeric machine IDs\r\n   * \r\n   * @param machineValidation - Result from InputValidator.validateMachineId()\r\n   * @param useNumericId - Whether to use numeric ID (m.id) or string ID (m.machine_id)\r\n   */\r\n  static buildMachineFilter(\r\n    machineValidation: {\r\n      numericId?: number;\r\n      alphanumericId?: string;\r\n      variants?: (string | number)[];\r\n      isNumeric?: boolean;\r\n    },\r\n    useNumericId: boolean = true\r\n  ): {\r\n    condition: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    // For numeric machine IDs (backward compatibility)\r\n    if (machineValidation.isNumeric && machineValidation.numericId && useNumericId) {\r\n      // Direct numeric ID matching: m.id = 1\r\n      return {\r\n        condition: 'm.id = ?',\r\n        replacements: [machineValidation.numericId]\r\n      };\r\n    }\r\n    \r\n    // For alphanumeric machine IDs or string-based matching\r\n    if (machineValidation.variants && machineValidation.variants.length > 0) {\r\n      // Use IN clause with all variants\r\n      const placeholders = machineValidation.variants.map(() => '?').join(', ');\r\n      \r\n      return {\r\n        condition: `m.machine_id IN (${placeholders})`,\r\n        replacements: machineValidation.variants\r\n      };\r\n    }\r\n\r\n    // Fallback to direct alphanumeric matching\r\n    if (machineValidation.alphanumericId) {\r\n      return {\r\n        condition: 'm.machine_id = ?',\r\n        replacements: [machineValidation.alphanumericId]\r\n      };\r\n    }\r\n\r\n    // Final fallback - should not reach here if validation passed\r\n    throw new Error('Invalid machine validation result for query building');\r\n  }\r\n\r\n  /**\r\n   * Build base query with schema, table, and joins\r\n   */\r\n  static buildBaseQuery(schemaName: string, tableName: string): string {\r\n    const escapedSchema = QueryBuilder.escapeIdentifier(schemaName);\r\n    \r\n    if (tableName === 'farmers') {\r\n      return `\r\n        FROM ${escapedSchema}.farmers f\r\n        LEFT JOIN ${escapedSchema}.societies s ON f.society_id = s.id\r\n        LEFT JOIN ${escapedSchema}.machines m ON f.machine_id = m.id\r\n      `;\r\n    } else if (tableName === 'machines') {\r\n      return `\r\n        FROM ${escapedSchema}.machines m\r\n        LEFT JOIN ${escapedSchema}.societies s ON m.society_id = s.id\r\n      `;\r\n    } else {\r\n      throw new Error(`Unsupported table name: ${tableName}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build complete SELECT query for farmer info\r\n   */\r\n  static buildFarmerQuery(\r\n    schemaName: string,\r\n    societyFilter: ReturnType<typeof QueryBuilder.buildSocietyFilter>,\r\n    machineFilter: ReturnType<typeof QueryBuilder.buildMachineFilter>,\r\n    pagination?: { limit: number; offset: number }\r\n  ): {\r\n    query: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    const baseQuery = QueryBuilder.buildBaseQuery(schemaName, 'farmers');\r\n    \r\n    let query = `\r\n      SELECT \r\n        f.id, \r\n        f.farmer_id,\r\n        f.rf_id, \r\n        f.name, \r\n        f.phone, \r\n        f.sms_enabled, \r\n        f.bonus\r\n      ${baseQuery}\r\n      WHERE ${societyFilter.condition}\r\n        AND f.status = 'active'\r\n        AND ${machineFilter.condition}\r\n      ORDER BY f.farmer_id\r\n    `;\r\n\r\n    let replacements = [\r\n      ...societyFilter.replacements,\r\n      ...machineFilter.replacements\r\n    ];\r\n\r\n    if (pagination) {\r\n      query += ' LIMIT ? OFFSET ?';\r\n      replacements = [...replacements, pagination.limit, pagination.offset];\r\n    }\r\n\r\n    return { query, replacements };\r\n  }\r\n\r\n  /**\r\n   * Build complete SELECT query for machine password\r\n   */\r\n  static buildMachinePasswordQuery(\r\n    schemaName: string,\r\n    societyFilter: ReturnType<typeof QueryBuilder.buildSocietyFilter>,\r\n    machineFilter: ReturnType<typeof QueryBuilder.buildMachineFilter>\r\n  ): {\r\n    query: string;\r\n    replacements: (string | number)[];\r\n  } {\r\n    const baseQuery = QueryBuilder.buildBaseQuery(schemaName, 'machines');\r\n    \r\n    const query = `\r\n      SELECT \r\n        m.id, \r\n        m.machine_id, \r\n        m.user_password, \r\n        m.supervisor_password, \r\n        m.statusU, \r\n        m.statusS,\r\n        s.society_id as society_string_id\r\n      ${baseQuery}\r\n      WHERE ${societyFilter.condition}\r\n        AND ${machineFilter.condition}\r\n        AND m.status = 'active'\r\n    `;\r\n\r\n    const replacements = [\r\n      ...societyFilter.replacements,\r\n      ...machineFilter.replacements\r\n    ];\r\n\r\n    return { query, replacements };\r\n  }\r\n\r\n  /**\r\n   * Build society lookup query to get database ID from society_id string\r\n   */\r\n  static buildSocietyLookupQuery(\r\n    schemaName: string,\r\n    societyIdStr: string\r\n  ): {\r\n    query: string;\r\n    replacements: string[];\r\n  } {\r\n    const escapedSchema = QueryBuilder.escapeIdentifier(schemaName);\r\n    \r\n    // Try both with and without S- prefix\r\n    const lookupParams = societyIdStr.startsWith('S-') \r\n      ? [societyIdStr, societyIdStr.substring(2)]\r\n      : [`S-${societyIdStr}`, societyIdStr];\r\n    \r\n    const query = `\r\n      SELECT id FROM ${escapedSchema}.societies \r\n      WHERE society_id = ? OR society_id = ?\r\n      LIMIT 1\r\n    `;\r\n\r\n    return {\r\n      query,\r\n      replacements: lookupParams\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Safely escape database identifiers (schema/table names)\r\n   */\r\n  static escapeIdentifier(identifier: string): string {\r\n    // Remove any non-alphanumeric characters except underscores\r\n    const cleaned = identifier.replace(/[^a-zA-Z0-9_]/g, '');\r\n    return `\\`${cleaned}\\``;\r\n  }\r\n\r\n  /**\r\n   * Build pagination parameters\r\n   */\r\n  static buildPagination(pageNumber: number, pageSize: number = 5): {\r\n    limit: number;\r\n    offset: number;\r\n    pageNumber: number;\r\n  } {\r\n    const normalizedPageNumber = Math.max(1, pageNumber);\r\n    const offset = (normalizedPageNumber - 1) * pageSize;\r\n    \r\n    return {\r\n      limit: pageSize,\r\n      offset,\r\n      pageNumber: normalizedPageNumber\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Extract page number from C parameter format (C00001 = page 1, C00002 = page 2)\r\n   */\r\n  static parsePageNumber(lengthParam: string): number {\r\n    if (!lengthParam || !lengthParam.startsWith('C')) {\r\n      return 1;\r\n    }\r\n    \r\n    const pageNumber = parseInt(lengthParam.replace(/^C0*/, '')) || 1;\r\n    return Math.max(1, pageNumber);\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 916, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/ResponseFormatter.ts"],"sourcesContent":["/**\r\n * Response formatting utilities for external APIs\r\n */\r\nexport class ResponseFormatter {\r\n  /**\r\n   * Format farmer data for CSV download\r\n   */\r\n  static formatFarmerCSV(farmers: Array<{\r\n    id: number;\r\n    farmer_id: string;\r\n    name: string;\r\n    phone: string | null;\r\n    sms_enabled: 'ON' | 'OFF' | null;\r\n    bonus: number | null;\r\n  }>): string {\r\n    const csvHeader = 'ID,RF-ID,NAME,MOBILE,SMS,BONUS\\n';\r\n    \r\n    const csvData = farmers.map(farmer => {\r\n      const phone = farmer.phone || '';\r\n      const smsEnabled = farmer.sms_enabled || 'OFF';\r\n      \r\n      // Convert bonus to number and format without decimal places (matching sample format)\r\n      let bonus = '0';\r\n      if (farmer.bonus !== null && farmer.bonus !== undefined) {\r\n        const bonusNum = Number(farmer.bonus);\r\n        bonus = isNaN(bonusNum) ? '0' : Math.round(bonusNum).toString();\r\n      }\r\n      \r\n      // Escape CSV values that contain commas or quotes\r\n      const escapeCsv = (value: string) => {\r\n        if (value.includes(',') || value.includes('\"')) {\r\n          return `\"${value.replace(/\"/g, '\"\"')}\"`;\r\n        }\r\n        return value;\r\n      };\r\n      \r\n      return `${farmer.id},${escapeCsv(farmer.farmer_id)},${escapeCsv(farmer.name)},${escapeCsv(phone)},${smsEnabled},${bonus}`;\r\n    }).join('\\n');\r\n\r\n    return csvHeader + csvData;\r\n  }\r\n\r\n  /**\r\n   * Format farmer data for pagination response (pipe-delimited)\r\n   */\r\n  static formatFarmerPagination(farmers: Array<{\r\n    id: number;\r\n    farmer_id: string;\r\n    name: string;\r\n    phone: string | null;\r\n    sms_enabled: 'ON' | 'OFF' | null;\r\n    bonus: number | null;\r\n  }>): string {\r\n    // Format: id|farmer_id|name|phone|sms_enabled|bonus||\r\n    // Each farmer separated by ||, fields separated by |\r\n    const responseData = farmers.map(farmer => {\r\n      const phone = farmer.phone || '';\r\n      const smsEnabled = farmer.sms_enabled || 'OFF';\r\n      \r\n      // Convert bonus to number and format with 2 decimal places\r\n      let bonus = '0.00';\r\n      if (farmer.bonus !== null && farmer.bonus !== undefined) {\r\n        const bonusNum = Number(farmer.bonus);\r\n        bonus = isNaN(bonusNum) ? '0.00' : bonusNum.toFixed(2);\r\n      }\r\n      \r\n      return `${farmer.id}|${farmer.farmer_id}|${farmer.name}|${phone}|${smsEnabled}|${bonus}`;\r\n    }).join('||');\r\n\r\n    return responseData;\r\n  }\r\n\r\n  /**\r\n   * Format machine password response\r\n   */\r\n  static formatMachinePassword(\r\n    passwordType: { isUser: boolean; isSupervisor: boolean },\r\n    password: string\r\n  ): string {\r\n    if (passwordType.isUser) {\r\n      return `PU|${password}`;\r\n    } else if (passwordType.isSupervisor) {\r\n      return `PS|${password}`;\r\n    }\r\n    \r\n    throw new Error('Invalid password type for formatting');\r\n  }\r\n\r\n  /**\r\n   * Create standard success response with proper headers\r\n   */\r\n  static createSuccessResponse(\r\n    data: string, \r\n    contentType: 'text/plain' | 'text/csv' = 'text/plain',\r\n    additionalHeaders?: Record<string, string>\r\n  ): Response {\r\n    const headers: Record<string, string> = {\r\n      'Content-Type': contentType,\r\n      'Access-Control-Allow-Origin': '*',\r\n      'Access-Control-Allow-Methods': 'GET, POST',\r\n      'Access-Control-Allow-Headers': 'Content-Type',\r\n      ...additionalHeaders\r\n    };\r\n\r\n    // Add CSV-specific headers\r\n    if (contentType === 'text/csv') {\r\n      headers['Content-Disposition'] = 'attachment; filename=\"FarmerDetails.csv\"';\r\n    }\r\n\r\n    return new Response(`\"${data}\"`, {\r\n      status: 200,\r\n      headers\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create standard error response\r\n   */\r\n  static createErrorResponse(errorMessage: string): Response {\r\n    return new Response(`\"${errorMessage}\"`, {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'text/plain' }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create CORS preflight response\r\n   */\r\n  static createCORSResponse(): Response {\r\n    return new Response(null, {\r\n      status: 200,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Wrap response data in quotes (external API standard)\r\n   */\r\n  static wrapInQuotes(data: string): string {\r\n    return `\"${data}\"`;\r\n  }\r\n\r\n  /**\r\n   * Log response details for debugging\r\n   */\r\n  static logResponse(\r\n    endpointName: string,\r\n    dataType: string,\r\n    itemCount: number,\r\n    responsePreview?: string\r\n  ): void {\r\n    console.log(`üì§ ${endpointName}: Returning ${dataType} for ${itemCount} items`);\r\n    \r\n    if (responsePreview) {\r\n      const preview = responsePreview.length > 100 \r\n        ? `${responsePreview.substring(0, 100)}...` \r\n        : responsePreview;\r\n      console.log(`üì§ Response preview: ${preview}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log CSV response details\r\n   */\r\n  static logCSVResponse(endpointName: string, itemCount: number, csvSize: number): void {\r\n    console.log(`üìÅ ${endpointName}: Returning CSV data for ${itemCount} items`);\r\n    console.log(`üìÅ CSV size: ${csvSize} characters`);\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1041, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/ESP32ResponseHelper.ts"],"sourcesContent":["/**\r\n * ESP32-Friendly Response Helper\r\n * \r\n * Utilities for creating responses compatible with ESP32 WiFi modules\r\n * \r\n * Key Requirements:\r\n * - Always return HTTP 200 status (even for errors)\r\n * - No quotes around response text for simple messages\r\n * - Specific headers: charset=utf-8, Content-Length, Connection: close\r\n * - Cache-Control: no-cache for fresh data\r\n */\r\n\r\nexport class ESP32ResponseHelper {\r\n  /**\r\n   * Create ESP32-friendly success response\r\n   * @param data - Response data (will be quoted by default)\r\n   * @param options - Additional options\r\n   */\r\n  static createResponse(\r\n    data: string, \r\n    options?: {\r\n      contentType?: string;\r\n      addQuotes?: boolean;\r\n      additionalHeaders?: Record<string, string>;\r\n    }\r\n  ): Response {\r\n    const { \r\n      contentType = 'text/plain; charset=utf-8',\r\n      addQuotes = true, // Changed default to true\r\n      additionalHeaders = {}\r\n    } = options || {};\r\n\r\n    // Wrap response in double quotes by default for ESP32 compatibility\r\n    const responseBody = addQuotes ? `\"${data}\"` : data;\r\n    const contentLength = Buffer.byteLength(responseBody, 'utf8');\r\n\r\n    return new Response(responseBody, {\r\n      status: 200, // Always 200 for ESP32 compatibility\r\n      headers: {\r\n        'Content-Type': contentType,\r\n        'Content-Length': contentLength.toString(),\r\n        'Connection': 'close',\r\n        'Cache-Control': 'no-cache',\r\n        'Access-Control-Allow-Origin': '*',\r\n        ...additionalHeaders\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create ESP32-friendly error response (still returns 200 status)\r\n   */\r\n  static createErrorResponse(errorMessage: string): Response {\r\n    return ESP32ResponseHelper.createResponse(errorMessage);\r\n  }\r\n\r\n  /**\r\n   * Create success response with structured data (pipe-delimited format)\r\n   */\r\n  static createDataResponse(data: string): Response {\r\n    return ESP32ResponseHelper.createResponse(data, {\r\n      additionalHeaders: {\r\n        'Access-Control-Allow-Methods': 'GET, POST',\r\n        'Access-Control-Allow-Headers': 'Content-Type'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create CSV response with proper headers\r\n   */\r\n  static createCSVResponse(csvData: string, filename: string = 'data.csv'): Response {\r\n    return new Response(csvData, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'text/csv; charset=utf-8',\r\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\r\n        'Content-Length': Buffer.byteLength(csvData, 'utf8').toString(),\r\n        'Connection': 'close',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST',\r\n        'Access-Control-Allow-Headers': 'Content-Type'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create CORS preflight response\r\n   */\r\n  static createCORSResponse(): Response {\r\n    return new Response(null, {\r\n      status: 200,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Extract InputString from request (handles malformed URLs from ESP32)\r\n   */\r\n  static async extractInputString(request: Request): Promise<string | null> {\r\n    let inputString: string | null = null;\r\n\r\n    if (request.method === 'GET') {\r\n      const { searchParams } = new URL(request.url);\r\n      inputString = searchParams.get('InputString');\r\n\r\n      // Handle malformed URLs from ESP32 (e.g., \"?,InputString=...\")\r\n      if (!inputString) {\r\n        // Check if any param key contains \"InputString\" (handles \",InputString\" case)\r\n        for (const [key, value] of searchParams.entries()) {\r\n          if (key.includes('InputString')) {\r\n            inputString = value;\r\n            console.log(`   ‚úÖ ESP32: Found InputString in malformed param key: \"${key}\"`);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    } else if (request.method === 'POST') {\r\n      try {\r\n        const body = await request.json();\r\n        inputString = body.InputString || null;\r\n      } catch {\r\n        try {\r\n          const formData = await request.formData();\r\n          inputString = formData.get('InputString') as string || null;\r\n        } catch (error) {\r\n          console.log(`‚ùå ESP32: Failed to parse POST body:`, error);\r\n        }\r\n      }\r\n    }\r\n\r\n    return inputString;\r\n  }\r\n\r\n  /**\r\n   * Filter line ending characters from InputString\r\n   * ESP32 sends $0D, $0A, $0D$0A patterns\r\n   */\r\n  static filterLineEndings(inputString: string): string {\r\n    if (!inputString) return inputString;\r\n\r\n    const original = inputString;\r\n    \r\n    // Remove common line ending patterns\r\n    const filtered = inputString\r\n      .replace(/\\$0D\\$0A/g, '')  // CRLF\r\n      .replace(/\\$0D/g, '')      // CR\r\n      .replace(/\\$0A/g, '')      // LF\r\n      .replace(/\\r\\n/g, '')      // Actual CRLF\r\n      .replace(/\\r/g, '')        // Actual CR\r\n      .replace(/\\n/g, '');       // Actual LF\r\n    \r\n    if (original !== filtered) {\r\n      console.log(`üßπ ESP32: Filtered line endings: \"${original}\" -> \"${filtered}\"`);\r\n    }\r\n\r\n    return filtered;\r\n  }\r\n\r\n  /**\r\n   * Log ESP32 request details for debugging\r\n   */\r\n  static logRequest(request: Request, dbKey: string, inputString: string | null): void {\r\n    console.log(`\\n${'='.repeat(80)}`);\r\n    console.log(`üì° ESP32 External API Request:`);\r\n    console.log(`   Timestamp: ${new Date().toISOString()}`);\r\n    console.log(`   Method: ${request.method}`);\r\n    console.log(`   Full URL: ${request.url}`);\r\n    console.log(`   DB Key: \"${dbKey}\"`);\r\n    console.log(`   InputString: \"${inputString}\"`);\r\n    console.log(`   Headers:`, {\r\n      'user-agent': request.headers.get('user-agent'),\r\n      'content-type': request.headers.get('content-type'),\r\n      'connection': request.headers.get('connection'),\r\n      'host': request.headers.get('host')\r\n    });\r\n    console.log(`${'='.repeat(80)}\\n`);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1194, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/external-api/index.ts"],"sourcesContent":["// External API pattern base classes and utilities\r\nexport { BaseExternalAPI } from './BaseExternalAPI';\r\nexport type { \r\n  BaseInputParts, \r\n  ValidationResult, \r\n  ExternalAPIConfig \r\n} from './BaseExternalAPI';\r\n\r\n// Input validation utilities\r\nexport { InputValidator } from './InputValidator';\r\n\r\n// Database query building utilities\r\nexport { QueryBuilder } from './QueryBuilder';\r\n\r\n// Response formatting utilities  \r\nexport { ResponseFormatter } from './ResponseFormatter';\r\n\r\n// ESP32-specific response utilities\r\nexport { ESP32ResponseHelper } from './ESP32ResponseHelper';\r\n\r\n// Re-import for interface extension\r\nimport type { BaseInputParts } from './BaseExternalAPI';\r\n\r\n// Common interfaces for external APIs\r\nexport interface FarmerInfoInput extends BaseInputParts {\r\n  pageNumber?: string; // Optional 5th part for pagination\r\n}\r\n\r\nexport interface MachinePasswordInput extends BaseInputParts {\r\n  passwordType: string; // Required 5th part for password type\r\n}\r\n\r\nexport interface MachineUpdateInput extends BaseInputParts {\r\n  datetime?: string; // Optional datetime parameter\r\n}\r\n\r\nexport interface MachineCorrectionInput extends BaseInputParts {\r\n  // Standard 4 parts only (societyId, machineType, version, machineId)\r\n  _marker?: never; // Type marker to prevent linting error\r\n}\r\n\r\nexport interface FarmerResult {\r\n  id: number;\r\n  farmer_id: string;\r\n  rf_id: string;\r\n  name: string;\r\n  phone: string | null;\r\n  sms_enabled: 'ON' | 'OFF' | null;\r\n  bonus: number | null;\r\n}\r\n\r\nexport interface MachinePasswordResult {\r\n  id: number;\r\n  machine_id: string;\r\n  user_password: string | null;\r\n  supervisor_password: string | null;\r\n  statusU: number;\r\n  statusS: number;\r\n  society_string_id?: string;\r\n}\r\n\r\nexport interface MachineCorrectionResult {\r\n  id: number;\r\n  machine_id: number;\r\n  channel1_fat: number;\r\n  channel1_snf: number;\r\n  channel1_clr: number;\r\n  channel1_temp: number;\r\n  channel1_water: number;\r\n  channel1_protein: number;\r\n  channel2_fat: number;\r\n  channel2_snf: number;\r\n  channel2_clr: number;\r\n  channel2_temp: number;\r\n  channel2_water: number;\r\n  channel2_protein: number;\r\n  channel3_fat: number;\r\n  channel3_snf: number;\r\n  channel3_clr: number;\r\n  channel3_temp: number;\r\n  channel3_water: number;\r\n  channel3_protein: number;\r\n  status: number;\r\n  created_at: Date;\r\n  updated_at: Date;\r\n}"],"names":[],"mappings":"AAAA,kDAAkD;;AAClD;AAOA,6BAA6B;AAC7B;AAEA,oCAAoC;AACpC;AAEA,kCAAkC;AAClC;AAEA,oCAAoC;AACpC","debugId":null}},
    {"offset": {"line": 1214, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/lib/sectionPulseTracker.ts"],"sourcesContent":["import { Sequelize, QueryTypes } from 'sequelize';\r\n\r\n/**\r\n * Section Pulse Tracker\r\n * \r\n * Tracks first and last milk collections per society per day\r\n * Manages section start/end pulse and inactivity periods\r\n */\r\n\r\ninterface PulseUpdateResult {\r\n  societyId: number;\r\n  pulseDate: string;\r\n  firstCollectionTime: Date | null;\r\n  lastCollectionTime: Date | null;\r\n  sectionEndTime: Date | null;\r\n  pulseStatus: 'not_started' | 'active' | 'paused' | 'ended' | 'inactive';\r\n  totalCollections: number;\r\n  inactiveDays: number;\r\n  createdAt?: Date | string | null;\r\n}\r\n\r\nexport class SectionPulseTracker {\r\n  /**\r\n   * Update pulse on new milk collection\r\n   * - Records first collection time (section start pulse)\r\n   * - Updates last collection time\r\n   * - Increments total collections counter (only for new collections)\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   * @param societyId Society database ID\r\n   * @param collectionDateTime Collection datetime (YYYY-MM-DD HH:MM:SS)\r\n   * @param isNewCollection Whether this is a new collection (not a duplicate update)\r\n   */\r\n  static async updatePulseOnCollection(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    societyId: number,\r\n    collectionDateTime: Date | string,\r\n    isNewCollection: boolean = true\r\n  ): Promise<void> {\r\n    try {\r\n      // Parse collection datetime - handle both string and Date\r\n      // Store as string to preserve IST timezone when passing to MySQL\r\n      let collectionDateStr: string;\r\n      let dateStr: string;\r\n      \r\n      if (typeof collectionDateTime === 'string') {\r\n        // If it's a string like \"2025-12-02 01:00:26\", use it directly\r\n        collectionDateStr = collectionDateTime;\r\n        dateStr = collectionDateTime.split(' ')[0]; // Get \"2025-12-02\"\r\n      } else {\r\n        // Convert Date to IST string format: YYYY-MM-DD HH:MM:SS\r\n        const offset = 5.5 * 60 * 60 * 1000; // IST offset in milliseconds\r\n        const istDate = new Date(collectionDateTime.getTime() + offset);\r\n        collectionDateStr = istDate.toISOString().slice(0, 19).replace('T', ' ');\r\n        dateStr = collectionDateStr.split(' ')[0];\r\n      }\r\n\r\n      console.log(`üìç Updating pulse for society ${societyId} on ${dateStr} at ${collectionDateStr}`);\r\n      console.log(`   üî¢ isNewCollection flag: ${isNewCollection} (will ${isNewCollection ? 'INCREMENT' : 'NOT INCREMENT'} total_collections)`);\r\n\r\n      // Check if pulse record exists for today\r\n      const existingPulse = await sequelize.query<{\r\n        id: number;\r\n        first_collection_time: Date | null;\r\n        total_collections: number;\r\n        pulse_status: string;\r\n      }>(`\r\n        SELECT id, first_collection_time, total_collections, pulse_status\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE society_id = ? AND DATE(pulse_date) = ?\r\n      `, {\r\n        replacements: [societyId, dateStr],\r\n        type: QueryTypes.SELECT\r\n      });\r\n\r\n      console.log(`üîç Query result:`, { length: existingPulse?.length, data: existingPulse });\r\n\r\n      if (!existingPulse || existingPulse.length === 0) {\r\n        // First collection of the day - create new pulse record\r\n        await sequelize.query(`\r\n          INSERT INTO \\`${schemaName}\\`.section_pulse (\r\n            society_id,\r\n            pulse_date,\r\n            first_collection_time,\r\n            last_collection_time,\r\n            pulse_status,\r\n            total_collections,\r\n            inactive_days,\r\n            last_checked,\r\n            created_at,\r\n            updated_at\r\n          ) VALUES (?, ?, ?, ?, 'active', 1, 0, NOW(), CONVERT_TZ(NOW(), '+00:00', '+05:30'), CONVERT_TZ(NOW(), '+00:00', '+05:30'))\r\n        `, {\r\n          replacements: [\r\n            societyId,\r\n            dateStr,\r\n            collectionDateStr,\r\n            collectionDateStr\r\n          ]\r\n        });\r\n\r\n        console.log(`üü¢ Section start pulse recorded at ${collectionDateStr}`);\r\n      } else {\r\n        // Update existing pulse record - restart if paused or ended\r\n        const currentStatus = existingPulse[0].pulse_status;\r\n        \r\n        // Only increment total_collections if this is a new collection (not a duplicate update)\r\n        const updateQuery = isNewCollection \r\n          ? `UPDATE \\`${schemaName}\\`.section_pulse\r\n             SET \r\n               last_collection_time = ?,\r\n               total_collections = total_collections + 1,\r\n               pulse_status = 'active',\r\n               section_end_time = NULL,\r\n               last_checked = NOW(),\r\n               updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n             WHERE society_id = ? AND DATE(pulse_date) = ?`\r\n          : `UPDATE \\`${schemaName}\\`.section_pulse\r\n             SET \r\n               last_collection_time = ?,\r\n               pulse_status = 'active',\r\n               section_end_time = NULL,\r\n               last_checked = NOW(),\r\n               updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n             WHERE society_id = ? AND DATE(pulse_date) = ?`;\r\n        \r\n        await sequelize.query(updateQuery, {\r\n          replacements: [collectionDateStr, societyId, dateStr]\r\n        });\r\n\r\n        if (currentStatus === 'paused') {\r\n          console.log(`‚ñ∂Ô∏è Section restarted from pause - collection at ${collectionDateStr}`);\r\n        } else if (currentStatus === 'ended') {\r\n          console.log(`üîÑ Section restarted from ended state - collection at ${collectionDateStr}`);\r\n        } else {\r\n          console.log(`üîµ Pulse updated - last collection at ${collectionDateStr}${isNewCollection ? '' : ' (duplicate, count unchanged)'}`);\r\n        }\r\n      }\r\n\r\n      // Reset inactive days counter since we have activity\r\n      await this.resetInactiveDays(sequelize, schemaName, societyId, dateStr);\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error updating pulse on collection:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check for section pause (5 minutes of inactivity) and section end (60 minutes)\r\n   * Should be called periodically (e.g., every 1-2 minutes)\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   */\r\n  static async checkSectionPauseAndEnd(\r\n    sequelize: Sequelize,\r\n    schemaName: string\r\n  ): Promise<void> {\r\n    try {\r\n      const now = new Date();\r\n      const today = now.toISOString().split('T')[0];\r\n      const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);\r\n      const sixtyMinutesAgo = new Date(now.getTime() - 60 * 60 * 1000);\r\n\r\n      // 1. End all active/paused sections from previous days\r\n      const [oldPulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status IN ('active', 'paused')\r\n        AND DATE(pulse_date) < ?\r\n        AND section_end_time IS NULL\r\n      `, {\r\n        replacements: [today],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      // Mark old sections as ended\r\n      for (const pulse of (oldPulses || [])) {\r\n        const sectionEndTime = pulse.last_collection_time ? \r\n          new Date(new Date(pulse.last_collection_time).getTime() + 60 * 60 * 1000) : null;\r\n\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            section_end_time = ?,\r\n            pulse_status = 'ended',\r\n            last_checked = NOW(),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [sectionEndTime, pulse.id]\r\n        });\r\n\r\n        console.log(`üî¥ Old section ended for society ${pulse.society_id} (date: ${pulse.pulse_date})`);\r\n      }\r\n\r\n      // 2. Check for sections to pause (5 minutes inactive, currently active, TODAY only)\r\n      const [activePulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status = 'active'\r\n        AND DATE(pulse_date) = ?\r\n        AND last_collection_time IS NOT NULL\r\n        AND last_collection_time <= ?\r\n        AND last_collection_time > ?\r\n      `, {\r\n        replacements: [today, fiveMinutesAgo, sixtyMinutesAgo],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      // Mark sections as paused\r\n      for (const pulse of (activePulses || [])) {\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            pulse_status = 'paused',\r\n            last_checked = NOW(),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [pulse.id]\r\n        });\r\n\r\n        console.log(`‚è∏Ô∏è Section paused for society ${pulse.society_id} - no collection for 5 minutes`);\r\n      }\r\n\r\n      // 3. Check for sections to end (60 minutes inactive, currently active or paused, TODAY only)\r\n      const [inactivePulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status IN ('active', 'paused')\r\n        AND DATE(pulse_date) = ?\r\n        AND last_collection_time IS NOT NULL\r\n        AND last_collection_time <= ?\r\n        AND section_end_time IS NULL\r\n      `, {\r\n        replacements: [today, sixtyMinutesAgo],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      // Mark sections as ended\r\n      for (const pulse of (inactivePulses || [])) {\r\n        const sectionEndTime = new Date(pulse.last_collection_time.getTime() + 60 * 60 * 1000);\r\n\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            section_end_time = ?,\r\n            pulse_status = 'ended',\r\n            last_checked = CONVERT_TZ(NOW(), '+00:00', '+05:30'),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [sectionEndTime, pulse.id]\r\n        });\r\n\r\n        console.log(`üî¥ Section end pulse recorded for society ${pulse.society_id} at ${sectionEndTime.toISOString()}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error checking section pause and end:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check for section end (60 minutes of inactivity after last collection)\r\n   * Should be called periodically (e.g., every 10-15 minutes)\r\n   * \r\n   * @deprecated Use checkSectionPauseAndEnd instead for better granularity\r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   */\r\n  static async checkSectionEnd(\r\n    sequelize: Sequelize,\r\n    schemaName: string\r\n  ): Promise<void> {\r\n    try {\r\n      const now = new Date();\r\n      const sixtyMinutesAgo = new Date(now.getTime() - 60 * 60 * 1000);\r\n\r\n      // Find active pulses where last collection was > 60 minutes ago\r\n      const [activePulses] = await sequelize.query<{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }>(`\r\n        SELECT id, society_id, pulse_date, last_collection_time\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE pulse_status = 'active'\r\n        AND last_collection_time IS NOT NULL\r\n        AND last_collection_time <= ?\r\n        AND section_end_time IS NULL\r\n      `, {\r\n        replacements: [sixtyMinutesAgo],\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{\r\n        id: number;\r\n        society_id: number;\r\n        pulse_date: string;\r\n        last_collection_time: Date;\r\n      }[]];\r\n\r\n      for (const pulse of (activePulses || [])) {\r\n        const sectionEndTime = new Date(pulse.last_collection_time.getTime() + 60 * 60 * 1000);\r\n\r\n        await sequelize.query(`\r\n          UPDATE \\`${schemaName}\\`.section_pulse\r\n          SET \r\n            section_end_time = ?,\r\n            pulse_status = 'ended',\r\n            last_checked = CONVERT_TZ(NOW(), '+00:00', '+05:30'),\r\n            updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          WHERE id = ?\r\n        `, {\r\n          replacements: [sectionEndTime, pulse.id]\r\n        });\r\n\r\n        console.log(`üî¥ Section end pulse recorded for society ${pulse.society_id} at ${sectionEndTime.toISOString()}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error checking section end:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check for multi-day inactivity\r\n   * Updates inactive_days counter for societies without collections\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   */\r\n  static async checkInactivity(\r\n    sequelize: Sequelize,\r\n    schemaName: string\r\n  ): Promise<void> {\r\n    try {\r\n      const today = new Date().toISOString().split('T')[0];\r\n      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];\r\n\r\n      // Get all societies\r\n      const [societies] = await sequelize.query<{ id: number }>(`\r\n        SELECT id FROM \\`${schemaName}\\`.societies\r\n        WHERE status = 'active'\r\n      `, {\r\n        type: QueryTypes.SELECT\r\n      }) as unknown as [{ id: number }[]];\r\n\r\n      for (const society of (societies || [])) {\r\n        // Check if society has pulse record for today\r\n        const [todayPulse] = await sequelize.query<{ id: number }>(`\r\n          SELECT id FROM \\`${schemaName}\\`.section_pulse\r\n          WHERE society_id = ? AND DATE(pulse_date) = ?\r\n        `, {\r\n          replacements: [society.id, today],\r\n          type: QueryTypes.SELECT\r\n        }) as unknown as [{ id: number }[]];\r\n\r\n        if (!todayPulse || todayPulse.length === 0) {\r\n          // No pulse today - check yesterday's pulse\r\n          const [yesterdayPulse] = await sequelize.query<{\r\n            inactive_days: number;\r\n            pulse_status: string;\r\n          }>(`\r\n            SELECT inactive_days, pulse_status\r\n            FROM \\`${schemaName}\\`.section_pulse\r\n            WHERE society_id = ? AND DATE(pulse_date) = ?\r\n          `, {\r\n            replacements: [society.id, yesterday],\r\n            type: QueryTypes.SELECT\r\n          }) as unknown as [{\r\n            inactive_days: number;\r\n            pulse_status: string;\r\n          }[]];\r\n\r\n          let inactiveDays = 1;\r\n          if (yesterdayPulse && yesterdayPulse.length > 0) {\r\n            inactiveDays = (yesterdayPulse[0].inactive_days || 0) + 1;\r\n          }\r\n\r\n          // Create today's pulse record with inactive status\r\n          await sequelize.query(`\r\n            INSERT INTO \\`${schemaName}\\`.section_pulse (\r\n              society_id,\r\n              pulse_date,\r\n              pulse_status,\r\n              inactive_days,\r\n              last_checked,\r\n              created_at,\r\n              updated_at\r\n            ) VALUES (?, ?, 'inactive', ?, NOW(), CONVERT_TZ(NOW(), '+00:00', '+05:30'), CONVERT_TZ(NOW(), '+00:00', '+05:30'))\r\n            ON DUPLICATE KEY UPDATE\r\n              pulse_status = 'inactive',\r\n              inactive_days = ?,\r\n              last_checked = NOW(),\r\n              updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n          `, {\r\n            replacements: [society.id, today, inactiveDays, inactiveDays]\r\n          });\r\n\r\n          console.log(`‚ö™ No pulse for society ${society.id} - ${inactiveDays} day(s) inactive`);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error checking inactivity:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Reset inactive days counter\r\n   */\r\n  private static async resetInactiveDays(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    societyId: number,\r\n    pulseDate: string\r\n  ): Promise<void> {\r\n    await sequelize.query(`\r\n      UPDATE \\`${schemaName}\\`.section_pulse\r\n      SET inactive_days = 0\r\n      WHERE society_id = ? AND DATE(pulse_date) = ?\r\n    `, {\r\n      replacements: [societyId, pulseDate]\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get pulse status for a society\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   * @param societyId Society database ID\r\n   * @param date Date string (YYYY-MM-DD) - defaults to today\r\n   */\r\n  static async getPulseStatus(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    societyId: number,\r\n    date?: string\r\n  ): Promise<PulseUpdateResult | null> {\r\n    try {\r\n      const pulseDate = date || new Date().toISOString().split('T')[0];\r\n\r\n      const pulseRecords = await sequelize.query(`\r\n        SELECT \r\n          society_id,\r\n          pulse_date,\r\n          first_collection_time,\r\n          last_collection_time,\r\n          section_end_time,\r\n          pulse_status,\r\n          total_collections,\r\n          inactive_days,\r\n          created_at\r\n        FROM \\`${schemaName}\\`.section_pulse\r\n        WHERE society_id = ? AND DATE(pulse_date) = ?\r\n      `, {\r\n        replacements: [societyId, pulseDate],\r\n        type: QueryTypes.SELECT\r\n      }) as {\r\n        society_id: number;\r\n        pulse_date: string;\r\n        first_collection_time: Date | null;\r\n        last_collection_time: Date | null;\r\n        section_end_time: Date | null;\r\n        pulse_status: 'not_started' | 'active' | 'paused' | 'ended' | 'inactive';\r\n        total_collections: number;\r\n        inactive_days: number;\r\n        created_at: Date | null;\r\n      }[];\r\n\r\n      if (!pulseRecords || pulseRecords.length === 0) {\r\n        // No pulse record exists - section not started\r\n        return {\r\n          societyId,\r\n          pulseDate,\r\n          firstCollectionTime: null,\r\n          lastCollectionTime: null,\r\n          sectionEndTime: null,\r\n          pulseStatus: 'not_started',\r\n          totalCollections: 0,\r\n          inactiveDays: 0,\r\n          createdAt: null\r\n        };\r\n      }\r\n\r\n      const pulse = pulseRecords[0];\r\n      return {\r\n        societyId: pulse.society_id,\r\n        pulseDate: pulse.pulse_date,\r\n        firstCollectionTime: pulse.first_collection_time,\r\n        lastCollectionTime: pulse.last_collection_time,\r\n        sectionEndTime: pulse.section_end_time,\r\n        pulseStatus: pulse.pulse_status,\r\n        totalCollections: pulse.total_collections,\r\n        inactiveDays: pulse.inactive_days,\r\n        createdAt: pulse.created_at\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error getting pulse status:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get pulse status for all societies\r\n   * \r\n   * @param sequelize Sequelize instance\r\n   * @param schemaName Admin schema name\r\n   * @param date Date string (YYYY-MM-DD) - defaults to today\r\n   */\r\n  static async getAllPulseStatuses(\r\n    sequelize: Sequelize,\r\n    schemaName: string,\r\n    date?: string\r\n  ): Promise<PulseUpdateResult[]> {\r\n    try {\r\n      const pulseDate = date || new Date().toISOString().split('T')[0];\r\n\r\n      const pulseRecords = await sequelize.query(`\r\n        SELECT \r\n          s.id as society_id,\r\n          s.name as society_name,\r\n          COALESCE(sp.pulse_date, ?) as pulse_date,\r\n          sp.first_collection_time,\r\n          sp.last_collection_time,\r\n          sp.section_end_time,\r\n          COALESCE(sp.pulse_status, 'not_started') as pulse_status,\r\n          COALESCE(sp.total_collections, 0) as total_collections,\r\n          COALESCE(sp.inactive_days, 0) as inactive_days,\r\n          sp.created_at\r\n        FROM \\`${schemaName}\\`.societies s\r\n        LEFT JOIN \\`${schemaName}\\`.section_pulse sp \r\n          ON s.id = sp.society_id AND DATE(sp.pulse_date) = ?\r\n        WHERE s.status = 'active'\r\n        ORDER BY s.name\r\n      `, {\r\n        replacements: [pulseDate, pulseDate],\r\n        type: QueryTypes.SELECT\r\n      }) as {\r\n        society_id: number;\r\n        society_name: string;\r\n        pulse_date: string;\r\n        first_collection_time: Date | null;\r\n        last_collection_time: Date | null;\r\n        section_end_time: Date | null;\r\n        pulse_status: 'not_started' | 'active' | 'ended' | 'inactive';\r\n        total_collections: number;\r\n        inactive_days: number;\r\n        created_at: Date | null;\r\n      }[];\r\n\r\n      return (pulseRecords || []).map(pulse => ({\r\n        societyId: pulse.society_id,\r\n        pulseDate: pulse.pulse_date,\r\n        firstCollectionTime: pulse.first_collection_time,\r\n        lastCollectionTime: pulse.last_collection_time,\r\n        sectionEndTime: pulse.section_end_time,\r\n        pulseStatus: pulse.pulse_status,\r\n        totalCollections: pulse.total_collections,\r\n        inactiveDays: pulse.inactive_days,\r\n        createdAt: pulse.created_at\r\n      }));\r\n    } catch (error) {\r\n      console.error('‚ùå Error getting all pulse statuses:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAqBO,MAAM;IACX;;;;;;;;;;;GAWC,GACD,aAAa,wBACX,SAAoB,EACpB,UAAkB,EAClB,SAAiB,EACjB,kBAAiC,EACjC,kBAA2B,IAAI,EAChB;QACf,IAAI;YACF,0DAA0D;YAC1D,iEAAiE;YACjE,IAAI;YACJ,IAAI;YAEJ,IAAI,OAAO,uBAAuB,UAAU;gBAC1C,+DAA+D;gBAC/D,oBAAoB;gBACpB,UAAU,mBAAmB,KAAK,CAAC,IAAI,CAAC,EAAE,EAAE,mBAAmB;YACjE,OAAO;gBACL,yDAAyD;gBACzD,MAAM,SAAS,MAAM,KAAK,KAAK,MAAM,6BAA6B;gBAClE,MAAM,UAAU,IAAI,KAAK,mBAAmB,OAAO,KAAK;gBACxD,oBAAoB,QAAQ,WAAW,GAAG,KAAK,CAAC,GAAG,IAAI,OAAO,CAAC,KAAK;gBACpE,UAAU,kBAAkB,KAAK,CAAC,IAAI,CAAC,EAAE;YAC3C;YAEA,QAAQ,GAAG,CAAC,CAAC,8BAA8B,EAAE,UAAU,IAAI,EAAE,QAAQ,IAAI,EAAE,mBAAmB;YAC9F,QAAQ,GAAG,CAAC,CAAC,4BAA4B,EAAE,gBAAgB,OAAO,EAAE,kBAAkB,cAAc,gBAAgB,mBAAmB,CAAC;YAExI,yCAAyC;YACzC,MAAM,gBAAgB,MAAM,UAAU,KAAK,CAKxC,CAAC;;eAEK,EAAE,WAAW;;MAEtB,CAAC,EAAE;gBACD,cAAc;oBAAC;oBAAW;iBAAQ;gBAClC,MAAM,0JAAU,CAAC,MAAM;YACzB;YAEA,QAAQ,GAAG,CAAC,CAAC,gBAAgB,CAAC,EAAE;gBAAE,QAAQ,eAAe;gBAAQ,MAAM;YAAc;YAErF,IAAI,CAAC,iBAAiB,cAAc,MAAM,KAAK,GAAG;gBAChD,wDAAwD;gBACxD,MAAM,UAAU,KAAK,CAAC,CAAC;wBACP,EAAE,WAAW;;;;;;;;;;;;QAY7B,CAAC,EAAE;oBACD,cAAc;wBACZ;wBACA;wBACA;wBACA;qBACD;gBACH;gBAEA,QAAQ,GAAG,CAAC,CAAC,mCAAmC,EAAE,mBAAmB;YACvE,OAAO;gBACL,4DAA4D;gBAC5D,MAAM,gBAAgB,aAAa,CAAC,EAAE,CAAC,YAAY;gBAEnD,wFAAwF;gBACxF,MAAM,cAAc,kBAChB,CAAC,SAAS,EAAE,WAAW;;;;;;;;0DAQuB,CAAC,GAC/C,CAAC,SAAS,EAAE,WAAW;;;;;;;0DAOuB,CAAC;gBAEnD,MAAM,UAAU,KAAK,CAAC,aAAa;oBACjC,cAAc;wBAAC;wBAAmB;wBAAW;qBAAQ;gBACvD;gBAEA,IAAI,kBAAkB,UAAU;oBAC9B,QAAQ,GAAG,CAAC,CAAC,gDAAgD,EAAE,mBAAmB;gBACpF,OAAO,IAAI,kBAAkB,SAAS;oBACpC,QAAQ,GAAG,CAAC,CAAC,sDAAsD,EAAE,mBAAmB;gBAC1F,OAAO;oBACL,QAAQ,GAAG,CAAC,CAAC,sCAAsC,EAAE,oBAAoB,kBAAkB,KAAK,iCAAiC;gBACnI;YACF;YAEA,qDAAqD;YACrD,MAAM,IAAI,CAAC,iBAAiB,CAAC,WAAW,YAAY,WAAW;QAEjE,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,yCAAyC;YACvD,MAAM;QACR;IACF;IAEA;;;;;;GAMC,GACD,aAAa,wBACX,SAAoB,EACpB,UAAkB,EACH;QACf,IAAI;YACF,MAAM,MAAM,IAAI;YAChB,MAAM,QAAQ,IAAI,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAC7C,MAAM,iBAAiB,IAAI,KAAK,IAAI,OAAO,KAAK,IAAI,KAAK;YACzD,MAAM,kBAAkB,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,KAAK;YAE3D,uDAAuD;YACvD,MAAM,CAAC,UAAU,GAAG,MAAM,UAAU,KAAK,CAKtC,CAAC;;eAEK,EAAE,WAAW;;;;MAItB,CAAC,EAAE;gBACD,cAAc;oBAAC;iBAAM;gBACrB,MAAM,0JAAU,CAAC,MAAM;YACzB;YAOA,6BAA6B;YAC7B,KAAK,MAAM,SAAU,aAAa,EAAE,CAAG;gBACrC,MAAM,iBAAiB,MAAM,oBAAoB,GAC/C,IAAI,KAAK,IAAI,KAAK,MAAM,oBAAoB,EAAE,OAAO,KAAK,KAAK,KAAK,QAAQ;gBAE9E,MAAM,UAAU,KAAK,CAAC,CAAC;mBACZ,EAAE,WAAW;;;;;;;QAOxB,CAAC,EAAE;oBACD,cAAc;wBAAC;wBAAgB,MAAM,EAAE;qBAAC;gBAC1C;gBAEA,QAAQ,GAAG,CAAC,CAAC,iCAAiC,EAAE,MAAM,UAAU,CAAC,QAAQ,EAAE,MAAM,UAAU,CAAC,CAAC,CAAC;YAChG;YAEA,oFAAoF;YACpF,MAAM,CAAC,aAAa,GAAG,MAAM,UAAU,KAAK,CAKzC,CAAC;;eAEK,EAAE,WAAW;;;;;;MAMtB,CAAC,EAAE;gBACD,cAAc;oBAAC;oBAAO;oBAAgB;iBAAgB;gBACtD,MAAM,0JAAU,CAAC,MAAM;YACzB;YAOA,0BAA0B;YAC1B,KAAK,MAAM,SAAU,gBAAgB,EAAE,CAAG;gBACxC,MAAM,UAAU,KAAK,CAAC,CAAC;mBACZ,EAAE,WAAW;;;;;;QAMxB,CAAC,EAAE;oBACD,cAAc;wBAAC,MAAM,EAAE;qBAAC;gBAC1B;gBAEA,QAAQ,GAAG,CAAC,CAAC,8BAA8B,EAAE,MAAM,UAAU,CAAC,8BAA8B,CAAC;YAC/F;YAEA,6FAA6F;YAC7F,MAAM,CAAC,eAAe,GAAG,MAAM,UAAU,KAAK,CAK3C,CAAC;;eAEK,EAAE,WAAW;;;;;;MAMtB,CAAC,EAAE;gBACD,cAAc;oBAAC;oBAAO;iBAAgB;gBACtC,MAAM,0JAAU,CAAC,MAAM;YACzB;YAOA,yBAAyB;YACzB,KAAK,MAAM,SAAU,kBAAkB,EAAE,CAAG;gBAC1C,MAAM,iBAAiB,IAAI,KAAK,MAAM,oBAAoB,CAAC,OAAO,KAAK,KAAK,KAAK;gBAEjF,MAAM,UAAU,KAAK,CAAC,CAAC;mBACZ,EAAE,WAAW;;;;;;;QAOxB,CAAC,EAAE;oBACD,cAAc;wBAAC;wBAAgB,MAAM,EAAE;qBAAC;gBAC1C;gBAEA,QAAQ,GAAG,CAAC,CAAC,0CAA0C,EAAE,MAAM,UAAU,CAAC,IAAI,EAAE,eAAe,WAAW,IAAI;YAChH;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,2CAA2C;YACzD,MAAM;QACR;IACF;IAEA;;;;;;;GAOC,GACD,aAAa,gBACX,SAAoB,EACpB,UAAkB,EACH;QACf,IAAI;YACF,MAAM,MAAM,IAAI;YAChB,MAAM,kBAAkB,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,KAAK;YAE3D,gEAAgE;YAChE,MAAM,CAAC,aAAa,GAAG,MAAM,UAAU,KAAK,CAKzC,CAAC;;eAEK,EAAE,WAAW;;;;;MAKtB,CAAC,EAAE;gBACD,cAAc;oBAAC;iBAAgB;gBAC/B,MAAM,0JAAU,CAAC,MAAM;YACzB;YAOA,KAAK,MAAM,SAAU,gBAAgB,EAAE,CAAG;gBACxC,MAAM,iBAAiB,IAAI,KAAK,MAAM,oBAAoB,CAAC,OAAO,KAAK,KAAK,KAAK;gBAEjF,MAAM,UAAU,KAAK,CAAC,CAAC;mBACZ,EAAE,WAAW;;;;;;;QAOxB,CAAC,EAAE;oBACD,cAAc;wBAAC;wBAAgB,MAAM,EAAE;qBAAC;gBAC1C;gBAEA,QAAQ,GAAG,CAAC,CAAC,0CAA0C,EAAE,MAAM,UAAU,CAAC,IAAI,EAAE,eAAe,WAAW,IAAI;YAChH;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,MAAM;QACR;IACF;IAEA;;;;;;GAMC,GACD,aAAa,gBACX,SAAoB,EACpB,UAAkB,EACH;QACf,IAAI;YACF,MAAM,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YACpD,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK,MAAM,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAExF,oBAAoB;YACpB,MAAM,CAAC,UAAU,GAAG,MAAM,UAAU,KAAK,CAAiB,CAAC;yBACxC,EAAE,WAAW;;MAEhC,CAAC,EAAE;gBACD,MAAM,0JAAU,CAAC,MAAM;YACzB;YAEA,KAAK,MAAM,WAAY,aAAa,EAAE,CAAG;gBACvC,8CAA8C;gBAC9C,MAAM,CAAC,WAAW,GAAG,MAAM,UAAU,KAAK,CAAiB,CAAC;2BACzC,EAAE,WAAW;;QAEhC,CAAC,EAAE;oBACD,cAAc;wBAAC,QAAQ,EAAE;wBAAE;qBAAM;oBACjC,MAAM,0JAAU,CAAC,MAAM;gBACzB;gBAEA,IAAI,CAAC,cAAc,WAAW,MAAM,KAAK,GAAG;oBAC1C,2CAA2C;oBAC3C,MAAM,CAAC,eAAe,GAAG,MAAM,UAAU,KAAK,CAG3C,CAAC;;mBAEK,EAAE,WAAW;;UAEtB,CAAC,EAAE;wBACD,cAAc;4BAAC,QAAQ,EAAE;4BAAE;yBAAU;wBACrC,MAAM,0JAAU,CAAC,MAAM;oBACzB;oBAKA,IAAI,eAAe;oBACnB,IAAI,kBAAkB,eAAe,MAAM,GAAG,GAAG;wBAC/C,eAAe,CAAC,cAAc,CAAC,EAAE,CAAC,aAAa,IAAI,CAAC,IAAI;oBAC1D;oBAEA,mDAAmD;oBACnD,MAAM,UAAU,KAAK,CAAC,CAAC;0BACP,EAAE,WAAW;;;;;;;;;;;;;;UAc7B,CAAC,EAAE;wBACD,cAAc;4BAAC,QAAQ,EAAE;4BAAE;4BAAO;4BAAc;yBAAa;oBAC/D;oBAEA,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,QAAQ,EAAE,CAAC,GAAG,EAAE,aAAa,gBAAgB,CAAC;gBACtF;YACF;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,MAAM;QACR;IACF;IAEA;;GAEC,GACD,aAAqB,kBACnB,SAAoB,EACpB,UAAkB,EAClB,SAAiB,EACjB,SAAiB,EACF;QACf,MAAM,UAAU,KAAK,CAAC,CAAC;eACZ,EAAE,WAAW;;;IAGxB,CAAC,EAAE;YACD,cAAc;gBAAC;gBAAW;aAAU;QACtC;IACF;IAEA;;;;;;;GAOC,GACD,aAAa,eACX,SAAoB,EACpB,UAAkB,EAClB,SAAiB,EACjB,IAAa,EACsB;QACnC,IAAI;YACF,MAAM,YAAY,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAEhE,MAAM,eAAe,MAAM,UAAU,KAAK,CAAC,CAAC;;;;;;;;;;;eAWnC,EAAE,WAAW;;MAEtB,CAAC,EAAE;gBACD,cAAc;oBAAC;oBAAW;iBAAU;gBACpC,MAAM,0JAAU,CAAC,MAAM;YACzB;YAYA,IAAI,CAAC,gBAAgB,aAAa,MAAM,KAAK,GAAG;gBAC9C,+CAA+C;gBAC/C,OAAO;oBACL;oBACA;oBACA,qBAAqB;oBACrB,oBAAoB;oBACpB,gBAAgB;oBAChB,aAAa;oBACb,kBAAkB;oBAClB,cAAc;oBACd,WAAW;gBACb;YACF;YAEA,MAAM,QAAQ,YAAY,CAAC,EAAE;YAC7B,OAAO;gBACL,WAAW,MAAM,UAAU;gBAC3B,WAAW,MAAM,UAAU;gBAC3B,qBAAqB,MAAM,qBAAqB;gBAChD,oBAAoB,MAAM,oBAAoB;gBAC9C,gBAAgB,MAAM,gBAAgB;gBACtC,aAAa,MAAM,YAAY;gBAC/B,kBAAkB,MAAM,iBAAiB;gBACzC,cAAc,MAAM,aAAa;gBACjC,WAAW,MAAM,UAAU;YAC7B;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,MAAM;QACR;IACF;IAEA;;;;;;GAMC,GACD,aAAa,oBACX,SAAoB,EACpB,UAAkB,EAClB,IAAa,EACiB;QAC9B,IAAI;YACF,MAAM,YAAY,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAEhE,MAAM,eAAe,MAAM,UAAU,KAAK,CAAC,CAAC;;;;;;;;;;;;eAYnC,EAAE,WAAW;oBACR,EAAE,WAAW;;;;MAI3B,CAAC,EAAE;gBACD,cAAc;oBAAC;oBAAW;iBAAU;gBACpC,MAAM,0JAAU,CAAC,MAAM;YACzB;YAaA,OAAO,CAAC,gBAAgB,EAAE,EAAE,GAAG,CAAC,CAAA,QAAS,CAAC;oBACxC,WAAW,MAAM,UAAU;oBAC3B,WAAW,MAAM,UAAU;oBAC3B,qBAAqB,MAAM,qBAAqB;oBAChD,oBAAoB,MAAM,oBAAoB;oBAC9C,gBAAgB,MAAM,gBAAgB;oBACtC,aAAa,MAAM,YAAY;oBAC/B,kBAAkB,MAAM,iBAAiB;oBACzC,cAAc,MAAM,aAAa;oBACjC,WAAW,MAAM,UAAU;gBAC7B,CAAC;QACH,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,uCAAuC;YACrD,MAAM;QACR;IACF;AACF","debugId":null}},
    {"offset": {"line": 1705, "column": 0}, "map": {"version":3,"sources":["file:///P:/psr-cloud-v2/src/app/api/%5Bdb-key%5D/Collection/SaveCollectionDetails/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { connectDB } from '@/lib/database';\r\nimport { \r\n  ESP32ResponseHelper, \r\n  InputValidator \r\n} from '@/lib/external-api';\r\nimport { SectionPulseTracker } from '@/lib/sectionPulseTracker';\r\n\r\ninterface CollectionInput {\r\n  societyId: string;\r\n  machineType: string;\r\n  version: string;\r\n  machineId: string;\r\n  session: string;      // EV (Evening) or MO (Morning)\r\n  extra: string;        // Extra field (shift number or other data)\r\n  channel: string;      // COW, BUFFALO, etc. (channel type)\r\n  fat: number;          // F090.70 -> 90.70\r\n  snf: number;          // S07.90 -> 7.90\r\n  clr: number;          // C28.00 -> 28.00\r\n  protein: number;      // P02.90 -> 2.90\r\n  lactose: number;      // L04.30 -> 4.30\r\n  salt: number;         // s00.65 -> 0.65\r\n  water: number;        // W06.00 -> 6.00\r\n  temperature: number;  // T26.47 -> 26.47\r\n  farmerId: string;     // I00005 -> 5\r\n  quantity: number;     // Q00000.00 -> 0.00\r\n  totalAmount: number;  // R00000.00 -> 0.00\r\n  rate: number;         // r033.60 -> 33.60\r\n  bonus: number;        // i10.99 -> 10.99\r\n  datetime: string;     // D2025-07-24_02:40:26\r\n}\r\n\r\ninterface SocietyLookupResult {\r\n  id: number;\r\n}\r\n\r\ninterface MachineResult {\r\n  id: number;\r\n  machine_id: string;\r\n}\r\n\r\n/**\r\n * SaveCollectionDetails API Endpoint\r\n * \r\n * Purpose: Save milk collection test data from machines\r\n * InputString format: societyId|machineType|version|machineId|session|extra|channel|\r\n *                     F{fat}|S{snf}|C{clr}|P{protein}|L{lactose}|s{salt}|W{water}|T{temp}|\r\n *                     I{farmerId}|Q{quantity}|R{totalAmount}|r{rate}|i{bonus}|D{datetime}\r\n * \r\n * Example: S-1|LSE-SVPWTBQ-12AH|LE2.00|Mm1|EV|4|COW|F090.70|S07.90|C28.00|P02.90|L04.30|s00.65|W06.00|T26.47|I00005|Q00000.00|R00000.00|r033.60|i10.99|D2025-07-24_02:40:26\r\n * \r\n * Endpoint: GET/POST /api/[db-key]/Collection/SaveCollectionDetails\r\n */\r\n\r\nasync function handleRequest(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<Record<string, string>> }\r\n) {\r\n  try {\r\n    // Extract InputString using helper\r\n    let inputString = await ESP32ResponseHelper.extractInputString(request);\r\n    \r\n    // Await the params Promise in Next.js 15\r\n    const resolvedParams = await params;\r\n    const dbKey = resolvedParams['db-key'] || resolvedParams.dbKey || resolvedParams['dbkey'];\r\n\r\n    // Filter line endings from InputString\r\n    if (inputString) {\r\n      inputString = ESP32ResponseHelper.filterLineEndings(inputString);\r\n    }\r\n\r\n    // Log request\r\n    console.log(`\\n${'='.repeat(80)}`);\r\n    console.log(`üì° SaveCollectionDetails API Request:`);\r\n    console.log(`   Timestamp: ${new Date().toISOString()}`);\r\n    ESP32ResponseHelper.logRequest(request, dbKey, inputString);\r\n\r\n    // Validate required parameters\r\n    if (!dbKey || dbKey.trim() === '') {\r\n      console.log(`‚ùå DB Key validation failed - dbKey: \"${dbKey}\"`);\r\n      return ESP32ResponseHelper.createErrorResponse('DB Key is required');\r\n    }\r\n\r\n    if (!inputString) {\r\n      console.log(`‚ùå InputString is required`);\r\n      return ESP32ResponseHelper.createErrorResponse('InputString parameter is required');\r\n    }\r\n\r\n    // Connect to database and validate DB Key\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { sequelize, User } = getModels();\r\n\r\n    // Validate DB key format\r\n    const dbKeyValidation = InputValidator.validateDbKey(dbKey);\r\n    if (!dbKeyValidation.isValid) {\r\n      return ESP32ResponseHelper.createErrorResponse(dbKeyValidation.error || 'Invalid DB Key');\r\n    }\r\n\r\n    // Find admin by dbKey to get schema name\r\n    const admin = await User.findOne({ \r\n      where: { dbKey: dbKey.toUpperCase() } \r\n    });\r\n\r\n    if (!admin || !admin.dbKey) {\r\n      console.log(`‚ùå Admin not found or missing DB Key for: ${dbKey}`);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid DB Key');\r\n    }\r\n\r\n    // Parse input string - 21 parts expected\r\n    const inputParts = inputString.split('|');\r\n    \r\n    if (inputParts.length !== 21) {\r\n      console.log(`‚ùå Invalid InputString format. Expected 21 parts, got ${inputParts.length}`);\r\n      console.log(`   Parts received:`, inputParts);\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid InputString format');\r\n    }\r\n\r\n    const [\r\n      societyIdStr,\r\n      machineType,\r\n      version,\r\n      machineId,\r\n      session,\r\n      extra,\r\n      channel,\r\n      fatStr,\r\n      snfStr,\r\n      clrStr,\r\n      proteinStr,\r\n      lactoseStr,\r\n      saltStr,\r\n      waterStr,\r\n      temperatureStr,\r\n      farmerIdStr,\r\n      quantityStr,\r\n      totalAmountStr,\r\n      rateStr,\r\n      bonusStr,\r\n      datetimeStr\r\n    ] = inputParts;\r\n\r\n    console.log(`üîç Parsed InputString:`, {\r\n      societyIdStr,\r\n      machineType,\r\n      version,\r\n      machineId,\r\n      session,\r\n      extra,\r\n      channel,\r\n      farmerIdStr,\r\n      datetime: datetimeStr\r\n    });\r\n\r\n    // Parse numeric values from formatted strings\r\n    const parseValue = (str: string, prefix: string): number => {\r\n      if (!str || !str.startsWith(prefix)) return 0;\r\n      const numStr = str.substring(prefix.length);\r\n      return parseFloat(numStr) || 0;\r\n    };\r\n\r\n    const collectionData: CollectionInput = {\r\n      societyId: societyIdStr,\r\n      machineType,\r\n      version,\r\n      machineId,\r\n      session,\r\n      extra,\r\n      channel,\r\n      fat: parseValue(fatStr, 'F'),\r\n      snf: parseValue(snfStr, 'S'),\r\n      clr: parseValue(clrStr, 'C'),\r\n      protein: parseValue(proteinStr, 'P'),\r\n      lactose: parseValue(lactoseStr, 'L'),\r\n      salt: parseValue(saltStr, 's'),\r\n      water: parseValue(waterStr, 'W'),\r\n      temperature: parseValue(temperatureStr, 'T'),\r\n      farmerId: farmerIdStr.substring(1).replace(/^0+/, '') || '0', // Remove 'I' prefix and leading zeros\r\n      quantity: parseValue(quantityStr, 'Q'),\r\n      totalAmount: parseValue(totalAmountStr, 'R'),\r\n      rate: parseValue(rateStr, 'r'),\r\n      bonus: parseValue(bonusStr, 'i'),\r\n      datetime: datetimeStr.substring(1) // Remove 'D' prefix\r\n    };\r\n\r\n    console.log(`üîç Parsed collection data:`, collectionData);\r\n\r\n    // Validate Society ID\r\n    const societyValidation = InputValidator.validateSocietyId(collectionData.societyId);\r\n    if (!societyValidation.isValid) {\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid society ID');\r\n    }\r\n\r\n    // Validate Machine ID\r\n    const machineValidation = InputValidator.validateMachineId(collectionData.machineId);\r\n    if (!machineValidation.isValid) {\r\n      return ESP32ResponseHelper.createErrorResponse('Invalid machine ID');\r\n    }\r\n\r\n    // Generate schema name\r\n    const cleanAdminName = admin.fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\r\n    const schemaName = `${cleanAdminName}_${admin.dbKey.toLowerCase()}`;\r\n\r\n    console.log(`üîç Using schema: ${schemaName}`);\r\n\r\n    // Look up society\r\n    const societyQuery = `\r\n      SELECT id FROM \\`${schemaName}\\`.societies \r\n      WHERE society_id = ? OR society_id = ?\r\n      LIMIT 1\r\n    `;\r\n    \r\n    const societyLookupParams = societyValidation.id.startsWith('S-') \r\n      ? [societyValidation.id, societyValidation.fallback]\r\n      : [`S-${societyValidation.id}`, societyValidation.id];\r\n    \r\n    const [societyResults] = await sequelize.query(societyQuery, { replacements: societyLookupParams });\r\n    \r\n    if (!Array.isArray(societyResults) || societyResults.length === 0) {\r\n      console.log(`‚ùå Society not found: \"${societyValidation.id}\"`);\r\n      return ESP32ResponseHelper.createErrorResponse('Society not found');\r\n    }\r\n    \r\n    const actualSocietyId = (societyResults[0] as SocietyLookupResult).id;\r\n    console.log(`‚úÖ Found society: \"${societyValidation.id}\" -> database ID: ${actualSocietyId}`);\r\n\r\n    // Look up machine\r\n    const machineIdVariants = (machineValidation.variants || []).map(v => String(v));\r\n    \r\n    if (machineIdVariants.length === 0) {\r\n      const machineIdCleaned = machineValidation.alphanumericId || machineValidation.numericId?.toString() || '';\r\n      machineIdVariants.push(machineIdCleaned);\r\n    }\r\n    \r\n    const placeholders = machineIdVariants.map(() => '?').join(', ');\r\n    const machineQuery = `\r\n      SELECT id, machine_id \r\n      FROM \\`${schemaName}\\`.machines \r\n      WHERE society_id = ? AND machine_id IN (${placeholders})\r\n      LIMIT 1\r\n    `;\r\n    \r\n    const [machineResults] = await sequelize.query(machineQuery, { \r\n      replacements: [actualSocietyId, ...machineIdVariants]\r\n    });\r\n    \r\n    if (!Array.isArray(machineResults) || machineResults.length === 0) {\r\n      console.log(`‚ùå Machine not found: \"${collectionData.machineId}\"`);\r\n      return ESP32ResponseHelper.createErrorResponse('Machine not found');\r\n    }\r\n    \r\n    const actualMachine = machineResults[0] as MachineResult;\r\n    console.log(`‚úÖ Found machine: \"${collectionData.machineId}\" -> database ID: ${actualMachine.id}`);\r\n\r\n    console.log(`‚ÑπÔ∏è  Farmer ID from input: \"${collectionData.farmerId}\"`);\r\n\r\n    // Parse datetime: D2025-07-24_02:40:26 -> date: 2025-07-24, time: 02:40:26\r\n    const datetimeParts = collectionData.datetime.split('_');\r\n    const datePart = datetimeParts[0] || ''; // 2025-07-24\r\n    const timePart = datetimeParts[1]?.replace(/-/g, ':') || '00:00:00'; // 02:40:26\r\n    const formattedDate = datePart;\r\n    const formattedTime = timePart;\r\n\r\n    // Determine shift time (morning or evening)\r\n    const shiftType = collectionData.session.toUpperCase() === 'EV' ? 'evening' : 'morning';\r\n    \r\n    // Use extra field as farmer name\r\n    const farmerName = collectionData.extra || null;\r\n\r\n    // Insert collection record\r\n    const insertQuery = `\r\n      INSERT INTO \\`${schemaName}\\`.milk_collections (\r\n        farmer_id,\r\n        society_id,\r\n        machine_id,\r\n        collection_date,\r\n        collection_time,\r\n        shift_type,\r\n        farmer_name,\r\n        channel,\r\n        fat_percentage,\r\n        snf_percentage,\r\n        clr_value,\r\n        protein_percentage,\r\n        lactose_percentage,\r\n        salt_percentage,\r\n        water_percentage,\r\n        temperature,\r\n        quantity,\r\n        rate_per_liter,\r\n        total_amount,\r\n        bonus,\r\n        machine_type,\r\n        machine_version,\r\n        created_at,\r\n        updated_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CONVERT_TZ(NOW(), '+00:00', '+05:30'), CONVERT_TZ(NOW(), '+00:00', '+05:30'))\r\n      ON DUPLICATE KEY UPDATE\r\n        farmer_name = VALUES(farmer_name),\r\n        channel = VALUES(channel),\r\n        fat_percentage = VALUES(fat_percentage),\r\n        snf_percentage = VALUES(snf_percentage),\r\n        clr_value = VALUES(clr_value),\r\n        protein_percentage = VALUES(protein_percentage),\r\n        lactose_percentage = VALUES(lactose_percentage),\r\n        salt_percentage = VALUES(salt_percentage),\r\n        water_percentage = VALUES(water_percentage),\r\n        temperature = VALUES(temperature),\r\n        quantity = VALUES(quantity),\r\n        rate_per_liter = VALUES(rate_per_liter),\r\n        total_amount = VALUES(total_amount),\r\n        bonus = VALUES(bonus),\r\n        machine_type = VALUES(machine_type),\r\n        machine_version = VALUES(machine_version),\r\n        updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')\r\n    `;\r\n\r\n    const insertParams = [\r\n      collectionData.farmerId, // Use farmer_id string directly\r\n      actualSocietyId,\r\n      actualMachine.id,\r\n      formattedDate,\r\n      formattedTime,\r\n      shiftType,\r\n      farmerName,\r\n      collectionData.channel,\r\n      collectionData.fat,\r\n      collectionData.snf,\r\n      collectionData.clr,\r\n      collectionData.protein,\r\n      collectionData.lactose,\r\n      collectionData.salt,\r\n      collectionData.water,\r\n      collectionData.temperature,\r\n      collectionData.quantity,\r\n      collectionData.rate,\r\n      collectionData.totalAmount,\r\n      collectionData.bonus,\r\n      collectionData.machineType,\r\n      collectionData.version\r\n    ];\r\n\r\n    console.log(`üíæ Saving collection record (will insert or update if duplicate)...`);\r\n    console.log(`   Farmer ID: ${collectionData.farmerId}`);\r\n    console.log(`   Farmer Name: ${farmerName}`);\r\n    console.log(`   Date: ${formattedDate}`);\r\n    console.log(`   Time: ${formattedTime}`);\r\n    console.log(`   Shift: ${shiftType}`);\r\n    console.log(`   Channel: ${collectionData.channel}`);\r\n    console.log(`   Fat: ${collectionData.fat}%, SNF: ${collectionData.snf}%`);\r\n    console.log(`   Quantity: ${collectionData.quantity}L, Rate: ${collectionData.rate}, Total: ${collectionData.totalAmount}, Bonus: ${collectionData.bonus}`);\r\n\r\n    const queryResult = await sequelize.query(insertQuery, { replacements: insertParams }) as any;\r\n    \r\n    // Check if this was a new insert or an update\r\n    // For Sequelize raw queries with INSERT...ON DUPLICATE KEY UPDATE:\r\n    // - Returns array [lastInsertId, affectedRows]\r\n    // - affectedRows = 1 means INSERT (new record)\r\n    // - affectedRows = 2 means UPDATE (duplicate key, existing record updated)\r\n    const [lastInsertId, affectedRows] = queryResult;\r\n    console.log(`üìä Query result - lastInsertId: ${lastInsertId}, affectedRows: ${affectedRows}`);\r\n    \r\n    const isNewCollection = affectedRows === 1;\r\n\r\n    console.log(`‚úÖ Collection record saved successfully${isNewCollection ? ' (new collection)' : ' (duplicate updated)'}`);\r\n\r\n    // Update section pulse tracking\r\n    try {\r\n      const collectionDateTime = `${formattedDate} ${formattedTime}`;\r\n      await SectionPulseTracker.updatePulseOnCollection(\r\n        sequelize,\r\n        schemaName,\r\n        actualSocietyId,\r\n        collectionDateTime,\r\n        isNewCollection  // Pass flag to indicate if this is a new collection\r\n      );\r\n      console.log(`‚úÖ Section pulse updated successfully`);\r\n    } catch (pulseError) {\r\n      // Log pulse tracking error but don't fail the collection save\r\n      console.error(`‚ö†Ô∏è Failed to update section pulse:`, pulseError);\r\n    }\r\n\r\n    // Send email notification to farmer (if new collection and email exists)\r\n    if (isNewCollection) {\r\n      try {\r\n        // Fetch farmer details including email and notification preference\r\n        const farmerQuery = `\r\n          SELECT f.name as farmer_name, f.email, f.email_notifications_enabled, s.name as society_name\r\n          FROM \\`${schemaName}\\`.farmers f\r\n          LEFT JOIN \\`${schemaName}\\`.societies s ON f.society_id = s.id\r\n          WHERE f.farmer_id = ?\r\n          LIMIT 1\r\n        `;\r\n        \r\n        const [farmerResults] = await sequelize.query(farmerQuery, {\r\n          replacements: [collectionData.farmerId]\r\n        });\r\n        \r\n        if (Array.isArray(farmerResults) && farmerResults.length > 0) {\r\n          const farmerData = farmerResults[0] as any;\r\n          \r\n          console.log(`üìß Email check for farmer ${collectionData.farmerId}:`, {\r\n            hasEmail: !!farmerData.email,\r\n            email: farmerData.email,\r\n            notificationSetting: farmerData.email_notifications_enabled,\r\n            willSend: farmerData.email && farmerData.email.trim() !== '' && farmerData.email_notifications_enabled === 'ON'\r\n          });\r\n          \r\n          // Only send email if: (1) email exists, (2) notifications are enabled\r\n          if (farmerData.email && farmerData.email.trim() !== '' && \r\n              farmerData.email_notifications_enabled === 'ON') {\r\n            console.log(`üìß Sending collection email to farmer ${collectionData.farmerId} at ${farmerData.email}`);\r\n            \r\n            // Import email service\r\n            const { sendMilkCollectionEmail } = await import('@/lib/emailService');\r\n            \r\n            // Send email (don't await - send async)\r\n            sendMilkCollectionEmail(\r\n              farmerData.email,\r\n              farmerData.farmer_name || farmerName || collectionData.farmerId,\r\n              {\r\n                farmerId: collectionData.farmerId,\r\n                societyName: farmerData.society_name,\r\n                collectionDate: formattedDate,\r\n                collectionTime: formattedTime,\r\n                shiftType: shiftType,\r\n                channel: collectionData.channel,\r\n                quantity: collectionData.quantity,\r\n                fatPercentage: collectionData.fat,\r\n                snfPercentage: collectionData.snf,\r\n                clrValue: collectionData.clr,\r\n                proteinPercentage: collectionData.protein,\r\n                lactosePercentage: collectionData.lactose,\r\n                waterPercentage: collectionData.water,\r\n                temperature: collectionData.temperature,\r\n                ratePerLiter: collectionData.rate,\r\n                totalAmount: collectionData.totalAmount,\r\n                bonus: collectionData.bonus\r\n              }\r\n            ).catch((emailError) => {\r\n              // Log email error but don't fail the collection\r\n              console.error(`‚ö†Ô∏è Failed to send collection email:`, emailError);\r\n            });\r\n            \r\n            console.log(`‚úÖ Collection email queued for sending`);\r\n          } else {\r\n            console.log(`‚ÑπÔ∏è  No email address found for farmer ${collectionData.farmerId}`);\r\n          }\r\n        } else {\r\n          console.log(`‚ÑπÔ∏è  Farmer not found in database: ${collectionData.farmerId}`);\r\n        }\r\n      } catch (emailError) {\r\n        // Log email error but don't fail the collection save\r\n        console.error(`‚ö†Ô∏è Error processing collection email:`, emailError);\r\n      }\r\n    }\r\n\r\n    console.log(`${'='.repeat(80)}\\n`);\r\n\r\n    // Return success response\r\n    return ESP32ResponseHelper.createResponse('Collection details saved successfully.', {\r\n      addQuotes: true\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(`‚ùå Error in SaveCollectionDetails API:`, error);\r\n    console.log(`${'='.repeat(80)}\\n`);\r\n    return ESP32ResponseHelper.createErrorResponse('Failed to save collection details');\r\n  }\r\n}\r\n\r\nexport const GET = handleRequest;\r\nexport const POST = handleRequest;\r\n\r\nexport async function OPTIONS() {\r\n  return ESP32ResponseHelper.createCORSResponse();\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}