module.exports=[808747,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),s=e.i(114444),o=e.i(837092),l=e.i(869741),c=e.i(316795),d=e.i(487718),u=e.i(995169),E=e.i(47587),p=e.i(666012),m=e.i(570101),y=e.i(626937),R=e.i(10372),h=e.i(193695);e.i(52474);var f=e.i(600220),g=e.i(79832),_=e.i(84168),S=e.i(48798);async function w(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,S.createErrorResponse)("Authentication required",401);let a=(0,g.verifyToken)(r);if(!a||"admin"!==a.role)return(0,S.createErrorResponse)("Admin access required",403);let{name:i,password:n,dairyId:s,location:o,contactPerson:l,phone:c,email:d,capacity:u,status:E,monthlyTarget:p}=await t.json();if(!i||!n||!s)return(0,S.createErrorResponse)("Name, password, and dairy ID are required",400);await (0,_.connectDB)();let{getModels:m}=await e.A(121985),{sequelize:y,User:R}=m(),h=await R.findByPk(a.id);if(!h||!h.dbKey)return(0,S.createErrorResponse)("Admin schema not found",404);let f=h.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),w=`${f}_${h.dbKey.toLowerCase()}`,T=`
      INSERT INTO \`${w}\`.\`dairy_farms\` 
      (name, dairy_id, password, location, contact_person, phone, email, capacity, status, monthly_target) 
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;return await y.query(T,{replacements:[i,s,n,o||null,l||null,c||null,d||null,u||5e3,E||"active",p||5e3]}),console.log(`âœ… Dairy farm added successfully to schema: ${w}`),(0,S.createSuccessResponse)("Dairy farm added successfully",{dairyId:s,name:i,location:o,contactPerson:l,capacity:u||5e3,status:E||"active",monthlyTarget:p||5e3})}catch(e){if(console.error("Error adding dairy farm:",e),e instanceof Error&&"SequelizeUniqueConstraintError"===e.name)return(0,S.createErrorResponse)("Dairy ID already exists",409);return(0,S.createErrorResponse)("Failed to add dairy farm",500)}}async function T(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,S.createErrorResponse)("Authentication required",401);let a=(0,g.verifyToken)(r);if(!a||"admin"!==a.role)return(0,S.createErrorResponse)("Admin access required",403);await (0,_.connectDB)();let{getModels:i}=await e.A(121985),{sequelize:n,User:s}=i(),o=await s.findByPk(a.id);if(!o||!o.dbKey)return(0,S.createErrorResponse)("Admin schema not found",404);let l=o.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),c=`${l}_${o.dbKey.toLowerCase()}`,[d]=await n.query(`
      SELECT 
        d.id, 
        d.name, 
        d.dairy_id as dairyId, 
        d.location, 
        d.contact_person as contactPerson, 
        d.phone, 
        d.email,
        d.capacity,
        d.status,
        d.monthly_target as monthlyTarget,
        d.created_at as createdAt, 
        d.updated_at as updatedAt,
        COUNT(DISTINCT b.id) as bmcCount,
        COUNT(DISTINCT s.id) as societyCount,
        COALESCE(COUNT(DISTINCT mc.id), 0) as totalCollections30d,
        COALESCE(SUM(mc.quantity), 0) as totalQuantity30d,
        COALESCE(SUM(mc.total_amount), 0) as totalAmount30d,
        COALESCE(
          CASE 
            WHEN SUM(mc.quantity) > 0 
            THEN ROUND(SUM(mc.fat_percentage * mc.quantity) / SUM(mc.quantity), 2)
            ELSE 0 
          END, 0
        ) as weightedFat30d,
        COALESCE(
          CASE 
            WHEN SUM(mc.quantity) > 0 
            THEN ROUND(SUM(mc.snf_percentage * mc.quantity) / SUM(mc.quantity), 2)
            ELSE 0 
          END, 0
        ) as weightedSnf30d,
        COALESCE(
          CASE 
            WHEN SUM(mc.quantity) > 0 
            THEN ROUND(SUM(mc.clr_value * mc.quantity) / SUM(mc.quantity), 2)
            ELSE 0 
          END, 0
        ) as weightedClr30d,
        COALESCE(
          CASE 
            WHEN SUM(CASE WHEN mc.water_percentage IS NOT NULL THEN mc.quantity ELSE 0 END) > 0 
            THEN ROUND(
              SUM(CASE WHEN mc.water_percentage IS NOT NULL THEN mc.water_percentage * mc.quantity ELSE 0 END) / 
              SUM(CASE WHEN mc.water_percentage IS NOT NULL THEN mc.quantity ELSE 0 END), 
              2
            )
            ELSE 0 
          END, 0
        ) as weightedWater30d
      FROM \`${c}\`.\`dairy_farms\` d
      LEFT JOIN \`${c}\`.\`bmcs\` b ON b.dairy_farm_id = d.id
      LEFT JOIN \`${c}\`.\`societies\` s ON s.bmc_id = b.id
      LEFT JOIN \`${c}\`.\`milk_collections\` mc ON mc.society_id = s.id
        AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
      GROUP BY d.id, d.name, d.dairy_id, d.location, d.contact_person, d.phone, d.email, 
               d.capacity, d.status, d.monthly_target, d.created_at, d.updated_at
      ORDER BY d.created_at DESC
    `);return(0,S.createSuccessResponse)("Dairy farms retrieved successfully",d)}catch(e){return console.error("Error retrieving dairy farms:",e),(0,S.createErrorResponse)("Failed to retrieve dairy farms",500)}}async function C(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,S.createErrorResponse)("Authentication required",401);let a=(0,g.verifyToken)(r);if(!a||"admin"!==a.role)return(0,S.createErrorResponse)("Admin access required",403);let{id:i,newDairyId:n,deleteAll:s,otp:o}=await t.json();if(!i)return(0,S.createErrorResponse)("Dairy ID is required",400);await (0,_.connectDB)();let{getModels:l}=await e.A(121985),{sequelize:c,User:d}=l(),u=await d.findByPk(a.id);if(!u||!u.dbKey)return(0,S.createErrorResponse)("Admin schema not found",404);let E=u.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),p=`${E}_${u.dbKey.toLowerCase()}`,[m]=await c.query(`
      SELECT id, name FROM \`${p}\`.\`dairy_farms\` WHERE id = ?
    `,{replacements:[i]});if(!m||0===m.length)return(0,S.createErrorResponse)("Dairy not found",404);let[y]=await c.query(`
      SELECT id FROM \`${p}\`.\`bmcs\` WHERE dairy_farm_id = ?
    `,{replacements:[i]});if(!(y.length>0))return await c.query(`
        DELETE FROM \`${p}\`.\`dairy_farms\` WHERE id = ?
      `,{replacements:[i]}),console.log(`âœ… Dairy ${i} deleted (no BMCs)`),(0,S.createSuccessResponse)("Dairy deleted successfully");if(s){if(!o)return(0,S.createErrorResponse)("OTP is required for delete all operation",400);let{verifyDeleteOTP:t}=await e.A(448668);if(!t(a.id,i,o))return(0,S.createErrorResponse)("Invalid or expired OTP",400);console.log(`ðŸ—‘ï¸ Starting CASCADE DELETE for dairy ${i} and all related data...`);let r=y.map(e=>e.id),[n]=await c.query(`
          SELECT id FROM \`${p}\`.\`societies\` WHERE bmc_id IN (?)
        `,{replacements:[r]});if(n.length>0){let e=n.map(e=>e.id);console.log("Step 1: Deleting milk collections..."),await c.query(`
            DELETE FROM \`${p}\`.\`milk_collections\`
            WHERE farmer_id IN (
              SELECT id FROM \`${p}\`.\`farmers\` WHERE society_id IN (?)
            )
          `,{replacements:[e]}),console.log("Step 2: Deleting milk sales..."),await c.query(`
            DELETE FROM \`${p}\`.\`milk_sales\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 3: Deleting milk dispatches..."),await c.query(`
            DELETE FROM \`${p}\`.\`milk_dispatches\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 4: Deleting section pulse..."),await c.query(`
            DELETE FROM \`${p}\`.\`section_pulse\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 5: Deleting rate chart download history..."),await c.query(`
            DELETE FROM \`${p}\`.\`rate_chart_download_history\`
            WHERE rate_chart_id IN (
              SELECT id FROM \`${p}\`.\`rate_charts\` WHERE society_id IN (?)
            )
          `,{replacements:[e]}),console.log("Step 6: Deleting rate chart data..."),await c.query(`
            DELETE FROM \`${p}\`.\`rate_chart_data\`
            WHERE rate_chart_id IN (
              SELECT id FROM \`${p}\`.\`rate_charts\` WHERE society_id IN (?)
            )
          `,{replacements:[e]}),console.log("Step 7: Deleting rate charts..."),await c.query(`
            DELETE FROM \`${p}\`.\`rate_charts\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 8: Deleting machine statistics..."),await c.query(`
            DELETE FROM \`${p}\`.\`machine_statistics\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 9: Deleting machine corrections..."),await c.query(`
            DELETE FROM \`${p}\`.\`machine_corrections\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 10: Deleting machine corrections from machine..."),await c.query(`
            DELETE FROM \`${p}\`.\`machine_corrections_from_machine\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 11: Deleting farmers..."),await c.query(`
            DELETE FROM \`${p}\`.\`farmers\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 12: Deleting machines..."),await c.query(`
            DELETE FROM \`${p}\`.\`machines\` WHERE society_id IN (?)
          `,{replacements:[e]}),console.log("Step 13: Deleting societies..."),await c.query(`
            DELETE FROM \`${p}\`.\`societies\` WHERE id IN (?)
          `,{replacements:[e]})}return console.log("Step 14: Deleting BMCs..."),await c.query(`
          DELETE FROM \`${p}\`.\`bmcs\` WHERE dairy_farm_id = ?
        `,{replacements:[i]}),console.log("Step 15: Deleting dairy..."),await c.query(`
          DELETE FROM \`${p}\`.\`dairy_farms\` WHERE id = ?
        `,{replacements:[i]}),console.log(`âœ… CASCADE DELETE completed for dairy ${i}`),(0,S.createSuccessResponse)("Dairy and all related data deleted successfully",{deletedAll:!0})}{if(!n)return(0,S.createErrorResponse)("New dairy ID is required for transfer",400);if(!o)return(0,S.createErrorResponse)("OTP is required for transfer operation",400);let{verifyDeleteOTP:t}=await e.A(448668);if(!t(a.id,i,o))return(0,S.createErrorResponse)("Invalid or expired OTP",400);let[r]=await c.query(`
          SELECT id FROM \`${p}\`.\`dairy_farms\` WHERE id = ?
        `,{replacements:[n]});if(!r||0===r.length)return(0,S.createErrorResponse)("New dairy not found",404);return await c.query(`
          UPDATE \`${p}\`.\`bmcs\` SET dairy_farm_id = ? WHERE dairy_farm_id = ?
        `,{replacements:[n,i]}),console.log(`âœ… Transferred ${y.length} BMCs to dairy ${n}`),await c.query(`
          DELETE FROM \`${p}\`.\`dairy_farms\` WHERE id = ?
        `,{replacements:[i]}),console.log(`âœ… Dairy ${i} deleted after transferring BMCs`),(0,S.createSuccessResponse)("BMCs transferred and dairy deleted successfully",{transferredBMCs:y.length})}}catch(e){return console.error("Error deleting dairy farm:",e),(0,S.createErrorResponse)("Failed to delete dairy farm",500)}}async function N(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,S.createErrorResponse)("Authentication required",401);let a=(0,g.verifyToken)(r);if(!a||"admin"!==a.role)return(0,S.createErrorResponse)("Admin access required",403);let{id:i,name:n,password:s,location:o,contactPerson:l,phone:c,email:d,capacity:u,status:E,monthlyTarget:p}=await t.json();if(!i)return(0,S.createErrorResponse)("Dairy ID is required",400);await (0,_.connectDB)();let{getModels:m}=await e.A(121985),{sequelize:y,User:R}=m(),h=await R.findByPk(a.id);if(!h||!h.dbKey)return(0,S.createErrorResponse)("Admin schema not found",404);let f=h.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),w=`${f}_${h.dbKey.toLowerCase()}`,[T]=await y.query(`
      SELECT id FROM \`${w}\`.\`dairy_farms\` WHERE id = ?
    `,{replacements:[i]});if(!T||0===T.length)return(0,S.createErrorResponse)("Dairy not found",404);let C=[],N=[];if(void 0!==n&&(C.push("name = ?"),N.push(n)),void 0!==o&&(C.push("location = ?"),N.push(o||null)),void 0!==l&&(C.push("contact_person = ?"),N.push(l||null)),void 0!==c&&(C.push("phone = ?"),N.push(c||null)),void 0!==d&&(C.push("email = ?"),N.push(d||null)),void 0!==u&&(C.push("capacity = ?"),N.push(u||null)),void 0!==E&&(C.push("status = ?"),N.push(E)),void 0!==p&&(C.push("monthly_target = ?"),N.push(p||null)),s&&(C.push("password = ?"),N.push(s)),0===C.length)return(0,S.createErrorResponse)("No fields to update",400);C.push("updated_at = NOW()"),N.push(i);let D=`
      UPDATE \`${w}\`.\`dairy_farms\` 
      SET ${C.join(", ")}
      WHERE id = ?
    `;return await y.query(D,{replacements:N}),console.log(`âœ… Dairy farm updated successfully in schema: ${w}`),(0,S.createSuccessResponse)("Dairy farm updated successfully",{id:i,name:n,location:o,contactPerson:l,phone:c,email:d,capacity:u,status:E,monthlyTarget:p})}catch(e){return console.error("Error updating dairy farm:",e),(0,S.createErrorResponse)("Failed to update dairy farm",500)}}e.s(["DELETE",()=>C,"GET",()=>T,"POST",()=>w,"PUT",()=>N],373706);var D=e.i(373706);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/user/dairy/route",pathname:"/api/user/dairy",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/dairy/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:O,workUnitAsyncStorage:q,serverHooks:v}=A;function L(){return(0,a.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:q})}async function M(e,t,a){A.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/user/dairy/route";g=g.replace(/\/index$/,"")||"/";let _=await A.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!_)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:S,params:w,nextConfig:T,parsedUrl:C,isDraftMode:N,prerenderManifest:D,routerServerContext:O,isOnDemandRevalidate:q,revalidateOnlyGenerated:v,resolvedPathname:L,clientReferenceManifest:M,serverActionsManifest:H}=_,$=(0,l.normalizeAppPath)(g),I=!!(D.dynamicRoutes[$]||D.routes[L]),U=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,C,!1):t.end("This page could not be found"),null);if(I&&!N){let e=!!D.routes[L],t=D.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await U();throw new h.NoFallbackError}}let F=null;!I||A.isDev||N||(F="/index"===(F=L)?"/":F);let b=!0===A.isDev||!I,W=I&&!b;H&&M&&(0,s.setReferenceManifestsSingleton)({page:g,clientReferenceManifest:M,serverActionsManifest:H,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:H})});let P=e.method||"GET",x=(0,n.getTracer)(),k=x.getActiveScopeSpan(),B={params:w,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:b,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>A.onRequestError(e,t,a,O)},sharedContext:{buildId:S}},K=new c.NodeNextRequest(e),j=new c.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let s=async e=>A.handle(z,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=x.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${P} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${P} ${g}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&q&&v&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(i);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=B.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(K,j,n,B.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[R.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:q})},O),t}},d=await A.handleResponse({req:e,nextConfig:T,cacheKey:F,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:v,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!I)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",q?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&I||u.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,j,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};k?await l(k):await x.withPropagatedContext(e.headers,()=>x.trace(u.BaseServerSpan.handleRequest,{spanName:`${P} ${g}`,kind:n.SpanKind.SERVER,attributes:{"http.method":P,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:q})}),I)throw t;return await (0,p.sendResponse)(K,j,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>L,"routeModule",()=>A,"serverHooks",()=>v,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>q],808747)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_7e56902a.js.map