module.exports=[48798,e=>{"use strict";var t=e.i(89171);function r(e,a,n=200){return t.NextResponse.json({success:!0,message:e,data:a},{status:n})}function a(e,r=400,n){return t.NextResponse.json({success:!1,message:"Error occurred",error:e,data:n},{status:r})}e.s(["createErrorResponse",()=>a,"createSuccessResponse",()=>r])},626612,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),s=e.i(561916),o=e.i(114444),i=e.i(837092),l=e.i(869741),u=e.i(316795),d=e.i(487718),c=e.i(995169),p=e.i(47587),f=e.i(666012),h=e.i(570101),R=e.i(626937),m=e.i(10372),g=e.i(193695);e.i(52474);var E=e.i(600220),v=e.i(79832),I=e.i(84168),C=e.i(48798);async function w(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,C.createErrorResponse)("Authentication required",401);let a=(0,v.verifyToken)(r);if(!a)return(0,C.createErrorResponse)("Invalid token",401);if("admin"!==a.role)return(0,C.createErrorResponse)("Admin access required",403);let n=await t.formData(),s=n.get("file"),o=n.get("societyId"),i=n.get("machineId");if(!s)return(0,C.createErrorResponse)("CSV file is required",400);if(!o)return(0,C.createErrorResponse)("Society ID is required",400);if(!i)return(0,C.createErrorResponse)("Machine ID is required",400);if(!s.name.toLowerCase().endsWith(".csv"))return(0,C.createErrorResponse)("Only CSV files are allowed",400);let l=(await s.text()).split("\n").filter(e=>e.trim());if(l.length<2)return(0,C.createErrorResponse)("CSV file must contain header and at least one data row",400);let u=l[0].split(",").map(e=>e.trim().replace(/"/g,""));console.log("CSV Header:",u);let d=["ID","RF-ID","NAME","MOBILE","SMS","BONUS"],c=[...d,"MACHINE-ID"],p=d.filter(e=>!u.includes(e));if(p.length>0)return(0,C.createErrorResponse)(`Missing required CSV headers: ${p.join(", ")}. Required: ${d.join(", ")}`,400);let f=u.filter(e=>!c.includes(e));if(f.length>0)return(0,C.createErrorResponse)(`Invalid CSV headers: ${f.join(", ")}. Valid headers: ${c.join(", ")}`,400);let h=[],R=[];for(let e=1;e<l.length;e++){let t=l[e].trim();if(!t)continue;let r=t.split(",").map(e=>e.trim().replace(/"/g,""));if(r.length!==u.length){R.push(`Row ${e+1}: Invalid number of columns`);continue}let a={};if(u.forEach((e,t)=>{a[e]=r[t]}),!a.ID||!a.NAME){R.push(`Row ${e+1}: ID and NAME are required`);continue}h.push(a)}if(R.length>0)return(0,C.createErrorResponse)(`CSV validation errors: ${R.join("; ")}`,400);if(0===h.length)return(0,C.createErrorResponse)("No valid farmer data found in CSV",400);let m=await (0,I.connectDB)();if(!m)return(0,C.createErrorResponse)("Database connection failed",500);let{User:g}=await e.A(121985).then(e=>e.getModels()),E=await g.findByPk(a.id);if(!E||!E.dbKey)return(0,C.createErrorResponse)("Admin schema not found",404);let w=E.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),y=`${w}_${E.dbKey.toLowerCase()}`,D={value:0},S=[];for(let e=0;e<h.length;e++){let t=h[e];try{let e=t["RF-ID"]||null;if(e&&e.trim()){let[r]=await m.query(`
            SELECT id FROM \`${y}\`.farmers 
            WHERE rf_id = ?
          `,{replacements:[e.trim()]});r.length>0&&(console.log(`âš ï¸ RF-ID '${e}' already exists, skipping RF-ID for farmer ${t.ID}`),e=null)}await m.query(`
          INSERT INTO \`${y}\`.farmers 
          (farmer_id, rf_id, name, phone, sms_enabled, bonus, society_id, machine_id, status)
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'active')
        `,{replacements:[t.ID,e,t.NAME,t.MOBILE||null,t.SMS||"OFF",parseFloat(t.BONUS)||0,parseInt(o),t["MACHINE-ID"]&&t["MACHINE-ID"].trim()?parseInt(t["MACHINE-ID"]):parseInt(i)]}),D.value++,t["RF-ID"]&&t["RF-ID"].trim()&&!e&&console.log(`âœ… Farmer '${t.ID}' created successfully but RF-ID '${t["RF-ID"]}' was skipped (already exists)`)}catch(a){console.error("Error inserting farmer:",a);let r="Database insertion failed";if(a&&"object"==typeof a&&"name"in a&&"SequelizeUniqueConstraintError"===a.name){if(a&&"object"==typeof a&&"original"in a&&a.original&&"object"==typeof a.original){let e=a.original;e.sqlMessage&&(r=e.sqlMessage.includes("unique_farmer_per_society")?`Farmer ID '${t.ID}' already exists in society ${o}`:e.sqlMessage.includes("unique_rf_id")?`RF-ID '${t["RF-ID"]}' already exists globally. RF-IDs must be unique across all societies.`:e.sqlMessage.includes("rf_id")?`RF-ID '${t["RF-ID"]}' already exists`:`Duplicate entry: ${e.sqlMessage}`)}}else a instanceof Error&&(r=a.message);S.push({row:e+2,farmer:t,error:r})}}let A={totalProcessed:h.length,successCount:D.value,failedCount:S.length,failedFarmers:S.map(e=>({row:e.row,farmerId:e.farmer.ID,name:e.farmer.NAME,error:e.error}))};console.log(`ðŸ“Š CSV Upload Results: ${D.value}/${h.length} farmers imported successfully`);let _=`Successfully imported ${D.value} out of ${h.length} farmers`;return S.length>0&&(_+=`. ${S.length} farmers failed to import.`),(0,C.createSuccessResponse)(_,A)}catch(e){return console.error("CSV upload error:",e),(0,C.createErrorResponse)("Failed to process CSV upload",500)}}e.s(["POST",()=>w],690421);var y=e.i(690421);let D=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/user/farmer/upload/route",pathname:"/api/user/farmer/upload",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/farmer/upload/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:S,workUnitAsyncStorage:A,serverHooks:_}=D;function x(){return(0,a.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:A})}async function N(e,t,a){D.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/user/farmer/upload/route";v=v.replace(/\/index$/,"")||"/";let I=await D.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!I)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:C,params:w,nextConfig:y,parsedUrl:S,isDraftMode:A,prerenderManifest:_,routerServerContext:x,isOnDemandRevalidate:N,revalidateOnlyGenerated:M,resolvedPathname:b,clientReferenceManifest:q,serverActionsManifest:$}=I,O=(0,l.normalizeAppPath)(v),F=!!(_.dynamicRoutes[O]||_.routes[b]),T=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,S,!1):t.end("This page could not be found"),null);if(F&&!A){let e=!!_.routes[b],t=_.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await T();throw new g.NoFallbackError}}let P=null;!F||D.isDev||A||(P="/index"===(P=b)?"/":P);let H=!0===D.isDev||!F,U=F&&!H;$&&q&&(0,o.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:q,serverActionsManifest:$,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:$})});let k=e.method||"GET",j=(0,s.getTracer)(),V=j.getActiveScopeSpan(),B={params:w,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>D.onRequestError(e,t,a,x)},sharedContext:{buildId:C}},L=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async e=>D.handle(z,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${k} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${v}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let u=async({previousCacheEntry:r})=>{try{if(!i&&N&&M&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!F)return await (0,f.sendResponse)(L,K,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})},x),t}},d=await D.handleResponse({req:e,nextConfig:y,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!F)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",N?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&F||c.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,R.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(L,K,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};V?await l(V):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${k} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})}),F)throw t;return await (0,f.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>x,"routeModule",()=>D,"serverHooks",()=>_,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>A],626612)},453753,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__86f7d54e._.js"].map(t=>e.l(t))).then(()=>t(736987)))},121985,e=>{e.v(t=>Promise.all(["server/chunks/src_models_index_ts_328304ec._.js"].map(t=>e.l(t))).then(()=>t(540590)))}];

//# sourceMappingURL=_4363d645._.js.map