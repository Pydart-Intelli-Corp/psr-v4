module.exports=[815384,e=>{"use strict";var t=e.i(747909),a=e.i(174017),s=e.i(996250),i=e.i(759756),r=e.i(561916),o=e.i(114444),c=e.i(837092),n=e.i(869741),l=e.i(316795),d=e.i(487718),m=e.i(995169),E=e.i(47587),u=e.i(666012),_=e.i(570101),p=e.i(626937),A=e.i(10372),y=e.i(193695);e.i(52474);var R=e.i(600220),T=e.i(191273),f=e.i(79832),C=e.i(84168),S=e.i(48798);async function h(t,{params:a}){try{let s,{id:i}=await a,r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,S.createErrorResponse)("Authentication required",401);let o=(0,f.verifyToken)(r);if(!o||"admin"!==o.role)return(0,S.createErrorResponse)("Admin access required",403);await (0,C.connectDB)();let{getModels:c}=await e.A(121985),{sequelize:n,User:l}=c(),d=await l.findByPk(o.id);if(!d||!d.dbKey)return(0,S.createErrorResponse)("Admin schema not found",404);let m=d.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),E=`${m}_${d.dbKey.toLowerCase()}`;console.log(`[Society Details API] Fetching society ${i} from schema: ${E}`);let u=[],_=[],p=[],A=[],y=[],R={totalFarmers:0,activeFarmers:0,totalMachines:0,activeMachines:0,totalCollections:0,totalDispatches:0,totalSales:0,totalQuantityCollected:0,totalQuantityDispatched:0,totalQuantitySold:0,totalRevenue:0,avgFat:0,avgSnf:0,avgRate:0},T=[],h=[],D=[],O=[];try{if([s]=await n.query(`
        SELECT 
          s.id,
          s.society_id as societyId,
          s.name,
          s.location,
          s.president_name as presidentName,
          s.contact_phone as contactPhone,
          s.email,
          s.bmc_id as bmcId,
          b.name as bmcName,
          b.bmc_id as bmcIdentifier,
          b.dairy_farm_id as dairyId,
          df.name as dairyName,
          df.dairy_id as dairyIdentifier,
          s.status,
          s.created_at as createdAt,
          s.updated_at as updatedAt
        FROM \`${E}\`.\`societies\` s
        LEFT JOIN \`${E}\`.\`bmcs\` b ON s.bmc_id = b.id
        LEFT JOIN \`${E}\`.\`dairy_farms\` df ON b.dairy_farm_id = df.id
        WHERE s.id = ?
      `,{replacements:[i]}),!Array.isArray(s)||0===s.length)return(0,S.createErrorResponse)("Society not found",404);s=s[0],console.log(`[Society Details API] Found society: ${s.name}`)}catch(e){return console.error("[Society Details API] Error fetching society:",e),(0,S.createErrorResponse)("Failed to fetch society information. Table may not exist.",500)}try{[u]=await n.query(`
        SELECT 
          m.id,
          m.machine_id as machineId,
          m.machine_type as machineType,
          m.location,
          m.installation_date as installationDate,
          m.operator_name as operatorName,
          m.contact_phone as contactPhone,
          m.status,
          m.is_master_machine as isMasterMachine,
          COUNT(DISTINCT mc.id) as totalCollections,
          COALESCE(SUM(mc.quantity), 0) as totalQuantity,
          COALESCE(SUM(mc.total_amount), 0) as totalRevenue,
          MAX(mc.collection_date) as lastCollectionDate
        FROM \`${E}\`.\`machines\` m
        LEFT JOIN \`${E}\`.\`milk_collections\` mc ON mc.machine_id = m.id
          AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        WHERE m.society_id = ?
        GROUP BY m.id
        ORDER BY m.created_at DESC
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${u.length} machines`)}catch(e){console.error("[Society Details API] Error fetching machines:",e)}try{[_]=await n.query(`
        SELECT 
          f.id,
          f.farmer_id as farmerId,
          f.rf_id as rfId,
          f.name,
          f.contact_number as contactNumber,
          f.address,
          f.bank_name as bankName,
          f.bank_account_number as bankAccountNumber,
          f.status,
          COUNT(DISTINCT mc.id) as totalCollections,
          COALESCE(SUM(mc.quantity), 0) as totalQuantity,
          COALESCE(SUM(mc.total_amount), 0) as totalRevenue,
          COALESCE(AVG(mc.fat_percentage), 0) as avgFat,
          COALESCE(AVG(mc.snf_percentage), 0) as avgSnf,
          MAX(mc.collection_date) as lastCollectionDate
        FROM \`${E}\`.\`farmers\` f
        LEFT JOIN \`${E}\`.\`milk_collections\` mc ON mc.farmer_id = f.id
          AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        WHERE f.society_id = ?
        GROUP BY f.id
        ORDER BY totalQuantity DESC
        LIMIT 100
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${_.length} farmers`)}catch(e){console.error("[Society Details API] Error fetching farmers:",e)}try{[p]=await n.query(`
        SELECT 
          mc.id,
          mc.farmer_id as farmerId,
          f.name as farmerName,
          m.machine_id as machineId,
          mc.collection_date as collectionDate,
          mc.collection_time as collectionTime,
          mc.shift_type as shiftType,
          mc.channel,
          mc.fat_percentage as fat,
          mc.snf_percentage as snf,
          mc.clr_value as clr,
          mc.quantity,
          mc.rate_per_liter as rate,
          mc.total_amount as amount,
          mc.bonus,
          mc.created_at as createdAt
        FROM \`${E}\`.\`milk_collections\` mc
        LEFT JOIN \`${E}\`.\`farmers\` f ON f.farmer_id = mc.farmer_id AND f.society_id = mc.society_id
        LEFT JOIN \`${E}\`.\`machines\` m ON mc.machine_id = m.id
        WHERE mc.society_id = ?
        ORDER BY mc.collection_date DESC, mc.collection_time DESC
        LIMIT 200
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${p.length} collections`)}catch(e){console.error("[Society Details API] Error fetching collections:",e)}try{[A]=await n.query(`
        SELECT 
          md.id,
          md.dispatch_id as dispatchId,
          m.machine_id as machineId,
          md.dispatch_date as dispatchDate,
          md.dispatch_time as dispatchTime,
          md.shift_type as shiftType,
          md.channel,
          md.fat_percentage as fat,
          md.snf_percentage as snf,
          md.clr_value as clr,
          md.quantity,
          md.rate_per_liter as rate,
          md.total_amount as amount,
          md.created_at as createdAt
        FROM \`${E}\`.\`milk_dispatches\` md
        LEFT JOIN \`${E}\`.\`machines\` m ON md.machine_id = m.id
        WHERE md.society_id = ?
        ORDER BY md.dispatch_date DESC, md.dispatch_time DESC
        LIMIT 200
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${A.length} dispatches`)}catch(e){console.error("[Society Details API] Error fetching dispatches:",e)}try{[y]=await n.query(`
        SELECT 
          ms.id,
          ms.count,
          m.machine_id as machineId,
          ms.sales_date as salesDate,
          ms.sales_time as salesTime,
          ms.channel,
          ms.quantity,
          ms.rate_per_liter as rate,
          ms.total_amount as amount,
          ms.created_at as createdAt
        FROM \`${E}\`.\`milk_sales\` ms
        LEFT JOIN \`${E}\`.\`machines\` m ON ms.machine_id = m.id
        WHERE ms.society_id = ?
        ORDER BY ms.sales_date DESC, ms.sales_time DESC
        LIMIT 200
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${y.length} sales`)}catch(e){console.error("[Society Details API] Error fetching sales:",e)}try{let[e]=await n.query(`
        SELECT 
          (SELECT COUNT(DISTINCT f.id) FROM \`${E}\`.\`farmers\` f WHERE f.society_id = ?) as totalFarmers,
          (SELECT COUNT(DISTINCT f.id) FROM \`${E}\`.\`farmers\` f WHERE f.society_id = ? AND f.status = 'active') as activeFarmers,
          (SELECT COUNT(DISTINCT m.id) FROM \`${E}\`.\`machines\` m WHERE m.society_id = ?) as totalMachines,
          (SELECT COUNT(DISTINCT m.id) FROM \`${E}\`.\`machines\` m WHERE m.society_id = ? AND m.status = 'active') as activeMachines,
          (SELECT COUNT(mc.id) FROM \`${E}\`.\`milk_collections\` mc WHERE mc.society_id = ? AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as totalCollections,
          (SELECT COUNT(md.id) FROM \`${E}\`.\`milk_dispatches\` md WHERE md.society_id = ? AND md.dispatch_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as totalDispatches,
          (SELECT COUNT(ms.id) FROM \`${E}\`.\`milk_sales\` ms WHERE ms.society_id = ? AND ms.sales_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as totalSales,
          (SELECT COALESCE(SUM(mc.quantity), 0) FROM \`${E}\`.\`milk_collections\` mc WHERE mc.society_id = ? AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as totalQuantityCollected,
          (SELECT COALESCE(SUM(md.quantity), 0) FROM \`${E}\`.\`milk_dispatches\` md WHERE md.society_id = ? AND md.dispatch_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as totalQuantityDispatched,
          (SELECT COALESCE(SUM(ms.quantity), 0) FROM \`${E}\`.\`milk_sales\` ms WHERE ms.society_id = ? AND ms.sales_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as totalQuantitySold,
          (SELECT COALESCE(SUM(mc.total_amount), 0) FROM \`${E}\`.\`milk_collections\` mc WHERE mc.society_id = ? AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as totalRevenue,
          (SELECT COALESCE(AVG(mc.fat_percentage), 0) FROM \`${E}\`.\`milk_collections\` mc WHERE mc.society_id = ? AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as avgFat,
          (SELECT COALESCE(AVG(mc.snf_percentage), 0) FROM \`${E}\`.\`milk_collections\` mc WHERE mc.society_id = ? AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as avgSnf,
          (SELECT COALESCE(AVG(mc.rate_per_liter), 0) FROM \`${E}\`.\`milk_collections\` mc WHERE mc.society_id = ? AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as avgRate
      `,{replacements:[i,i,i,i,i,i,i,i,i,i,i,i,i,i]});R=e[0],console.log(`[Society Details API] Analytics - Collections: ${R.totalCollections}, Revenue: â‚¹${R.totalRevenue}, Qty Collected: ${R.totalQuantityCollected}L, Qty Dispatched: ${R.totalQuantityDispatched}L, Dispatches: ${R.totalDispatches}, Sales: ${R.totalSales}`)}catch(e){console.error("[Society Details API] Error fetching analytics:",e)}try{[T]=await n.query(`
        SELECT 
          DATE(mc.collection_date) as date,
          COUNT(DISTINCT mc.id) as collections,
          COUNT(DISTINCT mc.farmer_id) as farmers,
          COALESCE(SUM(mc.quantity), 0) as totalQuantity,
          COALESCE(SUM(mc.total_amount), 0) as totalRevenue,
          COALESCE(AVG(mc.fat_percentage), 0) as avgFat,
          COALESCE(AVG(mc.snf_percentage), 0) as avgSnf
        FROM \`${E}\`.\`milk_collections\` mc
        WHERE mc.society_id = ?
          AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
        GROUP BY DATE(mc.collection_date)
        ORDER BY date DESC
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${T.length} daily trends`)}catch(e){console.error("[Society Details API] Error fetching daily trends:",e)}try{[h]=await n.query(`
        SELECT 
          mc.shift_type as shiftType,
          COUNT(DISTINCT mc.id) as collections,
          COALESCE(SUM(mc.quantity), 0) as totalQuantity,
          COALESCE(SUM(mc.total_amount), 0) as totalRevenue,
          COALESCE(AVG(mc.fat_percentage), 0) as avgFat,
          COALESCE(AVG(mc.snf_percentage), 0) as avgSnf
        FROM \`${E}\`.\`milk_collections\` mc
        WHERE mc.society_id = ?
          AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        GROUP BY mc.shift_type
        ORDER BY collections DESC
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${h.length} shift analyses`)}catch(e){console.error("[Society Details API] Error fetching shift analysis:",e)}try{[D]=await n.query(`
        SELECT 
          f.farmer_id as farmerId,
          f.name,
          COUNT(DISTINCT mc.id) as collections,
          COALESCE(SUM(mc.quantity), 0) as totalQuantity,
          COALESCE(SUM(mc.total_amount), 0) as totalRevenue,
          COALESCE(AVG(mc.fat_percentage), 0) as avgFat,
          COALESCE(AVG(mc.snf_percentage), 0) as avgSnf
        FROM \`${E}\`.\`farmers\` f
        LEFT JOIN \`${E}\`.\`milk_collections\` mc ON mc.farmer_id = f.id
          AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        WHERE f.society_id = ?
        GROUP BY f.id, f.farmer_id, f.name
        HAVING totalQuantity > 0
        ORDER BY totalQuantity DESC
        LIMIT 10
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${D.length} top farmers`)}catch(e){console.error("[Society Details API] Error fetching top farmers:",e)}try{[O]=await n.query(`
        SELECT 
          mc.channel,
          COUNT(DISTINCT mc.id) as collections,
          COALESCE(SUM(mc.quantity), 0) as totalQuantity,
          COALESCE(SUM(mc.total_amount), 0) as totalRevenue,
          COALESCE(AVG(mc.fat_percentage), 0) as avgFat,
          COALESCE(AVG(mc.snf_percentage), 0) as avgSnf
        FROM \`${E}\`.\`milk_collections\` mc
        WHERE mc.society_id = ?
          AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        GROUP BY mc.channel
        ORDER BY totalQuantity DESC
      `,{replacements:[i]}),console.log(`[Society Details API] Found ${O.length} channels`)}catch(e){console.error("[Society Details API] Error fetching channel breakdown:",e)}let I=[];try{[I]=await n.query(`
        SELECT 
          sp.id,
          DATE_FORMAT(sp.pulse_date, '%Y-%m-%d') as pulseDate,
          sp.pulse_status as pulseStatus,
          DATE_FORMAT(sp.first_collection_time, '%Y-%m-%d %H:%i:%s') as firstCollectionTime,
          DATE_FORMAT(sp.last_collection_time, '%Y-%m-%d %H:%i:%s') as lastCollectionTime,
          DATE_FORMAT(sp.section_end_time, '%Y-%m-%d %H:%i:%s') as sectionEndTime,
          sp.total_collections as totalCollections,
          sp.inactive_days as inactiveDays,
          DATE_FORMAT(sp.last_checked, '%Y-%m-%d %H:%i:%s') as lastChecked,
          (SELECT COUNT(*) FROM \`${E}\`.\`farmers\` WHERE society_id = ? AND status = 'active') as totalFarmers,
          (SELECT COUNT(DISTINCT mc.farmer_id) 
           FROM \`${E}\`.\`milk_collections\` mc 
           WHERE mc.society_id = ? AND DATE(mc.collection_date) = sp.pulse_date) as presentFarmers,
          ((SELECT COUNT(*) FROM \`${E}\`.\`farmers\` WHERE society_id = ? AND status = 'active') - 
           (SELECT COUNT(DISTINCT mc.farmer_id) 
            FROM \`${E}\`.\`milk_collections\` mc 
            WHERE mc.society_id = ? AND DATE(mc.collection_date) = sp.pulse_date)) as absentFarmers,
          DATE_FORMAT(sp.created_at, '%Y-%m-%d %H:%i:%s') as createdAt,
          DATE_FORMAT(sp.updated_at, '%Y-%m-%d %H:%i:%s') as updatedAt
        FROM \`${E}\`.\`section_pulse\` sp
        WHERE sp.society_id = ?
        ORDER BY sp.pulse_date DESC
        LIMIT 30
      `,{replacements:[i,i,i,i,i]}),console.log(`[Society Details API] Found ${I.length} section pulse records with farmer counts`)}catch(e){console.error("[Society Details API] Error fetching section pulse:",e)}return console.log(`[Society Details API] Successfully compiled society details for: ${s.name}`),(0,S.createSuccessResponse)("Society details retrieved successfully",{society:s,machines:u,farmers:_,collections:p,dispatches:A,sales:y,analytics:R,dailyTrends:T,shiftAnalysis:h,topPerformers:{farmers:D},channelBreakdown:O,sections:I})}catch(e){return console.error("[Society Details API] Error:",e),(0,S.createErrorResponse)("Failed to fetch society details",500)}}async function D(t,{params:a}){try{let{id:s}=await a,i=t.headers.get("authorization")?.replace("Bearer ","");if(!i)return(0,S.createErrorResponse)("Authentication required",401);let r=(0,f.verifyToken)(i);if(!r||"admin"!==r.role)return(0,S.createErrorResponse)("Admin access required",403);let{name:o,location:c,presidentName:n,contactPhone:l,email:d,status:m}=await t.json();if(!o||!o.trim())return(0,S.createErrorResponse)("Society name is required",400);if(!d||!d.trim())return(0,S.createErrorResponse)("Email is required",400);if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.trim()))return(0,S.createErrorResponse)("Please enter a valid email address",400);if(m&&!["active","inactive","maintenance"].includes(m))return(0,S.createErrorResponse)("Invalid status value",400);await (0,C.connectDB)();let{getModels:E}=await e.A(121985),{sequelize:u,User:_}=E(),p=await _.findByPk(r.id);if(!p||!p.dbKey)return(0,S.createErrorResponse)("Admin schema not found",404);let A=p.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),y=`${A}_${p.dbKey.toLowerCase()}`;console.log(`[Society Update API] Updating society ${s} in schema: ${y}`);let R=await u.query(`SELECT id FROM \`${y}\`.\`societies\` WHERE id = ? LIMIT 1`,{replacements:[s],type:T.QueryTypes.SELECT});if(!R||0===R.length)return(0,S.createErrorResponse)("Society not found",404);let h=`
      SELECT society_id FROM \`${y}\`.\`societies\`
      WHERE email = ? AND id != ? LIMIT 1
    `,[D]=await u.query(h,{replacements:[d.trim().toLowerCase(),s]});if(Array.isArray(D)&&D.length>0)return console.log(`ðŸ“§ Duplicate email detected: ${d}`),(0,S.createErrorResponse)("Email address already exists. Please use a different email.",400);await u.query(`UPDATE \`${y}\`.\`societies\`
       SET name = ?,
           location = ?,
           president_name = ?,
           contact_phone = ?,
           email = ?,
           status = ?,
           updated_at = NOW()
       WHERE id = ?`,{replacements:[o.trim(),c||null,n||null,l||null,d.trim().toLowerCase(),m||"active",s]}),console.log(`[Society Update API] Successfully updated society ${s}`);let[O]=await u.query(`SELECT 
        s.id,
        s.society_id as societyId,
        s.name,
        s.location,
        s.president_name as presidentName,
        s.contact_phone as contactPhone,
        s.bmc_id as bmcId,
        b.name as bmcName,
        b.bmc_id as bmcIdentifier,
        b.dairy_farm_id as dairyId,
        df.name as dairyName,
        df.dairy_id as dairyIdentifier,
        s.status,
        DATE_FORMAT(s.created_at, '%Y-%m-%d %H:%i:%s') as createdAt,
        DATE_FORMAT(s.updated_at, '%Y-%m-%d %H:%i:%s') as updatedAt
      FROM \`${y}\`.\`societies\` s
      LEFT JOIN \`${y}\`.\`bmcs\` b ON s.bmc_id = b.id
      LEFT JOIN \`${y}\`.\`dairy_farms\` df ON b.dairy_farm_id = df.id
      WHERE s.id = ?
      LIMIT 1`,{replacements:[s]});return(0,S.createSuccessResponse)("Society updated successfully",{society:O[0]})}catch(e){return console.error("[Society Update API] Error:",e),(0,S.createErrorResponse)("Failed to update society details",500)}}e.s(["GET",()=>h,"PUT",()=>D],279007);var O=e.i(279007);let I=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/user/society/[id]/route",pathname:"/api/user/society/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/society/[id]/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:N,workUnitAsyncStorage:g,serverHooks:L}=I;function v(){return(0,s.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:g})}async function U(e,t,s){I.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let T="/api/user/society/[id]/route";T=T.replace(/\/index$/,"")||"/";let f=await I.prepare(e,t,{srcPage:T,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:C,params:S,nextConfig:h,parsedUrl:D,isDraftMode:O,prerenderManifest:N,routerServerContext:g,isOnDemandRevalidate:L,revalidateOnlyGenerated:v,resolvedPathname:U,clientReferenceManifest:M,serverActionsManifest:F}=f,$=(0,n.normalizeAppPath)(T),w=!!(N.dynamicRoutes[$]||N.routes[U]),P=async()=>((null==g?void 0:g.render404)?await g.render404(e,t,D,!1):t.end("This page could not be found"),null);if(w&&!O){let e=!!N.routes[U],t=N.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(h.experimental.adapterPath)return await P();throw new y.NoFallbackError}}let b=null;!w||I.isDev||O||(b="/index"===(b=U)?"/":b);let H=!0===I.isDev||!w,q=w&&!H;F&&M&&(0,o.setReferenceManifestsSingleton)({page:T,clientReferenceManifest:M,serverActionsManifest:F,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:F})});let k=e.method||"GET",B=(0,r.getTracer)(),Y=B.getActiveScopeSpan(),W={params:S,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!h.experimental.authInterrupts},cacheComponents:!!h.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:h.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,s)=>I.onRequestError(e,t,s,g)},sharedContext:{buildId:C}},x=new l.NodeNextRequest(e),V=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(x,(0,d.signalFromNodeResponse)(t));try{let o=async e=>I.handle(G,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=B.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${k} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${T}`)}),c=!!(0,i.getRequestMeta)(e,"minimalMode"),n=async i=>{var r,n;let l=async({previousCacheEntry:a})=>{try{if(!c&&L&&v&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(i);e.fetchMetrics=W.renderOpts.fetchMetrics;let n=W.renderOpts.pendingWaitUntil;n&&s.waitUntil&&(s.waitUntil(n),n=void 0);let l=W.renderOpts.collectedTags;if(!w)return await (0,u.sendResponse)(x,V,r,W.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(r.headers);l&&(t[A.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=A.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,s=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=A.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==a?void 0:a.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:L})},g),t}},d=await I.handleResponse({req:e,nextConfig:h,cacheKey:b,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:L,revalidateOnlyGenerated:v,responseGenerator:l,waitUntil:s.waitUntil,isMinimalMode:c});if(!w)return null;if((null==d||null==(r=d.value)?void 0:r.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(n=d.value)?void 0:n.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",L?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),O&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,_.fromNodeOutgoingHttpHeaders)(d.value.headers);return c&&w||m.delete(A.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,p.getCacheControlHeader)(d.cacheControl)),await (0,u.sendResponse)(x,V,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};Y?await n(Y):await B.withPropagatedContext(e.headers,()=>B.trace(m.BaseServerSpan.handleRequest,{spanName:`${k} ${T}`,kind:r.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},n))}catch(t){if(t instanceof y.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:L})}),w)throw t;return await (0,u.sendResponse)(x,V,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>v,"routeModule",()=>I,"serverHooks",()=>L,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>g],815384)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_8fcf0553.js.map