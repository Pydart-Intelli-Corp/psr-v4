module.exports=[352598,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),s=e.i(759756),n=e.i(561916),i=e.i(114444),o=e.i(837092),c=e.i(869741),l=e.i(316795),d=e.i(487718),u=e.i(995169),h=e.i(47587),p=e.i(666012),E=e.i(570101),R=e.i(626937),m=e.i(10372),_=e.i(193695);e.i(52474);var f=e.i(600220),g=e.i(89171),y=e.i(79832),w=e.i(84168);async function N(t){try{let a=t.headers.get("Authorization");if(!a?.startsWith("Bearer "))return g.NextResponse.json({success:!1,message:"No authorization token provided"},{status:401});let r=a.substring(7),s=(0,y.verifyToken)(r);if(!s||"admin"!==s.role&&"super_admin"!==s.role)return g.NextResponse.json({success:!1,message:"Unauthorized - Admin access required"},{status:403});let{masterChartId:n,societyIds:i,replaceExisting:o}=await t.json();if(!n||!i||!Array.isArray(i)||0===i.length)return g.NextResponse.json({success:!1,message:"Master chart ID and society IDs are required"},{status:400});let c=await (0,w.connectDB)();if(!c)return g.NextResponse.json({success:!1,message:"Database connection failed"},{status:500});let{User:l}=await e.A(121985).then(e=>e.getModels()),d=await l.findByPk(s.id);if(!d||!d.dbKey)return g.NextResponse.json({success:!1,message:"Admin schema not found"},{status:404});let u=d.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),h=`${u}_${d.dbKey.toLowerCase()}`,[p]=await c.query(`
      SELECT * FROM ${h}.rate_charts WHERE id = ? AND shared_chart_id IS NULL
    `,{replacements:[n]});if(!p||0===p.length)return g.NextResponse.json({success:!1,message:"Master chart not found"},{status:404});let E=p[0],[R]=await c.query(`
      SELECT 
        rc.id,
        rc.society_id as societyId,
        s.name as societyName,
        rc.channel,
        rc.file_name as fileName,
        CASE 
          WHEN rc.shared_chart_id IS NULL THEN rc.id
          ELSE rc.shared_chart_id
        END as masterChartId
      FROM ${h}.rate_charts rc
      LEFT JOIN ${h}.societies s ON rc.society_id = s.id
      WHERE rc.society_id IN (?) AND rc.channel = ?
    `,{replacements:[i,E.channel]});if(R.length>0&&!o){let e=R.map(e=>({societyId:e.societyId,societyName:e.societyName,currentFileName:e.fileName,currentMasterChartId:e.masterChartId}));return g.NextResponse.json({success:!1,requiresConfirmation:!0,message:`${e.length} ${1===e.length?"society":"societies"} already have a ${E.channel} chart assigned`,conflicts:e},{status:409})}if(o&&R.length>0){let e=await c.transaction();try{for(let t of R){let a=t.id;if(t.societyId,t.masterChartId,null===t.shared_chart_id){let[t]=await c.query(`
              SELECT COUNT(*) as count FROM ${h}.rate_charts
              WHERE shared_chart_id = ?
            `,{replacements:[a],transaction:e});if(t[0].count>0){let[t]=await c.query(`
                SELECT id FROM ${h}.rate_charts
                WHERE shared_chart_id = ?
                ORDER BY id ASC LIMIT 1
              `,{replacements:[a],transaction:e}),r=t[0].id;await c.query(`
                UPDATE ${h}.rate_chart_data
                SET rate_chart_id = ?
                WHERE rate_chart_id = ?
              `,{replacements:[r,a],transaction:e}),await c.query(`
                UPDATE ${h}.rate_charts
                SET shared_chart_id = NULL
                WHERE id = ?
              `,{replacements:[r],transaction:e}),await c.query(`
                UPDATE ${h}.rate_charts
                SET shared_chart_id = ?
                WHERE shared_chart_id = ? AND id != ?
              `,{replacements:[r,a,r],transaction:e})}else await c.query(`
                DELETE FROM ${h}.rate_chart_data
                WHERE rate_chart_id = ?
              `,{replacements:[a],transaction:e})}await c.query(`
            DELETE FROM ${h}.rate_chart_download_history
            WHERE rate_chart_id = ?
          `,{replacements:[a],transaction:e}),await c.query(`
            DELETE FROM ${h}.rate_charts
            WHERE id = ?
          `,{replacements:[a],transaction:e})}await e.commit()}catch(t){throw await e.rollback(),t}}let[m]=await c.query(`
      SELECT society_id as societyId FROM ${h}.rate_charts 
       WHERE (id = ? OR shared_chart_id = ?) AND society_id IN (?)
    `,{replacements:[n,n,i]}),_=m.map(e=>e.societyId),f=i.filter(e=>!_.includes(e));if(0===f.length)return g.NextResponse.json({success:!1,message:"All selected societies already have this chart assigned"},{status:400});let[N]=await c.query(`
      SELECT id, name, society_id FROM ${h}.societies WHERE id IN (?)
    `,{replacements:[f]}),v=N.map(e=>c.query(`INSERT INTO ${h}.rate_charts 
         (society_id, channel, uploaded_at, uploaded_by, file_name, record_count, shared_chart_id, status)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,{replacements:[e.id,E.channel,new Date,d.fullName,E.file_name,E.record_count,n,1]}));return await Promise.all(v),g.NextResponse.json({success:!0,message:`Successfully assigned chart to ${f.length} new ${1===f.length?"society":"societies"}`,data:{assignedCount:f.length,skippedCount:_.length}})}catch(e){return console.error("Error assigning chart to societies:",e),g.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}e.s(["POST",()=>N],633290);var v=e.i(633290);let C=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/user/ratechart/assign/route",pathname:"/api/user/ratechart/assign",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/ratechart/assign/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:A,workUnitAsyncStorage:T,serverHooks:x}=C;function I(){return(0,r.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:T})}async function S(e,t,r){C.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/user/ratechart/assign/route";g=g.replace(/\/index$/,"")||"/";let y=await C.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:N,nextConfig:v,parsedUrl:A,isDraftMode:T,prerenderManifest:x,routerServerContext:I,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,resolvedPathname:H,clientReferenceManifest:P,serverActionsManifest:q}=y,D=(0,c.normalizeAppPath)(g),M=!!(x.dynamicRoutes[D]||x.routes[H]),$=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,A,!1):t.end("This page could not be found"),null);if(M&&!T){let e=!!x.routes[H],t=x.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await $();throw new _.NoFallbackError}}let b=null;!M||C.isDev||T||(b="/index"===(b=H)?"/":b);let L=!0===C.isDev||!M,U=M&&!L;q&&P&&(0,i.setReferenceManifestsSingleton)({page:g,clientReferenceManifest:P,serverActionsManifest:q,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:q})});let j=e.method||"GET",k=(0,n.getTracer)(),F=k.getActiveScopeSpan(),W={params:N,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>C.onRequestError(e,t,r,I)},sharedContext:{buildId:w}},K=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let i=async e=>C.handle(z,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=k.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${g}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var n,c;let l=async({previousCacheEntry:a})=>{try{if(!o&&S&&O&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=W.renderOpts.fetchMetrics;let c=W.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let l=W.renderOpts.collectedTags;if(!M)return await (0,p.sendResponse)(K,B,n,W.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,r=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:S})},I),t}},d=await C.handleResponse({req:e,nextConfig:v,cacheKey:b,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:o});if(!M)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,E.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&M||u.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,R.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,B,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};F?await c(F):await k.withPropagatedContext(e.headers,()=>k.trace(u.BaseServerSpan.handleRequest,{spanName:`${j} ${g}`,kind:n.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(t){if(t instanceof _.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:S})}),M)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>I,"routeModule",()=>C,"serverHooks",()=>x,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>T],352598)},453753,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__86f7d54e._.js"].map(t=>e.l(t))).then(()=>t(736987)))},121985,e=>{e.v(t=>Promise.all(["server/chunks/src_models_index_ts_328304ec._.js"].map(t=>e.l(t))).then(()=>t(540590)))}];

//# sourceMappingURL=_a9fa5475._.js.map