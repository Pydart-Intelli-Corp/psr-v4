module.exports=[665693,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),o=e.i(561916),i=e.i(114444),s=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),p=e.i(47587),h=e.i(666012),g=e.i(570101),R=e.i(626937),y=e.i(10372),E=e.i(193695);e.i(52474);var f=e.i(600220),m=e.i(84168),S=e.i(116185);e.i(512982);var C=e.i(375448),w=e.i(871366),I=e.i(309241);async function P(t,{params:r}){try{var a;let n,o,i,s,l,d,c,u,p,h,g,R=await C.ESP32ResponseHelper.extractInputString(t),y=await r,E=y["db-key"]||y.dbKey||y.dbkey;if(R&&(R=C.ESP32ResponseHelper.filterLineEndings(R)),C.ESP32ResponseHelper.logRequest(t,E,R),!E||""===E.trim())return console.log(`‚ùå DB Key validation failed - dbKey: "${E}"`),C.ESP32ResponseHelper.createErrorResponse("DB Key is required");if(!R)return C.ESP32ResponseHelper.createErrorResponse("InputString parameter is required");await (0,m.connectDB)();let{getModels:f}=await e.A(121985),{sequelize:S,User:P}=f(),v=w.InputValidator.validateDbKey(E);if(!v.isValid)return C.ESP32ResponseHelper.createErrorResponse(v.error||"Invalid DB Key");let A=await P.findOne({where:{dbKey:E.toUpperCase()}});if(!A||!A.dbKey)return console.log(`‚ùå Admin not found or missing DB Key for: ${E}`),C.ESP32ResponseHelper.createErrorResponse("Invalid DB Key");let $=R.split("|");if(6!==$.length)return console.log(`‚ùå Invalid InputString format. Expected 6 parts, got ${$.length}`),C.ESP32ResponseHelper.createErrorResponse("Invalid InputString format. Expected: societyId|machineType|version|machineId|channel|pageNumber");let[_,x,T,b,D,M]=$;console.log(`üîç Parsed InputString parts:`,{societyIdStr:_,machineType:x,machineModel:T,machineId:b,channel:D,pageParam:M});let L=A.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),N=`${L}_${A.dbKey.toLowerCase()}`,{query:O,replacements:H}=I.QueryBuilder.buildSocietyLookupQuery(N,_),[U]=await S.query(O,{replacements:H});if(!Array.isArray(U)||0===U.length)return console.log(`‚ùå No society found for society_id: "${_}"`),C.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let q=U[0].id;console.log(`‚úÖ Found society: "${_}" -> database ID: ${q}`);let K=w.InputValidator.validateMachineId(b);if(!K.isValid)return console.log(`‚ùå Invalid machine ID: "${b}" - ${K.error}`),C.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let F=K.numericId,k=(K.variants||[]).map(e=>String(e));if(console.log(`üîç Machine ID parsing: "${b}" -> ${F||k.join(", ")}`),null!=F)h=`
        SELECT id, machine_id, society_id
        FROM \`${N}\`.machines 
        WHERE id = ? AND society_id = ? AND status = 'active'
        LIMIT 1
      `,g=[F,q];else{let e=k.map(()=>"?").join(", ");h=`
        SELECT id, machine_id, society_id
        FROM \`${N}\`.machines 
        WHERE machine_id IN (${e}) AND society_id = ? AND status = 'active'
        LIMIT 1
      `,g=[...k,q]}let[B]=await S.query(h,{replacements:g});if(!Array.isArray(B)||0===B.length)return console.log(`‚ùå Machine "${b}" not registered under society ${q}`),C.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let G=B[0];console.log(`‚úÖ Verified machine: "${G.machine_id}" (ID: ${G.id}) registered under society ${q}`);let j=D.toUpperCase();if(!["COW","BUF","MIX"].includes(j))return console.log(`‚ùå Invalid channel: "${D}". Must be COW, BUF, or MIX`),C.ESP32ResponseHelper.createErrorResponse("Invalid channel. Must be COW, BUF, or MIX");let W=parseInt(M.replace(/^C0*/,""))||1,V=(W-1)*10;console.log(`üîç Pagination: Page ${W}, Size 10, Offset ${V}`),W<1&&console.log(`‚ö†Ô∏è Invalid page number: ${W}, using page 1`),console.log(`üîç Using schema: ${N} for society: ${q}, channel: ${j}`);let X=`
      SELECT 
        rc.id,
        rc.society_id,
        rc.channel,
        rc.file_name,
        rc.shared_chart_id,
        rc.uploaded_at,
        rc.status
      FROM \`${N}\`.rate_charts rc
      LEFT JOIN \`${N}\`.rate_chart_download_history dh 
        ON dh.rate_chart_id = rc.id 
        AND dh.machine_id = ?
      WHERE rc.society_id = ? 
        AND rc.channel = ?
        AND rc.status = 1
        AND dh.id IS NULL
      ORDER BY rc.uploaded_at DESC
      LIMIT 1
    `,[z]=await S.query(X,{replacements:[G.id,q,j]});if(0===z.length)return console.log(`‚ÑπÔ∏è No rate chart found for society ${q}, channel ${j}`),C.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let Y=z[0];console.log(`‚úÖ Found rate chart: ${Y.file_name} (ID: ${Y.id}, Type: ${Y.shared_chart_id?"SHARED":"MASTER"})`);let Q=Y.shared_chart_id||Y.id;Y.shared_chart_id&&console.log(`   üìå Using master chart ID ${Q} for data lookup`);let Z=`
      SELECT 
        fat,
        snf,
        clr,
        rate
      FROM \`${N}\`.rate_chart_data
      WHERE rate_chart_id = ?
      ORDER BY 
        CAST(fat AS DECIMAL(10,2)) ASC,
        CAST(snf AS DECIMAL(10,2)) ASC
      LIMIT ? OFFSET ?
    `,[J]=await S.query(Z,{replacements:[Q,10,V]});if(console.log(`‚úÖ Found ${J.length} rate chart records for chart ${Y.id} using data from chart ${Q} (Page ${W}, Offset ${V})`),0===J.length)return console.log(`‚ÑπÔ∏è End of rate chart reached at page ${W}`),C.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let ee=J.length<10,et=e=>{let t=parseFloat(e);return isNaN(t)?"0.00":t.toFixed(2)},er=[(a=Y.uploaded_at,n=new Date(a),o=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),s=n.getFullYear(),l=n.getHours(),d=String(n.getMinutes()).padStart(2,"0"),c=String(n.getSeconds()).padStart(2,"0"),u=l>=12?"PM":"AM",l%=12,l=l||12,p=String(l).padStart(2,"0"),`${o}-${i}-${s} ${p}:${d}:${c} ${u}`),""];J.forEach(e=>{er.push(j),er.push(et(e.fat)),er.push(et(e.snf)),er.push(et(e.clr)),er.push(et(e.rate)),er.push("")}),ee&&er.push('"Price chart not found."');let ea=er.join("|");console.log(`üì§ Returning rate chart data for ${J.length} records (Page ${W}${ee?" - LAST PAGE":""})`),console.log(`üì§ Response format: ${ea.substring(0,100)}${ea.length>100?"...":""}`);let en=`"${ea}"`;return new Response(en,{status:200,headers:{"Content-Type":"text/plain","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST","Access-Control-Allow-Headers":"Content-Type"}})}catch(e){return console.error("‚ùå Error in GetLatestPriceChart API:",e),C.ESP32ResponseHelper.createErrorResponse("Price chart not found.")}}async function v(e,t){let r=Date.now();try{let a=await P(e,t),n=Date.now();try{let t=(0,S.extractRequestMetadata)(e.url);console.log("üîî Logging request to monitoring system:",{endpoint:"PriceChartUpdation/GetLatest",dbKey:t.dbKey,societyId:t.societyId,statusCode:a.status,responseTime:n-r}),S.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/GetLatest",dbKey:t.dbKey,societyId:t.societyId,machineId:t.machineId,inputString:t.inputString,statusCode:a.status,responseTime:n-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",category:"external"}),console.log("‚úÖ Request logged successfully")}catch(e){console.error("‚ùå Failed to log request:",e)}return a}catch(n){let t=Date.now(),a=n instanceof Error?n.message:"Unknown error";try{let n=(0,S.extractRequestMetadata)(e.url);S.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/GetLatest",dbKey:n.dbKey,societyId:n.societyId,machineId:n.machineId,inputString:n.inputString,statusCode:500,responseTime:t-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",error:a,category:"external"})}catch(e){console.error("Failed to log error:",e)}throw n}}async function A(e,t){let r=Date.now();try{let a=await P(e,t),n=Date.now();try{let t=(0,S.extractRequestMetadata)(e.url);S.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/GetLatest",dbKey:t.dbKey,societyId:t.societyId,machineId:t.machineId,inputString:t.inputString,statusCode:a.status,responseTime:n-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",category:"external"})}catch(e){console.error("Failed to log request:",e)}return a}catch(n){let t=Date.now(),a=n instanceof Error?n.message:"Unknown error";try{let n=(0,S.extractRequestMetadata)(e.url);S.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/GetLatest",dbKey:n.dbKey,societyId:n.societyId,machineId:n.machineId,inputString:n.inputString,statusCode:500,responseTime:t-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",error:a,category:"external"})}catch(e){console.error("Failed to log error:",e)}throw n}}async function $(){return C.ESP32ResponseHelper.createCORSResponse()}e.s(["GET",()=>v,"OPTIONS",()=>$,"POST",()=>A],240154);var _=e.i(240154);let x=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/[db-key]/PriceChartUpdation/GetLatestPriceChart/route",pathname:"/api/[db-key]/PriceChartUpdation/GetLatestPriceChart",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/[db-key]/PriceChartUpdation/GetLatestPriceChart/route.ts",nextConfigOutput:"",userland:_}),{workAsyncStorage:T,workUnitAsyncStorage:b,serverHooks:D}=x;function M(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:b})}async function L(e,t,a){x.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let m="/api/[db-key]/PriceChartUpdation/GetLatestPriceChart/route";m=m.replace(/\/index$/,"")||"/";let S=await x.prepare(e,t,{srcPage:m,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:C,params:w,nextConfig:I,parsedUrl:P,isDraftMode:v,prerenderManifest:A,routerServerContext:$,isOnDemandRevalidate:_,revalidateOnlyGenerated:T,resolvedPathname:b,clientReferenceManifest:D,serverActionsManifest:M}=S,L=(0,l.normalizeAppPath)(m),N=!!(A.dynamicRoutes[L]||A.routes[b]),O=async()=>((null==$?void 0:$.render404)?await $.render404(e,t,P,!1):t.end("This page could not be found"),null);if(N&&!v){let e=!!A.routes[b],t=A.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await O();throw new E.NoFallbackError}}let H=null;!N||x.isDev||v||(H="/index"===(H=b)?"/":H);let U=!0===x.isDev||!N,q=N&&!U;M&&D&&(0,i.setReferenceManifestsSingleton)({page:m,clientReferenceManifest:D,serverActionsManifest:M,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:M})});let K=e.method||"GET",F=(0,o.getTracer)(),k=F.getActiveScopeSpan(),B={params:w,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>x.onRequestError(e,t,a,$)},sharedContext:{buildId:C}},G=new d.NodeNextRequest(e),j=new d.NodeNextResponse(t),W=c.NextRequestAdapter.fromNodeNextRequest(G,(0,c.signalFromNodeResponse)(t));try{let i=async e=>x.handle(W,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${K} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${K} ${m}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&_&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!N)return await (0,h.sendResponse)(G,j,o,B.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[y.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:_})},$),t}},c=await x.handleResponse({req:e,nextConfig:I,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!N)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",_?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&N||u.delete(y.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,R.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(G,j,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};k?await l(k):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${K} ${m}`,kind:o.SpanKind.SERVER,attributes:{"http.method":K,"http.target":e.url}},l))}catch(t){if(t instanceof E.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:_})}),N)throw t;return await (0,h.sendResponse)(G,j,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>M,"routeModule",()=>x,"serverHooks",()=>D,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>b],665693)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_52e42e1a.js.map