module.exports=[328448,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),o=e.i(561916),i=e.i(114444),s=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),p=e.i(47587),h=e.i(666012),g=e.i(570101),y=e.i(626937),R=e.i(10372),E=e.i(193695);e.i(52474);var m=e.i(600220),f=e.i(84168),v=e.i(116185);e.i(512982);var w=e.i(375448),S=e.i(871366),I=e.i(309241);async function C(t,{params:r}){try{let a,n,o=await w.ESP32ResponseHelper.extractInputString(t),i=await r,s=i["db-key"]||i.dbKey||i.dbkey;if(o&&(o=w.ESP32ResponseHelper.filterLineEndings(o)),w.ESP32ResponseHelper.logRequest(t,s,o),!s||""===s.trim())return console.log(`âŒ DB Key validation failed - dbKey: "${s}"`),w.ESP32ResponseHelper.createErrorResponse("DB Key is required");if(!o)return w.ESP32ResponseHelper.createErrorResponse("InputString parameter is required");await (0,f.connectDB)();let{getModels:l}=await e.A(121985),{sequelize:d,User:c}=l(),u=S.InputValidator.validateDbKey(s);if(!u.isValid)return w.ESP32ResponseHelper.createErrorResponse(u.error||"Invalid DB Key");let p=await c.findOne({where:{dbKey:s.toUpperCase()}});if(!p||!p.dbKey)return console.log(`âŒ Admin not found or missing DB Key for: ${s}`),w.ESP32ResponseHelper.createErrorResponse("Invalid DB Key");let h=o.split("|");if(5!==h.length)return console.log(`âŒ Invalid InputString format. Expected 5 parts, got ${h.length}`),w.ESP32ResponseHelper.createErrorResponse("Invalid InputString format. Expected: societyId|machineType|version|machineId|channel");let[g,y,R,E,m]=h;console.log(`ðŸ” Parsed InputString parts:`,{societyIdStr:g,machineType:y,machineModel:R,machineId:E,channel:m});let v=p.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),C=`${v}_${p.dbKey.toLowerCase()}`,{query:P,replacements:A}=I.QueryBuilder.buildSocietyLookupQuery(C,g),[x]=await d.query(P,{replacements:A});if(!Array.isArray(x)||0===x.length)return console.log(`âŒ No society found for society_id: "${g}"`),w.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let H=x[0].id;console.log(`âœ… Found society: "${g}" -> database ID: ${H}`);let _=S.InputValidator.validateMachineId(E);if(!_.isValid)return console.log(`âŒ Invalid machine ID: "${E}" - ${_.error}`),w.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let b=_.numericId,$=(_.variants||[]).map(e=>String(e));if(console.log(`ðŸ” Machine ID parsing: "${E}" -> ${b||$.join(", ")}`),null!=b)a=`
        SELECT id, machine_id, society_id
        FROM \`${C}\`.machines 
        WHERE id = ? AND society_id = ? AND status = 'active'
        LIMIT 1
      `,n=[b,H];else{let e=$.map(()=>"?").join(", ");a=`
        SELECT id, machine_id, society_id
        FROM \`${C}\`.machines 
        WHERE machine_id IN (${e}) AND society_id = ? AND status = 'active'
        LIMIT 1
      `,n=[...$,H]}let[D]=await d.query(a,{replacements:n});if(!Array.isArray(D)||0===D.length)return console.log(`âŒ Machine "${E}" not registered under society ${H}`),w.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let T=D[0];console.log(`âœ… Verified machine: "${T.machine_id}" (ID: ${T.id}) registered under society ${H}`);let U=m.toUpperCase();if(!["COW","BUF","MIX"].includes(U))return console.log(`âŒ Invalid channel: "${m}". Must be COW, BUF, or MIX`),w.ESP32ResponseHelper.createErrorResponse("Invalid channel. Must be COW, BUF, or MIX");console.log(`ðŸ” Using schema: ${C} for society: ${H}, channel: ${U}`);let N=`
      SELECT id 
      FROM \`${C}\`.rate_charts 
      WHERE society_id = ? AND channel = ? AND status = 1
      ORDER BY uploaded_at DESC
      LIMIT 1
    `,[M]=await d.query(N,{replacements:[H,U]});if(!Array.isArray(M)||0===M.length)return console.log(`âŒ No active rate chart found for society ${H}, channel ${U}`),w.ESP32ResponseHelper.createErrorResponse("Price chart not found.");let O=M[0].id,q=`
      SELECT id 
      FROM \`${C}\`.rate_chart_download_history 
      WHERE machine_id = ? AND rate_chart_id = ? AND channel = ?
      LIMIT 1
    `,[K]=await d.query(q,{replacements:[T.id,O,U]});if(Array.isArray(K)&&K.length>0)return console.log(`â„¹ï¸ Machine ${T.id} already downloaded chart ${O} for channel ${U}`),w.ESP32ResponseHelper.createDataResponse("Price chart history saved successfully.");let k=`
      INSERT INTO \`${C}\`.rate_chart_download_history 
      (rate_chart_id, machine_id, society_id, channel, downloaded_at)
      VALUES (?, ?, ?, ?, NOW())
    `;return await d.query(k,{replacements:[O,T.id,H,U]}),console.log(`âœ… Recorded download history for machine ${T.id}, chart ${O}`),w.ESP32ResponseHelper.createDataResponse("Price chart history saved successfully.")}catch(e){return console.error("âŒ Error in SavePriceChartUpdationHistory API:",e),w.ESP32ResponseHelper.createErrorResponse("Price chart not found.")}}async function P(e,t){let r=Date.now();try{let a=await C(e,t),n=Date.now();try{let t=(0,v.extractRequestMetadata)(e.url);v.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/SaveHistory",dbKey:t.dbKey,societyId:t.societyId,machineId:t.machineId,inputString:t.inputString,statusCode:a.status,responseTime:n-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",category:"external"})}catch(e){console.error("âŒ Failed to log request:",e)}return a}catch(n){let t=Date.now(),a=n instanceof Error?n.message:"Unknown error";try{let n=(0,v.extractRequestMetadata)(e.url);v.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/SaveHistory",dbKey:n.dbKey,societyId:n.societyId,machineId:n.machineId,inputString:n.inputString,statusCode:500,responseTime:t-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",error:a,category:"external"})}catch(e){console.error("Failed to log error:",e)}throw n}}async function A(e,t){let r=Date.now();try{let a=await C(e,t),n=Date.now();try{let t=(0,v.extractRequestMetadata)(e.url);v.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/SaveHistory",dbKey:t.dbKey,societyId:t.societyId,machineId:t.machineId,inputString:t.inputString,statusCode:a.status,responseTime:n-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",category:"external"})}catch(e){console.error("Failed to log request:",e)}return a}catch(n){let t=Date.now(),a=n instanceof Error?n.message:"Unknown error";try{let n=(0,v.extractRequestMetadata)(e.url);v.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"PriceChartUpdation/SaveHistory",dbKey:n.dbKey,societyId:n.societyId,machineId:n.machineId,inputString:n.inputString,statusCode:500,responseTime:t-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",error:a,category:"external"})}catch(e){console.error("Failed to log error:",e)}throw n}}async function x(){return w.ESP32ResponseHelper.createCORSResponse()}e.s(["GET",()=>P,"OPTIONS",()=>x,"POST",()=>A],869841);var H=e.i(869841);let _=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/[db-key]/PriceChartUpdation/SavePriceChartUpdationHistory/route",pathname:"/api/[db-key]/PriceChartUpdation/SavePriceChartUpdationHistory",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/[db-key]/PriceChartUpdation/SavePriceChartUpdationHistory/route.ts",nextConfigOutput:"",userland:H}),{workAsyncStorage:b,workUnitAsyncStorage:$,serverHooks:D}=_;function T(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:$})}async function U(e,t,a){_.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/[db-key]/PriceChartUpdation/SavePriceChartUpdationHistory/route";f=f.replace(/\/index$/,"")||"/";let v=await _.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:S,nextConfig:I,parsedUrl:C,isDraftMode:P,prerenderManifest:A,routerServerContext:x,isOnDemandRevalidate:H,revalidateOnlyGenerated:b,resolvedPathname:$,clientReferenceManifest:D,serverActionsManifest:T}=v,U=(0,l.normalizeAppPath)(f),N=!!(A.dynamicRoutes[U]||A.routes[$]),M=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,C,!1):t.end("This page could not be found"),null);if(N&&!P){let e=!!A.routes[$],t=A.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await M();throw new E.NoFallbackError}}let O=null;!N||_.isDev||P||(O="/index"===(O=$)?"/":O);let q=!0===_.isDev||!N,K=N&&!q;T&&D&&(0,i.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:D,serverActionsManifest:T,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:T})});let k=e.method||"GET",L=(0,o.getTracer)(),F=L.getActiveScopeSpan(),B={params:S,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>_.onRequestError(e,t,a,x)},sharedContext:{buildId:w}},W=new d.NodeNextRequest(e),j=new d.NodeNextResponse(t),V=c.NextRequestAdapter.fromNodeNextRequest(W,(0,c.signalFromNodeResponse)(t));try{let i=async e=>_.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${k} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${f}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&H&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!N)return await (0,h.sendResponse)(W,j,o,B.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:K,isOnDemandRevalidate:H})},x),t}},c=await _.handleResponse({req:e,nextConfig:I,cacheKey:O,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:H,revalidateOnlyGenerated:b,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!N)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",H?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&N||u.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,y.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(W,j,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};F?await l(F):await L.withPropagatedContext(e.headers,()=>L.trace(u.BaseServerSpan.handleRequest,{spanName:`${k} ${f}`,kind:o.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof E.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:K,isOnDemandRevalidate:H})}),N)throw t;return await (0,h.sendResponse)(W,j,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>T,"routeModule",()=>_,"serverHooks",()=>D,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>$],328448)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_c25c7581.js.map