{"version":3,"sources":["turbopack:///[project]/src/middleware/auth.ts","turbopack:///[project]/src/app/api/user/dairy/send-delete-otp/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyToken, JWTPayload } from '@/lib/auth';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// Types for authentication middleware\r\n\r\nexport interface AuthenticatedRequest extends NextRequest {\r\n  user?: JWTPayload;\r\n}\r\n\r\n// Authentication middleware\r\nexport const authenticateToken = (req: NextRequest): { \r\n  success: boolean; \r\n  user?: JWTPayload; \r\n  error?: string \r\n} => {\r\n  try {\r\n    const authHeader = req.headers.get('authorization');\r\n    const token = authHeader?.split(' ')[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return { success: false, error: 'Access token required' };\r\n    }\r\n\r\n    const decoded = verifyToken(token);\r\n    if (!decoded) {\r\n      return { success: false, error: 'Invalid or expired token' };\r\n    }\r\n\r\n    return { success: true, user: decoded };\r\n  } catch {\r\n    return { success: false, error: 'Authentication failed' };\r\n  }\r\n};\r\n\r\n// Role-based authorization middleware\r\nexport const authorizeRole = (requiredRoles: UserRole[]) => {\r\n  return (user: JWTPayload): { success: boolean; error?: string } => {\r\n    if (!user) {\r\n      return { success: false, error: 'User not authenticated' };\r\n    }\r\n\r\n    if (!requiredRoles.includes(user.role as UserRole)) {\r\n      return { success: false, error: 'Insufficient permissions' };\r\n    }\r\n\r\n    return { success: true };\r\n  };\r\n};\r\n\r\n// Super Admin authorization\r\nexport const requireSuperAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  if (user.role !== UserRole.SUPER_ADMIN && user.email !== (process.env.SUPER_ADMIN_USERNAME || 'admin')) {\r\n    return { success: false, error: 'Super Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Admin or higher authorization\r\nexport const requireAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  const adminRoles = [UserRole.SUPER_ADMIN, UserRole.ADMIN];\r\n  if (!adminRoles.includes(user.role as UserRole)) {\r\n    return { success: false, error: 'Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Hierarchy-based authorization\r\nexport const requireHierarchyAccess = (targetUserId: number, currentUser: JWTPayload): {\r\n  success: boolean; \r\n  error?: string \r\n} => {\r\n  // Super admin can access everything\r\n  if (currentUser.role === UserRole.SUPER_ADMIN) {\r\n    return { success: true };\r\n  }\r\n\r\n  // Admin can access users in their schema\r\n  if (currentUser.role === UserRole.ADMIN && currentUser.dbKey) {\r\n    // Additional logic would be needed to check if targetUser belongs to admin's schema\r\n    return { success: true };\r\n  }\r\n\r\n  // For other roles, implement specific hierarchy checks\r\n  // This would require database queries to verify parent-child relationships\r\n  \r\n  return { success: false, error: 'Access denied' };\r\n};\r\n\r\n// Response helpers\r\nexport const createErrorResponse = (message: string, status: number = 400) => {\r\n  return NextResponse.json(\r\n    { \r\n      success: false, \r\n      error: { message, code: status.toString() },\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\nexport const createSuccessResponse = (data: unknown, message: string = 'Success', status: number = 200) => {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      message,\r\n      data,\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\n// Validation helper\r\nexport const validateRequiredFields = (\r\n  body: Record<string, unknown>, \r\n  requiredFields: string[]\r\n): { success: boolean; missing?: string[] } => {\r\n  const missing = requiredFields.filter(field => \r\n    !body[field] || (typeof body[field] === 'string' && body[field].trim() === '')\r\n  );\r\n\r\n  if (missing.length > 0) {\r\n    return { success: false, missing };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Rate limiting (basic implementation)\r\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>();\r\n\r\nexport const checkRateLimit = (\r\n  identifier: string, \r\n  maxRequests: number = 100, \r\n  windowMs: number = 15 * 60 * 1000 // 15 minutes\r\n): { success: boolean; resetTime?: number } => {\r\n  const now = Date.now();\r\n  const record = rateLimitMap.get(identifier);\r\n\r\n  if (!record || now > record.resetTime) {\r\n    // Reset or create new record\r\n    rateLimitMap.set(identifier, { count: 1, resetTime: now + windowMs });\r\n    return { success: true };\r\n  }\r\n\r\n  if (record.count >= maxRequests) {\r\n    return { success: false, resetTime: record.resetTime };\r\n  }\r\n\r\n  record.count++;\r\n  return { success: true };\r\n};\r\n\r\n// CORS headers\r\nexport const setCorsHeaders = (response: NextResponse) => {\r\n  response.headers.set('Access-Control-Allow-Origin', process.env.CLIENT_URL || '*');\r\n  response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n  response.headers.set('Access-Control-Allow-Credentials', 'true');\r\n  return response;\r\n};\r\n\r\nconst middleware = {\r\n  authenticateToken,\r\n  authorizeRole,\r\n  requireSuperAdmin,\r\n  requireAdmin,\r\n  requireHierarchyAccess,\r\n  createErrorResponse,\r\n  createSuccessResponse,\r\n  validateRequiredFields,\r\n  checkRateLimit,\r\n  setCorsHeaders\r\n};\r\n\r\nexport default middleware;","import { NextRequest } from 'next/server';\r\nimport { verifyToken } from '@/lib/auth';\r\nimport { createErrorResponse, createSuccessResponse } from '@/middleware/auth';\r\nimport { connectDB } from '@/lib/database';\r\nimport { generateOTP } from '@/lib/emailService';\r\nimport nodemailer from 'nodemailer';\r\n\r\n// In-memory store for OTPs (you could also use Redis or database)\r\nconst otpStore = new Map<string, { otp: string; expires: Date; dairyId: number }>();\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return createErrorResponse('Authentication required', 401);\r\n    }\r\n\r\n    const payload = verifyToken(token);\r\n    if (!payload || payload.role !== 'admin') {\r\n      return createErrorResponse('Admin access required', 403);\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { dairyId } = body;\r\n\r\n    if (!dairyId) {\r\n      return createErrorResponse('Dairy ID is required', 400);\r\n    }\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { User } = getModels();\r\n\r\n    // Get admin details\r\n    const admin = await User.findByPk(payload.id);\r\n    if (!admin || !admin.email) {\r\n      return createErrorResponse('Admin email not found', 404);\r\n    }\r\n\r\n    // Generate OTP\r\n    const otp = generateOTP();\r\n    const expires = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes\r\n\r\n    // Store OTP in memory\r\n    const otpKey = `${admin.id}_${dairyId}`;\r\n    otpStore.set(otpKey, { otp, expires, dairyId });\r\n\r\n    // Clean up expired OTPs\r\n    for (const [key, value] of otpStore.entries()) {\r\n      if (value.expires < new Date()) {\r\n        otpStore.delete(key);\r\n      }\r\n    }\r\n\r\n    // Send OTP email\r\n    try {\r\n      const emailConfig = {\r\n        host: process.env.SMTP_HOST || process.env.EMAIL_HOST || 'smtp.gmail.com',\r\n        port: parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || '587'),\r\n        secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true',\r\n        auth: {\r\n          user: process.env.SMTP_USERNAME || process.env.EMAIL_USER,\r\n          pass: process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD,\r\n        },\r\n      };\r\n\r\n      const transporter = nodemailer.createTransport(emailConfig);\r\n\r\n      const mailOptions = {\r\n        from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n        to: admin.email,\r\n        subject: '‚ö†Ô∏è CRITICAL: Dairy Deletion Confirmation Required',\r\n      html: `\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <meta charset=\"UTF-8\">\r\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n          <style>\r\n            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; }\r\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n            .header { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 30px; border-radius: 10px 10px 0 0; text-align: center; }\r\n            .content { background: #f9fafb; padding: 30px; border: 2px solid #fee2e2; }\r\n            .otp-box { background: white; border: 3px dashed #dc2626; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center; }\r\n            .otp { font-size: 36px; font-weight: bold; color: #dc2626; letter-spacing: 8px; font-family: 'Courier New', monospace; }\r\n            .warning { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 20px 0; border-radius: 5px; }\r\n            .footer { background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; font-size: 12px; border-radius: 0 0 10px 10px; }\r\n            .icon { font-size: 48px; margin-bottom: 10px; }\r\n          </style>\r\n        </head>\r\n        <body>\r\n          <div class=\"container\">\r\n            <div class=\"header\">\r\n              <div class=\"icon\">üö®</div>\r\n              <h1 style=\"margin: 0; font-size: 24px;\">CRITICAL DELETION REQUEST</h1>\r\n              <p style=\"margin: 10px 0 0 0; opacity: 0.95;\">Dairy Farm & All Related Data</p>\r\n            </div>\r\n            \r\n            <div class=\"content\">\r\n              <p style=\"margin-top: 0; font-size: 16px;\">Hello <strong>${admin.fullName}</strong>,</p>\r\n              \r\n              <div class=\"warning\">\r\n                <strong style=\"color: #dc2626; font-size: 18px;\">‚ö†Ô∏è THIS ACTION CANNOT BE UNDONE!</strong>\r\n                <p style=\"margin: 10px 0 0 0;\">You are about to permanently delete a dairy farm and ALL associated data from your system.</p>\r\n              </div>\r\n\r\n              <p style=\"font-weight: 600; margin-bottom: 10px;\">The following data will be permanently deleted:</p>\r\n              <ul style=\"color: #666; font-size: 14px; margin: 10px 0;\">\r\n                <li>All BMCs under this dairy</li>\r\n                <li>All societies under these BMCs</li>\r\n                <li>All farmers</li>\r\n                <li>All machines</li>\r\n                <li>All machine statistics</li>\r\n                <li>All machine corrections (admin & device saved)</li>\r\n                <li>All rate charts and rate chart data</li>\r\n                <li>All milk collections</li>\r\n                <li>All sales records</li>\r\n                <li>All dispatch records</li>\r\n                <li>All section pulse tracking data</li>\r\n              </ul>\r\n\r\n              <p style=\"font-weight: 600; margin-top: 25px;\">Your One-Time Verification Code:</p>\r\n              \r\n              <div class=\"otp-box\">\r\n                <p style=\"margin: 0; font-size: 14px; color: #666;\">OTP Code</p>\r\n                <div class=\"otp\">${otp}</div>\r\n                <p style=\"margin: 10px 0 0 0; font-size: 12px; color: #999;\">Valid for 10 minutes only</p>\r\n              </div>\r\n\r\n              <div style=\"background: #fee2e2; border-radius: 8px; padding: 15px; margin-top: 20px;\">\r\n                <p style=\"margin: 0; font-size: 13px; color: #991b1b;\">\r\n                  <strong>Security Notice:</strong> If you did not request this deletion, please ignore this email and contact your system administrator immediately.\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            <div class=\"footer\">\r\n              <p style=\"margin: 0;\">Poornasree Equipments Cloud</p>\r\n              <p style=\"margin: 5px 0;\">This is an automated security message. Please do not reply to this email.</p>\r\n            </div>\r\n          </div>\r\n        </body>\r\n        </html>\r\n      `\r\n    };\r\n\r\n      await transporter.sendMail(mailOptions);\r\n      console.log(`‚úÖ Delete confirmation OTP sent to ${admin.email} for dairy ${dairyId}`);\r\n    } catch (emailError) {\r\n      console.error('Failed to send OTP email:', emailError);\r\n      return createErrorResponse('Failed to send OTP email', 500);\r\n    }\r\n\r\n    return createSuccessResponse(\r\n      { expiresIn: 600 }, // 10 minutes\r\n      'OTP sent to your email address'\r\n    );\r\n\r\n  } catch (error: unknown) {\r\n    console.error('Error sending delete OTP:', error);\r\n    return createErrorResponse('Failed to send OTP', 500);\r\n  }\r\n}\r\n\r\n// Export verification function for use in DELETE endpoint\r\nexport function verifyDeleteOTP(adminId: number, dairyId: number, otp: string): boolean {\r\n  const otpKey = `${adminId}_${dairyId}`;\r\n  const stored = otpStore.get(otpKey);\r\n\r\n  if (!stored) {\r\n    return false;\r\n  }\r\n\r\n  if (stored.expires < new Date()) {\r\n    otpStore.delete(otpKey);\r\n    return false;\r\n  }\r\n\r\n  if (stored.otp !== otp || stored.dairyId !== dairyId) {\r\n    return false;\r\n  }\r\n\r\n  // OTP is valid, delete it (one-time use)\r\n  otpStore.delete(otpKey);\r\n  return true;\r\n}\r\n"],"names":[],"mappings":"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"}