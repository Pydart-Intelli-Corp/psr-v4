module.exports=[796963,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),n=e.i(759756),i=e.i(561916),o=e.i(114444),s=e.i(837092),l=e.i(869741),c=e.i(316795),d=e.i(487718),p=e.i(995169),u=e.i(47587),h=e.i(666012),g=e.i(570101),R=e.i(626937),E=e.i(10372),f=e.i(193695);e.i(52474);var m=e.i(600220),v=e.i(84168);e.i(512982);var y=e.i(375448),S=e.i(871366);async function I(t,{params:a}){try{let r=await y.ESP32ResponseHelper.extractInputString(t),n=await a,i=n["db-key"]||n.dbKey||n.dbkey;if(r&&(r=y.ESP32ResponseHelper.filterLineEndings(r)),console.log(`
${"=".repeat(80)}`),console.log(`ðŸ“¡ SaveDispatchDetails API Request:`),console.log(`   Timestamp: ${new Date().toISOString()}`),y.ESP32ResponseHelper.logRequest(t,i,r),!i||""===i.trim())return console.log(`âŒ DB Key validation failed - dbKey: "${i}"`),y.ESP32ResponseHelper.createErrorResponse("DB Key is required");if(!r)return console.log(`âŒ InputString is required`),y.ESP32ResponseHelper.createErrorResponse("InputString parameter is required");await (0,v.connectDB)();let{getModels:o}=await e.A(121985),{sequelize:s,User:l}=o(),c=S.InputValidator.validateDbKey(i);if(!c.isValid)return y.ESP32ResponseHelper.createErrorResponse(c.error||"Invalid DB Key");let d=await l.findOne({where:{dbKey:i.toUpperCase()}});if(!d||!d.dbKey)return console.log(`âŒ Admin not found or missing DB Key for: ${i}`),y.ESP32ResponseHelper.createErrorResponse("Invalid DB Key");let p=r.split("|");if(15!==p.length)return console.log(`âŒ Invalid InputString format. Expected 15 parts, got ${p.length}`),console.log("   Parts received:",p),y.ESP32ResponseHelper.createErrorResponse("Invalid InputString format");let[u,h,g,R,E,f,m,I,_,A,D,w,C,P,$]=p;console.log(`ðŸ” Parsed InputString:`,{societyIdStr:u,machineType:h,version:g,machineId:R,shift:E,extra:m,channel:I,dispatchIdStr:f,datetime:$});let b=(e,t)=>{if(!e||!e.startsWith(t))return 0;let a=e.substring(t.length);return parseFloat(a)||0},T={societyId:u,machineType:h,version:g,machineId:R,shift:E,extra:m,channel:I,fat:b(_,"F"),snf:b(A,"S"),clr:b(D,"C"),dispatchId:(f?.substring(1)||"").replace(/^0+/,"")||"0",quantity:b(w,"Q"),totalAmount:b(C,"R"),rate:b(P,"r"),datetime:$.substring(1)};console.log(`ðŸ” Parsed dispatch data:`,T);let O=S.InputValidator.validateSocietyId(T.societyId);if(!O.isValid)return y.ESP32ResponseHelper.createErrorResponse("Invalid society ID");let H=S.InputValidator.validateMachineId(T.machineId);if(!H.isValid)return y.ESP32ResponseHelper.createErrorResponse("Invalid machine ID");let N=d.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),x=`${N}_${d.dbKey.toLowerCase()}`;console.log(`ðŸ” Using schema: ${x}`);let U=`
      SELECT id FROM \`${x}\`.societies 
      WHERE society_id = ? OR society_id = ?
      LIMIT 1
    `,q=O.id.startsWith("S-")?[O.id,O.fallback]:[`S-${O.id}`,O.id],[L]=await s.query(U,{replacements:q});if(!Array.isArray(L)||0===L.length)return console.log(`âŒ Society not found: "${O.id}"`),y.ESP32ResponseHelper.createErrorResponse("Society not found");let M=L[0].id;console.log(`âœ… Found society: "${O.id}" -> database ID: ${M}`);let k=(H.variants||[]).map(e=>String(e));if(0===k.length){let e=H.alphanumericId||H.numericId?.toString()||"";k.push(e)}let K=k.map(()=>"?").join(", "),V=`
      SELECT id, machine_id 
      FROM \`${x}\`.machines 
      WHERE society_id = ? AND machine_id IN (${K})
      LIMIT 1
    `,[F]=await s.query(V,{replacements:[M,...k]});if(!Array.isArray(F)||0===F.length)return console.log(`âŒ Machine not found: "${T.machineId}"`),y.ESP32ResponseHelper.createErrorResponse("Machine not found");let B=F[0];console.log(`âœ… Found machine: "${T.machineId}" -> database ID: ${B.id}`),console.log(`â„¹ï¸  Dispatch ID from input: "${T.dispatchId}"`);let W=T.datetime.split("_"),j=W[0]||"",G=W[1]?.replace(/-/g,":")||"00:00:00",Q="MR"===T.shift.toUpperCase()?"morning":"EV"===T.shift.toUpperCase()?"evening":"morning",X=`
      INSERT INTO \`${x}\`.milk_dispatches (
        dispatch_id,
        society_id,
        machine_id,
        dispatch_date,
        dispatch_time,
        shift_type,
        channel,
        fat_percentage,
        snf_percentage,
        clr_value,
        quantity,
        rate_per_liter,
        total_amount,
        machine_type,
        machine_version,
        created_at,
        updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
      ON DUPLICATE KEY UPDATE
        channel = VALUES(channel),
        fat_percentage = VALUES(fat_percentage),
        snf_percentage = VALUES(snf_percentage),
        clr_value = VALUES(clr_value),
        quantity = VALUES(quantity),
        rate_per_liter = VALUES(rate_per_liter),
        total_amount = VALUES(total_amount),
        machine_type = VALUES(machine_type),
        machine_version = VALUES(machine_version),
        updated_at = NOW()
    `,z=[T.dispatchId,M,B.id,j,G,Q,T.channel,T.fat,T.snf,T.clr,T.quantity,T.rate,T.totalAmount,T.machineType,T.version];return console.log(`ðŸ’¾ Saving dispatch record (will insert or update if duplicate)...`),console.log(`   Dispatch ID: ${T.dispatchId}`),console.log(`   Date: ${j}`),console.log(`   Time: ${G}`),console.log(`   Shift: ${Q}`),console.log(`   Channel: ${T.channel}`),console.log(`   Fat: ${T.fat}%, SNF: ${T.snf}%, CLR: ${T.clr}`),console.log(`   Quantity: ${T.quantity}L, Rate: ${T.rate}, Total: ${T.totalAmount}`),await s.query(X,{replacements:z}),console.log(`âœ… Dispatch details saved successfully`),console.log(`${"=".repeat(80)}
`),y.ESP32ResponseHelper.createResponse("Dispatch details saved successfully.",{addQuotes:!0})}catch(e){return console.error(`âŒ Error in SaveDispatchDetails API:`,e),console.log(`${"=".repeat(80)}
`),y.ESP32ResponseHelper.createErrorResponse("Failed to save dispatch details")}}async function _(){return y.ESP32ResponseHelper.createCORSResponse()}e.s(["GET",0,I,"OPTIONS",()=>_,"POST",0,I],195384);var A=e.i(195384);let D=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/[db-key]/Dispatch/SaveDispatchDetails/route",pathname:"/api/[db-key]/Dispatch/SaveDispatchDetails",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/[db-key]/Dispatch/SaveDispatchDetails/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:w,workUnitAsyncStorage:C,serverHooks:P}=D;function $(){return(0,r.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:C})}async function b(e,t,r){D.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/[db-key]/Dispatch/SaveDispatchDetails/route";v=v.replace(/\/index$/,"")||"/";let y=await D.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:S,params:I,nextConfig:_,parsedUrl:A,isDraftMode:w,prerenderManifest:C,routerServerContext:P,isOnDemandRevalidate:$,revalidateOnlyGenerated:b,resolvedPathname:T,clientReferenceManifest:O,serverActionsManifest:H}=y,N=(0,l.normalizeAppPath)(v),x=!!(C.dynamicRoutes[N]||C.routes[T]),U=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,A,!1):t.end("This page could not be found"),null);if(x&&!w){let e=!!C.routes[T],t=C.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(_.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let q=null;!x||D.isDev||w||(q="/index"===(q=T)?"/":q);let L=!0===D.isDev||!x,M=x&&!L;H&&O&&(0,o.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:O,serverActionsManifest:H,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:H})});let k=e.method||"GET",K=(0,i.getTracer)(),V=K.getActiveScopeSpan(),F={params:I,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!_.experimental.authInterrupts},cacheComponents:!!_.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:_.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>D.onRequestError(e,t,r,P)},sharedContext:{buildId:S}},B=new c.NodeNextRequest(e),W=new c.NodeNextResponse(t),j=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let o=async e=>D.handle(j,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=K.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${v}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let c=async({previousCacheEntry:a})=>{try{if(!s&&$&&b&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!x)return await (0,h.sendResponse)(B,W,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[E.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:$})},P),t}},d=await D.handleResponse({req:e,nextConfig:_,cacheKey:q,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:$,revalidateOnlyGenerated:b,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:s});if(!x)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",$?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&x||p.delete(E.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,R.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(B,W,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};V?await l(V):await K.withPropagatedContext(e.headers,()=>K.trace(p.BaseServerSpan.handleRequest,{spanName:`${k} ${v}`,kind:i.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:$})}),x)throw t;return await (0,h.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>$,"routeModule",()=>D,"serverHooks",()=>P,"workAsyncStorage",()=>w,"workUnitAsyncStorage",()=>C],796963)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_a0320aac.js.map