module.exports=[48798,e=>{"use strict";var t=e.i(89171);function r(e,a,n=200){return t.NextResponse.json({success:!0,message:e,data:a},{status:n})}function a(e,r=400,n){return t.NextResponse.json({success:!1,message:"Error occurred",error:e,data:n},{status:r})}e.s(["createErrorResponse",()=>a,"createSuccessResponse",()=>r])},387609,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),i=e.i(561916),s=e.i(114444),o=e.i(837092),c=e.i(869741),l=e.i(316795),d=e.i(487718),u=e.i(995169),h=e.i(47587),p=e.i(666012),R=e.i(570101),E=e.i(626937),m=e.i(10372),f=e.i(193695);e.i(52474);var _=e.i(600220),y=e.i(79832),v=e.i(84168),A=e.i(48798);async function C(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,A.createErrorResponse)("Authentication required",401);let a=(0,y.verifyToken)(r);if(!a||"admin"!==a.role)return(0,A.createErrorResponse)("Admin access required",403);let{searchParams:n}=new URL(t.url),i=n.get("chartId"),s=n.get("fileName"),o=n.get("channel"),c=n.get("societyId");await (0,v.connectDB)();let{getModels:l}=await e.A(121985),{sequelize:d,User:u}=l(),h=await u.findByPk(a.id);if(!h||!h.dbKey)return(0,A.createErrorResponse)("Admin schema not found",404);let p=h.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),R=`${p}_${h.dbKey.toLowerCase()}`;if(i){let e=parseInt(i);if(isNaN(e))return(0,A.createErrorResponse)("Invalid chart ID",400);let t=`
        SELECT rc.id, rc.society_id, rc.channel, rc.shared_chart_id
        FROM \`${R}\`.rate_charts rc
        WHERE rc.id = ?
        LIMIT 1
      `,[r]=await d.query(t,{replacements:[e]});if(!Array.isArray(r)||0===r.length)return(0,A.createErrorResponse)("Rate chart not found",404);let a=r[0],n=[a.id];if(a.shared_chart_id){let e=`
          SELECT id FROM \`${R}\`.rate_charts
          WHERE shared_chart_id = ? OR id = ?
        `,[t]=await d.query(e,{replacements:[a.shared_chart_id,a.shared_chart_id]});n=t.map(e=>e.id)}else{let e=`
          SELECT id FROM \`${R}\`.rate_charts
          WHERE shared_chart_id = ?
        `,[t]=await d.query(e,{replacements:[a.id]});n=[a.id,...t.map(e=>e.id)]}let s=`
        SELECT DISTINCT society_id FROM \`${R}\`.rate_charts
        WHERE id IN (${n.join(",")})
      `,[o]=await d.query(s),c=o.map(e=>e.society_id),l=`
        SELECT DISTINCT
          m.id,
          m.machine_id as machineId,
          m.society_id as societyId,
          m.machine_type as machineType,
          m.location,
          s.name as societyName,
          s.society_id as societyIdentifier
        FROM \`${R}\`.machines m
        INNER JOIN \`${R}\`.societies s ON m.society_id = s.id
        INNER JOIN \`${R}\`.rate_chart_download_history rcdh 
          ON m.id = rcdh.machine_id 
          AND rcdh.rate_chart_id IN (${n.join(",")})
          AND rcdh.channel = ?
        WHERE m.society_id IN (${c.join(",")}) AND m.status = 1
        ORDER BY m.machine_id ASC
      `,[u]=await d.query(l,{replacements:[a.channel]});return console.log(`✅ Retrieved ${Array.isArray(u)?u.length:0} machines that downloaded chart ID ${e}`),(0,A.createSuccessResponse)("Machines retrieved successfully",{machines:u})}if(!s||!o||!c)return(0,A.createErrorResponse)("Either chartId OR (fileName, channel, societyId) are required",400);let E=`
      SELECT rc.id, rc.file_name, rc.channel
      FROM \`${R}\`.rate_charts rc
      WHERE rc.file_name = ? 
        AND rc.channel = ? 
        AND rc.society_id = ?
        AND rc.status = 1
      LIMIT 1
    `,[m]=await d.query(E,{replacements:[s,o,c]});if(!Array.isArray(m)||0===m.length)return(0,A.createErrorResponse)("Rate chart not found",404);let f=m[0],_=`
      SELECT fat, snf, clr, rate
      FROM \`${R}\`.rate_chart_data
      WHERE rate_chart_id = ?
      ORDER BY CAST(fat AS DECIMAL(5,2)) ASC, CAST(snf AS DECIMAL(5,2)) ASC
    `,[C]=await d.query(_,{replacements:[f.id]});return console.log(`✅ Retrieved ${Array.isArray(C)?C.length:0} rate chart records for ${s} (${o})`),(0,A.createSuccessResponse)("Rate chart data retrieved successfully",C)}catch(e){return console.error("Error fetching rate chart data:",e),(0,A.createErrorResponse)("Failed to fetch rate chart data",500)}}e.s(["GET",()=>C],139319);var g=e.i(139319);let w=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/user/ratechart/data/route",pathname:"/api/user/ratechart/data",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/ratechart/data/route.ts",nextConfigOutput:"",userland:g}),{workAsyncStorage:N,workUnitAsyncStorage:I,serverHooks:T}=w;function S(){return(0,a.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:I})}async function O(e,t,a){w.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/user/ratechart/data/route";y=y.replace(/\/index$/,"")||"/";let v=await w.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:A,params:C,nextConfig:g,parsedUrl:N,isDraftMode:I,prerenderManifest:T,routerServerContext:S,isOnDemandRevalidate:O,revalidateOnlyGenerated:x,resolvedPathname:D,clientReferenceManifest:M,serverActionsManifest:$}=v,P=(0,c.normalizeAppPath)(y),q=!!(T.dynamicRoutes[P]||T.routes[D]),H=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,N,!1):t.end("This page could not be found"),null);if(q&&!I){let e=!!T.routes[D],t=T.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await H();throw new f.NoFallbackError}}let b=null;!q||w.isDev||I||(b="/index"===(b=D)?"/":b);let L=!0===w.isDev||!q,k=q&&!L;$&&M&&(0,s.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:M,serverActionsManifest:$,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:$})});let U=e.method||"GET",F=(0,i.getTracer)(),j=F.getActiveScopeSpan(),B={params:C,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>w.onRequestError(e,t,a,S)},sharedContext:{buildId:A}},K=new l.NodeNextRequest(e),W=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let s=async e=>w.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${y}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var i,c;let l=async({previousCacheEntry:r})=>{try{if(!o&&O&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let c=B.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let l=B.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(K,W,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:_.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:O})},S),t}},d=await w.handleResponse({req:e,nextConfig:g,cacheKey:b,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:x,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:o});if(!q)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==_.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,R.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&q||u.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,E.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,W,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};j?await c(j):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${y}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},c))}catch(t){if(t instanceof f.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:O})}),q)throw t;return await (0,p.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>S,"routeModule",()=>w,"serverHooks",()=>T,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>I],387609)},453753,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__86f7d54e._.js"].map(t=>e.l(t))).then(()=>t(736987)))},121985,e=>{e.v(t=>Promise.all(["server/chunks/src_models_index_ts_328304ec._.js"].map(t=>e.l(t))).then(()=>t(540590)))}];

//# sourceMappingURL=_e3a21c0e._.js.map