{"version":3,"sources":["turbopack:///[project]/src/middleware/auth.ts","turbopack:///[project]/src/app/api/user/bmc/send-delete-otp/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyToken, JWTPayload } from '@/lib/auth';\r\nimport { UserRole } from '@/models/User';\r\n\r\n// Types for authentication middleware\r\n\r\nexport interface AuthenticatedRequest extends NextRequest {\r\n  user?: JWTPayload;\r\n}\r\n\r\n// Authentication middleware\r\nexport const authenticateToken = (req: NextRequest): { \r\n  success: boolean; \r\n  user?: JWTPayload; \r\n  error?: string \r\n} => {\r\n  try {\r\n    const authHeader = req.headers.get('authorization');\r\n    const token = authHeader?.split(' ')[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return { success: false, error: 'Access token required' };\r\n    }\r\n\r\n    const decoded = verifyToken(token);\r\n    if (!decoded) {\r\n      return { success: false, error: 'Invalid or expired token' };\r\n    }\r\n\r\n    return { success: true, user: decoded };\r\n  } catch {\r\n    return { success: false, error: 'Authentication failed' };\r\n  }\r\n};\r\n\r\n// Role-based authorization middleware\r\nexport const authorizeRole = (requiredRoles: UserRole[]) => {\r\n  return (user: JWTPayload): { success: boolean; error?: string } => {\r\n    if (!user) {\r\n      return { success: false, error: 'User not authenticated' };\r\n    }\r\n\r\n    if (!requiredRoles.includes(user.role as UserRole)) {\r\n      return { success: false, error: 'Insufficient permissions' };\r\n    }\r\n\r\n    return { success: true };\r\n  };\r\n};\r\n\r\n// Super Admin authorization\r\nexport const requireSuperAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  if (user.role !== UserRole.SUPER_ADMIN && user.email !== (process.env.SUPER_ADMIN_USERNAME || 'admin')) {\r\n    return { success: false, error: 'Super Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Admin or higher authorization\r\nexport const requireAdmin = (user: JWTPayload): { success: boolean; error?: string } => {\r\n  if (!user) {\r\n    return { success: false, error: 'User not authenticated' };\r\n  }\r\n\r\n  const adminRoles = [UserRole.SUPER_ADMIN, UserRole.ADMIN];\r\n  if (!adminRoles.includes(user.role as UserRole)) {\r\n    return { success: false, error: 'Admin access required' };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Hierarchy-based authorization\r\nexport const requireHierarchyAccess = (targetUserId: number, currentUser: JWTPayload): {\r\n  success: boolean; \r\n  error?: string \r\n} => {\r\n  // Super admin can access everything\r\n  if (currentUser.role === UserRole.SUPER_ADMIN) {\r\n    return { success: true };\r\n  }\r\n\r\n  // Admin can access users in their schema\r\n  if (currentUser.role === UserRole.ADMIN && currentUser.dbKey) {\r\n    // Additional logic would be needed to check if targetUser belongs to admin's schema\r\n    return { success: true };\r\n  }\r\n\r\n  // For other roles, implement specific hierarchy checks\r\n  // This would require database queries to verify parent-child relationships\r\n  \r\n  return { success: false, error: 'Access denied' };\r\n};\r\n\r\n// Response helpers\r\nexport const createErrorResponse = (message: string, status: number = 400) => {\r\n  return NextResponse.json(\r\n    { \r\n      success: false, \r\n      error: { message, code: status.toString() },\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\nexport const createSuccessResponse = (data: unknown, message: string = 'Success', status: number = 200) => {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      message,\r\n      data,\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    { status }\r\n  );\r\n};\r\n\r\n// Validation helper\r\nexport const validateRequiredFields = (\r\n  body: Record<string, unknown>, \r\n  requiredFields: string[]\r\n): { success: boolean; missing?: string[] } => {\r\n  const missing = requiredFields.filter(field => \r\n    !body[field] || (typeof body[field] === 'string' && body[field].trim() === '')\r\n  );\r\n\r\n  if (missing.length > 0) {\r\n    return { success: false, missing };\r\n  }\r\n\r\n  return { success: true };\r\n};\r\n\r\n// Rate limiting (basic implementation)\r\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>();\r\n\r\nexport const checkRateLimit = (\r\n  identifier: string, \r\n  maxRequests: number = 100, \r\n  windowMs: number = 15 * 60 * 1000 // 15 minutes\r\n): { success: boolean; resetTime?: number } => {\r\n  const now = Date.now();\r\n  const record = rateLimitMap.get(identifier);\r\n\r\n  if (!record || now > record.resetTime) {\r\n    // Reset or create new record\r\n    rateLimitMap.set(identifier, { count: 1, resetTime: now + windowMs });\r\n    return { success: true };\r\n  }\r\n\r\n  if (record.count >= maxRequests) {\r\n    return { success: false, resetTime: record.resetTime };\r\n  }\r\n\r\n  record.count++;\r\n  return { success: true };\r\n};\r\n\r\n// CORS headers\r\nexport const setCorsHeaders = (response: NextResponse) => {\r\n  response.headers.set('Access-Control-Allow-Origin', process.env.CLIENT_URL || '*');\r\n  response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n  response.headers.set('Access-Control-Allow-Credentials', 'true');\r\n  return response;\r\n};\r\n\r\nconst middleware = {\r\n  authenticateToken,\r\n  authorizeRole,\r\n  requireSuperAdmin,\r\n  requireAdmin,\r\n  requireHierarchyAccess,\r\n  createErrorResponse,\r\n  createSuccessResponse,\r\n  validateRequiredFields,\r\n  checkRateLimit,\r\n  setCorsHeaders\r\n};\r\n\r\nexport default middleware;","import { NextRequest } from 'next/server';\r\nimport { verifyToken } from '@/lib/auth';\r\nimport { createErrorResponse, createSuccessResponse } from '@/middleware/auth';\r\nimport { connectDB } from '@/lib/database';\r\nimport { generateOTP } from '@/lib/emailService';\r\nimport nodemailer from 'nodemailer';\r\n\r\n// In-memory store for OTPs (you could also use Redis or database)\r\nconst otpStore = new Map<string, { otp: string; expires: Date; bmcId: number }>();\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return createErrorResponse('Authentication required', 401);\r\n    }\r\n\r\n    const payload = verifyToken(token);\r\n    if (!payload || payload.role !== 'admin') {\r\n      return createErrorResponse('Admin access required', 403);\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { bmcId, bmcName } = body;\r\n\r\n    if (!bmcId) {\r\n      return createErrorResponse('BMC ID is required', 400);\r\n    }\r\n\r\n    await connectDB();\r\n    const { getModels } = await import('@/models');\r\n    const { User } = getModels();\r\n\r\n    // Get admin details\r\n    const admin = await User.findByPk(payload.id);\r\n    if (!admin) {\r\n      return createErrorResponse('Admin not found', 404);\r\n    }\r\n\r\n    // Generate OTP\r\n    const otp = generateOTP();\r\n    const expires = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes\r\n\r\n    // Store OTP in memory\r\n    const otpKey = `${admin.id}_${bmcId}`;\r\n    otpStore.set(otpKey, { otp, expires, bmcId });\r\n\r\n    // Clean up expired OTPs\r\n    for (const [key, value] of otpStore.entries()) {\r\n      if (value.expires < new Date()) {\r\n        otpStore.delete(key);\r\n      }\r\n    }\r\n\r\n    // Send OTP email with custom message for deletion\r\n    try {\r\n      await sendDeleteConfirmationOTP(admin.email, otp, admin.fullName, bmcName);\r\n      console.log(`✅ Delete confirmation OTP sent to ${admin.email} for BMC ${bmcName}`);\r\n    } catch (emailError) {\r\n      console.error('Failed to send OTP email:', emailError);\r\n      return createErrorResponse('Failed to send OTP email', 500);\r\n    }\r\n\r\n    return createSuccessResponse(\r\n      { expiresIn: 600 }, // 10 minutes\r\n      'OTP sent to your email. Please check and verify.'\r\n    );\r\n\r\n  } catch (error: unknown) {\r\n    console.error('Error sending delete OTP:', error);\r\n    return createErrorResponse('Failed to send OTP', 500);\r\n  }\r\n}\r\n\r\n// Custom email function for delete confirmation\r\nasync function sendDeleteConfirmationOTP(\r\n  email: string,\r\n  otp: string,\r\n  name: string,\r\n  bmcName: string\r\n): Promise<void> {\r\n  const emailConfig = {\r\n    host: process.env.SMTP_HOST || process.env.EMAIL_HOST || 'smtp.gmail.com',\r\n    port: parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || '587'),\r\n    secure: (process.env.SMTP_SECURE || process.env.EMAIL_SECURE) === 'true',\r\n    auth: {\r\n      user: process.env.SMTP_USERNAME || process.env.EMAIL_USER,\r\n      pass: process.env.SMTP_PASSWORD || process.env.EMAIL_PASSWORD,\r\n    },\r\n  };\r\n\r\n  const transporter = nodemailer.createTransport(emailConfig);\r\n\r\n  const mailOptions = {\r\n    from: `\"Poornasree Equipments Cloud\" <${process.env.SMTP_USERNAME || process.env.EMAIL_USER}>`,\r\n    to: email,\r\n    subject: '⚠️ CRITICAL: BMC Deletion Confirmation Required',\r\n    html: `\r\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;\">\r\n        <div style=\"background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); padding: 30px; border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;\">\r\n          <h1 style=\"margin: 0; font-size: 28px;\">⚠️ Critical Action Required</h1>\r\n          <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">BMC Deletion Confirmation</p>\r\n        </div>\r\n        \r\n        <div style=\"padding: 20px; background: #fef2f2; border: 2px solid #dc2626; border-radius: 10px;\">\r\n          <h2 style=\"color: #dc2626; margin-top: 0;\">Hello ${name}!</h2>\r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            You have requested to <strong style=\"color: #dc2626;\">permanently delete</strong> the following BMC and all its associated data:\r\n          </p>\r\n          \r\n          <div style=\"background: white; padding: 15px; border-left: 4px solid #dc2626; margin: 20px 0;\">\r\n            <h3 style=\"margin: 0; color: #dc2626;\">${bmcName}</h3>\r\n            <p style=\"margin: 10px 0 0 0; color: #666; font-size: 14px;\">\r\n              This action will delete:\r\n            </p>\r\n            <ul style=\"color: #666; font-size: 14px; margin: 10px 0;\">\r\n              <li>All societies under this BMC</li>\r\n              <li>All farmers</li>\r\n              <li>All machines</li>\r\n              <li>All machine statistics</li>\r\n              <li>All machine corrections (admin & device saved)</li>\r\n              <li>All rate charts and rate chart data</li>\r\n              <li>All milk collections</li>\r\n              <li>All sales records</li>\r\n              <li>All dispatch records</li>\r\n              <li>All section pulse tracking data</li>\r\n            </ul>\r\n            <p style=\"margin: 10px 0 0 0; color: #dc2626; font-weight: bold; font-size: 14px;\">\r\n              ⚠️ THIS ACTION CANNOT BE UNDONE!\r\n            </p>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6;\">\r\n            To confirm this deletion, please enter the following OTP:\r\n          </p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <div style=\"display: inline-block; padding: 15px 30px; background: #dc2626; color: white; font-size: 32px; font-weight: bold; letter-spacing: 5px; border-radius: 8px; box-shadow: 0 4px 6px rgba(220, 38, 38, 0.3);\">\r\n              ${otp}\r\n            </div>\r\n          </div>\r\n          \r\n          <p style=\"color: #666; line-height: 1.6; font-size: 14px;\">\r\n            This OTP is valid for <strong>10 minutes</strong>. If you didn't request this deletion, please ignore this email and contact support immediately.\r\n          </p>\r\n          \r\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #fca5a5; color: #888; font-size: 14px;\">\r\n            <p>Best regards,<br>Poornasree Equipments Cloud Team</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `,\r\n  };\r\n\r\n  await transporter.sendMail(mailOptions);\r\n}\r\n\r\n// Export function to verify OTP (called from delete endpoint)\r\nexport function verifyDeleteOTP(adminId: number, bmcId: number, providedOtp: string): boolean {\r\n  const otpKey = `${adminId}_${bmcId}`;\r\n  const stored = otpStore.get(otpKey);\r\n\r\n  if (!stored) {\r\n    console.log('❌ No OTP found for this deletion request');\r\n    return false;\r\n  }\r\n\r\n  if (stored.expires < new Date()) {\r\n    otpStore.delete(otpKey);\r\n    console.log('❌ OTP expired');\r\n    return false;\r\n  }\r\n\r\n  if (stored.otp !== providedOtp) {\r\n    console.log('❌ Invalid OTP');\r\n    return false;\r\n  }\r\n\r\n  // OTP is valid, delete it so it can't be reused\r\n  otpStore.delete(otpKey);\r\n  console.log('✅ OTP verified successfully');\r\n  return true;\r\n}\r\n"],"names":[],"mappings":"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"}