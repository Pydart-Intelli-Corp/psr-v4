module.exports=[544979,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),n=e.i(759756),o=e.i(561916),l=e.i(114444),i=e.i(837092),s=e.i(869741),c=e.i(316795),d=e.i(487718),u=e.i(995169),p=e.i(47587),m=e.i(666012),f=e.i(570101),g=e.i(626937),E=e.i(10372),h=e.i(193695);e.i(52474);var R=e.i(600220),_=e.i(84168);e.i(512982);var y=e.i(375448),S=e.i(871366),v=e.i(290092);async function I(t,{params:a}){try{let r=await y.ESP32ResponseHelper.extractInputString(t),n=await a,o=n["db-key"]||n.dbKey||n.dbkey;if(r&&(r=y.ESP32ResponseHelper.filterLineEndings(r)),console.log(`
${"=".repeat(80)}`),console.log(`ðŸ“¡ SaveCollectionDetails API Request:`),console.log(`   Timestamp: ${new Date().toISOString()}`),y.ESP32ResponseHelper.logRequest(t,o,r),!o||""===o.trim())return console.log(`âŒ DB Key validation failed - dbKey: "${o}"`),y.ESP32ResponseHelper.createErrorResponse("DB Key is required");if(!r)return console.log(`âŒ InputString is required`),y.ESP32ResponseHelper.createErrorResponse("InputString parameter is required");await (0,_.connectDB)();let{getModels:l}=await e.A(121985),{sequelize:i,User:s}=l(),c=S.InputValidator.validateDbKey(o);if(!c.isValid)return y.ESP32ResponseHelper.createErrorResponse(c.error||"Invalid DB Key");let d=await s.findOne({where:{dbKey:o.toUpperCase()}});if(!d||!d.dbKey)return console.log(`âŒ Admin not found or missing DB Key for: ${o}`),y.ESP32ResponseHelper.createErrorResponse("Invalid DB Key");let u=r.split("|");if(21!==u.length)return console.log(`âŒ Invalid InputString format. Expected 21 parts, got ${u.length}`),console.log("   Parts received:",u),y.ESP32ResponseHelper.createErrorResponse("Invalid InputString format");let[p,m,f,g,E,h,R,I,A,C,w,P,$,b,T,N,O,D,U,L,H]=u;console.log(`ðŸ” Parsed InputString:`,{societyIdStr:p,machineType:m,version:f,machineId:g,session:E,extra:h,channel:R,farmerIdStr:N,datetime:H});let x=(e,t)=>{if(!e||!e.startsWith(t))return 0;let a=e.substring(t.length);return parseFloat(a)||0},q={societyId:p,machineType:m,version:f,machineId:g,session:E,extra:h,channel:R,fat:x(I,"F"),snf:x(A,"S"),clr:x(C,"C"),protein:x(w,"P"),lactose:x(P,"L"),salt:x($,"s"),water:x(b,"W"),temperature:x(T,"T"),farmerId:N.substring(1).replace(/^0+/,"")||"0",quantity:x(O,"Q"),totalAmount:x(D,"R"),rate:x(U,"r"),bonus:x(L,"i"),datetime:H.substring(1)};console.log(`ðŸ” Parsed collection data:`,q);let V=S.InputValidator.validateSocietyId(q.societyId);if(!V.isValid)return y.ESP32ResponseHelper.createErrorResponse("Invalid society ID");let F=S.InputValidator.validateMachineId(q.machineId);if(!F.isValid)return y.ESP32ResponseHelper.createErrorResponse("Invalid machine ID");let M=d.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),k=`${M}_${d.dbKey.toLowerCase()}`;console.log(`ðŸ” Using schema: ${k}`);let K=`
      SELECT id FROM \`${k}\`.societies 
      WHERE society_id = ? OR society_id = ?
      LIMIT 1
    `,B=V.id.startsWith("S-")?[V.id,V.fallback]:[`S-${V.id}`,V.id],[W]=await i.query(K,{replacements:B});if(!Array.isArray(W)||0===W.length)return console.log(`âŒ Society not found: "${V.id}"`),y.ESP32ResponseHelper.createErrorResponse("Society not found");let j=W[0].id;console.log(`âœ… Found society: "${V.id}" -> database ID: ${j}`);let Z=(F.variants||[]).map(e=>String(e));if(0===Z.length){let e=F.alphanumericId||F.numericId?.toString()||"";Z.push(e)}let G=Z.map(()=>"?").join(", "),Q=`
      SELECT id, machine_id 
      FROM \`${k}\`.machines 
      WHERE society_id = ? AND machine_id IN (${G})
      LIMIT 1
    `,[X]=await i.query(Q,{replacements:[j,...Z]});if(!Array.isArray(X)||0===X.length)return console.log(`âŒ Machine not found: "${q.machineId}"`),y.ESP32ResponseHelper.createErrorResponse("Machine not found");let z=X[0];console.log(`âœ… Found machine: "${q.machineId}" -> database ID: ${z.id}`),console.log(`â„¹ï¸  Farmer ID from input: "${q.farmerId}"`);let J=q.datetime.split("_"),Y=J[0]||"",ee=J[1]?.replace(/-/g,":")||"00:00:00",et="EV"===q.session.toUpperCase()?"evening":"morning",ea=q.extra||null,er=`
      INSERT INTO \`${k}\`.milk_collections (
        farmer_id,
        society_id,
        machine_id,
        collection_date,
        collection_time,
        shift_type,
        farmer_name,
        channel,
        fat_percentage,
        snf_percentage,
        clr_value,
        protein_percentage,
        lactose_percentage,
        salt_percentage,
        water_percentage,
        temperature,
        quantity,
        rate_per_liter,
        total_amount,
        bonus,
        machine_type,
        machine_version,
        created_at,
        updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CONVERT_TZ(NOW(), '+00:00', '+05:30'), CONVERT_TZ(NOW(), '+00:00', '+05:30'))
      ON DUPLICATE KEY UPDATE
        farmer_name = VALUES(farmer_name),
        channel = VALUES(channel),
        fat_percentage = VALUES(fat_percentage),
        snf_percentage = VALUES(snf_percentage),
        clr_value = VALUES(clr_value),
        protein_percentage = VALUES(protein_percentage),
        lactose_percentage = VALUES(lactose_percentage),
        salt_percentage = VALUES(salt_percentage),
        water_percentage = VALUES(water_percentage),
        temperature = VALUES(temperature),
        quantity = VALUES(quantity),
        rate_per_liter = VALUES(rate_per_liter),
        total_amount = VALUES(total_amount),
        bonus = VALUES(bonus),
        machine_type = VALUES(machine_type),
        machine_version = VALUES(machine_version),
        updated_at = CONVERT_TZ(NOW(), '+00:00', '+05:30')
    `,en=[q.farmerId,j,z.id,Y,ee,et,ea,q.channel,q.fat,q.snf,q.clr,q.protein,q.lactose,q.salt,q.water,q.temperature,q.quantity,q.rate,q.totalAmount,q.bonus,q.machineType,q.version];console.log(`ðŸ’¾ Saving collection record (will insert or update if duplicate)...`),console.log(`   Farmer ID: ${q.farmerId}`),console.log(`   Farmer Name: ${ea}`),console.log(`   Date: ${Y}`),console.log(`   Time: ${ee}`),console.log(`   Shift: ${et}`),console.log(`   Channel: ${q.channel}`),console.log(`   Fat: ${q.fat}%, SNF: ${q.snf}%`),console.log(`   Quantity: ${q.quantity}L, Rate: ${q.rate}, Total: ${q.totalAmount}, Bonus: ${q.bonus}`);let[eo,el]=await i.query(er,{replacements:en});console.log(`ðŸ“Š Query result - lastInsertId: ${eo}, affectedRows: ${el}`);let ei=1===el;console.log(`âœ… Collection record saved successfully${ei?" (new collection)":" (duplicate updated)"}`);try{let e=`${Y} ${ee}`;await v.SectionPulseTracker.updatePulseOnCollection(i,k,j,e,ei),console.log(`âœ… Section pulse updated successfully`)}catch(e){console.error(`âš ï¸ Failed to update section pulse:`,e)}if(ei)try{let t=`
          SELECT f.name as farmer_name, f.email, f.email_notifications_enabled, s.name as society_name
          FROM \`${k}\`.farmers f
          LEFT JOIN \`${k}\`.societies s ON f.society_id = s.id
          WHERE f.farmer_id = ?
          LIMIT 1
        `,[a]=await i.query(t,{replacements:[q.farmerId]});if(Array.isArray(a)&&a.length>0){let t=a[0];if(console.log(`ðŸ“§ Email check for farmer ${q.farmerId}:`,{hasEmail:!!t.email,email:t.email,notificationSetting:t.email_notifications_enabled,willSend:t.email&&""!==t.email.trim()&&"ON"===t.email_notifications_enabled}),t.email&&""!==t.email.trim()&&"ON"===t.email_notifications_enabled){console.log(`ðŸ“§ Sending collection email to farmer ${q.farmerId} at ${t.email}`);let{sendMilkCollectionEmail:a}=await e.A(476424);a(t.email,t.farmer_name||ea||q.farmerId,{farmerId:q.farmerId,societyName:t.society_name,collectionDate:Y,collectionTime:ee,shiftType:et,channel:q.channel,quantity:q.quantity,fatPercentage:q.fat,snfPercentage:q.snf,clrValue:q.clr,proteinPercentage:q.protein,lactosePercentage:q.lactose,waterPercentage:q.water,temperature:q.temperature,ratePerLiter:q.rate,totalAmount:q.totalAmount,bonus:q.bonus}).catch(e=>{console.error(`âš ï¸ Failed to send collection email:`,e)}),console.log(`âœ… Collection email queued for sending`)}else console.log(`â„¹ï¸  No email address found for farmer ${q.farmerId}`)}else console.log(`â„¹ï¸  Farmer not found in database: ${q.farmerId}`)}catch(e){console.error(`âš ï¸ Error processing collection email:`,e)}return console.log(`${"=".repeat(80)}
`),y.ESP32ResponseHelper.createResponse("Collection details saved successfully.",{addQuotes:!0})}catch(e){return console.error(`âŒ Error in SaveCollectionDetails API:`,e),console.log(`${"=".repeat(80)}
`),y.ESP32ResponseHelper.createErrorResponse("Failed to save collection details")}}async function A(){return y.ESP32ResponseHelper.createCORSResponse()}e.s(["GET",0,I,"OPTIONS",()=>A,"POST",0,I],764746);var C=e.i(764746);let w=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/[db-key]/Collection/SaveCollectionDetails/route",pathname:"/api/[db-key]/Collection/SaveCollectionDetails",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/[db-key]/Collection/SaveCollectionDetails/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:P,workUnitAsyncStorage:$,serverHooks:b}=w;function T(){return(0,r.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:$})}async function N(e,t,r){w.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let _="/api/[db-key]/Collection/SaveCollectionDetails/route";_=_.replace(/\/index$/,"")||"/";let y=await w.prepare(e,t,{srcPage:_,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:S,params:v,nextConfig:I,parsedUrl:A,isDraftMode:C,prerenderManifest:P,routerServerContext:$,isOnDemandRevalidate:b,revalidateOnlyGenerated:T,resolvedPathname:N,clientReferenceManifest:O,serverActionsManifest:D}=y,U=(0,s.normalizeAppPath)(_),L=!!(P.dynamicRoutes[U]||P.routes[N]),H=async()=>((null==$?void 0:$.render404)?await $.render404(e,t,A,!1):t.end("This page could not be found"),null);if(L&&!C){let e=!!P.routes[N],t=P.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await H();throw new h.NoFallbackError}}let x=null;!L||w.isDev||C||(x="/index"===(x=N)?"/":x);let q=!0===w.isDev||!L,V=L&&!q;D&&O&&(0,l.setReferenceManifestsSingleton)({page:_,clientReferenceManifest:O,serverActionsManifest:D,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:D})});let F=e.method||"GET",M=(0,o.getTracer)(),k=M.getActiveScopeSpan(),K={params:v,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>w.onRequestError(e,t,r,$)},sharedContext:{buildId:S}},B=new c.NodeNextRequest(e),W=new c.NodeNextResponse(t),j=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let l=async e=>w.handle(j,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${F} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${_}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),s=async n=>{var o,s;let c=async({previousCacheEntry:a})=>{try{if(!i&&b&&T&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await l(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let s=K.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let c=K.renderOpts.collectedTags;if(!L)return await (0,m.sendResponse)(B,W,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[E.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:V,isOnDemandRevalidate:b})},$),t}},d=await w.handleResponse({req:e,nextConfig:I,cacheKey:x,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:T,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:i});if(!L)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(s=d.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",b?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&L||u.delete(E.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(B,W,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};k?await s(k):await M.withPropagatedContext(e.headers,()=>M.trace(u.BaseServerSpan.handleRequest,{spanName:`${F} ${_}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},s))}catch(t){if(t instanceof h.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:V,isOnDemandRevalidate:b})}),L)throw t;return await (0,m.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>T,"routeModule",()=>w,"serverHooks",()=>b,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>$],544979)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_61f392d9.js.map