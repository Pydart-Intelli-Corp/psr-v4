module.exports=[596385,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),s=e.i(759756),i=e.i(561916),n=e.i(114444),o=e.i(837092),c=e.i(869741),l=e.i(316795),d=e.i(487718),u=e.i(995169),E=e.i(47587),p=e.i(666012),m=e.i(570101),y=e.i(626937),h=e.i(10372),R=e.i(193695);e.i(52474);var f=e.i(600220),_=e.i(79832),S=e.i(84168),w=e.i(48798);async function A(t,r,a){let{sequelize:s,User:i}=await e.A(121985).then(e=>e.getModels()),[n]=await s.query(`
    SELECT DISTINCT TABLE_SCHEMA 
    FROM information_schema.TABLES 
    WHERE (TABLE_SCHEMA LIKE 'db_%' OR TABLE_SCHEMA LIKE 'tester_%') 
    AND TABLE_NAME = 'societies'
    ORDER BY TABLE_SCHEMA
  `);for(let e of n.map(e=>e.TABLE_SCHEMA))try{let i=`SELECT society_id, name FROM \`${e}\`.\`societies\` WHERE email = ?`,n=[t.trim().toLowerCase()];r&&a&&e===a&&(i+=" AND id != ?",n.push(r));let[o]=await s.query(i,{replacements:n});if(Array.isArray(o)&&o.length>0)return{isUnique:!1,existingSchema:e}}catch(t){console.log(`âš ï¸ Schema ${e} not accessible or doesn't have societies table`);continue}return{isUnique:!0}}async function g(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,w.createErrorResponse)("Authentication required",401);let a=(0,_.verifyToken)(r);if(!a||"admin"!==a.role)return(0,w.createErrorResponse)("Admin access required",403);let{name:s,password:i,societyId:n,location:o,presidentName:c,contactPhone:l,email:d,bmcId:u}=await t.json();if(!s||!i||!n||!d)return(0,w.createErrorResponse)("Name, password, society ID, and email are required",400);if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.trim()))return(0,w.createErrorResponse)("Please enter a valid email address",400);await (0,S.connectDB)();let{getModels:E}=await e.A(121985),{sequelize:p,User:m}=E(),y=await m.findByPk(a.id);if(!y||!y.dbKey)return(0,w.createErrorResponse)("Admin schema not found",404);let h=y.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),R=`${h}_${y.dbKey.toLowerCase()}`,f=await A(d);if(!f.isUnique)return console.log(`ðŸ“§ Global duplicate email detected: ${d} (exists in schema: ${f.existingSchema})`),(0,w.createErrorResponse)("Email address already exists in the system. Please use a different email.",400);let g=`
      INSERT INTO \`${R}\`.\`societies\` 
      (name, society_id, password, location, president_name, contact_phone, email, bmc_id, status) 
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'active')
    `;return await p.query(g,{replacements:[s,n,i,o||null,c||null,l||null,d.trim().toLowerCase(),u||null]}),console.log(`âœ… Society added successfully to schema: ${R}`),(0,w.createSuccessResponse)("Society added successfully",{societyId:n,name:s,email:d,location:o,presidentName:c})}catch(e){if(console.error("Error adding society:",e),e instanceof Error&&"SequelizeUniqueConstraintError"===e.name)return(0,w.createErrorResponse)("Society ID already exists",409);return(0,w.createErrorResponse)("Failed to add society",500)}}async function C(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,w.createErrorResponse)("Authentication required",401);let a=(0,_.verifyToken)(r);if(!a||"admin"!==a.role)return(0,w.createErrorResponse)("Admin access required",403);await (0,S.connectDB)();let{getModels:s}=await e.A(121985),{sequelize:i,User:n}=s(),o=await n.findByPk(a.id);if(!o||!o.dbKey)return(0,w.createErrorResponse)("Admin schema not found",404);let c=o.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),l=`${c}_${o.dbKey.toLowerCase()}`,[d]=await i.query(`
      SELECT 
        s.id, s.name, s.society_id, s.location, s.president_name, s.contact_phone, s.email, s.bmc_id, s.status,
        b.name as bmc_name, s.created_at, s.updated_at,
        COALESCE(COUNT(DISTINCT mc.id), 0) as total_collections_30d,
        COALESCE(SUM(mc.quantity), 0) as total_quantity_30d,
        COALESCE(SUM(mc.total_amount), 0) as total_amount_30d,
        COALESCE(
          CASE 
            WHEN SUM(mc.quantity) > 0 
            THEN ROUND(SUM(mc.fat_percentage * mc.quantity) / SUM(mc.quantity), 2)
            ELSE 0 
          END, 0
        ) as weighted_fat_30d,
        COALESCE(
          CASE 
            WHEN SUM(mc.quantity) > 0 
            THEN ROUND(SUM(mc.snf_percentage * mc.quantity) / SUM(mc.quantity), 2)
            ELSE 0 
          END, 0
        ) as weighted_snf_30d,
        COALESCE(
          CASE 
            WHEN SUM(mc.quantity) > 0 
            THEN ROUND(SUM(mc.clr_value * mc.quantity) / SUM(mc.quantity), 2)
            ELSE 0 
          END, 0
        ) as weighted_clr_30d,
        COALESCE(
          CASE 
            WHEN SUM(CASE WHEN mc.water_percentage IS NOT NULL THEN mc.quantity ELSE 0 END) > 0 
            THEN ROUND(
              SUM(CASE WHEN mc.water_percentage IS NOT NULL THEN mc.water_percentage * mc.quantity ELSE 0 END) / 
              SUM(CASE WHEN mc.water_percentage IS NOT NULL THEN mc.quantity ELSE 0 END), 
              2
            )
            ELSE 0 
          END, 0
        ) as weighted_water_30d
      FROM \`${l}\`.\`societies\` s
      LEFT JOIN \`${l}\`.\`bmcs\` b ON s.bmc_id = b.id
      LEFT JOIN \`${l}\`.\`milk_collections\` mc 
        ON mc.society_id = s.id 
        AND mc.collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
      GROUP BY s.id, s.name, s.society_id, s.location, s.president_name, s.contact_phone, 
               s.bmc_id, s.status, b.name, s.created_at, s.updated_at
      ORDER BY s.created_at DESC
    `);return(0,w.createSuccessResponse)("Societies retrieved successfully",d)}catch(e){return console.error("Error retrieving societies:",e),(0,w.createErrorResponse)("Failed to retrieve societies",500)}}async function T(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,w.createErrorResponse)("Authentication required",401);let a=(0,_.verifyToken)(r);if(!a||"admin"!==a.role)return(0,w.createErrorResponse)("Admin access required",403);let{searchParams:s}=new URL(t.url),i=s.get("id"),n=s.get("otp");if(!i||!n)return(0,w.createErrorResponse)("Society ID and OTP are required",400);let{verifyDeleteOTP:o}=await e.A(957050);if(!o(a.id,parseInt(i),n))return(0,w.createErrorResponse)("Invalid or expired OTP",401);await (0,S.connectDB)();let{getModels:c}=await e.A(121985),{sequelize:l,User:d}=c(),u=await d.findByPk(a.id);if(!u||!u.dbKey)return(0,w.createErrorResponse)("Admin schema not found",404);let E=u.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),p=`${E}_${u.dbKey.toLowerCase()}`,[m]=await l.query(`
      SELECT id, name FROM \`${p}\`.\`societies\` WHERE id = ?
    `,{replacements:[i]});if(!Array.isArray(m)||0===m.length)return(0,w.createErrorResponse)("Society not found",404);let y=m[0];console.log(`ðŸ—‘ï¸ Starting cascade delete for Society ID ${i}: ${y.name}`);let[h]=await l.query(`
      SELECT id FROM \`${p}\`.\`farmers\` WHERE society_id = ?
    `,{replacements:[i]}),R=Array.isArray(h)?h.map(e=>e.id):[],[f]=await l.query(`
      SELECT id FROM \`${p}\`.\`rate_charts\` WHERE society_id = ?
    `,{replacements:[i]}),A=Array.isArray(f)?f.map(e=>e.id):[];return R.length>0&&(await l.query(`
        DELETE FROM \`${p}\`.\`milk_collections\` 
        WHERE farmer_id IN (?)
      `,{replacements:[R]}),console.log(`âœ… Step 1: Deleted milk collections for farmers`)),await l.query(`
      DELETE FROM \`${p}\`.\`milk_sales\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 2: Deleted milk sales records`),await l.query(`
      DELETE FROM \`${p}\`.\`milk_dispatches\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 3: Deleted milk dispatches`),await l.query(`
      DELETE FROM \`${p}\`.\`section_pulse\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 4: Deleted section pulse data`),A.length>0&&(await l.query(`
        DELETE FROM \`${p}\`.\`rate_chart_download_history\` 
        WHERE rate_chart_id IN (?)
      `,{replacements:[A]}),console.log(`âœ… Step 5: Deleted rate chart download history`)),A.length>0&&(await l.query(`
        DELETE FROM \`${p}\`.\`rate_chart_data\` 
        WHERE rate_chart_id IN (?)
      `,{replacements:[A]}),console.log(`âœ… Step 6: Deleted rate chart data`)),await l.query(`
      DELETE FROM \`${p}\`.\`rate_charts\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 7: Deleted rate charts`),await l.query(`
      DELETE FROM \`${p}\`.\`machine_statistics\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 8: Deleted machine statistics`),await l.query(`
      DELETE FROM \`${p}\`.\`machine_corrections\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 9: Deleted machine corrections (admin saved)`),await l.query(`
      DELETE FROM \`${p}\`.\`machine_corrections_from_machine\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 10: Deleted machine corrections (device saved)`),await l.query(`
      DELETE FROM \`${p}\`.\`farmers\` WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 11: Deleted farmers`),await l.query(`
      UPDATE \`${p}\`.\`machines\` SET society_id = NULL WHERE society_id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 12: Unlinked machines from society`),await l.query(`
      DELETE FROM \`${p}\`.\`societies\` WHERE id = ?
    `,{replacements:[i]}),console.log(`âœ… Step 13: Deleted society "${y.name}"`),console.log(`ðŸŽ‰ Cascade delete completed successfully for Society ID ${i}`),(0,w.createSuccessResponse)("Society and all related data deleted successfully",{societyId:parseInt(i),societyName:y.name,deletedItems:{farmers:R.length,rateCharts:A.length}})}catch(e){return console.error("Error deleting society:",e),(0,w.createErrorResponse)("Failed to delete society",500)}}async function N(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,w.createErrorResponse)("Authentication required",401);let a=(0,_.verifyToken)(r);if(!a||"admin"!==a.role)return(0,w.createErrorResponse)("Admin access required",403);let{id:s,name:i,location:n,presidentName:o,contactPhone:c,email:l,bmcId:d,status:u,password:E}=await t.json();if(!s||!i||!l)return(0,w.createErrorResponse)("Society ID, name, and email are required",400);if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l.trim()))return(0,w.createErrorResponse)("Please enter a valid email address",400);await (0,S.connectDB)();let{getModels:p}=await e.A(121985),{sequelize:m,User:y}=p(),h=await y.findByPk(a.id);if(!h||!h.dbKey)return(0,w.createErrorResponse)("Admin schema not found",404);let R=h.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),f=`${R}_${h.dbKey.toLowerCase()}`,[g]=await m.query(`
      SELECT id FROM \`${f}\`.\`societies\` WHERE id = ?
    `,{replacements:[s]});if(!Array.isArray(g)||0===g.length)return(0,w.createErrorResponse)("Society not found",404);let C=await A(l,s,f);if(!C.isUnique)return console.log(`ðŸ“§ Global duplicate email detected: ${l} (exists in schema: ${C.existingSchema})`),(0,w.createErrorResponse)("Email address already exists in the system. Please use a different email.",400);let T=["name = ?","email = ?"],N=[i,l.trim().toLowerCase()];return void 0!==n&&(T.push("location = ?"),N.push(n)),void 0!==o&&(T.push("president_name = ?"),N.push(o)),void 0!==c&&(T.push("contact_phone = ?"),N.push(c)),void 0!==d&&(T.push("bmc_id = ?"),N.push(d)),void 0!==u&&(T.push("status = ?"),N.push(u)),E&&(T.push("password = ?"),N.push(E)),T.push("updated_at = NOW()"),N.push(s),await m.query(`
      UPDATE \`${f}\`.\`societies\` 
      SET ${T.join(", ")}
      WHERE id = ?
    `,{replacements:N}),(0,w.createSuccessResponse)("Society updated successfully",{id:s})}catch(e){if(console.error("Error updating society:",e),e instanceof Error){let t=e.message;if(t.includes("email")||t.includes("unique_society_email"))return(0,w.createErrorResponse)("Email address already exists. Please use a different email.",400)}return(0,w.createErrorResponse)("Failed to update society",500)}}e.s(["DELETE",()=>T,"GET",()=>C,"POST",()=>g,"PUT",()=>N],377983);var D=e.i(377983);let L=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/user/society/route",pathname:"/api/user/society",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/society/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:q,workUnitAsyncStorage:v,serverHooks:O}=L;function H(){return(0,a.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:v})}async function M(e,t,a){L.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let _="/api/user/society/route";_=_.replace(/\/index$/,"")||"/";let S=await L.prepare(e,t,{srcPage:_,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:A,nextConfig:g,parsedUrl:C,isDraftMode:T,prerenderManifest:N,routerServerContext:D,isOnDemandRevalidate:q,revalidateOnlyGenerated:v,resolvedPathname:O,clientReferenceManifest:H,serverActionsManifest:M}=S,U=(0,c.normalizeAppPath)(_),$=!!(N.dynamicRoutes[U]||N.routes[O]),b=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,C,!1):t.end("This page could not be found"),null);if($&&!T){let e=!!N.routes[O],t=N.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await b();throw new R.NoFallbackError}}let I=null;!$||L.isDev||T||(I="/index"===(I=O)?"/":I);let x=!0===L.isDev||!$,P=$&&!x;M&&H&&(0,n.setReferenceManifestsSingleton)({page:_,clientReferenceManifest:H,serverActionsManifest:M,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:M})});let F=e.method||"GET",W=(0,i.getTracer)(),k=W.getActiveScopeSpan(),B={params:A,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:x,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>L.onRequestError(e,t,a,D)},sharedContext:{buildId:w}},K=new l.NodeNextRequest(e),j=new l.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let n=async e=>L.handle(z,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=W.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${_}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var i,c;let l=async({previousCacheEntry:r})=>{try{if(!o&&q&&v&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(s);e.fetchMetrics=B.renderOpts.fetchMetrics;let c=B.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let l=B.renderOpts.collectedTags;if(!$)return await (0,p.sendResponse)(K,j,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[h.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await L.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:q})},D),t}},d=await L.handleResponse({req:e,nextConfig:g,cacheKey:I,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:v,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:o});if(!$)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",q?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&$||u.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,j,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};k?await c(k):await W.withPropagatedContext(e.headers,()=>W.trace(u.BaseServerSpan.handleRequest,{spanName:`${F} ${_}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},c))}catch(t){if(t instanceof R.NoFallbackError||await L.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:q})}),$)throw t;return await (0,p.sendResponse)(K,j,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>H,"routeModule",()=>L,"serverHooks",()=>O,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>v],596385)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_98609c5b.js.map