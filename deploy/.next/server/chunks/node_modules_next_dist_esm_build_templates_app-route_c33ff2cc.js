module.exports=[328882,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(114444),s=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),h=e.i(47587),p=e.i(666012),E=e.i(570101),R=e.i(626937),f=e.i(10372),_=e.i(193695);e.i(52474);var w=e.i(600220),m=e.i(79832),$=e.i(84168),g=e.i(48798);async function y(t){try{let r=t.headers.get("authorization")?.replace("Bearer ","");if(!r)return(0,g.createErrorResponse)("Authentication required",401);let a=(0,m.verifyToken)(r);if(!a)return(0,g.createErrorResponse)("Invalid token",401);if("admin"!==a.role)return(0,g.createErrorResponse)("Admin access required",403);let i=await t.formData(),n=i.get("file"),o=i.get("societyIds"),s=i.get("channel");if(!n)return(0,g.createErrorResponse)("CSV file is required",400);if(!o)return(0,g.createErrorResponse)("Society ID(s) required",400);let l=o.split(",").map(e=>e.trim()).filter(e=>e);if(0===l.length)return(0,g.createErrorResponse)("At least one society ID is required",400);if(!s||!["COW","BUF","MIX"].includes(s))return(0,g.createErrorResponse)("Valid channel (COW, BUF, or MIX) is required",400);if(!n.name.toLowerCase().endsWith(".csv"))return(0,g.createErrorResponse)("Only CSV files are allowed",400);let d=(await n.text()).split("\n").filter(e=>e.trim());if(d.length<2)return(0,g.createErrorResponse)("CSV file must contain header and at least one data row",400);let c=d[0].split(",").map(e=>e.trim().replace(/"/g,""));console.log("CSV Header:",c);let u=["CLR","FAT","SNF","RATE"],h=u.filter(e=>!c.includes(e));if(h.length>0)return(0,g.createErrorResponse)(`Missing required CSV headers: ${h.join(", ")}. Required: ${u.join(", ")}`,400);let p=[],E=[];for(let e=1;e<d.length;e++){let t=d[e].trim();if(!t)continue;let r=t.split(",").map(e=>e.trim().replace(/"/g,""));if(r.length!==c.length){E.push(`Row ${e+1}: Invalid number of columns`);continue}let a={};if(c.forEach((e,t)=>{a[e]=r[t]}),!a.CLR||!a.FAT||!a.SNF||!a.RATE){E.push(`Row ${e+1}: All fields (CLR, FAT, SNF, RATE) are required`);continue}if(isNaN(Number(a.CLR))||isNaN(Number(a.FAT))||isNaN(Number(a.SNF))||isNaN(Number(a.RATE))){E.push(`Row ${e+1}: All values must be numeric`);continue}p.push(a)}if(E.length>0)return(0,g.createErrorResponse)(`CSV validation errors: ${E.join("; ")}`,400);if(0===p.length)return(0,g.createErrorResponse)("No valid rate data found in CSV",400);let R=await (0,$.connectDB)();if(!R)return(0,g.createErrorResponse)("Database connection failed",500);let{User:f}=await e.A(121985).then(e=>e.getModels()),_=await f.findByPk(a.id);if(!_||!_.dbKey)return(0,g.createErrorResponse)("Admin schema not found",404);let w=_.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),y=`${w}_${_.dbKey.toLowerCase()}`,C=await R.transaction();try{if(1===l.length){let[e]=await R.query(`
          SELECT id, shared_chart_id FROM ${y}.rate_charts
          WHERE society_id = ${l[0]} AND channel = :channel
        `,{replacements:{channel:s},transaction:C});if(e&&e.length>0){let t=e[0];if(null!==t.shared_chart_id)await R.query(`
              DELETE FROM ${y}.rate_charts
              WHERE id = ${t.id}
            `,{transaction:C});else{let[e]=await R.query(`
              SELECT COUNT(*) as count FROM ${y}.rate_charts
              WHERE shared_chart_id = ${t.id}
            `,{transaction:C});if(e[0].count>0){let[e]=await R.query(`
                SELECT id, society_id FROM ${y}.rate_charts
                WHERE shared_chart_id = ${t.id}
                ORDER BY id ASC
                LIMIT 1
              `,{transaction:C}),r=e[0];await R.query(`
                UPDATE ${y}.rate_chart_data
                SET rate_chart_id = ${r.id}
                WHERE rate_chart_id = ${t.id}
              `,{transaction:C}),await R.query(`
                UPDATE ${y}.rate_charts
                SET shared_chart_id = NULL
                WHERE id = ${r.id}
              `,{transaction:C}),await R.query(`
                UPDATE ${y}.rate_charts
                SET shared_chart_id = ${r.id}
                WHERE shared_chart_id = ${t.id} AND id != ${r.id}
              `,{transaction:C}),await R.query(`
                DELETE FROM ${y}.rate_chart_download_history
                WHERE rate_chart_id = ${t.id}
              `,{transaction:C}),await R.query(`
                DELETE FROM ${y}.rate_charts
                WHERE id = ${t.id}
              `,{transaction:C})}else await R.query(`
                DELETE FROM ${y}.rate_chart_data
                WHERE rate_chart_id = ${t.id}
              `,{transaction:C}),await R.query(`
                DELETE FROM ${y}.rate_charts
                WHERE id = ${t.id}
              `,{transaction:C})}}}else await R.query(`
          DELETE FROM ${y}.rate_chart_data
          WHERE rate_chart_id IN (
            SELECT id FROM ${y}.rate_charts
            WHERE society_id IN (${l.join(",")}) AND channel = :channel
          )
        `,{replacements:{channel:s},transaction:C}),await R.query(`
          DELETE FROM ${y}.rate_charts
          WHERE society_id IN (${l.join(",")}) AND channel = :channel
        `,{replacements:{channel:s},transaction:C});let e=l.map(e=>`(${e}, '${s}', NOW(), '${_.fullName.replace(/'/g,"''")}', '${n.name.replace(/'/g,"''")}', ${p.length}, 1)`).join(",");await R.query(`
        INSERT INTO ${y}.rate_charts 
        (society_id, channel, uploaded_at, uploaded_by, file_name, record_count, status)
        VALUES ${e}
      `,{transaction:C});let[t]=await R.query(`
        SELECT id FROM ${y}.rate_charts
        WHERE society_id = ${l[0]} AND channel = :channel
        ORDER BY id DESC
        LIMIT 1
      `,{replacements:{channel:s},transaction:C}),r=t[0].id;if(p.length>0){let e=p.map(e=>`(${r}, ${e.CLR}, ${e.FAT}, ${e.SNF}, ${e.RATE})`).join(",");await R.query(`
          INSERT INTO ${y}.rate_chart_data 
          (rate_chart_id, clr, fat, snf, rate)
          VALUES ${e}
        `,{transaction:C})}return l.length>1&&await R.query(`
          UPDATE ${y}.rate_charts
          SET shared_chart_id = ${r}
          WHERE society_id IN (${l.slice(1).join(",")}) AND channel = :channel
        `,{replacements:{channel:s},transaction:C}),await C.commit(),console.log(`ðŸ“Š Rate chart uploaded: ${p.length} records for ${s} channel, ${l.length} societies`),(0,g.createSuccessResponse)("Rate chart uploaded successfully",{recordCount:p.length,channel:s,societyCount:l.length,societyIds:l})}catch(e){throw await C.rollback(),e}}catch(e){return console.error("CSV upload error:",e),(0,g.createErrorResponse)("Failed to process CSV upload",500)}}e.s(["POST",()=>y],68940);var C=e.i(68940);let T=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/user/ratechart/upload/route",pathname:"/api/user/ratechart/upload",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/ratechart/upload/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:A,workUnitAsyncStorage:N,serverHooks:v}=T;function S(){return(0,a.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:N})}async function O(e,t,a){T.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let m="/api/user/ratechart/upload/route";m=m.replace(/\/index$/,"")||"/";let $=await T.prepare(e,t,{srcPage:m,multiZoneDraftMode:!1});if(!$)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:g,params:y,nextConfig:C,parsedUrl:A,isDraftMode:N,prerenderManifest:v,routerServerContext:S,isOnDemandRevalidate:O,revalidateOnlyGenerated:q,resolvedPathname:D,clientReferenceManifest:H,serverActionsManifest:I}=$,M=(0,l.normalizeAppPath)(m),F=!!(v.dynamicRoutes[M]||v.routes[D]),b=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,A,!1):t.end("This page could not be found"),null);if(F&&!N){let e=!!v.routes[D],t=v.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await b();throw new _.NoFallbackError}}let x=null;!F||T.isDev||N||(x="/index"===(x=D)?"/":x);let L=!0===T.isDev||!F,P=F&&!L;I&&H&&(0,o.setReferenceManifestsSingleton)({page:m,clientReferenceManifest:H,serverActionsManifest:I,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:I})});let U=e.method||"GET",W=(0,n.getTracer)(),k=W.getActiveScopeSpan(),j={params:y,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>T.onRequestError(e,t,a,S)},sharedContext:{buildId:g}},V=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(V,(0,c.signalFromNodeResponse)(t));try{let o=async e=>T.handle(K,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=W.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${m}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&O&&q&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=j.renderOpts.fetchMetrics;let l=j.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=j.renderOpts.collectedTags;if(!F)return await (0,p.sendResponse)(V,B,n,j.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,a=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:O})},S),t}},c=await T.handleResponse({req:e,nextConfig:C,cacheKey:x,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:q,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!F)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",O?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,E.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&F||u.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,R.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(V,B,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};k?await l(k):await W.withPropagatedContext(e.headers,()=>W.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${m}`,kind:n.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:O})}),F)throw t;return await (0,p.sendResponse)(V,B,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>S,"routeModule",()=>T,"serverHooks",()=>v,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>N],328882)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_c33ff2cc.js.map