module.exports=[471187,e=>{"use strict";var t=e.i(747909),a=e.i(174017),i=e.i(996250),s=e.i(759756),n=e.i(561916),c=e.i(114444),o=e.i(837092),m=e.i(869741),r=e.i(316795),l=e.i(487718),d=e.i(995169),h=e.i(47587),u=e.i(666012),p=e.i(570101),_=e.i(626937),E=e.i(10372),y=e.i(193695);e.i(52474);var R=e.i(600220),O=e.i(89171),N=e.i(79832),T=e.i(84168);async function I(t){try{let a=t.headers.get("authorization")?.replace("Bearer ","");if(!a)return O.NextResponse.json({error:"Authentication required"},{status:401});let i=(0,N.verifyToken)(a);if(!i||"admin"!==i.role)return O.NextResponse.json({error:"Admin access required"},{status:403});let{searchParams:s}=new URL(t.url),n="true"===s.get("graphData"),c=s.get("metric")||"quantity";await (0,T.connectDB)();let{getModels:o}=await e.A(121985),{sequelize:m,User:r}=o(),l=await r.findByPk(i.id);if(!l||!l.dbKey)return O.NextResponse.json({error:"Admin not found or database not configured"},{status:404});let d=l.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),h=`${d}_${l.dbKey.toLowerCase()}`;console.log("ðŸ” Machine Performance API - Schema:",h);let u=new Date;u.setDate(u.getDate()-30);let p=u.toISOString().split("T")[0],_=new Date().toISOString().split("T")[0];if(n){let e="",t=p;switch(c){case"quantity":e=`
            SELECT 
              m.id,
              m.machine_id as machineId,
              m.machine_type as machineType,
              s.name as societyName,
              SUM(mc.quantity) as value
            FROM \`${h}\`.milk_collections mc
            JOIN \`${h}\`.machines m ON mc.machine_id = m.id
            LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
            WHERE mc.collection_date >= ?
            GROUP BY m.id, m.machine_id, m.machine_type, s.name
            ORDER BY value DESC
            LIMIT 20
          `;break;case"tests":e=`
            SELECT 
              m.id,
              m.machine_id as machineId,
              m.machine_type as machineType,
              s.name as societyName,
              SUM(ms.total_test) as value
            FROM \`${h}\`.machine_statistics ms
            JOIN \`${h}\`.machines m ON ms.machine_id = m.id
            LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
            WHERE ms.statistics_date >= ?
            GROUP BY m.id, m.machine_id, m.machine_type, s.name
            ORDER BY value DESC
            LIMIT 20
          `;break;case"cleaning":e=`
            SELECT 
              m.id,
              m.machine_id as machineId,
              m.machine_type as machineType,
              s.name as societyName,
              SUM(ms.daily_cleaning + ms.weekly_cleaning) as value
            FROM \`${h}\`.machine_statistics ms
            JOIN \`${h}\`.machines m ON ms.machine_id = m.id
            LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
            WHERE ms.statistics_date >= ?
            GROUP BY m.id, m.machine_id, m.machine_type, s.name
            ORDER BY value DESC
            LIMIT 20
          `;break;case"skip":e=`
            SELECT 
              m.id,
              m.machine_id as machineId,
              m.machine_type as machineType,
              s.name as societyName,
              SUM(ms.cleaning_skip) as value
            FROM \`${h}\`.machine_statistics ms
            JOIN \`${h}\`.machines m ON ms.machine_id = m.id
            LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
            WHERE ms.statistics_date >= ?
            GROUP BY m.id, m.machine_id, m.machine_type, s.name
            ORDER BY value DESC
            LIMIT 20
          `;break;case"today":e=`
            SELECT 
              m.id,
              m.machine_id as machineId,
              m.machine_type as machineType,
              s.name as societyName,
              COUNT(mc.id) as value
            FROM \`${h}\`.milk_collections mc
            JOIN \`${h}\`.machines m ON mc.machine_id = m.id
            LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
            WHERE mc.collection_date = ?
            GROUP BY m.id, m.machine_id, m.machine_type, s.name
            ORDER BY value DESC
            LIMIT 20
          `,t=_;break;case"uptime":e=`
            SELECT 
              m.id,
              m.machine_id as machineId,
              m.machine_type as machineType,
              s.name as societyName,
              COUNT(DISTINCT mc.collection_date) as value
            FROM \`${h}\`.milk_collections mc
            JOIN \`${h}\`.machines m ON mc.machine_id = m.id
            LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
            WHERE mc.collection_date >= ?
            GROUP BY m.id, m.machine_id, m.machine_type, s.name
            ORDER BY value DESC
            LIMIT 20
          `}let a=(await m.query(e,{replacements:[t]}))[0],i=Array.isArray(a)?a.map((e,t)=>({machine:{machineId:e.machineId,machineType:e.machineType,societyName:e.societyName},value:parseFloat(e.value)||0,label:`${t+1}. ${e.machineId}`})):[];return O.NextResponse.json(i)}{let e=await m.query(`
        SELECT 
          m.id,
          m.machine_id as machineId,
          m.machine_type as machineType,
          s.name as societyName,
          SUM(mc.quantity) as total_quantity
        FROM \`${h}\`.milk_collections mc
        JOIN \`${h}\`.machines m ON mc.machine_id = m.id
        LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
        WHERE mc.collection_date >= ?
        GROUP BY m.id
        ORDER BY total_quantity DESC
        LIMIT 1
      `,{replacements:[p]}),t=await m.query(`
        SELECT 
          m.id,
          m.machine_id as machineId,
          m.machine_type as machineType,
          s.name as societyName,
          SUM(ms.total_test) as total_tests
        FROM \`${h}\`.machine_statistics ms
        JOIN \`${h}\`.machines m ON ms.machine_id = m.id
        LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
        WHERE ms.statistics_date >= ?
        GROUP BY m.id
        ORDER BY total_tests DESC
        LIMIT 1
      `,{replacements:[p]}),a=await m.query(`
        SELECT 
          m.id,
          m.machine_id as machineId,
          m.machine_type as machineType,
          s.name as societyName,
          SUM(ms.daily_cleaning + ms.weekly_cleaning) as total_cleanings
        FROM \`${h}\`.machine_statistics ms
        JOIN \`${h}\`.machines m ON ms.machine_id = m.id
        LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
        WHERE ms.statistics_date >= ?
        GROUP BY m.id
        ORDER BY total_cleanings DESC
        LIMIT 1
      `,{replacements:[p]}),i=await m.query(`
        SELECT 
          m.id,
          m.machine_id as machineId,
          m.machine_type as machineType,
          s.name as societyName,
          SUM(ms.cleaning_skip) as total_skips
        FROM \`${h}\`.machine_statistics ms
        JOIN \`${h}\`.machines m ON ms.machine_id = m.id
        LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
        WHERE ms.statistics_date >= ?
        GROUP BY m.id
        ORDER BY total_skips DESC
        LIMIT 1
      `,{replacements:[p]}),s=await m.query(`
        SELECT 
          m.id,
          m.machine_id as machineId,
          m.machine_type as machineType,
          s.name as societyName,
          COUNT(mc.id) as collections_today
        FROM \`${h}\`.milk_collections mc
        JOIN \`${h}\`.machines m ON mc.machine_id = m.id
        LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
        WHERE mc.collection_date = ?
        GROUP BY m.id
        ORDER BY collections_today DESC
        LIMIT 1
      `,{replacements:[_]}),n=await m.query(`
        SELECT 
          m.id,
          m.machine_id as machineId,
          m.machine_type as machineType,
          s.name as societyName,
          COUNT(DISTINCT mc.collection_date) as active_days
        FROM \`${h}\`.milk_collections mc
        JOIN \`${h}\`.machines m ON mc.machine_id = m.id
        LEFT JOIN \`${h}\`.societies s ON m.society_id = s.id
        WHERE mc.collection_date >= ?
        GROUP BY m.id
        ORDER BY active_days DESC
        LIMIT 1
      `,{replacements:[p]}),c=e[0],o=t[0],r=a[0],l=i[0],d=s[0],u=n[0];console.log("ðŸ“Š Machine Performance Results:"),console.log("  - Top Collector:",c?.length||0,"records"),console.log("  - Most Tests:",o?.length||0,"records"),console.log("  - Best Cleaning:",r?.length||0,"records"),console.log("  - Most Cleaning Skip:",l?.length||0,"records"),console.log("  - Active Today:",d?.length||0,"records"),console.log("  - Highest Uptime:",u?.length||0,"records");let E={topCollector:c&&c.length>0?{machine:c[0],totalQuantity:parseFloat(c[0].total_quantity)||0}:null,mostTests:o&&o.length>0?{machine:o[0],totalTests:parseInt(o[0].total_tests)||0}:null,bestCleaning:r&&r.length>0?{machine:r[0],totalCleanings:parseInt(r[0].total_cleanings)||0}:null,mostCleaningSkip:l&&l.length>0?{machine:l[0],totalSkips:parseInt(l[0].total_skips)||0}:null,activeToday:d&&d.length>0?{machine:d[0],collectionsToday:parseInt(d[0].collections_today)||0}:null,highestUptime:u&&u.length>0?{machine:u[0],activeDays:parseInt(u[0].active_days)||0}:null};return O.NextResponse.json(E)}}catch(e){return console.error("Error fetching machine performance:",e),O.NextResponse.json({error:"Failed to fetch machine performance data",details:e.message},{status:500})}}e.s(["GET",()=>I],101042);var g=e.i(101042);let C=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/analytics/machine-performance/route",pathname:"/api/analytics/machine-performance",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/analytics/machine-performance/route.ts",nextConfigOutput:"",userland:g}),{workAsyncStorage:v,workUnitAsyncStorage:S,serverHooks:f}=C;function w(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:S})}async function M(e,t,i){C.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let O="/api/analytics/machine-performance/route";O=O.replace(/\/index$/,"")||"/";let N=await C.prepare(e,t,{srcPage:O,multiZoneDraftMode:!1});if(!N)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:T,params:I,nextConfig:g,parsedUrl:v,isDraftMode:S,prerenderManifest:f,routerServerContext:w,isOnDemandRevalidate:M,revalidateOnlyGenerated:$,resolvedPathname:D,clientReferenceManifest:L,serverActionsManifest:U}=N,P=(0,m.normalizeAppPath)(O),A=!!(f.dynamicRoutes[P]||f.routes[D]),k=async()=>((null==w?void 0:w.render404)?await w.render404(e,t,v,!1):t.end("This page could not be found"),null);if(A&&!S){let e=!!f.routes[D],t=f.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await k();throw new y.NoFallbackError}}let x=null;!A||C.isDev||S||(x="/index"===(x=D)?"/":x);let F=!0===C.isDev||!A,B=A&&!F;U&&L&&(0,c.setReferenceManifestsSingleton)({page:O,clientReferenceManifest:L,serverActionsManifest:U,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:U})});let b=e.method||"GET",q=(0,n.getTracer)(),H=q.getActiveScopeSpan(),J={params:I,prerenderManifest:f,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i)=>C.onRequestError(e,t,i,w)},sharedContext:{buildId:T}},Y=new r.NodeNextRequest(e),G=new r.NodeNextResponse(t),W=l.NextRequestAdapter.fromNodeNextRequest(Y,(0,l.signalFromNodeResponse)(t));try{let c=async e=>C.handle(W,J).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${b} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${b} ${O}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),m=async s=>{var n,m;let r=async({previousCacheEntry:a})=>{try{if(!o&&M&&$&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await c(s);e.fetchMetrics=J.renderOpts.fetchMetrics;let m=J.renderOpts.pendingWaitUntil;m&&i.waitUntil&&(i.waitUntil(m),m=void 0);let r=J.renderOpts.collectedTags;if(!A)return await (0,u.sendResponse)(Y,G,n,J.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);r&&(t[E.NEXT_CACHE_TAGS_HEADER]=r),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==J.renderOpts.collectedRevalidate&&!(J.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&J.renderOpts.collectedRevalidate,i=void 0===J.renderOpts.collectedExpire||J.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:J.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:M})},w),t}},l=await C.handleResponse({req:e,nextConfig:g,cacheKey:x,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:f,isRoutePPREnabled:!1,isOnDemandRevalidate:M,revalidateOnlyGenerated:$,responseGenerator:r,waitUntil:i.waitUntil,isMinimalMode:o});if(!A)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(m=l.value)?void 0:m.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",M?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&A||d.delete(E.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,_.getCacheControlHeader)(l.cacheControl)),await (0,u.sendResponse)(Y,G,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};H?await m(H):await q.withPropagatedContext(e.headers,()=>q.trace(d.BaseServerSpan.handleRequest,{spanName:`${b} ${O}`,kind:n.SpanKind.SERVER,attributes:{"http.method":b,"http.target":e.url}},m))}catch(t){if(t instanceof y.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:M})}),A)throw t;return await (0,u.sendResponse)(Y,G,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>w,"routeModule",()=>C,"serverHooks",()=>f,"workAsyncStorage",()=>v,"workUnitAsyncStorage",()=>S],471187)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_611495cc.js.map