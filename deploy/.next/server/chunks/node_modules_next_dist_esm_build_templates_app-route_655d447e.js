module.exports=[120462,e=>{"use strict";var r=e.i(747909),a=e.i(174017),t=e.i(996250),s=e.i(759756),n=e.i(561916),i=e.i(114444),o=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),f=e.i(47587),m=e.i(666012),p=e.i(570101),E=e.i(626937),R=e.i(10372),_=e.i(193695);e.i(52474);var h=e.i(600220),y=e.i(79832),g=e.i(84168),b=e.i(48798);async function w(r,a,t){let{sequelize:s,User:n}=await e.A(121985).then(e=>e.getModels()),[i]=await s.query(`
    SELECT DISTINCT TABLE_SCHEMA 
    FROM information_schema.TABLES 
    WHERE (TABLE_SCHEMA LIKE 'db_%' OR TABLE_SCHEMA LIKE 'tester_%') 
    AND TABLE_NAME = 'farmers'
    ORDER BY TABLE_SCHEMA
  `);for(let e of i.map(e=>e.TABLE_SCHEMA))try{let n=`SELECT farmer_id, name FROM \`${e}\`.\`farmers\` WHERE email = ?`,i=[r.trim().toLowerCase()];a&&t&&e===t&&(n+=" AND id != ?",i.push(a));let[o]=await s.query(n,{replacements:i});if(Array.isArray(o)&&o.length>0)return{isUnique:!1,existingSchema:e}}catch(r){console.log(`âš ï¸ Schema ${e} not accessible or doesn't have farmers table`);continue}return{isUnique:!0}}async function A(r){try{let a,t=r.headers.get("authorization")?.replace("Bearer ","");if(!t)return(0,b.createErrorResponse)("Authentication required",401);let s=(0,y.verifyToken)(t);if(!s||"admin"!==s.role)return(0,b.createErrorResponse)("Admin access required",403);await (0,g.connectDB)();let{getModels:n}=await e.A(121985),{sequelize:i,User:o}=n(),{searchParams:l}=new URL(r.url),d=l.get("id"),c=await o.findByPk(s.id);if(!c||!c.dbKey)return(0,b.createErrorResponse)("Admin not found or database not configured",404);let u=c.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),f=`${u}_${c.dbKey.toLowerCase()}`;console.log(`ðŸ” Fetching farmers from schema: ${f}`);let m=[];d?(a=`
        SELECT 
          f.id, f.farmer_id, f.rf_id, f.name, f.password, f.phone, f.email, f.sms_enabled, 
          f.email_notifications_enabled, f.bonus, f.address, f.bank_name, f.bank_account_number, f.ifsc_code, 
          f.society_id, f.machine_id, f.status, f.notes, f.cattle_count, f.created_at, f.updated_at,
          s.name as society_name, s.society_id as society_identifier,
          m.machine_id as machine_name, m.machine_type
        FROM \`${f}\`.farmers f
        LEFT JOIN \`${f}\`.societies s ON f.society_id = s.id
        LEFT JOIN \`${f}\`.machines m ON f.machine_id = m.id
        WHERE f.id = ?
      `,m=[d]):a=`
        SELECT 
          f.id, f.farmer_id, f.rf_id, f.name, f.password, f.phone, f.email, f.sms_enabled, 
          f.email_notifications_enabled, f.bonus, f.address, f.bank_name, f.bank_account_number, f.ifsc_code, 
          f.society_id, f.machine_id, f.status, f.notes, f.cattle_count, f.created_at, f.updated_at,
          s.name as society_name, s.society_id as society_identifier,
          m.machine_id as machine_name, m.machine_type
        FROM \`${f}\`.farmers f
        LEFT JOIN \`${f}\`.societies s ON f.society_id = s.id
        LEFT JOIN \`${f}\`.machines m ON f.machine_id = m.id
        ORDER BY f.created_at DESC
      `;let[p]=await i.query(a,{replacements:m}),E=p.map(e=>({id:e.id,farmerId:e.farmer_id,rfId:e.rf_id,farmerName:e.name,password:e.password,contactNumber:e.phone,email:e.email,smsEnabled:e.sms_enabled||"OFF",emailNotificationsEnabled:e.email_notifications_enabled||"ON",bonus:Number(e.bonus)||0,address:e.address,bankName:e.bank_name,bankAccountNumber:e.bank_account_number,ifscCode:e.ifsc_code,societyId:e.society_id,societyName:e.society_name,societyIdentifier:e.society_identifier,machineId:e.machine_id,machineName:e.machine_name,machineType:e.machine_type,status:e.status||"active",notes:e.notes,cattleCount:e.cattle_count,createdAt:e.created_at,updatedAt:e.updated_at}));if(d)return console.log(`âœ… Retrieved farmer ${d} from schema: ${f}`),(0,b.createSuccessResponse)("Farmer retrieved successfully",E);return console.log(`âœ… Retrieved ${E.length} farmers from schema: ${f}`),(0,b.createSuccessResponse)("Farmers retrieved successfully",E)}catch(e){return console.error("Error fetching farmers:",e),(0,b.createErrorResponse)("Failed to fetch farmers",500)}}async function N(r){try{let a=r.headers.get("authorization")?.replace("Bearer ","");if(!a)return(0,b.createErrorResponse)("Authentication required",401);let t=(0,y.verifyToken)(a);if(!t||"admin"!==t.role)return(0,b.createErrorResponse)("Admin access required",403);let{farmers:s,...n}=await r.json();await (0,g.connectDB)();let{getModels:i}=await e.A(121985),{sequelize:o,User:l}=i(),d=await l.findByPk(t.id);if(!d||!d.dbKey)return(0,b.createErrorResponse)("Admin not found or database not configured",404);let c=d.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),u=`${c}_${d.dbKey.toLowerCase()}`;if(s&&Array.isArray(s)){console.log(`ðŸ”„ Processing bulk upload of ${s.length} farmers...`);let e=s.map(e=>[e.farmerId,e.rfId||null,e.farmerName,e.password||null,e.contactNumber||null,e.email||null,e.smsEnabled||"OFF",e.emailNotificationsEnabled||"ON",e.bonus||0,e.address||null,e.bankName||null,e.bankAccountNumber||null,e.ifscCode||null,e.societyId||null,e.machineId||null,e.status||"active",e.notes||null]),r=`
        INSERT INTO \`${u}\`.farmers 
        (farmer_id, rf_id, name, password, phone, email, sms_enabled, email_notifications_enabled, bonus, address,
         bank_name, bank_account_number, ifsc_code, society_id, machine_id, status, notes)
        VALUES ${e.map(()=>"(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)").join(", ")}
      `,a=e.flat();return await o.query(r,{replacements:a}),console.log(`âœ… Successfully uploaded ${s.length} farmers to schema: ${u}`),(0,b.createSuccessResponse)(`Successfully uploaded ${s.length} farmers`,null)}{let{farmerId:e,rfId:r,farmerName:a,password:t,contactNumber:s,email:i,smsEnabled:l,emailNotificationsEnabled:d,bonus:c,address:f,bankName:m,bankAccountNumber:p,ifscCode:E,societyId:R,machineId:_,status:h,notes:y}=n;if(!e||!a)return(0,b.createErrorResponse)("Farmer ID and name are required",400);if(i&&""!==i.trim()){let e=await w(i);if(!e.isUnique)return console.log(`ðŸ“§ Global duplicate farmer email detected: ${i} (exists in schema: ${e.existingSchema})`),(0,b.createErrorResponse)("Email address already exists in the system. Please use a different email.",400)}let g=`
        INSERT INTO \`${u}\`.farmers 
        (farmer_id, rf_id, name, password, phone, email, sms_enabled, email_notifications_enabled, bonus, address, 
         bank_name, bank_account_number, ifsc_code, society_id, machine_id, status, notes)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `,A=[e,r||null,a,t||null,s||null,i||null,l||"OFF",d||"ON",c||0,f||null,m||null,p||null,E||null,R||null,_||null,h||"active",y||null];return await o.query(g,{replacements:A}),console.log(`âœ… Successfully created farmer: ${e} in schema: ${u}`),(0,b.createSuccessResponse)("Farmer created successfully",null)}}catch(t){console.error("Error creating farmer(s):",t);let e=t?.message||t?.original?.sqlMessage||t?.parent?.sqlMessage||"",r=t?.original?.code||t?.code||t?.parent?.code||"",a=t?.original?.errno||t?.errno||t?.parent?.errno||"";if("ER_DUP_ENTRY"===r||1062===a||e.includes("Duplicate entry")){if(e.includes("farmer_id")||e.includes("unique_farmer_id"))return(0,b.createErrorResponse)("Farmer ID already exists",400);if(e.includes("email")||e.includes("unique_email"))return(0,b.createErrorResponse)("Email address already exists. Please use a different email.",400);if(e.includes("rf_id"))return(0,b.createErrorResponse)("RF-ID already exists",400);return(0,b.createErrorResponse)("Farmer ID, RF-ID, or Email already exists",400)}if(t?.name==="SequelizeUniqueConstraintError"){if(t?.original?.sqlMessage){if(t.original.sqlMessage.includes("farmer_id"))return(0,b.createErrorResponse)("Farmer ID already exists",400);if(t.original.sqlMessage.includes("email")||t.original.sqlMessage.includes("unique_email"))return(0,b.createErrorResponse)("Email address already exists. Please use a different email.",400)}return(0,b.createErrorResponse)("Farmer ID, RF-ID, or Email already exists",400)}return(0,b.createErrorResponse)("Failed to create farmer(s)",500)}}async function T(r){try{let a=r.headers.get("authorization")?.replace("Bearer ","");if(!a)return(0,b.createErrorResponse)("Authentication required",401);let t=(0,y.verifyToken)(a);if(!t||"admin"!==t.role)return(0,b.createErrorResponse)("Admin access required",403);let s=await r.json();await (0,g.connectDB)();let{getModels:n}=await e.A(121985),{sequelize:i,User:o}=n(),l=await o.findByPk(t.id);if(!l||!l.dbKey)return(0,b.createErrorResponse)("Admin not found or database not configured",404);let d=l.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),c=`${d}_${l.dbKey.toLowerCase()}`;if(s.bulkStatusUpdate&&Array.isArray(s.farmerIds)){let{farmerIds:e,status:r}=s;if(!r||0===e.length)return(0,b.createErrorResponse)("Status and farmer IDs are required for bulk update",400);console.log(`ðŸ”„ Processing bulk status update for ${e.length} farmers to status: ${r}`);let a=e.map(()=>"?").join(","),t=`
        UPDATE \`${c}\`.farmers 
        SET status = ?, updated_at = CURRENT_TIMESTAMP
        WHERE id IN (${a})
      `,n=[r,...e],[o]=await i.query(t,{replacements:n}),l=o.affectedRows||0;if(console.log(`âœ… Successfully updated status for ${l} farmers in schema: ${c}`),0===l)return(0,b.createErrorResponse)("No farmers were updated",404);return(0,b.createSuccessResponse)(`Successfully updated status to "${r}" for ${l} farmer(s)`,{updated:l})}let{id:u,farmerId:f,rfId:m,farmerName:p,password:E,contactNumber:R,email:_,smsEnabled:h,emailNotificationsEnabled:A,bonus:N,address:T,bankName:S,bankAccountNumber:$,ifscCode:C,societyId:I,machineId:q,status:v,notes:F}=s;if(!u||!f||!p)return(0,b.createErrorResponse)("ID, Farmer ID and name are required",400);if(_&&""!==_.trim()){let e=await w(_,u,c);if(!e.isUnique)return console.log(`ðŸ“§ Global duplicate farmer email detected: ${_} (exists in schema: ${e.existingSchema})`),(0,b.createErrorResponse)("Email address already exists in the system. Please use a different email.",400)}let O=`
      UPDATE \`${c}\`.farmers 
      SET farmer_id = ?, rf_id = ?, name = ?, password = ?, phone = ?, email = ?,
          sms_enabled = ?, email_notifications_enabled = ?, bonus = ?, address = ?, bank_name = ?,
          bank_account_number = ?, ifsc_code = ?, society_id = ?, 
          machine_id = ?, status = ?, notes = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `,D=[f,m||null,p,E||null,R||null,_||null,h||"OFF",A||"ON",N||0,T||null,S||null,$||null,C||null,I||null,q||null,v||"active",F||null,u];await i.query(O,{replacements:D});let x=`SELECT id FROM \`${c}\`.farmers WHERE id = ?`,[M]=await i.query(x,{replacements:[u]});if(Array.isArray(M)&&0===M.length)return(0,b.createErrorResponse)("Farmer not found",404);return console.log(`âœ… Successfully updated farmer: ${f} in schema: ${c}`),(0,b.createSuccessResponse)("Farmer updated successfully",null)}catch(a){console.error("Error updating farmer:",a);let e=a?.message||a?.original?.sqlMessage||"",r=a?.original?.code||a?.code||"";if("ER_DUP_ENTRY"===r||1062===r||e.includes("Duplicate entry")){if(e.includes("farmer_id")||e.includes("unique_farmer_id"))return(0,b.createErrorResponse)("Farmer ID already exists",400);if(e.includes("email")||e.includes("unique_email"))return(0,b.createErrorResponse)("Email address already exists. Please use a different email.",400);if(e.includes("rf_id"))return(0,b.createErrorResponse)("RF-ID already exists",400);return(0,b.createErrorResponse)("Farmer ID, RF-ID, or Email already exists",400)}if(a?.name==="SequelizeUniqueConstraintError"){if(a?.original?.sqlMessage){if(a.original.sqlMessage.includes("farmer_id"))return(0,b.createErrorResponse)("Farmer ID already exists",400);if(a.original.sqlMessage.includes("email")||a.original.sqlMessage.includes("unique_email"))return(0,b.createErrorResponse)("Email address already exists. Please use a different email.",400)}return(0,b.createErrorResponse)("Farmer ID, RF-ID, or Email already exists",400)}return(0,b.createErrorResponse)("Failed to update farmer",500)}}async function S(r){try{let a=r.headers.get("authorization")?.replace("Bearer ","");if(!a)return(0,b.createErrorResponse)("Authentication required",401);let t=(0,y.verifyToken)(a);if(!t||"admin"!==t.role)return(0,b.createErrorResponse)("Admin access required",403);let{searchParams:s}=new URL(r.url),n=s.get("id"),i=s.get("ids");if(!n&&!i)return(0,b.createErrorResponse)("Farmer ID(s) required",400);await (0,g.connectDB)();let{getModels:o}=await e.A(121985),{sequelize:l,User:d}=o(),c=await d.findByPk(t.id);if(!c||!c.dbKey)return(0,b.createErrorResponse)("Admin not found or database not configured",404);let u=c.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),f=`${u}_${c.dbKey.toLowerCase()}`;if(i){let e=JSON.parse(i).map(e=>parseInt(e)).filter(e=>!isNaN(e));if(0===e.length)return(0,b.createErrorResponse)("No valid farmer IDs provided",400);let r=e.map(()=>"?").join(","),a=`SELECT id FROM \`${f}\`.farmers WHERE id IN (${r})`,[t]=await l.query(a,{replacements:e});if(!Array.isArray(t)||t.length!==e.length)return(0,b.createErrorResponse)("One or more farmers not found",404);let s=`DELETE FROM \`${f}\`.farmers WHERE id IN (${r})`;return await l.query(s,{replacements:e}),console.log(`âœ… Successfully deleted ${e.length} farmers from schema: ${f}`),(0,b.createSuccessResponse)(`Successfully deleted ${e.length} farmers`,null)}{let e=`SELECT id FROM \`${f}\`.farmers WHERE id = ?`,[r]=await l.query(e,{replacements:[n]});if(Array.isArray(r)&&0===r.length)return(0,b.createErrorResponse)("Farmer not found",404);let a=`DELETE FROM \`${f}\`.farmers WHERE id = ?`;return await l.query(a,{replacements:[n]}),console.log(`âœ… Successfully deleted farmer with ID: ${n} from schema: ${f}`),(0,b.createSuccessResponse)("Farmer deleted successfully",null)}}catch(e){return console.error("Error deleting farmer:",e),(0,b.createErrorResponse)("Failed to delete farmer",500)}}e.s(["DELETE",()=>S,"GET",()=>A,"POST",()=>N,"PUT",()=>T],641027);var $=e.i(641027);let C=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/user/farmer/route",pathname:"/api/user/farmer",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/user/farmer/route.ts",nextConfigOutput:"",userland:$}),{workAsyncStorage:I,workUnitAsyncStorage:q,serverHooks:v}=C;function F(){return(0,t.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:q})}async function O(e,r,t){C.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/user/farmer/route";y=y.replace(/\/index$/,"")||"/";let g=await C.prepare(e,r,{srcPage:y,multiZoneDraftMode:!1});if(!g)return r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve()),null;let{buildId:b,params:w,nextConfig:A,parsedUrl:N,isDraftMode:T,prerenderManifest:S,routerServerContext:$,isOnDemandRevalidate:I,revalidateOnlyGenerated:q,resolvedPathname:v,clientReferenceManifest:F,serverActionsManifest:O}=g,D=(0,l.normalizeAppPath)(y),x=!!(S.dynamicRoutes[D]||S.routes[v]),M=async()=>((null==$?void 0:$.render404)?await $.render404(e,r,N,!1):r.end("This page could not be found"),null);if(x&&!T){let e=!!S.routes[v],r=S.dynamicRoutes[D];if(r&&!1===r.fallback&&!e){if(A.experimental.adapterPath)return await M();throw new _.NoFallbackError}}let P=null;!x||C.isDev||T||(P="/index"===(P=v)?"/":P);let k=!0===C.isDev||!x,L=x&&!k;O&&F&&(0,i.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:F,serverActionsManifest:O,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:O})});let U=e.method||"GET",H=(0,n.getTracer)(),B=H.getActiveScopeSpan(),K={params:w,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:t.waitUntil,onClose:e=>{r.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(r,a,t)=>C.onRequestError(e,r,t,$)},sharedContext:{buildId:b}},j=new d.NodeNextRequest(e),W=new d.NodeNextResponse(r),z=c.NextRequestAdapter.fromNodeNextRequest(j,(0,c.signalFromNodeResponse)(r));try{let i=async e=>C.handle(z,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let t=a.get("next.route");if(t){let r=`${U} ${t}`;e.setAttributes({"next.route":t,"http.route":t,"next.span_name":r}),e.updateName(r)}else e.updateName(`${U} ${y}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&I&&q&&!a)return r.statusCode=404,r.setHeader("x-nextjs-cache","REVALIDATED"),r.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&t.waitUntil&&(t.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!x)return await (0,m.sendResponse)(j,W,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),r=(0,p.toNodeOutgoingHttpHeaders)(n.headers);d&&(r[R.NEXT_CACHE_TAGS_HEADER]=d),!r["content-type"]&&e.type&&(r["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,t=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:r},cacheControl:{revalidate:a,expire:t}}}}catch(r){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,r,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:I})},$),r}},c=await C.handleResponse({req:e,nextConfig:A,cacheKey:P,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:q,responseGenerator:d,waitUntil:t.waitUntil,isMinimalMode:o});if(!x)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||r.setHeader("x-nextjs-cache",I?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,p.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&x||u.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||r.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,E.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(j,W,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};B?await l(B):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${y}`,kind:n.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(r){if(r instanceof _.NoFallbackError||await C.onRequestError(e,r,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:I})}),x)throw r;return await (0,m.sendResponse)(j,W,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>F,"routeModule",()=>C,"serverHooks",()=>v,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>q],120462)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_655d447e.js.map