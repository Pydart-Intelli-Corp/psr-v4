module.exports=[48798,e=>{"use strict";var t=e.i(89171);function a(e,r,n=200){return t.NextResponse.json({success:!0,message:e,data:r},{status:n})}function r(e,a=400,n){return t.NextResponse.json({success:!1,message:"Error occurred",error:e,data:n},{status:a})}e.s(["createErrorResponse",()=>r,"createSuccessResponse",()=>a])},233405,(e,t,a)=>{t.exports=e.x("child_process",()=>require("child_process"))},469222,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),n=e.i(759756),i=e.i(561916),s=e.i(114444),o=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),p=e.i(47587),m=e.i(666012),y=e.i(570101),E=e.i(626937),h=e.i(10372),f=e.i(193695);e.i(52474);var R=e.i(600220),_=e.i(84168),T=e.i(48798),g=e.i(79832),b=e.i(686599);async function w(t){let{sequelize:a,User:r}=await e.A(121985).then(e=>e.getModels()),[n]=await a.query(`
    SELECT DISTINCT TABLE_SCHEMA 
    FROM information_schema.TABLES 
    WHERE (TABLE_SCHEMA LIKE 'db_%' OR TABLE_SCHEMA LIKE 'tester_%' OR TABLE_SCHEMA LIKE 'tishnu_%') 
    ORDER BY TABLE_SCHEMA
  `),i=n.map(e=>e.TABLE_SCHEMA),[s]=await a.query(`
    SELECT id, fullName, email, dbKey 
    FROM users 
    WHERE role = 'admin' AND dbKey IS NOT NULL
  `),o=s.reduce((e,t)=>{let a=t.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase();return e[`${a}_${t.dbKey.toLowerCase()}`]=t,e},{});for(let e of i)try{let[r]=await a.query(`
        SELECT s.id, s.name, s.society_id, s.email, s.location, s.president_name, 
               s.contact_phone, s.bmc_id, s.status
        FROM \`${e}\`.societies s
        WHERE s.email = ?
      `,{replacements:[t.trim().toLowerCase()]});if(Array.isArray(r)&&r.length>0){let t=r[0];try{let[r]=await a.query(`
            SELECT b.name as bmc_name, d.name as dairy_name, d.id as dairy_id
            FROM \`${e}\`.bmcs b
            LEFT JOIN \`${e}\`.dairies d ON b.dairy_id = d.id
            WHERE b.id = ?
          `,{replacements:[t.bmc_id]});Array.isArray(r)&&r.length>0&&Object.assign(t,r[0])}catch(e){}return{found:!0,entityType:"society",entityData:t,schemaName:e,adminInfo:o[e]}}let[n]=await a.query(`
        SELECT f.id, f.farmer_id, f.name, f.email, f.phone, f.society_id, f.status
        FROM \`${e}\`.farmers f
        WHERE f.email = ?
      `,{replacements:[t.trim().toLowerCase()]});if(Array.isArray(n)&&n.length>0){let t=n[0];try{let[r]=await a.query(`
            SELECT s.name as society_name, s.society_id as society_identifier,
                   b.name as bmc_name, d.name as dairy_name, d.id as dairy_id
            FROM \`${e}\`.societies s
            LEFT JOIN \`${e}\`.bmcs b ON s.bmc_id = b.id
            LEFT JOIN \`${e}\`.dairies d ON b.dairy_id = d.id
            WHERE s.id = ?
          `,{replacements:[t.society_id]});Array.isArray(r)&&r.length>0&&Object.assign(t,r[0])}catch(e){}return{found:!0,entityType:"farmer",entityData:t,schemaName:e,adminInfo:o[e]}}let[i]=await a.query(`
        SELECT b.id, b.name, b.bmc_id, b.email, b.location, b.contact_phone, 
               b.dairy_id, b.status
        FROM \`${e}\`.bmcs b
        WHERE b.email = ?
      `,{replacements:[t.trim().toLowerCase()]});if(Array.isArray(i)&&i.length>0){let t=i[0];try{let[r]=await a.query(`
            SELECT d.name as dairy_name, d.dairy_id as dairy_identifier
            FROM \`${e}\`.dairies d
            WHERE d.id = ?
          `,{replacements:[t.dairy_id]});Array.isArray(r)&&r.length>0&&Object.assign(t,r[0])}catch(e){}return{found:!0,entityType:"bmc",entityData:t,schemaName:e,adminInfo:o[e]}}let[s]=await a.query(`
        SELECT d.id, d.name, d.dairy_id, d.email, d.location, d.contact_phone, 
               d.president_name, d.status
        FROM \`${e}\`.dairies d
        WHERE d.email = ?
      `,{replacements:[t.trim().toLowerCase()]});if(Array.isArray(s)&&s.length>0)return{found:!0,entityType:"dairy",entityData:s[0],schemaName:e,adminInfo:o[e]}}catch(t){console.error(`‚ö†Ô∏è Schema ${e} error:`,t);continue}return{found:!1}}async function A(e){try{let{email:t}=await e.json();if(!t||!t.trim())return(0,T.createErrorResponse)("Email address is required",400);if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.trim()))return(0,T.createErrorResponse)("Please enter a valid email address",400);await (0,_.connectDB)();let a=await w(t);if(!a.found)return console.log(`üìß Email not found in any schema: ${t}`),(0,T.createErrorResponse)("Email address not found. Please contact your supervisor for registration.",404);let r=(0,g.generateOTP)(),n=new Date(Date.now()+6e5);if(global.otpStore=global.otpStore||new Map,!a.entityType||!a.schemaName||!a.adminInfo)return(0,T.createErrorResponse)("Invalid entity data found",500);global.otpStore.set(t.toLowerCase(),{otp:r,expiry:n,entityType:a.entityType,entityData:a.entityData,schemaName:a.schemaName,adminInfo:a.adminInfo});let i=new Date;for(let[e,t]of global.otpStore.entries())t.expiry<i&&global.otpStore.delete(e);let s=a.entityData.name||a.entityData.farmer_id||"User";a.entityType&&(a.entityType.charAt(0).toUpperCase(),a.entityType.slice(1));try{await (0,b.sendOTPEmail)(t,r,s),console.log(`‚úÖ OTP sent successfully to ${t} for ${a.entityType}: ${s}`)}catch(e){return console.error("Failed to send OTP email:",e),(0,T.createErrorResponse)("Failed to send OTP. Please try again later.",500)}return(0,T.createSuccessResponse)("OTP sent successfully to your email address",{email:t,entityType:a.entityType,entityName:s,adminName:a.adminInfo?.fullName,message:`OTP sent to ${t}. Please check your email and enter the 6-digit code.`})}catch(e){return console.error("Error in send-otp:",e),(0,T.createErrorResponse)("Failed to process request",500)}}e.s(["POST",()=>A],430169);var C=e.i(430169);let v=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/external/auth/send-otp/route",pathname:"/api/external/auth/send-otp",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/external/auth/send-otp/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:O,workUnitAsyncStorage:S,serverHooks:N}=v;function x(){return(0,r.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:S})}async function P(e,t,r){v.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let _="/api/external/auth/send-otp/route";_=_.replace(/\/index$/,"")||"/";let T=await v.prepare(e,t,{srcPage:_,multiZoneDraftMode:!1});if(!T)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:g,params:b,nextConfig:w,parsedUrl:A,isDraftMode:C,prerenderManifest:O,routerServerContext:S,isOnDemandRevalidate:N,revalidateOnlyGenerated:x,resolvedPathname:P,clientReferenceManifest:L,serverActionsManifest:I}=T,M=(0,l.normalizeAppPath)(_),H=!!(O.dynamicRoutes[M]||O.routes[P]),D=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,A,!1):t.end("This page could not be found"),null);if(H&&!C){let e=!!O.routes[P],t=O.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await D();throw new f.NoFallbackError}}let $=null;!H||v.isDev||C||($="/index"===($=P)?"/":$);let q=!0===v.isDev||!H,F=H&&!q;I&&L&&(0,s.setReferenceManifestsSingleton)({page:_,clientReferenceManifest:L,serverActionsManifest:I,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:I})});let U=e.method||"GET",k=(0,i.getTracer)(),j=k.getActiveScopeSpan(),B={params:b,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>v.onRequestError(e,t,r,S)},sharedContext:{buildId:g}},K=new d.NodeNextRequest(e),W=new d.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let s=async e=>v.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=k.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${_}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&N&&x&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!H)return await (0,m.sendResponse)(K,W,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:N})},S),t}},c=await v.handleResponse({req:e,nextConfig:w,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:x,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!H)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,y.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&H||u.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,E.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(K,W,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};j?await l(j):await k.withPropagatedContext(e.headers,()=>k.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${_}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:N})}),H)throw t;return await (0,m.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>x,"routeModule",()=>v,"serverHooks",()=>N,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>S],469222)},453753,e=>{e.v(t=>Promise.all(["server/chunks/src_lib_migrations_ts_7dc08040._.js"].map(t=>e.l(t))).then(()=>t(736987)))},121985,e=>{e.v(t=>Promise.all(["server/chunks/src_models_index_ts_328304ec._.js"].map(t=>e.l(t))).then(()=>t(540590)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__0ba6ea2c._.js.map