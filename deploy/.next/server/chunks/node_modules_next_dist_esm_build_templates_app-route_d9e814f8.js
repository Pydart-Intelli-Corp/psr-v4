module.exports=[641487,e=>{"use strict";var t=e.i(747909),r=e.i(174017),n=e.i(996250),o=e.i(759756),a=e.i(561916),s=e.i(114444),i=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),p=e.i(47587),h=e.i(666012),g=e.i(570101),f=e.i(626937),m=e.i(10372),y=e.i(193695);e.i(52474);var R=e.i(600220),w=e.i(84168),C=e.i(116185);e.i(512982);var I=e.i(375448),E=e.i(871366);async function v(t,{params:r}){try{let n=await I.ESP32ResponseHelper.extractInputString(t),o=await r,a=o["db-key"]||o.dbKey||o.dbkey;if(n&&(n=I.ESP32ResponseHelper.filterLineEndings(n)),I.ESP32ResponseHelper.logRequest(t,a,n),!a||""===a.trim())return console.log(`‚ùå DB Key validation failed - dbKey: "${a}"`),I.ESP32ResponseHelper.createErrorResponse("DB Key is required");if(!n)return I.ESP32ResponseHelper.createErrorResponse("InputString parameter is required");await (0,w.connectDB)();let{getModels:s}=await e.A(121985),{sequelize:i,User:l}=s(),d=E.InputValidator.validateDbKey(a);if(!d.isValid)return I.ESP32ResponseHelper.createErrorResponse(d.error||"Invalid DB Key");let c=await l.findOne({where:{dbKey:a.toUpperCase()}});if(!c||!c.dbKey)return console.log(`‚ùå Admin not found or missing DB Key for: ${a}`),I.ESP32ResponseHelper.createErrorResponse("Invalid DB Key");let u=n.split("|"),p=4===u.length,h=5===u.length;if(!p&&!h)return I.ESP32ResponseHelper.createErrorResponse("Invalid InputString format. Expected: societyId|machineType|version|machineId or societyId|machineType|version|machineId|pageNumber");let[g,f,m,y,R]=u;console.log(`üîç Parsed InputString parts:`,{societyIdStr:g,machineType:f,machineModel:m,machineId:y,lengthParam:R});let C=c.fullName.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),v=`${C}_${c.dbKey.toLowerCase()}`,S=`
      SELECT id FROM \`${v}\`.societies 
      WHERE society_id = ? OR society_id = ?
      LIMIT 1
    `,b=g.startsWith("S-")?[g,g.substring(2)]:[`S-${g}`,g],[A]=await i.query(S,{replacements:b});if(!Array.isArray(A)||0===A.length){console.log(`‚ùå No society found for society_id: "${g}"`);let e="Failed to download farmer. Invalid token.";return new Response(e,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Length":Buffer.byteLength(e,"utf8").toString(),Connection:"close","Cache-Control":"no-cache","Access-Control-Allow-Origin":"*"}})}let $=A[0].id;if(console.log(`‚úÖ Found society: "${g}" -> database ID: ${$}`),!y||!y.trim()){console.log(`‚ùå Machine ID is required but not provided`);let e="Failed to download farmer. Invalid machine details.";return new Response(e,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Length":Buffer.byteLength(e,"utf8").toString(),Connection:"close","Cache-Control":"no-cache","Access-Control-Allow-Origin":"*"}})}let x=E.InputValidator.validateMachineId(y);if(!x.isValid){console.log(`‚ùå Invalid machine ID: "${y}" - ${x.error}`);let e="Failed to download farmer. Invalid machine details.";return new Response(e,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Length":Buffer.byteLength(e,"utf8").toString(),Connection:"close","Cache-Control":"no-cache","Access-Control-Allow-Origin":"*"}})}let T=x.numericId||null,O=(x.variants||[]).map(e=>String(e));console.log(`üîç Machine ID parsing: "${y}" -> ${null!==T?T:JSON.stringify(O)}`),m&&""!==m.trim()||console.log(`‚ö†Ô∏è Machine model is empty: "${m}"`),console.log(`üîç Machine model: "${m}"`);let N=1,F=5,L=0;h&&R?(N=parseInt(R.replace(/^C0*/,""))||1,F=5,L=(N-1)*F,console.log(`üîç Pagination: Page ${N}, Size ${F}, Offset ${L}`),N<1&&console.log(`‚ö†Ô∏è Invalid page number: ${N}, using page 1`)):p&&console.log(`üìÅ CSV Download requested - fetching all farmers`),console.log(`üîç Using schema: ${v} for society: ${$}, machine variants: ${JSON.stringify(O)}`);let P=`
      SELECT 
        f.rf_id, 
        f.farmer_id, 
        f.name, 
        f.phone, 
        f.sms_enabled, 
        f.bonus
      FROM \`${v}\`.farmers f
      LEFT JOIN \`${v}\`.societies s ON f.society_id = s.id
      LEFT JOIN \`${v}\`.machines m ON f.machine_id = m.id
      WHERE f.society_id = ? 
        AND f.status = 'active'
    `,D=[$];if(O.length>0)if(null!==T)P+=" AND f.machine_id = ?",D.push(T);else{let e=O.map(()=>"?").join(", ");P+=` AND m.machine_id IN (${e})`,D.push(...O)}P+=" ORDER BY f.farmer_id",h&&(P+=" LIMIT ? OFFSET ?",D.push(F,L)),console.log(`üîç Executing query with replacements:`,D);let[_]=await i.query(P,{replacements:D});if(console.log(`‚úÖ Found ${_.length} farmers in schema: ${v} ${h?`(Page ${N}, Offset ${L})`:"(CSV Download)"}`),0===_.length){console.log(`‚ÑπÔ∏è No active farmers found for society ${$} in schema ${v}`);let e="Farmer info not found.";return new Response(e,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Length":Buffer.byteLength(e,"utf8").toString(),Connection:"close","Cache-Control":"no-cache","Access-Control-Allow-Origin":"*"}})}if(p){let e=_.map(e=>{let t=e.farmer_id||"0",r=e.rf_id||"0",n=e.name||"0",o=e.phone||"0",a=e.sms_enabled||"OFF",s="0";if(null!==e.bonus&&void 0!==e.bonus){let t=Number(e.bonus);s=isNaN(t)?"0":Math.round(t).toString()}let i=e=>e.includes(",")||e.includes('"')?`"${e.replace(/"/g,'""')}"`:e;return`${i(t)},${r},${i(n)},${i(o)},${a},${s}`}).join("\n"),t="ID,RF-ID,NAME,MOBILE,SMS,BONUS\n"+e;return console.log(`üìÅ Returning CSV data for ${_.length} farmers`),console.log(`üìÅ CSV size: ${t.length} characters`),new Response(t,{status:200,headers:{"Content-Type":"text/csv","Content-Disposition":'attachment; filename="FarmerDetails.csv"',"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST","Access-Control-Allow-Headers":"Content-Type"}})}{let e=_.map((e,t)=>{let r=e.farmer_id||"0",n=e.rf_id||"0",o=e.name||"0",a=e.phone||"0",s=e.sms_enabled||"OFF",i="0.00";if(null!==e.bonus&&void 0!==e.bonus){let t=Number(e.bonus);i=isNaN(t)?"0.00":t.toFixed(2)}let l=t===_.length-1;return`${r}|${n}|${o}|${a}|${s}|${i}${l?"":"||"}`}).join("");console.log(`üì§ Returning farmer data for ${_.length} farmers`),console.log(`üì§ Response format: ${e.substring(0,100)}${e.length>100?"...":""}`);let t=`"${e}"`;return new Response(t,{status:200,headers:{"Content-Type":"text/plain","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST","Access-Control-Allow-Headers":"Content-Type"}})}}catch(e){return console.error("‚ùå Error in GetLatestFarmerInfo API:",e),I.ESP32ResponseHelper.createErrorResponse("Internal server error")}}async function S(e,t){let r=Date.now();try{let n=await v(e,t),o=Date.now();try{let t=(0,C.extractRequestMetadata)(e.url);console.log("üîî Logging request to monitoring system:",{endpoint:"FarmerInfo/GetLatest",dbKey:t.dbKey,societyId:t.societyId,statusCode:n.status,responseTime:o-r}),C.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"FarmerInfo/GetLatest",dbKey:t.dbKey,societyId:t.societyId,machineId:t.machineId,inputString:t.inputString,statusCode:n.status,responseTime:o-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",category:"external"}),console.log("‚úÖ Request logged successfully")}catch(e){console.error("‚ùå Failed to log request:",e)}return n}catch(o){let t=Date.now(),n=o instanceof Error?o.message:"Unknown error";try{let o=(0,C.extractRequestMetadata)(e.url);C.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"FarmerInfo/GetLatest",dbKey:o.dbKey,societyId:o.societyId,machineId:o.machineId,inputString:o.inputString,statusCode:500,responseTime:t-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",error:n,category:"external"})}catch(e){console.error("Failed to log error:",e)}throw o}}async function b(e,t){let r=Date.now();try{let n=await v(e,t),o=Date.now();try{let t=(0,C.extractRequestMetadata)(e.url);C.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"FarmerInfo/GetLatest",dbKey:t.dbKey,societyId:t.societyId,machineId:t.machineId,inputString:t.inputString,statusCode:n.status,responseTime:o-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",category:"external"})}catch(e){console.error("Failed to log request:",e)}return n}catch(o){let t=Date.now(),n=o instanceof Error?o.message:"Unknown error";try{let o=(0,C.extractRequestMetadata)(e.url);C.requestLogger.log({method:e.method,path:new URL(e.url).pathname,endpoint:"FarmerInfo/GetLatest",dbKey:o.dbKey,societyId:o.societyId,machineId:o.machineId,inputString:o.inputString,statusCode:500,responseTime:t-r,userAgent:e.headers.get("user-agent")||void 0,ip:e.headers.get("x-forwarded-for")?.split(",")[0].trim()||e.headers.get("x-real-ip")||"unknown",error:n,category:"external"})}catch(e){console.error("Failed to log error:",e)}throw o}}async function A(){return I.ESP32ResponseHelper.createCORSResponse()}e.s(["GET",()=>S,"OPTIONS",()=>A,"POST",()=>b],536471);var $=e.i(536471);let x=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/[db-key]/FarmerInfo/GetLatestFarmerInfo/route",pathname:"/api/[db-key]/FarmerInfo/GetLatestFarmerInfo",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/[db-key]/FarmerInfo/GetLatestFarmerInfo/route.ts",nextConfigOutput:"",userland:$}),{workAsyncStorage:T,workUnitAsyncStorage:O,serverHooks:N}=x;function F(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:O})}async function L(e,t,n){x.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/[db-key]/FarmerInfo/GetLatestFarmerInfo/route";w=w.replace(/\/index$/,"")||"/";let C=await x.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!C)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:I,params:E,nextConfig:v,parsedUrl:S,isDraftMode:b,prerenderManifest:A,routerServerContext:$,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,resolvedPathname:N,clientReferenceManifest:F,serverActionsManifest:L}=C,P=(0,l.normalizeAppPath)(w),D=!!(A.dynamicRoutes[P]||A.routes[N]),_=async()=>((null==$?void 0:$.render404)?await $.render404(e,t,S,!1):t.end("This page could not be found"),null);if(D&&!b){let e=!!A.routes[N],t=A.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await _();throw new y.NoFallbackError}}let M=null;!D||x.isDev||b||(M="/index"===(M=N)?"/":M);let q=!0===x.isDev||!D,H=D&&!q;L&&F&&(0,s.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:F,serverActionsManifest:L,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:L})});let K=e.method||"GET",k=(0,a.getTracer)(),U=k.getActiveScopeSpan(),B={params:E,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>x.onRequestError(e,t,n,$)},sharedContext:{buildId:I}},G=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),j=c.NextRequestAdapter.fromNodeNextRequest(G,(0,c.signalFromNodeResponse)(t));try{let s=async e=>x.handle(j,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=k.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${K} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${K} ${w}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var a,l;let d=async({previousCacheEntry:r})=>{try{if(!i&&T&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)(G,V,a,B.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},$),t}},c=await x.handleResponse({req:e,nextConfig:v,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:i});if(!D)return null;if((null==c||null==(a=c.value)?void 0:a.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&D||u.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(G,V,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};U?await l(U):await k.withPropagatedContext(e.headers,()=>k.trace(u.BaseServerSpan.handleRequest,{spanName:`${K} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":K,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),D)throw t;return await (0,h.sendResponse)(G,V,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>F,"routeModule",()=>x,"serverHooks",()=>N,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>O],641487)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_d9e814f8.js.map