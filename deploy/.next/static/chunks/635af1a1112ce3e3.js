(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,910361,e=>{"use strict";var t=e.i(843476),a=e.i(271645),r=e.i(618566),i=e.i(846932),n=e.i(88653),l=e.i(178583),s=e.i(896390),o=e.i(715788),d=e.i(212426),c=e.i(440160),h=e.i(475254);let m=(0,h.default)("file-down",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]);var x=e.i(25652),g=e.i(217923),u=e.i(16715),p=e.i(727612),y=e.i(263488),f=e.i(255749),w=e.i(945700),S=e.i(186441);e.i(633999);var F=e.i(269111);e.i(137996);var b=e.i(425091),j=e.i(833472),k=e.i(199083),N=e.i(641041),_=e.i(540274),v=e.i(174080),C=e.i(37727),E=e.i(514764);function T({isOpen:e,onClose:r,onSend:l,defaultEmail:s="",recordCount:o=0,reportType:d="Report"}){let[c,h]=(0,a.useState)(""),[m,x]=(0,a.useState)(!1),[g,u]=(0,a.useState)("");(0,a.useEffect)(()=>{e&&s&&h(s)},[e,s]);let p=async e=>{if(e.preventDefault(),!c)return void u("Email address is required");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c))return void u("Please enter a valid email address");x(!0),u("");try{await l(c),h(""),r()}catch(e){u(e instanceof Error?e.message:"Failed to send email")}finally{x(!1)}},f=()=>{h(""),u(""),r()},w=(0,t.jsx)(n.AnimatePresence,{children:e&&(0,t.jsx)(i.motion.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 dark:bg-black/70 flex items-end sm:items-center justify-center z-[9999] p-0 sm:p-4",style:{position:"fixed",top:0,left:0,right:0,bottom:0},onClick:e=>{e.target===e.currentTarget&&f()},children:(0,t.jsxs)(i.motion.div,{initial:{y:"100%",opacity:0},animate:{y:0,opacity:1},exit:{y:"100%",opacity:0},transition:{type:"spring",damping:25,stiffness:300},className:"bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-xl shadow-2xl w-full sm:max-w-md max-h-[90vh] overflow-y-auto",onClick:e=>e.stopPropagation(),children:[(0,t.jsx)("div",{className:"sm:hidden flex justify-center pt-3 pb-1",children:(0,t.jsx)("div",{className:"w-12 h-1 bg-gray-300 dark:bg-gray-600 rounded-full"})}),(0,t.jsx)("div",{className:"p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"p-2 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-lg",children:(0,t.jsx)(y.Mail,{className:"w-5 h-5 text-white"})}),(0,t.jsxs)("h2",{className:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-gray-100",children:["Send ",d]})]}),(0,t.jsx)("button",{onClick:f,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors",children:(0,t.jsx)(C.X,{className:"w-5 h-5 text-gray-500 dark:text-gray-400"})})]})}),(0,t.jsx)("div",{className:"p-4 sm:p-6",children:(0,t.jsxs)("form",{onSubmit:p,className:"space-y-4",children:[(0,t.jsx)("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)(y.Mail,{className:"w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5"}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h4",{className:"text-sm font-medium text-blue-800 dark:text-blue-200 mb-1",children:"Email Report"}),(0,t.jsxs)("p",{className:"text-xs text-blue-700 dark:text-blue-300",children:["The filtered report (",o," records) will be sent as both CSV and PDF attachments to the email address you specify below."]})]})]})}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:["Email Address ",(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,t.jsx)("input",{type:"email",value:c,onChange:e=>{h(e.target.value),u("")},placeholder:"Enter email address",required:!0,disabled:m,className:`form-input-custom w-full px-3 sm:px-4 py-2 sm:py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 focus:outline-none ${g?"border-red-300 bg-red-50 dark:border-red-700 dark:bg-red-900/20":""}`}),g&&(0,t.jsx)("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:g})]}),(0,t.jsxs)("div",{className:"flex gap-3 pt-2",children:[(0,t.jsx)("button",{type:"button",onClick:f,disabled:m,className:"flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"Cancel"}),(0,t.jsx)("button",{type:"submit",disabled:m||!c,className:"flex-1 px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2",children:m?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(E.Send,{className:"w-4 h-4"}),"Send Email"]})})]})]})})]})})});return(0,v.createPortal)(w,document.body)}let A=(e,a)=>{if(!e&&0!==e)return e||"";if(!a)return e;let r=e.toString(),i=RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return r.split(i).map((e,a)=>i.test(e)?(0,t.jsx)("span",{className:"bg-yellow-200 dark:bg-yellow-800 px-0.5 rounded",children:e},a):e)},R=e=>({ch1:"COW",ch2:"BUFFALO",ch3:"MIXED",CH1:"COW",CH2:"BUFFALO",CH3:"MIXED",COW:"COW",BUFFALO:"BUFFALO",MIXED:"MIXED",cow:"COW",buffalo:"BUFFALO",mixed:"MIXED",BUF:"BUFFALO",MIX:"MIXED"})[e]||e.toUpperCase();function $({globalSearch:e="",initialSocietyId:r=null,initialSocietyName:i=null,initialFromDate:n=null,initialToDate:l=null,initialBmcFilter:o=null,initialMachineFilter:d=null}){console.log("CollectionReports received props:",{initialSocietyId:r,initialSocietyName:i,initialFromDate:n,initialToDate:l,initialMachineFilter:d});let[h,v]=(0,a.useState)([]),[C,E]=(0,a.useState)([]),[$,D]=(0,a.useState)({totalCollections:0,totalQuantity:0,totalAmount:0,averageRate:0,weightedFat:0,weightedSnf:0,weightedClr:0}),[L,M]=(0,a.useState)(!0),[O,I]=(0,a.useState)("");(0,a.useEffect)(()=>{void 0!==e&&I(e)},[e]);let z=(0,a.useMemo)(()=>e||O,[e,O]),[B,P]=(0,a.useState)(""),[W,Q]=(0,a.useState)(""),[U,X]=(0,a.useState)(""),[V,q]=(0,a.useState)("all"),[G,Y]=(0,a.useState)("all"),[H,J]=(0,a.useState)([]),[K,Z]=(0,a.useState)([]),[ee,et]=(0,a.useState)([]),[ea,er]=(0,a.useState)([]),[ei,en]=(0,a.useState)([]),[el,es]=(0,a.useState)([]),[eo,ed]=(0,a.useState)([]),[ec,eh]=(0,a.useState)([]),[em,ex]=(0,a.useState)([]),[eg,eu]=(0,a.useState)([]),[ep,ey]=(0,a.useState)(!1),[ef,ew]=(0,a.useState)(null),[eS,eF]=(0,a.useState)(!1),[eb,ej]=(0,a.useState)(""),[ek,eN]=(0,a.useState)(""),[e_,ev]=(0,a.useState)(new Set),[eC,eE]=(0,a.useState)(!1),[eT,eA]=(0,a.useState)(!1),[eR,e$]=(0,a.useState)(!1),[eD,eL]=(0,a.useState)(""),[eM,eO]=(0,a.useState)(!1),[eI,ez]=(0,a.useState)("");(0,a.useEffect)(()=>{if(r){let e=ec.find(e=>e.society_id===r);if(e&&!ee.includes(e.id.toString())&&(et([e.id.toString()]),i)){let e=`Filter Applied: ${decodeURIComponent(i)}`;n&&l&&(e+=` • Date: ${n} to ${l}`),ej(e),setTimeout(()=>ej(""),5e3)}}},[ec]),(0,a.useEffect)(()=>{if(d&&em.length>0){let e=em.find(e=>e.machineId===d);e&&!ea.includes(e.id.toString())&&(console.log("Setting machineFilter to machine:",e.machineId,"ID:",e.id),er([e.id.toString()]),ej(`Filter Applied: Machine ${e.machineId}`),setTimeout(()=>ej(""),5e3))}},[em]),(0,a.useEffect)(()=>{n&&(console.log("Setting dateFromFilter to:",n),Q(n)),l&&(console.log("Setting dateToFilter to:",l),X(l)),o&&(console.log("Setting bmcFilter to:",o),Z([o]))},[n,l,o]),(0,a.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("/api/user/profile",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){let e=(await t.json()).email||"";ez(e)}}catch(e){console.error("Error fetching admin email:",e)}})()},[]),(0,a.useEffect)(()=>{console.log("Current filter states:",{dateFromFilter:W,dateToFilter:U,societyFilter:ee,recordsCount:h.length,filteredCount:C.length})},[W,U,ee,h.length,C.length]),(0,a.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("/api/user/dairy",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){let e=await t.json();es(e.data||[])}let a=await fetch("/api/user/bmc",{headers:{Authorization:`Bearer ${e}`}});if(a.ok){let e=await a.json();ed(e.data||[])}let r=await fetch("/api/user/society",{headers:{Authorization:`Bearer ${e}`}});if(r.ok){let e=await r.json();eh(e.data||[])}let i=await fetch("/api/user/machine",{headers:{Authorization:`Bearer ${e}`}});if(i.ok){let e=await i.json();ex(e.data||[])}let n=await fetch("/api/user/farmer",{headers:{Authorization:`Bearer ${e}`}});if(n.ok){let e=await n.json();eu(e.data||[])}}catch(e){console.error("Error fetching dairies/BMCs/societies/machines/farmers:",e)}})()},[]);let eB=(0,a.useMemo)(()=>{if(!el.length||!h.length)return el;let e=new Set(h.filter(e=>e.dairy_id).map(e=>e.dairy_id));return el.filter(t=>e.has(t.id))},[el,h]),eP=(0,a.useMemo)(()=>{if(!eo.length||!h.length)return eo;let e=new Set(h.filter(e=>e.bmc_id).map(e=>e.bmc_id));return eo.filter(t=>e.has(t.id))},[eo,h]),eW=(0,a.useMemo)(()=>{if(!h.length)return[];let e=new Set(h.filter(e=>e.society_id).map(e=>e.society_id));if(ec.length>0)return ec.filter(t=>e.has(t.society_id));let t=new Map;return h.forEach(e=>{e.society_id&&!t.has(e.society_id)&&t.set(e.society_id,{society_id:e.society_id,society_name:e.society_name||e.society_id})}),Array.from(t.values()).map((e,t)=>({id:t+1,name:e.society_name,society_id:e.society_id,bmc_id:void 0}))},[h,ec]),eQ=(0,a.useMemo)(()=>{if(!em.length||!h.length)return em;let e=new Set(h.filter(e=>e.machine_id).map(e=>e.machine_id));return em.filter(t=>e.has(t.machineId)).map(e=>({...e,collectionCount:h.filter(t=>t.machine_id===e.machineId).length}))},[em,h]),eU=(0,a.useMemo)(()=>{if(!eg.length||!h.length)return eg;let e=new Set(h.filter(e=>e.farmer_id).map(e=>e.farmer_id));return eg.filter(t=>e.has(t.farmerId))},[eg,h]),eX=async e=>{if(ef){eF(!0);try{let t=localStorage.getItem("authToken"),a=await fetch("/api/user/reports/collections/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({recordId:ef,password:e})}),r=await a.json();if(!a.ok)throw Error(r.error||"Failed to delete record");ej("Collection record deleted successfully"),setTimeout(()=>ej(""),5e3),eY()}catch(e){throw console.error("Delete error:",e),eN(e instanceof Error?e.message:"Failed to delete record"),setTimeout(()=>eN(""),5e3),e}finally{eF(!1),ew(null)}}},eV=()=>{ev(new Set),eE(!1)},eq=async e=>{eA(!1),e$(!0);try{let t=localStorage.getItem("authToken"),a=Array.from(e_).map(a=>fetch("/api/user/reports/collections/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({recordId:a,password:e})}).then(async e=>{if(!e.ok){let t=await e.json();throw Error(t.message||"Delete failed")}return e.json()})),r=await Promise.allSettled(a),i=r.filter(e=>"fulfilled"===e.status).length,n=r.filter(e=>"rejected"===e.status).length;if(i>0)ej(`Successfully deleted ${i} record(s)${n>0?`. ${n} failed.`:""}`),setTimeout(()=>ej(""),5e3),eY(),eV();else{let e=r.find(e=>"rejected"===e.status),t=e?.reason?.message||"Failed to delete selected records";eN(t),setTimeout(()=>eN(""),5e3)}}catch(e){console.error("Bulk delete error:",e),eN(e instanceof Error?e.message:"Failed to delete selected records"),setTimeout(()=>eN(""),5e3)}finally{e$(!1),eL("")}},eG=(0,a.useCallback)(e=>{let t=e.reduce((e,t)=>e+parseFloat(t.quantity||"0"),0),a=e.reduce((e,t)=>e+parseFloat(t.total_amount||"0"),0),r=e.reduce((e,t)=>e+parseFloat(t.rate_per_liter||"0"),0),i=e.length>0?r/e.length:0,n=e.reduce((e,t)=>e+parseFloat(t.quantity||"0")*parseFloat(t.fat_percentage||"0"),0),l=e.reduce((e,t)=>e+parseFloat(t.quantity||"0")*parseFloat(t.snf_percentage||"0"),0),s=e.reduce((e,t)=>e+parseFloat(t.quantity||"0")*parseFloat(t.clr_value||"0"),0),o=t>0?n/t:0,d=t>0?l/t:0,c=t>0?s/t:0;D({totalCollections:e.length,totalQuantity:parseFloat(t.toFixed(2)),totalAmount:parseFloat(a.toFixed(2)),averageRate:parseFloat(i.toFixed(2)),weightedFat:parseFloat(o.toFixed(2)),weightedSnf:parseFloat(d.toFixed(2)),weightedClr:parseFloat(c.toFixed(2))})},[]),eY=(0,a.useCallback)(async(e=!0)=>{let t=localStorage.getItem("authToken");if(t)try{e&&M(!0);let a=await fetch("/api/user/reports/collections",{headers:{Authorization:`Bearer ${t}`}});if(a.ok){let e=await a.json();v(t=>JSON.stringify(t)!==JSON.stringify(e)?(eG(e),e):t)}}catch(e){console.error("Error fetching collection data:",e)}finally{e&&M(!1)}},[eG]);(0,a.useEffect)(()=>{eY(!0);let e=setInterval(()=>{eY(!1)},1e3);return()=>clearInterval(e)},[eY]),(0,a.useEffect)(()=>{let e=h;if(H.length>0){let t=H.map(e=>{let t=el.find(t=>t.id.toString()===e);return t?.id}).filter(Boolean);t.length>0&&(e=e.filter(e=>void 0!==e.dairy_id&&t.includes(e.dairy_id)))}if(K.length>0){let t=K.map(e=>{let t=eo.find(t=>t.id.toString()===e);return t?.id}).filter(Boolean);t.length>0&&(e=e.filter(e=>void 0!==e.bmc_id&&t.includes(e.bmc_id)))}if("all"!==V&&(e="morning"===V?e.filter(e=>["MR","MX","morning"].includes(e.shift_type)):"evening"===V?e.filter(e=>["EV","EX","evening"].includes(e.shift_type)):e.filter(e=>e.shift_type===V)),Array.isArray(ee)&&ee.length>0){let t=ee.map(e=>{let t=eW.find(t=>t.id.toString()===e);return t?.society_id}).filter(Boolean);t.length>0&&(e=e.filter(e=>t.includes(e.society_id)))}if(ea.length>0){let t=ea.map(e=>eQ.find(t=>t.id.toString()===e)?.machineId).filter(Boolean);t.length>0&&(e=e.filter(e=>t.includes(e.machine_id)))}if(ei.length>0){let t=ei.map(e=>eU.find(t=>t.id.toString()===e)?.farmerId).filter(Boolean);t.length>0&&(e=e.filter(e=>t.includes(e.farmer_id)))}if("all"!==G&&(e=e.filter(e=>R(e.channel)===G)),B&&(e=e.filter(e=>e.collection_date===B)),W&&(e=e.filter(e=>e.collection_date>=W)),U&&(e=e.filter(e=>e.collection_date<=U)),z){let t=z.toLowerCase();e=e.filter(e=>{let a=["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"Morning":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"Evening":e.shift_type;return[e.farmer_id,e.farmer_name,e.society_id,e.society_name,e.bmc_name,e.dairy_name,e.machine_id,e.machine_type,e.machine_version,e.channel,R(e.channel),e.collection_date,e.collection_time,e.shift_type,a,e.quantity,e.fat_percentage,e.snf_percentage,e.clr_value,e.protein_percentage,e.lactose_percentage,e.salt_percentage,e.water_percentage,e.temperature,e.rate_per_liter,e.total_amount,e.bonus].some(e=>e?.toString().toLowerCase().includes(t))})}E(e),eG(e)},[e,O,B,W,U,V,G,ee,ea,ei,H,K,h,eW,eQ,eU,el,eo,eG]);let eH=async e=>{if(!e||!e.includes("@"))throw Error("Please enter a valid email address");try{let t=W&&U?`${W} To ${U}`:B||"All Dates",a=new Date().toLocaleString("en-IN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),r=C.map(e=>[e.collection_date,e.collection_time,e.channel,e.shift_type,`${e.machine_id} (${e.machine_type})`,e.society_name||"",e.farmer_id||"",e.farmer_name||"",e.fat_percentage,e.snf_percentage,e.clr_value,e.water_percentage,e.rate_per_liter,e.quantity,e.total_amount,e.bonus]),i=[["POORNASREE EQUIPMENTS MILK COLLECTION REPORT"],["Admin Report with Weighted Averages"],[],["Report Generated:",a],["Date Range:",t],["Total Collections:",$.totalCollections],["Total Quantity (L):",$.totalQuantity.toFixed(2)],["Total Amount (₹):",$.totalAmount.toFixed(2)],["Average Rate (₹/L):",$.averageRate.toFixed(2)],["Weighted FAT (%):",$.weightedFat.toFixed(2)],["Weighted SNF (%):",$.weightedSnf.toFixed(2)],["Weighted CLR:",$.weightedClr.toFixed(2)],[],["Date","Time","Channel","Shift","Machine","Society","Farmer ID","Farmer Name","Fat (%)","SNF (%)","CLR","Water (%)","Rate (₹/L)","Quantity (L)","Total Amount (₹)","Incentive"],...r].map(e=>e.join(",")).join("\n"),n=new f.default({orientation:"landscape",unit:"mm",format:"a4"});n.addImage("/fulllogo.png","PNG",14,8,0,12),n.setFontSize(14),n.setFont("helvetica","bold"),n.text("Daily Collection Report - LactoConnect Milk Collection System",148.5,15,{align:"center"}),n.setFontSize(9),n.setFont("helvetica","normal"),n.text(`Date From ${t}`,148.5,21,{align:"center"}),n.setFontSize(10),n.setFont("helvetica","bold"),n.text("DETAILED COLLECTION DATA",148.5,28,{align:"center"});let l=C.map((e,t)=>[(t+1).toString(),e.collection_date,e.collection_time,R(e.channel),e.shift_type,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.farmer_id,e.farmer_name||"",e.fat_percentage,e.snf_percentage,e.clr_value,e.water_percentage,e.rate_per_liter,e.quantity,e.total_amount,e.bonus]);(0,w.default)(n,{startY:32,head:[["SI No","Date","Time","Channel","Shift","Machine","Society","Farmer ID","Farmer Name","Fat (%)","SNF (%)","CLR","Water (%)","Rate","Quantity (L)","Total Amount","Incentive"]],body:l,theme:"grid",styles:{fontSize:6,cellPadding:1,halign:"center"},headStyles:{fillColor:[255,255,255],textColor:[0,0,0],fontStyle:"bold",fontSize:7,lineWidth:.5,lineColor:[0,0,0]},bodyStyles:{lineWidth:.3,lineColor:[200,200,200]},columnStyles:{0:{cellWidth:10},8:{halign:"left"}}});let s=n.lastAutoTable.finalY+8;n.setFontSize(11),n.setFont("helvetica","bold"),n.text("WEIGHTED AVERAGES",14,s),n.setFontSize(9),n.setFont("helvetica","normal");let o=s+6;n.text(`Weighted Fat      : ${$.weightedFat.toFixed(2)}`,14,o),o+=5,n.text(`Weighted SNF      : ${$.weightedSnf.toFixed(2)}`,14,o),o+=5,n.text(`Weighted CLR      : ${$.weightedClr.toFixed(2)}`,14,o),o+=8,n.setFont("helvetica","bold"),n.text("OVERALL SUMMARY",14,o),n.setFont("helvetica","normal"),o+=6,n.text(`Total Collections  : ${$.totalCollections}`,14,o),o+=5,n.text(`Total Quantity (L) : ${$.totalQuantity.toFixed(2)}`,14,o),o+=5,n.text(`Total Amount       : ${$.totalAmount.toFixed(2)}`,14,o),n.setFontSize(11),n.setFont("helvetica","bold"),n.text("REPORT NOTES",283,s,{align:"right"}),n.setFontSize(9),n.setFont("helvetica","normal");let d=s+6;n.text("Prepared by: POORNASREE EQUIPMENTS",283,d,{align:"right"}),d+=5,n.text("Contact: marketing@poornasree.com",283,d,{align:"right"}),d+=8,n.setFont("helvetica","bold"),n.text("POORNASREE EQUIPMENTS",283,d,{align:"right"}),n.setFont("helvetica","normal"),d+=5,n.text("Thank you for using LactoConnect",283,d,{align:"right"}),d+=5,n.text("For support, visit: www.poornasree.com",283,d,{align:"right"});let c=n.output("datauristring").split(",")[1],h=localStorage.getItem("authToken"),m=await fetch("/api/user/reports/send-email",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`},body:JSON.stringify({email:e,csvContent:i,pdfContent:c,reportType:"Collection Report",dateRange:t,stats:$})});if(!m.ok){let e=await m.json().catch(()=>({}));throw Error(e.error||"Failed to send email")}ej(`Report sent successfully to ${e}`),setTimeout(()=>ej(""),5e3)}catch(e){throw console.error("Error sending email:",e),e}};return L?(0,t.jsx)("div",{className:"flex items-center justify-center min-h-[400px]",children:(0,t.jsx)(F.FlowerSpinner,{size:48})}):(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-7 gap-3",children:[(0,t.jsx)(S.default,{title:"Total Collections",value:$.totalCollections,icon:(0,t.jsx)(s.Droplet,{className:"w-full h-full"}),color:"blue"}),(0,t.jsx)(S.default,{title:"Total Quantity (L)",value:$.totalQuantity,icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"green"}),(0,t.jsx)(S.default,{title:"Total Amount (₹)",value:`₹${$.totalAmount.toFixed(2)}`,icon:(0,t.jsx)(x.TrendingUp,{className:"w-full h-full"}),color:"yellow"}),(0,t.jsx)(S.default,{title:"Avg Rate (₹/L)",value:`₹${$.averageRate.toFixed(2)}`,icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"gray"}),(0,t.jsx)(S.default,{title:"Weighted FAT (%)",value:$.weightedFat.toFixed(2),icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"blue"}),(0,t.jsx)(S.default,{title:"Weighted SNF (%)",value:$.weightedSnf.toFixed(2),icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"green"}),(0,t.jsx)(S.default,{title:"Weighted CLR",value:$.weightedClr.toFixed(2),icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"red"})]}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Showing ",C.length," of ",h.length," records"]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)("button",{onClick:()=>{let e;q("all"),J([]),Z([]),et([]),er([]),en([]),P(""),Q(""),X(""),Y("all"),I(""),e=new CustomEvent("globalSearch",{detail:{query:""}}),window.dispatchEvent(e),eY()},className:"flex items-center justify-center gap-2 px-3 py-2 bg-psr-primary-600 text-white rounded-lg hover:bg-psr-primary-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(u.RefreshCw,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Refresh"})]}),(0,t.jsxs)("button",{onClick:()=>{if(0===C.length)return;let e=W&&U?`${W} To ${U}`:B||"All Dates",t=new Date().toLocaleString("en-IN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),a=new Blob([["Admin Report - LactoConnect Milk Collection System",`Date From ${e}`,"","DETAILED COLLECTION DATA","","Date,Time,Channel,Shift,Machine,Society,Farmer ID,Farmer Name,Fat (%),SNF (%),CLR,Water (%),Rate,Quantity (L),Total Amount,Incentive",...C.map(e=>[e.collection_date,e.collection_time,e.channel,e.shift_type,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.farmer_id,e.farmer_name,e.fat_percentage,e.snf_percentage,e.clr_value,e.water_percentage,e.rate_per_liter,e.quantity,e.total_amount,e.bonus]).map(e=>e.join(",")),"","","OVERALL SUMMARY",`Total Collections:,${$.totalCollections}`,`Total Quantity (L):,${$.totalQuantity.toFixed(2)}`,`Overall Weighted Fat (%):,${$.weightedFat.toFixed(2)}`,`Overall Weighted SNF (%):,${$.weightedSnf.toFixed(2)}`,`Overall Weighted CLR:,${$.weightedClr.toFixed(2)}`,`Total Amount (Rs):,${$.totalAmount.toFixed(2)}`,`Overall Average Rate (Rs/L):,${$.averageRate.toFixed(2)}`,"","Thank you","Poornasree Equipments",`Generated on: ${t}`].join("\n")],{type:"text/csv"}),r=window.URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=`collection-report-${new Date().toISOString().split("T")[0]}.csv`,i.click()},className:"flex items-center justify-center gap-2 px-3 py-2 bg-psr-green-600 text-white rounded-lg hover:bg-psr-green-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(c.Download,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"CSV"})]}),(0,t.jsxs)("button",{onClick:()=>{if(0===C.length)return;let e=new f.default({orientation:"landscape",unit:"mm",format:"a4"}),t=W&&U?`${W} To ${U}`:B?`${B} To ${B}`:"All Dates";e.addImage("/fulllogo.png","PNG",14,8,0,12),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Daily Collection Report - LactoConnect Milk Collection System",148.5,15,{align:"center"}),e.setFontSize(9),e.setFont("helvetica","normal"),e.text(`Date From ${t}`,148.5,21,{align:"center"}),e.setFontSize(10),e.setFont("helvetica","bold"),e.text("DETAILED COLLECTION DATA",148.5,28,{align:"center"});let a=C.map((e,t)=>[(t+1).toString(),e.collection_date,e.collection_time,R(e.channel),e.shift_type,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.farmer_id,e.farmer_name||"",e.fat_percentage,e.snf_percentage,e.clr_value,e.water_percentage,e.rate_per_liter,e.quantity,e.total_amount,e.bonus]);(0,w.default)(e,{startY:32,head:[["SI No","Date","Time","Channel","Shift","Machine","Society","Farmer ID","Farmer Name","Fat (%)","SNF (%)","CLR","Water (%)","Rate","Quantity (L)","Total Amount","Incentive"]],body:a,theme:"grid",styles:{fontSize:6,cellPadding:1,halign:"center"},headStyles:{fillColor:[255,255,255],textColor:[0,0,0],fontStyle:"bold",fontSize:7,lineWidth:.5,lineColor:[0,0,0]},bodyStyles:{lineWidth:.3,lineColor:[200,200,200]},columnStyles:{0:{cellWidth:10},8:{halign:"left"}}});let r=e.lastAutoTable.finalY+8;e.setFontSize(11),e.setFont("helvetica","bold"),e.text("WEIGHTED AVERAGES",14,r),e.setFontSize(9),e.setFont("helvetica","normal");let i=r+6;e.text(`Weighted Fat      : ${$.weightedFat.toFixed(2)}`,14,i),i+=5,e.text(`Weighted SNF      : ${$.weightedSnf.toFixed(2)}`,14,i),i+=5,e.text(`Weighted CLR      : ${$.weightedClr.toFixed(2)}`,14,i),i+=8,e.setFont("helvetica","bold"),e.text("OVERALL SUMMARY",14,i),e.setFont("helvetica","normal"),i+=6,e.text(`Total Collections  : ${$.totalCollections}`,14,i),i+=5,e.text(`Total Quantity (L) : ${$.totalQuantity.toFixed(2)}`,14,i),i+=5,e.text(`Total Amount       : ${$.totalAmount.toFixed(2)}`,14,i),e.setFontSize(11),e.setFont("helvetica","bold"),e.text("REPORT NOTES",283,r,{align:"right"}),e.setFontSize(9),e.setFont("helvetica","normal");let n=r+6;e.text("Prepared by: POORNASREE EQUIPMENTS",283,n,{align:"right"}),n+=5,e.text("Contact: marketing@poornasree.com",283,n,{align:"right"}),n+=8,e.setFont("helvetica","bold"),e.text("POORNASREE EQUIPMENTS",283,n,{align:"right"}),e.setFont("helvetica","normal"),n+=5,e.text("Thank you for using LactoConnect",283,n,{align:"right"}),n+=5,e.text("For support, visit: www.poornasree.com",283,n,{align:"right"}),e.save(`collection-report-${new Date().toISOString().split("T")[0]}.pdf`)},className:"flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(m,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"PDF"})]}),(0,t.jsxs)("button",{onClick:()=>eO(!0),className:"flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(y.Mail,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Send Mail"})]})]})]}),(0,t.jsx)(b.FilterDropdown,{statusFilter:V,onStatusChange:q,dairyFilter:H,onDairyChange:e=>J(Array.isArray(e)?e:[e]),bmcFilter:K,onBmcChange:e=>Z(Array.isArray(e)?e:[e]),societyFilter:ee,onSocietyChange:e=>et(Array.isArray(e)?e:[e]),machineFilter:ea,onMachineChange:e=>er(Array.isArray(e)?e:[e]),farmerFilter:ei,onFarmerChange:e=>en(Array.isArray(e)?e:[e]),dairies:eB,bmcs:eP,societies:eW,machines:eQ,farmers:eU,filteredCount:C.length,totalCount:h.length,searchQuery:O,onSearchChange:I,icon:(0,t.jsx)(s.Droplet,{className:"w-5 h-5"}),dateFilter:B,onDateChange:P,dateFromFilter:W,onDateFromChange:Q,dateToFilter:U,onDateToChange:X,channelFilter:G,onChannelChange:Y,showDateFilter:!0,showChannelFilter:!0,showShiftFilter:!0,showMachineFilter:!0,hideMainFilterButton:!0})]})}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden",children:(0,t.jsx)("div",{className:"overflow-auto max-h-[600px]",tabIndex:0,children:(0,t.jsxs)("table",{className:"w-auto min-w-full table-auto",children:[(0,t.jsx)("thead",{className:"bg-gray-50 dark:bg-gray-700 sticky top-0 z-10",children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"px-4 py-3 text-center",children:(0,t.jsx)("input",{type:"checkbox",checked:eC,onChange:()=>{eC?(ev(new Set),eE(!1)):(ev(new Set(C.map(e=>e.id))),eE(!0))},className:"w-4 h-4 text-emerald-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-emerald-500 dark:focus:ring-emerald-400 cursor-pointer"})}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Date & Time"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Farmer"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Society"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Machine"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Shift"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Channel"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Fat %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"SNF %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"CLR"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Protein %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Lactose %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Salt %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Water %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Temp (°C)"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Rate/L"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Bonus"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Qty (L)"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Amount"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Action"})]})}),(0,t.jsx)("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:0===C.length?(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:20,className:"px-4 py-8 text-center text-gray-500 dark:text-gray-400",children:"No collection records found"})}):C.map(e=>(0,t.jsxs)("tr",{className:`transition-colors ${e_.has(e.id)?"bg-emerald-50 dark:bg-emerald-900/20 hover:bg-emerald-100 dark:hover:bg-emerald-900/30":"hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[(0,t.jsx)("td",{className:"px-4 py-3 text-center",children:(0,t.jsx)("input",{type:"checkbox",checked:e_.has(e.id),onChange:()=>{var t;let a;return t=e.id,void((a=new Set(e_)).has(t)?a.delete(t):a.add(t),ev(a),eE(a.size===C.length&&C.length>0))},className:"w-4 h-4 text-emerald-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-emerald-500 dark:focus:ring-emerald-400 cursor-pointer"})}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{children:A(e.collection_date,z)}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:e.collection_time})]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{className:"font-medium",children:A(e.farmer_name,z)}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["ID: ",A(e.farmer_id,z)]})]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{className:"font-medium",children:A(e.society_name,z)}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["ID: ",A(e.society_id,z)]})]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{className:"font-medium",children:A(e.machine_id,z)}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:A(e.machine_type,z)})]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${["MR","MX","morning"].includes(e.shift_type?.toUpperCase()==="MORNING"?"morning":e.shift_type)?"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400":["EV","EX","evening"].includes(e.shift_type?.toUpperCase()==="EVENING"?"evening":e.shift_type)?"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400":"bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400"}`,children:A(["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"Morning":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"Evening":e.shift_type,z)})}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${"COW"===R(e.channel)?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400":"BUFFALO"===R(e.channel)?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"}`,children:A(R(e.channel),z)})}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.fat_percentage).toFixed(2),z)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.snf_percentage).toFixed(2),z)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.clr_value).toFixed(2),z)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.protein_percentage).toFixed(2),z)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.lactose_percentage).toFixed(2),z)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.salt_percentage).toFixed(2),z)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.water_percentage).toFixed(2),z)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:A(parseFloat(e.temperature).toFixed(2),z)}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:["₹",A(parseFloat(e.rate_per_liter).toFixed(2),z)]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:["₹",A(parseFloat(e.bonus).toFixed(2),z)]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center font-medium text-gray-900 dark:text-white",children:A(parseFloat(e.quantity).toFixed(2),z)}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center font-medium text-green-600 dark:text-green-400",children:["₹",A(parseFloat(e.total_amount).toFixed(2),z)]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("button",{onClick:()=>{ew(e.id),ey(!0)},className:"p-1 text-red-600 hover:text-red-800 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:"Delete record",children:(0,t.jsx)(p.Trash2,{className:"w-4 h-4"})})})]},e.id))})]})})}),(0,t.jsx)(_.default,{isOpen:ep,onClose:()=>ey(!1),onConfirm:eX,title:"Delete Collection Record",message:"Enter your admin password to confirm deletion. This action cannot be undone and will be logged for security purposes."}),(0,t.jsx)(_.default,{isOpen:eT,onClose:()=>{eA(!1),eL("")},onConfirm:eq,title:`Delete ${e_.size} Collection Record${e_.size>1?"s":""}`,message:`Enter your admin password to confirm deletion of ${e_.size} selected record(s). This action cannot be undone and will be logged for security purposes.`}),(0,t.jsx)(N.BulkActionsToolbar,{selectedCount:e_.size,totalCount:C.length,onBulkDelete:()=>{0!==e_.size&&eA(!0)},onClearSelection:eV,itemType:"record",showStatusUpdate:!1}),(0,t.jsx)(j.LoadingSnackbar,{isVisible:eS||eR,message:eR?`Deleting ${e_.size} Records`:"Deleting Record",submessage:"Verifying credentials and removing data...",showProgress:!1}),(0,t.jsx)(T,{isOpen:eM,onClose:()=>eO(!1),onSend:eH,defaultEmail:eI,recordCount:C.length,reportType:"Collection Report"}),(0,t.jsx)(k.StatusMessage,{success:eb,error:ek,onClose:()=>{ej(""),eN("")}})]})}let D=(0,h.default)("package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]),L=(e,a)=>{if(!e&&0!==e)return e||"";if(!a)return e;let r=e.toString(),i=RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return r.split(i).map((e,a)=>i.test(e)?(0,t.jsx)("span",{className:"bg-yellow-200 dark:bg-yellow-800 px-0.5 rounded",children:e},a):e)},M=e=>({ch1:"COW",ch2:"BUFFALO",ch3:"MIXED",CH1:"COW",CH2:"BUFFALO",CH3:"MIXED",COW:"COW",BUFFALO:"BUFFALO",MIXED:"MIXED",cow:"COW",buffalo:"BUFFALO",mixed:"MIXED",BUF:"BUFFALO",MIX:"MIXED"})[e]||e.toUpperCase();function O({globalSearch:e=""}){let[r,i]=(0,a.useState)([]),[n,l]=(0,a.useState)([]),[s,d]=(0,a.useState)({totalDispatches:0,totalQuantity:0,totalAmount:0,averageRate:0,weightedFat:0,weightedSnf:0,weightedClr:0}),[h,v]=(0,a.useState)(!0),[C,E]=(0,a.useState)("");(0,a.useEffect)(()=>{void 0!==e&&E(e)},[e]);let A=(0,a.useMemo)(()=>e||C,[e,C]),[R,$]=(0,a.useState)(""),[O,I]=(0,a.useState)(""),[z,B]=(0,a.useState)(""),[P,W]=(0,a.useState)("all"),[Q,U]=(0,a.useState)("all"),[X,V]=(0,a.useState)([]),[q,G]=(0,a.useState)([]),[Y,H]=(0,a.useState)([]),[J,K]=(0,a.useState)([]),[Z,ee]=(0,a.useState)([]),[et,ea]=(0,a.useState)([]),[er,ei]=(0,a.useState)(!1),[en,el]=(0,a.useState)(null),[es,eo]=(0,a.useState)(!1),[ed,ec]=(0,a.useState)(""),[eh,em]=(0,a.useState)(""),[ex,eg]=(0,a.useState)(new Set),[eu,ep]=(0,a.useState)(!1),[ey,ef]=(0,a.useState)(!1),[ew,eS]=(0,a.useState)(!1),[eF,eb]=(0,a.useState)(""),[ej,ek]=(0,a.useState)(!1),[eN,e_]=(0,a.useState)(""),[ev,eC]=(0,a.useState)([]),[eE,eT]=(0,a.useState)([]);(0,a.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("/api/user/dairy",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){let e=await t.json();ee(e.data||[])}let a=await fetch("/api/user/bmc",{headers:{Authorization:`Bearer ${e}`}});if(a.ok){let e=await a.json();ea(e.data||[])}let r=await fetch("/api/user/society",{headers:{Authorization:`Bearer ${e}`}});if(r.ok){let e=await r.json();eC(e.data||[])}let i=await fetch("/api/user/machine",{headers:{Authorization:`Bearer ${e}`}});if(i.ok){let e=await i.json();eT(e.data||[])}}catch(e){console.error("Error fetching dairies/BMCs/Societies/Machines:",e)}})()},[]);let eA=(0,a.useMemo)(()=>{if(!Z.length||!r.length)return Z;let e=new Set(r.filter(e=>e.dairy_id).map(e=>e.dairy_id));return Z.filter(t=>e.has(t.id))},[Z,r]),eR=async e=>{if(en){eo(!0);try{let t=localStorage.getItem("authToken"),a=await fetch("/api/user/reports/dispatches/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({recordId:en,password:e})}),r=await a.json();if(!a.ok)throw Error(r.error||"Failed to delete record");ec("Dispatch record deleted successfully"),setTimeout(()=>ec(""),5e3),eI()}catch(e){throw console.error("Delete error:",e),em(e instanceof Error?e.message:"Failed to delete record"),setTimeout(()=>em(""),5e3),e}finally{eo(!1),el(null)}}},e$=()=>{eg(new Set),ep(!1)},eD=async e=>{ef(!1),eS(!0);try{let t=localStorage.getItem("authToken"),a=Array.from(ex).map(a=>fetch("/api/user/reports/dispatches/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({recordId:a,password:e})}).then(async e=>{if(!e.ok){let t=await e.json();throw Error(t.message||"Delete failed")}return e.json()})),r=await Promise.allSettled(a),i=r.filter(e=>"fulfilled"===e.status).length,n=r.filter(e=>"rejected"===e.status).length;if(i>0)ec(`Successfully deleted ${i} record(s)${n>0?`. ${n} failed.`:""}`),setTimeout(()=>ec(""),5e3),eI(),e$();else{let e=r.find(e=>"rejected"===e.status),t=e?.reason?.message||"Failed to delete selected records";em(t),setTimeout(()=>em(""),5e3)}}catch(e){console.error("Bulk delete error:",e),em(e instanceof Error?e.message:"Failed to delete selected records"),setTimeout(()=>em(""),5e3)}finally{eS(!1),eb("")}},eL=(0,a.useMemo)(()=>{if(!ev.length||!r.length)return ev;let e=new Set(r.filter(e=>e.society_id).map(e=>e.society_id));return ev.filter(t=>e.has(t.society_id))},[ev,r]),eM=(0,a.useMemo)(()=>{if(!eE.length||!r.length)return eE;let e=new Set(r.filter(e=>e.machine_id).map(e=>e.machine_id));return eE.filter(t=>e.has(t.machineId)).map(e=>({...e,collectionCount:r.filter(t=>t.machine_id===e.machineId).length}))},[eE,r]),eO=(0,a.useCallback)(e=>{let t=e.reduce((e,t)=>e+parseFloat(t.quantity||"0"),0),a=e.reduce((e,t)=>e+parseFloat(t.total_amount||"0"),0),r=e.reduce((e,t)=>e+parseFloat(t.rate_per_liter||"0"),0),i=e.length>0?r/e.length:0,n=e.reduce((e,t)=>e+parseFloat(t.quantity||"0")*parseFloat(t.fat_percentage||"0"),0),l=e.reduce((e,t)=>e+parseFloat(t.quantity||"0")*parseFloat(t.snf_percentage||"0"),0),s=e.reduce((e,t)=>e+parseFloat(t.quantity||"0")*parseFloat(t.clr_value||"0"),0),o=t>0?n/t:0,c=t>0?l/t:0,h=t>0?s/t:0;d({totalDispatches:e.length,totalQuantity:parseFloat(t.toFixed(2)),totalAmount:parseFloat(a.toFixed(2)),averageRate:parseFloat(i.toFixed(2)),weightedFat:parseFloat(o.toFixed(2)),weightedSnf:parseFloat(c.toFixed(2)),weightedClr:parseFloat(h.toFixed(2))})},[]),eI=(0,a.useCallback)(async(e=!0)=>{let t=localStorage.getItem("authToken");if(t)try{e&&v(!0);let a=await fetch("/api/user/reports/dispatches",{headers:{Authorization:`Bearer ${t}`}});if(a.ok){let e=await a.json();i(t=>JSON.stringify(t)!==JSON.stringify(e)?(eO(e),e):t)}}catch(e){console.error("Error fetching dispatch data:",e)}finally{e&&v(!1)}},[eO]);(0,a.useEffect)(()=>{eI(!0);let e=setInterval(()=>{eI(!1)},1e3);return()=>clearInterval(e)},[eI]),(0,a.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("/api/user/profile",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){let e=(await t.json()).email||"";e_(e)}}catch(e){console.error("Error fetching admin email:",e)}})()},[]),(0,a.useEffect)(()=>{let e=r;if(X.length>0){let t=X.map(e=>Z.find(t=>t.id.toString()===e)?.id).filter(Boolean);t.length>0&&(e=e.filter(e=>e.dairy_id&&t.includes(e.dairy_id)))}if(q.length>0){let t=q.map(e=>et.find(t=>t.id.toString()===e)?.id).filter(Boolean);t.length>0&&(e=e.filter(e=>e.bmc_id&&t.includes(e.bmc_id)))}if("all"!==P&&(e="morning"===P?e.filter(e=>["MR","MX","morning"].includes(e.shift_type)):"evening"===P?e.filter(e=>["EV","EX","evening"].includes(e.shift_type)):e.filter(e=>e.shift_type===P)),Array.isArray(Y)&&Y.length>0){let t=Y.map(e=>{let t=eL.find(t=>t.id.toString()===e);return t?.society_id}).filter(Boolean);t.length>0&&(e=e.filter(e=>t.includes(e.society_id)))}if(J.length>0){let t=J.map(e=>eM.find(t=>t.id.toString()===e)?.machineId).filter(Boolean);t.length>0&&(e=e.filter(e=>t.includes(e.machine_id)))}if("all"!==Q&&(e=e.filter(e=>M(e.channel)===Q)),R&&(e=e.filter(e=>e.dispatch_date===R)),O&&(e=e.filter(e=>e.dispatch_date>=O)),z&&(e=e.filter(e=>e.dispatch_date<=z)),A){let t=A.toLowerCase();e=e.filter(e=>{let a=["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"Morning":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"Evening":e.shift_type;return[e.dispatch_id,e.society_id,e.society_name,e.bmc_name,e.dairy_name,e.machine_id,e.machine_type,e.machine_version,e.channel,M(e.channel),e.dispatch_date,e.dispatch_time,e.shift_type,a,e.quantity,e.fat_percentage,e.snf_percentage,e.clr_value,e.rate_per_liter,e.total_amount].some(e=>e?.toString().toLowerCase().includes(t))})}l(e),eO(e)},[e,C,R,O,z,P,Q,Y,J,X,q,r,eL,eM,Z,et,eO]);let ez=async e=>{if(!e||!e.includes("@"))throw Error("Please enter a valid email address");try{let t=O&&z?`${O} To ${z}`:R||"All Dates",a=new Date().toLocaleString("en-IN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),r=n.map(e=>[e.dispatch_date,e.dispatch_time,e.channel,e.shift_type,`${e.machine_id} (${e.machine_type})`,e.society_name||"",e.fat_percentage,e.snf_percentage,e.clr_value,e.rate_per_liter,e.quantity,e.total_amount]),i=[["POORNASREE EQUIPMENTS MILK DISPATCH REPORT"],["Admin Report with Weighted Averages"],[],["Report Generated:",a],["Date Range:",t],["Total Dispatches:",s.totalDispatches],["Total Quantity (L):",s.totalQuantity.toFixed(2)],["Total Amount (₹):",s.totalAmount.toFixed(2)],["Average Rate (₹/L):",s.averageRate.toFixed(2)],["Weighted FAT (%):",s.weightedFat.toFixed(2)],["Weighted SNF (%):",s.weightedSnf.toFixed(2)],["Weighted CLR:",s.weightedClr.toFixed(2)],[],["Date","Time","Channel","Shift","Machine","Society","Fat (%)","SNF (%)","CLR","Rate (₹/L)","Quantity (L)","Total Amount (₹)"],...r].map(e=>e.join(",")).join("\n"),l=new f.default({orientation:"landscape",unit:"mm",format:"a4"});l.addImage("/fulllogo.png","PNG",14,8,0,12),l.setFontSize(14),l.setFont("helvetica","bold"),l.text("Daily Dispatch Report - LactoConnect Milk Dispatch System",148.5,15,{align:"center"}),l.setFontSize(9),l.setFont("helvetica","normal"),l.text(`Date From ${t}`,148.5,21,{align:"center"}),l.setFontSize(10),l.setFont("helvetica","bold"),l.text("DETAILED DISPATCH DATA",148.5,28,{align:"center"});let o=n.map((e,t)=>[(t+1).toString(),e.dispatch_date,e.dispatch_time,M(e.channel),e.shift_type,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.fat_percentage,e.snf_percentage,e.clr_value,e.rate_per_liter,e.quantity,e.total_amount]);(0,w.default)(l,{startY:32,head:[["SI No","Date","Time","Channel","Shift","Machine","Society","Fat (%)","SNF (%)","CLR","Rate","Quantity (L)","Total Amount"]],body:o,theme:"grid",styles:{fontSize:7,cellPadding:1.5,halign:"center"},headStyles:{fillColor:[255,255,255],textColor:[0,0,0],fontStyle:"bold",fontSize:8,lineWidth:.5,lineColor:[0,0,0]},bodyStyles:{lineWidth:.3,lineColor:[200,200,200]},columnStyles:{0:{cellWidth:12}}});let d=l.lastAutoTable.finalY+8;l.setFontSize(11),l.setFont("helvetica","bold"),l.text("WEIGHTED AVERAGES",14,d),l.setFontSize(9),l.setFont("helvetica","normal");let c=d+6;l.text(`Weighted Fat      : ${s.weightedFat.toFixed(2)}`,14,c),c+=5,l.text(`Weighted SNF      : ${s.weightedSnf.toFixed(2)}`,14,c),c+=5,l.text(`Weighted CLR      : ${s.weightedClr.toFixed(2)}`,14,c),c+=8,l.setFont("helvetica","bold"),l.text("OVERALL SUMMARY",14,c),l.setFont("helvetica","normal"),c+=6,l.text(`Total Dispatches   : ${s.totalDispatches}`,14,c),c+=5,l.text(`Total Quantity (L) : ${s.totalQuantity.toFixed(2)}`,14,c),c+=5,l.text(`Total Amount       : ${s.totalAmount.toFixed(2)}`,14,c),l.setFontSize(11),l.setFont("helvetica","bold"),l.text("REPORT NOTES",283,d,{align:"right"}),l.setFontSize(9),l.setFont("helvetica","normal");let h=d+6;l.text("Prepared by: POORNASREE EQUIPMENTS",283,h,{align:"right"}),h+=5,l.text("Contact: marketing@poornasree.com",283,h,{align:"right"}),h+=8,l.setFont("helvetica","bold"),l.text("POORNASREE EQUIPMENTS",283,h,{align:"right"}),l.setFont("helvetica","normal"),h+=5,l.text("Thank you for using LactoConnect",283,h,{align:"right"}),h+=5,l.text("For support, visit: www.poornasree.com",283,h,{align:"right"});let m=l.output("datauristring").split(",")[1],x=localStorage.getItem("authToken"),g=await fetch("/api/user/reports/send-email",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${x}`},body:JSON.stringify({email:e,csvContent:i,pdfContent:m,reportType:"Dispatch Report",dateRange:t,stats:s})});if(!g.ok){let e=await g.json().catch(()=>({}));throw Error(e.error||"Failed to send email")}ec(`Report sent successfully to ${e}`),setTimeout(()=>ec(""),5e3)}catch(e){throw console.error("Error sending email:",e),e}};return h?(0,t.jsx)("div",{className:"flex items-center justify-center min-h-[400px]",children:(0,t.jsx)(F.FlowerSpinner,{size:48})}):(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-7 gap-3",children:[(0,t.jsx)(S.default,{title:"Total Dispatches",value:s.totalDispatches,icon:(0,t.jsx)(o.Truck,{className:"w-full h-full"}),color:"green"}),(0,t.jsx)(S.default,{title:"Total Quantity (L)",value:s.totalQuantity,icon:(0,t.jsx)(D,{className:"w-full h-full"}),color:"blue"}),(0,t.jsx)(S.default,{title:"Total Amount (₹)",value:`₹${s.totalAmount.toFixed(2)}`,icon:(0,t.jsx)(x.TrendingUp,{className:"w-full h-full"}),color:"yellow"}),(0,t.jsx)(S.default,{title:"Avg Rate (₹/L)",value:`₹${s.averageRate.toFixed(2)}`,icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"gray"}),(0,t.jsx)(S.default,{title:"Weighted FAT (%)",value:s.weightedFat.toFixed(2),icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"blue"}),(0,t.jsx)(S.default,{title:"Weighted SNF (%)",value:s.weightedSnf.toFixed(2),icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"green"}),(0,t.jsx)(S.default,{title:"Weighted CLR",value:s.weightedClr.toFixed(2),icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"red"})]}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Showing ",n.length," of ",r.length," records"]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)("button",{onClick:()=>{let e;W("all"),V([]),G([]),H([]),K([]),$(""),I(""),B(""),U("all"),E(""),e=new CustomEvent("globalSearch",{detail:{query:""}}),window.dispatchEvent(e),eI()},className:"flex items-center justify-center gap-2 px-3 py-2 bg-psr-primary-600 text-white rounded-lg hover:bg-psr-primary-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(u.RefreshCw,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Refresh"})]}),(0,t.jsxs)("button",{onClick:()=>{if(0===n.length)return;let e=O&&z?`${O} To ${z}`:R||"All Dates",t=new Date().toLocaleString("en-IN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),a=new Blob([["Admin Report - LactoConnect Milk Dispatch System",`Date From ${e}`,"","DETAILED DISPATCH DATA","","Date,Time,Channel,Shift,Machine,Society,Fat (%),SNF (%),CLR,Rate,Quantity (L),Total Amount",...n.map(e=>[e.dispatch_date,e.dispatch_time,e.channel,e.shift_type,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.fat_percentage,e.snf_percentage,e.clr_value,e.rate_per_liter,e.quantity,e.total_amount]).map(e=>e.join(",")),"","","OVERALL SUMMARY",`Total Dispatches:,${s.totalDispatches}`,`Total Quantity (L):,${s.totalQuantity.toFixed(2)}`,`Overall Weighted Fat (%):,${s.weightedFat.toFixed(2)}`,`Overall Weighted SNF (%):,${s.weightedSnf.toFixed(2)}`,`Overall Weighted CLR:,${s.weightedClr.toFixed(2)}`,`Total Amount (Rs):,${s.totalAmount.toFixed(2)}`,`Overall Average Rate (Rs/L):,${s.averageRate.toFixed(2)}`,"","Thank you","Poornasree Equipments",`Generated on: ${t}`].join("\n")],{type:"text/csv"}),r=window.URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=`dispatch-report-${new Date().toISOString().split("T")[0]}.csv`,i.click()},className:"flex items-center justify-center gap-2 px-3 py-2 bg-psr-green-600 text-white rounded-lg hover:bg-psr-green-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(c.Download,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"CSV"})]}),(0,t.jsxs)("button",{onClick:()=>{if(0===n.length)return;let e=new f.default({orientation:"landscape",unit:"mm",format:"a4"}),t=O&&z?`${O} To ${z}`:R?`${R} To ${R}`:"All Dates";e.addImage("/fulllogo.png","PNG",14,8,0,12),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Daily Dispatch Report - LactoConnect Milk Dispatch System",148.5,15,{align:"center"}),e.setFontSize(9),e.setFont("helvetica","normal"),e.text(`Date From ${t}`,148.5,21,{align:"center"}),e.setFontSize(10),e.setFont("helvetica","bold"),e.text("DETAILED DISPATCH DATA",148.5,28,{align:"center"});let a=n.map((e,t)=>[(t+1).toString(),e.dispatch_date,e.dispatch_time,M(e.channel),e.shift_type,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.fat_percentage,e.snf_percentage,e.clr_value,e.rate_per_liter,e.quantity,e.total_amount]);(0,w.default)(e,{startY:32,head:[["SI No","Date","Time","Channel","Shift","Machine","Society","Fat (%)","SNF (%)","CLR","Rate","Quantity (L)","Total Amount"]],body:a,theme:"grid",styles:{fontSize:7,cellPadding:1.5,halign:"center"},headStyles:{fillColor:[255,255,255],textColor:[0,0,0],fontStyle:"bold",fontSize:8,lineWidth:.5,lineColor:[0,0,0]},bodyStyles:{lineWidth:.3,lineColor:[200,200,200]},columnStyles:{0:{cellWidth:12}}});let r=e.lastAutoTable.finalY+8;e.setFontSize(11),e.setFont("helvetica","bold"),e.text("WEIGHTED AVERAGES",14,r),e.setFontSize(9),e.setFont("helvetica","normal");let i=r+6;e.text(`Weighted Fat      : ${s.weightedFat.toFixed(2)}`,14,i),i+=5,e.text(`Weighted SNF      : ${s.weightedSnf.toFixed(2)}`,14,i),i+=5,e.text(`Weighted CLR      : ${s.weightedClr.toFixed(2)}`,14,i),i+=8,e.setFont("helvetica","bold"),e.text("OVERALL SUMMARY",14,i),e.setFont("helvetica","normal"),i+=6,e.text(`Total Dispatches   : ${s.totalDispatches}`,14,i),i+=5,e.text(`Total Quantity (L) : ${s.totalQuantity.toFixed(2)}`,14,i),i+=5,e.text(`Total Amount       : ${s.totalAmount.toFixed(2)}`,14,i),e.setFontSize(11),e.setFont("helvetica","bold"),e.text("REPORT NOTES",283,r,{align:"right"}),e.setFontSize(9),e.setFont("helvetica","normal");let l=r+6;e.text("Prepared by: POORNASREE EQUIPMENTS",283,l,{align:"right"}),l+=5,e.text("Contact: marketing@poornasree.com",283,l,{align:"right"}),l+=8,e.setFont("helvetica","bold"),e.text("POORNASREE EQUIPMENTS",283,l,{align:"right"}),e.setFont("helvetica","normal"),l+=5,e.text("Thank you for using LactoConnect",283,l,{align:"right"}),l+=5,e.text("For support, visit: www.poornasree.com",283,l,{align:"right"}),e.save(`dispatch-report-${new Date().toISOString().split("T")[0]}.pdf`)},className:"flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(m,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"PDF"})]}),(0,t.jsxs)("button",{onClick:()=>ek(!0),className:"flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(y.Mail,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Send Mail"})]})]})]}),(0,t.jsx)(b.FilterDropdown,{statusFilter:P,onStatusChange:W,dairyFilter:X,onDairyChange:e=>V(Array.isArray(e)?e:[e]),bmcFilter:q,onBmcChange:e=>G(Array.isArray(e)?e:[e]),societyFilter:Y,onSocietyChange:e=>H(Array.isArray(e)?e:[e]),machineFilter:J,onMachineChange:e=>K(Array.isArray(e)?e:[e]),dairies:eA,bmcs:et,societies:eL,machines:eM,filteredCount:n.length,totalCount:r.length,searchQuery:C,onSearchChange:E,icon:(0,t.jsx)(o.Truck,{className:"w-5 h-5"}),dateFilter:R,onDateChange:$,dateFromFilter:O,onDateFromChange:I,dateToFilter:z,onDateToChange:B,channelFilter:Q,onChannelChange:U,showDateFilter:!0,showChannelFilter:!0,showShiftFilter:!0,showMachineFilter:!0,hideMainFilterButton:!0})]})}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden",children:(0,t.jsx)("div",{className:"overflow-auto max-h-[600px]",tabIndex:0,children:(0,t.jsxs)("table",{className:"w-auto min-w-full table-auto",children:[(0,t.jsx)("thead",{className:"bg-gray-50 dark:bg-gray-700 sticky top-0 z-10",children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"px-4 py-3 text-center",children:(0,t.jsx)("input",{type:"checkbox",checked:eu,onChange:()=>{eu?(eg(new Set),ep(!1)):(eg(new Set(n.map(e=>e.id))),ep(!0))},className:"w-4 h-4 text-emerald-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-emerald-500 dark:focus:ring-emerald-400 cursor-pointer"})}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Date & Time"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Dispatch ID"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Society"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Shift"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Channel"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Machine"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Fat %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"SNF %"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"CLR"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Rate/L"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Qty (L)"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Amount"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Action"})]})}),(0,t.jsx)("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:0===n.length?(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:14,className:"px-4 py-8 text-center text-gray-500 dark:text-gray-400",children:"No dispatch records found"})}):n.map(e=>(0,t.jsx)(a.default.Fragment,{children:(0,t.jsxs)("tr",{className:`transition-colors ${ex.has(e.id)?"bg-emerald-50 dark:bg-emerald-900/20 hover:bg-emerald-100 dark:hover:bg-emerald-900/30":"hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[(0,t.jsx)("td",{className:"px-4 py-3 text-center",children:(0,t.jsx)("input",{type:"checkbox",checked:ex.has(e.id),onChange:()=>{var t;let a;return t=e.id,void((a=new Set(ex)).has(t)?a.delete(t):a.add(t),eg(a),ep(a.size===n.length&&n.length>0))},className:"w-4 h-4 text-emerald-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-emerald-500 dark:focus:ring-emerald-400 cursor-pointer"})}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{children:L(e.dispatch_date,A)}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:e.dispatch_time})]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center font-medium text-gray-900 dark:text-white",children:L(e.dispatch_id,A)}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{className:"font-medium",children:L(e.society_name,A)}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["ID: ",L(e.society_id,A)]})]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400":"bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400"}`,children:L(["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"Morning":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"Evening":e.shift_type,A)})}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${"COW"===M(e.channel)?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400":"BUFFALO"===M(e.channel)?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"}`,children:L(M(e.channel),A)})}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{className:"font-medium",children:L(e.machine_id||"N/A",A)}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:L(e.machine_type,A)})]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:L(parseFloat(e.fat_percentage).toFixed(2),A)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:L(parseFloat(e.snf_percentage).toFixed(2),A)}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:L(parseFloat(e.clr_value).toFixed(2),A)}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:["₹",L(parseFloat(e.rate_per_liter).toFixed(2),A)]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center font-medium text-gray-900 dark:text-white",children:L(parseFloat(e.quantity).toFixed(2),A)}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center font-medium text-green-600 dark:text-green-400",children:["₹",L(parseFloat(e.total_amount).toFixed(2),A)]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("button",{onClick:()=>{el(e.id),ei(!0)},className:"p-1 text-red-600 hover:text-red-800 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:"Delete record",children:(0,t.jsx)(p.Trash2,{className:"w-4 h-4"})})})]})},e.id))})]})})}),(0,t.jsx)(_.default,{isOpen:er,onClose:()=>ei(!1),onConfirm:eR,title:"Delete Dispatch Record",message:"Enter your admin password to confirm deletion. This action cannot be undone and will be logged for security purposes."}),(0,t.jsx)(_.default,{isOpen:ey,onClose:()=>{ef(!1),eb("")},onConfirm:eD,title:`Delete ${ex.size} Dispatch Record${ex.size>1?"s":""}`,message:`Enter your admin password to confirm deletion of ${ex.size} selected record(s). This action cannot be undone and will be logged for security purposes.`}),(0,t.jsx)(N.BulkActionsToolbar,{selectedCount:ex.size,totalCount:n.length,onBulkDelete:()=>{0!==ex.size&&ef(!0)},onClearSelection:e$,itemType:"record",showStatusUpdate:!1}),(0,t.jsx)(j.LoadingSnackbar,{isVisible:es||ew,message:ew?`Deleting ${ex.size} Records`:"Deleting Record",submessage:"Verifying credentials and removing data...",showProgress:!1}),(0,t.jsx)(T,{isOpen:ej,onClose:()=>ek(!1),onSend:ez,defaultEmail:eN,recordCount:n.length,reportType:"Dispatch Report"}),(0,t.jsx)(k.StatusMessage,{success:ed,error:eh,onClose:()=>{ec(""),em("")}})]})}var I=e.i(201928);let z=(e,a)=>{if(!e&&0!==e)return e||"";if(!a)return e;let r=e.toString(),i=RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return r.split(i).map((e,a)=>i.test(e)?(0,t.jsx)("span",{className:"bg-yellow-200 dark:bg-yellow-800 px-0.5 rounded",children:e},a):e)},B=e=>({ch1:"COW",ch2:"BUFFALO",ch3:"MIXED",CH1:"COW",CH2:"BUFFALO",CH3:"MIXED",COW:"COW",BUFFALO:"BUFFALO",MIXED:"MIXED",cow:"COW",buffalo:"BUFFALO",mixed:"MIXED",BUF:"BUFFALO",MIX:"MIXED"})[e]||e.toUpperCase();function P({globalSearch:e=""}){let[r,i]=(0,a.useState)([]),[n,l]=(0,a.useState)([]),[s,o]=(0,a.useState)({totalSales:0,totalQuantity:0,totalAmount:0,averageRate:0}),[h,v]=(0,a.useState)(!0),[C,E]=(0,a.useState)("");(0,a.useEffect)(()=>{void 0!==e&&E(e)},[e]);let A=(0,a.useMemo)(()=>e||C,[e,C]),[R,$]=(0,a.useState)(""),[D,L]=(0,a.useState)(""),[M,O]=(0,a.useState)(""),[P,W]=(0,a.useState)("all"),[Q,U]=(0,a.useState)("all"),[X,V]=(0,a.useState)([]),[q,G]=(0,a.useState)([]),[Y,H]=(0,a.useState)([]),[J,K]=(0,a.useState)([]),[Z,ee]=(0,a.useState)([]),[et,ea]=(0,a.useState)([]),[er,ei]=(0,a.useState)(!1),[en,el]=(0,a.useState)(null),[es,eo]=(0,a.useState)(!1),[ed,ec]=(0,a.useState)(""),[eh,em]=(0,a.useState)(""),[ex,eg]=(0,a.useState)(new Set),[eu,ep]=(0,a.useState)(!1),[ey,ef]=(0,a.useState)(!1),[ew,eS]=(0,a.useState)(!1),[eF,eb]=(0,a.useState)(""),[ej,ek]=(0,a.useState)(!1),[eN,e_]=(0,a.useState)(""),[ev,eC]=(0,a.useState)([]),[eE,eT]=(0,a.useState)([]);(0,a.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("/api/user/dairy",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){let e=await t.json();ee(e.data||[])}let a=await fetch("/api/user/bmc",{headers:{Authorization:`Bearer ${e}`}});if(a.ok){let e=await a.json();ea(e.data||[])}let r=await fetch("/api/user/society",{headers:{Authorization:`Bearer ${e}`}});if(r.ok){let e=await r.json();eC(e.data||[])}let i=await fetch("/api/user/machine",{headers:{Authorization:`Bearer ${e}`}});if(i.ok){let e=await i.json();eT(e.data||[])}}catch(e){console.error("Error fetching dairies/BMCs/Societies/Machines:",e)}})()},[]);let eA=(0,a.useMemo)(()=>{if(!Z.length||!r.length)return Z;let e=new Set(r.filter(e=>e.dairy_id).map(e=>e.dairy_id));return Z.filter(t=>e.has(t.id))},[Z,r]),eR=async e=>{if(en){eo(!0);try{let t=localStorage.getItem("authToken"),a=await fetch("/api/user/reports/sales/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({recordId:en,password:e})}),r=await a.json();if(!a.ok)throw Error(r.error||"Failed to delete record");ec("Sales record deleted successfully"),setTimeout(()=>ec(""),5e3),eI()}catch(e){throw console.error("Delete error:",e),em(e instanceof Error?e.message:"Failed to delete record"),setTimeout(()=>em(""),5e3),e}finally{eo(!1),el(null)}}},e$=()=>{eg(new Set),ep(!1)},eD=async e=>{ef(!1),eS(!0);try{let t=localStorage.getItem("authToken"),a=Array.from(ex).map(a=>fetch("/api/user/reports/sales/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({recordId:a,password:e})}).then(async e=>{if(!e.ok){let t=await e.json();throw Error(t.message||"Delete failed")}return e.json()})),r=await Promise.allSettled(a),i=r.filter(e=>"fulfilled"===e.status).length,n=r.filter(e=>"rejected"===e.status).length;if(i>0)ec(`Successfully deleted ${i} record(s)${n>0?`. ${n} failed.`:""}`),setTimeout(()=>ec(""),5e3),eI(),e$();else{let e=r.find(e=>"rejected"===e.status),t=e?.reason?.message||"Failed to delete selected records";em(t),setTimeout(()=>em(""),5e3)}}catch(e){console.error("Bulk delete error:",e),em(e instanceof Error?e.message:"Failed to delete selected records"),setTimeout(()=>em(""),5e3)}finally{eS(!1),eb("")}},eL=(0,a.useMemo)(()=>{if(!ev.length||!r.length)return ev;let e=new Set(r.filter(e=>e.society_id).map(e=>e.society_id));return ev.filter(t=>e.has(t.society_id))},[ev,r]),eM=(0,a.useMemo)(()=>{if(!eE.length||!r.length)return eE;let e=new Set(r.filter(e=>e.machine_id).map(e=>e.machine_id));return eE.filter(t=>e.has(t.machineId)).map(e=>({...e,collectionCount:r.filter(t=>t.machine_id===e.machineId).length}))},[eE,r]),eO=(0,a.useCallback)(e=>{let t=e.reduce((e,t)=>e+parseFloat(t.quantity||"0"),0),a=e.reduce((e,t)=>e+parseFloat(t.total_amount||"0"),0),r=e.reduce((e,t)=>e+parseFloat(t.rate_per_liter||"0"),0),i=e.length>0?r/e.length:0;o({totalSales:e.length,totalQuantity:parseFloat(t.toFixed(2)),totalAmount:parseFloat(a.toFixed(2)),averageRate:parseFloat(i.toFixed(2))})},[]),eI=(0,a.useCallback)(async(e=!0)=>{let t=localStorage.getItem("authToken");if(t)try{e&&v(!0);let a=await fetch("/api/user/reports/sales",{headers:{Authorization:`Bearer ${t}`}});if(a.ok){let e=await a.json();i(t=>JSON.stringify(t)!==JSON.stringify(e)?(eO(e),e):t)}}catch(e){console.error("Error fetching sales data:",e)}finally{e&&v(!1)}},[eO]);(0,a.useEffect)(()=>{eI(!0);let e=setInterval(()=>{eI(!1)},1e3);return()=>clearInterval(e)},[eI]),(0,a.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("/api/user/profile",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){let e=(await t.json()).email||"";e_(e)}}catch(e){console.error("Error fetching admin email:",e)}})()},[]),(0,a.useEffect)(()=>{let e=r;if(X.length>0){let t=X.map(e=>Z.find(t=>t.id.toString()===e)?.id).filter(Boolean);t.length>0&&(e=e.filter(e=>e.dairy_id&&t.includes(e.dairy_id)))}if(q.length>0){let t=q.map(e=>et.find(t=>t.id.toString()===e)?.id).filter(Boolean);t.length>0&&(e=e.filter(e=>e.bmc_id&&t.includes(e.bmc_id)))}if("all"!==P&&(e="morning"===P?e.filter(e=>["MR","MX"].includes(e.shift_type)):"evening"===P?e.filter(e=>["EV","EX"].includes(e.shift_type)):e.filter(e=>e.shift_type===P)),Array.isArray(Y)&&Y.length>0){let t=Y.map(e=>{let t=eL.find(t=>t.id.toString()===e);return t?.society_id}).filter(Boolean);t.length>0&&(e=e.filter(e=>t.includes(e.society_id)))}if(J.length>0){let t=J.map(e=>eM.find(t=>t.id.toString()===e)?.machineId).filter(Boolean);t.length>0&&(e=e.filter(e=>t.includes(e.machine_id)))}if("all"!==Q&&(e=e.filter(e=>B(e.channel)===Q)),R&&(e=e.filter(e=>e.sales_date===R)),D&&(e=e.filter(e=>e.sales_date>=D)),M&&(e=e.filter(e=>e.sales_date<=M)),A){let t=A.toLowerCase();e=e.filter(e=>{let a=["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"Morning":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"Evening":e.shift_type;return[e.count,e.society_id,e.society_name,e.bmc_name,e.dairy_name,e.machine_id,e.machine_type,e.machine_version,e.channel,B(e.channel),e.sales_date,e.sales_time,e.shift_type,a,e.quantity,e.rate_per_liter,e.total_amount].some(e=>e?.toString().toLowerCase().includes(t))})}l(e),eO(e)},[e,C,R,D,M,P,Q,Y,J,X,q,r,eL,eM,Z,et,eO]);let ez=async e=>{if(!e||!e.includes("@"))throw Error("Please enter a valid email address");try{let t=D&&M?`${D} To ${M}`:R||"All Dates",a=new Date().toLocaleString("en-IN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),r=n.map(e=>[e.count,e.sales_date,e.sales_time,e.channel,e.shift_type,`${e.machine_id} (${e.machine_type})`,e.society_name||"",e.quantity,e.rate_per_liter,e.total_amount]),i=[["POORNASREE EQUIPMENTS MILK SALES REPORT"],["Admin Report with Sales Summary"],[],["Report Generated:",a],["Date Range:",t],["Total Sales:",s.totalSales],["Total Quantity (L):",s.totalQuantity.toFixed(2)],["Total Amount (₹):",s.totalAmount.toFixed(2)],["Average Rate (₹/L):",s.averageRate.toFixed(2)],[],["Count","Date","Time","Channel","Shift","Machine","Society","Quantity (L)","Rate (₹/L)","Total Amount (₹)"],...r].map(e=>e.join(",")).join("\n"),l=new f.default({orientation:"landscape",unit:"mm",format:"a4"});l.addImage("/fulllogo.png","PNG",14,8,0,12),l.setFontSize(14),l.setFont("helvetica","bold"),l.text("Daily Sales Report - LactoConnect Milk Sales System",148.5,15,{align:"center"}),l.setFontSize(9),l.setFont("helvetica","normal"),l.text(`Date From ${t}`,148.5,21,{align:"center"}),l.setFontSize(10),l.setFont("helvetica","bold"),l.text("DETAILED SALES DATA",148.5,28,{align:"center"});let o=n.map((e,t)=>[(t+1).toString(),e.count,e.sales_date,e.sales_time,B(e.channel),e.shift_type,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.quantity,e.rate_per_liter,e.total_amount]);(0,w.default)(l,{startY:32,head:[["SI No","Count","Date","Time","Channel","Shift","Machine","Society","Quantity (L)","Rate","Total Amount"]],body:o,theme:"grid",styles:{fontSize:7,cellPadding:1.5,halign:"center"},headStyles:{fillColor:[255,255,255],textColor:[0,0,0],fontStyle:"bold",fontSize:8,lineWidth:.5,lineColor:[0,0,0]},bodyStyles:{lineWidth:.3,lineColor:[200,200,200]},columnStyles:{0:{cellWidth:12}}});let d=l.lastAutoTable.finalY+8;l.setFontSize(11),l.setFont("helvetica","bold"),l.text("OVERALL SUMMARY",14,d),l.setFont("helvetica","normal");let c=d+6;l.text(`Total Sales        : ${s.totalSales}`,14,c),c+=5,l.text(`Total Quantity (L) : ${s.totalQuantity.toFixed(2)}`,14,c),c+=5,l.text(`Total Amount       : ${s.totalAmount.toFixed(2)}`,14,c),c+=5,l.text(`Average Rate       : ${s.averageRate.toFixed(2)}`,14,c),l.setFontSize(11),l.setFont("helvetica","bold"),l.text("REPORT NOTES",283,d,{align:"right"}),l.setFontSize(9),l.setFont("helvetica","normal");let h=d+6;l.text("Prepared by: POORNASREE EQUIPMENTS",283,h,{align:"right"}),h+=5,l.text("Contact: marketing@poornasree.com",283,h,{align:"right"}),h+=8,l.setFont("helvetica","bold"),l.text("POORNASREE EQUIPMENTS",283,h,{align:"right"}),l.setFont("helvetica","normal"),h+=5,l.text("Thank you for using LactoConnect",283,h,{align:"right"}),h+=5,l.text("For support, visit: www.poornasree.com",283,h,{align:"right"});let m=l.output("datauristring").split(",")[1],x=localStorage.getItem("authToken"),g=await fetch("/api/user/reports/send-email",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${x}`},body:JSON.stringify({email:e,csvContent:i,pdfContent:m,reportType:"Sales Report",dateRange:t,stats:s})});if(!g.ok){let e=await g.json().catch(()=>({}));throw Error(e.error||"Failed to send email")}ec(`Report sent successfully to ${e}`),setTimeout(()=>ec(""),5e3)}catch(e){throw console.error("Error sending email:",e),e}};return h?(0,t.jsx)("div",{className:"flex items-center justify-center min-h-[400px]",children:(0,t.jsx)(F.FlowerSpinner,{size:48})}):(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-4 gap-3",children:[(0,t.jsx)(S.default,{title:"Total Sales",value:s.totalSales,icon:(0,t.jsx)(I.ShoppingCart,{className:"w-full h-full"}),color:"blue"}),(0,t.jsx)(S.default,{title:"Total Quantity (L)",value:s.totalQuantity,icon:(0,t.jsx)(g.BarChart3,{className:"w-full h-full"}),color:"green"}),(0,t.jsx)(S.default,{title:"Total Amount (₹)",value:`₹${s.totalAmount.toFixed(2)}`,icon:(0,t.jsx)(d.DollarSign,{className:"w-full h-full"}),color:"yellow"}),(0,t.jsx)(S.default,{title:"Avg Rate (₹/L)",value:`₹${s.averageRate.toFixed(2)}`,icon:(0,t.jsx)(x.TrendingUp,{className:"w-full h-full"}),color:"gray"})]}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Showing ",n.length," of ",r.length," records"]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)("button",{onClick:()=>{let e;W("all"),V([]),G([]),H([]),K([]),$(""),L(""),O(""),U("all"),E(""),e=new CustomEvent("globalSearch",{detail:{query:""}}),window.dispatchEvent(e),eI()},className:"flex items-center justify-center gap-2 px-3 py-2 bg-psr-primary-600 text-white rounded-lg hover:bg-psr-primary-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(u.RefreshCw,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Refresh"})]}),(0,t.jsxs)("button",{onClick:()=>{if(0===n.length)return;let e=D&&M?`${D} To ${M}`:R||"All Dates",t=new Date().toLocaleString("en-IN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),a=new Blob([["Admin Report - LactoConnect Milk Sales System",`Date From ${e}`,"","DETAILED SALES DATA","","Date,Time,Channel,Machine,Society,Rate,Quantity (L),Total Amount",...n.map(e=>[e.sales_date,e.sales_time,e.channel,`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.rate_per_liter,e.quantity,e.total_amount]).map(e=>e.join(",")),"","","OVERALL SUMMARY",`Total Sales:,${s.totalSales}`,`Total Quantity (L):,${s.totalQuantity.toFixed(2)}`,`Total Amount (Rs):,${s.totalAmount.toFixed(2)}`,`Overall Average Rate (Rs/L):,${s.averageRate.toFixed(2)}`,"","Thank you","Poornasree Equipments",`Generated on: ${t}`].join("\n")],{type:"text/csv"}),r=window.URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=`sales-report-${new Date().toISOString().split("T")[0]}.csv`,i.click()},className:"flex items-center justify-center gap-2 px-3 py-2 bg-psr-green-600 text-white rounded-lg hover:bg-psr-green-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(c.Download,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"CSV"})]}),(0,t.jsxs)("button",{onClick:()=>{if(0===n.length)return;let e=new f.default({orientation:"landscape",unit:"mm",format:"a4"}),t=D&&M?`${D} To ${M}`:R?`${R} To ${R}`:"All Dates";e.addImage("/fulllogo.png","PNG",14,8,0,12),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Daily Sales Report - LactoConnect Milk Sales System",148.5,15,{align:"center"}),e.setFontSize(9),e.setFont("helvetica","normal"),e.text(`Date From ${t}`,148.5,21,{align:"center"}),e.setFontSize(10),e.setFont("helvetica","bold"),e.text("DETAILED SALES DATA",148.5,28,{align:"center"});let a=n.map((e,t)=>[(t+1).toString(),e.sales_date,e.sales_time,B(e.channel),`${e.machine_id} (${e.machine_type})`,`${e.society_name} (${e.society_id})`,e.rate_per_liter,e.quantity,e.total_amount]);(0,w.default)(e,{startY:32,head:[["SI No","Date","Time","Channel","Machine","Society","Rate","Quantity (L)","Total Amount"]],body:a,theme:"grid",styles:{fontSize:8,cellPadding:2,halign:"center"},headStyles:{fillColor:[255,255,255],textColor:[0,0,0],fontStyle:"bold",fontSize:9,lineWidth:.5,lineColor:[0,0,0]},bodyStyles:{lineWidth:.3,lineColor:[200,200,200]},columnStyles:{0:{cellWidth:15}}});let r=e.lastAutoTable.finalY+8;e.setFontSize(11),e.setFont("helvetica","bold"),e.text("OVERALL SUMMARY",14,r),e.setFont("helvetica","normal"),e.setFontSize(9);let i=r+6;e.text(`Total Sales        : ${s.totalSales}`,14,i),i+=5,e.text(`Total Quantity (L) : ${s.totalQuantity.toFixed(2)}`,14,i),i+=5,e.text(`Total Amount       : ${s.totalAmount.toFixed(2)}`,14,i),i+=5,e.text(`Avg Rate (Rs/L)    : ${s.averageRate.toFixed(2)}`,14,i),e.setFontSize(11),e.setFont("helvetica","bold"),e.text("REPORT NOTES",283,r,{align:"right"}),e.setFontSize(9),e.setFont("helvetica","normal");let l=r+6;e.text("Prepared by: POORNASREE EQUIPMENTS",283,l,{align:"right"}),l+=5,e.text("Contact: marketing@poornasree.com",283,l,{align:"right"}),l+=8,e.setFont("helvetica","bold"),e.text("POORNASREE EQUIPMENTS",283,l,{align:"right"}),e.setFont("helvetica","normal"),l+=5,e.text("Thank you for using LactoConnect",283,l,{align:"right"}),l+=5,e.text("For support, visit: www.poornasree.com",283,l,{align:"right"}),e.save(`sales-report-${new Date().toISOString().split("T")[0]}.pdf`)},className:"flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(m,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"PDF"})]}),(0,t.jsxs)("button",{onClick:()=>ek(!0),className:"flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm shadow-sm hover:shadow-md",children:[(0,t.jsx)(y.Mail,{className:"w-4 h-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Send Mail"})]})]})]}),(0,t.jsx)(b.FilterDropdown,{statusFilter:P,onStatusChange:W,dairyFilter:X,onDairyChange:e=>V(Array.isArray(e)?e:[e]),bmcFilter:q,onBmcChange:e=>G(Array.isArray(e)?e:[e]),societyFilter:Y,onSocietyChange:e=>H(Array.isArray(e)?e:[e]),machineFilter:J,onMachineChange:e=>K(Array.isArray(e)?e:[e]),dairies:eA,bmcs:et,societies:eL,machines:eM,filteredCount:n.length,totalCount:r.length,searchQuery:C,onSearchChange:E,icon:(0,t.jsx)(d.DollarSign,{className:"w-5 h-5"}),dateFilter:R,onDateChange:$,dateFromFilter:D,onDateFromChange:L,dateToFilter:M,onDateToChange:O,channelFilter:Q,onChannelChange:U,showDateFilter:!0,showChannelFilter:!0,showShiftFilter:!0,showMachineFilter:!0,hideMainFilterButton:!0})]})}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden",children:(0,t.jsx)("div",{className:"overflow-auto max-h-[600px]",tabIndex:0,children:(0,t.jsxs)("table",{className:"w-auto min-w-full table-auto",children:[(0,t.jsx)("thead",{className:"bg-gray-50 dark:bg-gray-700 sticky top-0 z-10",children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"px-4 py-3 text-center",children:(0,t.jsx)("input",{type:"checkbox",checked:eu,onChange:()=>{eu?(eg(new Set),ep(!1)):(eg(new Set(n.map(e=>e.id))),ep(!0))},className:"w-4 h-4 text-emerald-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-emerald-500 dark:focus:ring-emerald-400 cursor-pointer"})}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Date & Time"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Count"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Society"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Shift"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Channel"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Machine"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Rate/L"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Qty (L)"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Amount"}),(0,t.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Action"})]})}),(0,t.jsx)("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:0===n.length?(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:11,className:"px-4 py-8 text-center text-gray-500 dark:text-gray-400",children:"No sales records found"})}):n.map(e=>(0,t.jsx)(a.default.Fragment,{children:(0,t.jsxs)("tr",{className:`transition-colors ${ex.has(e.id)?"bg-emerald-50 dark:bg-emerald-900/20 hover:bg-emerald-100 dark:hover:bg-emerald-900/30":"hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[(0,t.jsx)("td",{className:"px-4 py-3 text-center",children:(0,t.jsx)("input",{type:"checkbox",checked:ex.has(e.id),onChange:()=>{var t;let a;return t=e.id,void((a=new Set(ex)).has(t)?a.delete(t):a.add(t),eg(a),ep(a.size===n.length&&n.length>0))},className:"w-4 h-4 text-emerald-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-emerald-500 dark:focus:ring-emerald-400 cursor-pointer"})}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{children:z(e.sales_date,A)}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:e.sales_time})]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center font-medium text-gray-900 dark:text-white",children:["#",z(e.count,A)]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{className:"font-medium",children:z(e.society_name,A)}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["ID: ",z(e.society_id,A)]})]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400":"bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400"}`,children:z(["MR","MX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="morning"?"Morning":["EV","EX"].includes(e.shift_type)||e.shift_type?.toLowerCase()==="evening"?"Evening":e.shift_type,A)})}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${"COW"===B(e.channel)?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400":"BUFFALO"===B(e.channel)?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"}`,children:z(B(e.channel),A)})}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white whitespace-nowrap",children:[(0,t.jsx)("div",{className:"font-medium",children:z(e.machine_id||"N/A",A)}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:z(e.machine_type,A)})]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center text-gray-900 dark:text-white",children:["₹",z(parseFloat(e.rate_per_liter).toFixed(2),A)]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center font-medium text-gray-900 dark:text-white",children:z(parseFloat(e.quantity).toFixed(2),A)}),(0,t.jsxs)("td",{className:"px-4 py-3 text-sm text-center font-medium text-green-600 dark:text-green-400",children:["₹",z(parseFloat(e.total_amount).toFixed(2),A)]}),(0,t.jsx)("td",{className:"px-4 py-3 text-sm text-center",children:(0,t.jsx)("button",{onClick:()=>{el(e.id),ei(!0)},className:"p-1 text-red-600 hover:text-red-800 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:"Delete record",children:(0,t.jsx)(p.Trash2,{className:"w-4 h-4"})})})]})},e.id))})]})})}),(0,t.jsx)(_.default,{isOpen:er,onClose:()=>ei(!1),onConfirm:eR,title:"Delete Sales Record",message:"Enter your admin password to confirm deletion. This action cannot be undone and will be logged for security purposes."}),(0,t.jsx)(_.default,{isOpen:ey,onClose:()=>{ef(!1),eb("")},onConfirm:eD,title:`Delete ${ex.size} Sales Record${ex.size>1?"s":""}`,message:`Enter your admin password to confirm deletion of ${ex.size} selected record(s). This action cannot be undone and will be logged for security purposes.`}),(0,t.jsx)(N.BulkActionsToolbar,{selectedCount:ex.size,totalCount:n.length,onBulkDelete:()=>{0!==ex.size&&ef(!0)},onClearSelection:e$,itemType:"record",showStatusUpdate:!1}),(0,t.jsx)(j.LoadingSnackbar,{isVisible:es||ew,message:ew?`Deleting ${ex.size} Records`:"Deleting Record",submessage:"Verifying credentials and removing data...",showProgress:!1}),(0,t.jsx)(T,{isOpen:ej,onClose:()=>ek(!1),onSend:ez,defaultEmail:eN,recordCount:n.length,reportType:"Sales Report"}),(0,t.jsx)(k.StatusMessage,{success:ed,error:eh,onClose:()=>{ec(""),em("")}})]})}let W=[{id:"collection",label:"Collection",icon:s.Droplet,color:"text-blue-600 dark:text-blue-400",gradient:"from-blue-600 to-cyan-600"},{id:"dispatch",label:"Dispatch",icon:o.Truck,color:"text-green-600 dark:text-green-400",gradient:"from-green-600 to-emerald-600"},{id:"sales",label:"Sales",icon:d.DollarSign,color:"text-purple-600 dark:text-purple-400",gradient:"from-purple-600 to-pink-600"}];function Q(){let e=(0,r.useSearchParams)(),[s,o]=(0,a.useState)("collection"),[d,c]=(0,a.useState)(""),[h,m]=(0,a.useState)(null),[x,g]=(0,a.useState)(null),[u,p]=(0,a.useState)(null),[y,f]=(0,a.useState)(null),[w,S]=(0,a.useState)(null),[F,b]=(0,a.useState)(null);return(0,a.useEffect)(()=>{let t=e.get("societyId"),a=e.get("societyName"),r=e.get("fromDate"),i=e.get("toDate"),n=e.get("bmcFilter"),l=e.get("machineFilter");console.log("Reports Page - URL Params:",{societyId:t,societyName:a,fromDate:r,toDate:i,machineFilter:l}),t&&(m(t),g(a)),r&&(console.log("Setting initialFromDate:",r),p(r)),i&&(console.log("Setting initialToDate:",i),f(i)),n&&(console.log("Setting initialBmcFilter:",n),S(n)),l&&(console.log("Setting initialMachineFilter:",l),b(l))},[]),(0,a.useEffect)(()=>{let e=e=>{c(e.detail.query)};return window.addEventListener("globalSearch",e),()=>{window.removeEventListener("globalSearch",e)}},[]),(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[(0,t.jsx)("div",{className:"border-b border-gray-200 dark:border-gray-700",children:(0,t.jsx)("div",{className:"px-4 sm:px-6 lg:px-8 py-4 sm:py-6",children:(0,t.jsxs)("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"p-2 sm:p-3 bg-gradient-to-br from-green-600 to-emerald-600 rounded-xl shadow-lg",children:(0,t.jsx)(l.FileText,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white",children:"Reports"}),(0,t.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1 hidden sm:block",children:"View and analyze data"})]})]}),(0,t.jsx)("div",{className:"inline-flex bg-psr-green-50 dark:bg-gray-800 rounded-xl p-1 shadow-inner",children:W.map(e=>{let a=e.icon,r=s===e.id;return(0,t.jsxs)("button",{onClick:()=>o(e.id),className:`
                      relative flex items-center gap-2 px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg font-medium
                      transition-all duration-200
                      ${r?"bg-psr-green-600 dark:bg-psr-green-700 text-white shadow-md":"text-gray-600 dark:text-gray-400 hover:text-psr-green-600 dark:hover:text-psr-green-400"}
                    `,children:[(0,t.jsx)(a,{className:"w-4 h-4 sm:w-5 sm:h-5"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:e.label})]},e.id)})})]})})}),(0,t.jsx)("div",{className:"px-4 sm:px-6 lg:px-8 py-6",children:(0,t.jsx)(n.AnimatePresence,{mode:"wait",children:(0,t.jsx)(i.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.2},children:(()=>{switch(console.log("Rendering with date filters:",{initialFromDate:u,initialToDate:y,initialBmcFilter:w,initialMachineFilter:F}),s){case"collection":return(0,t.jsx)($,{globalSearch:d,initialSocietyId:h,initialSocietyName:x,initialFromDate:u,initialToDate:y,initialBmcFilter:w,initialMachineFilter:F},"collection");case"dispatch":return(0,t.jsx)(O,{globalSearch:d},"dispatch");case"sales":return(0,t.jsx)(P,{globalSearch:d},"sales");default:return null}})()},s)})})]})}function U(){return(0,t.jsx)(a.Suspense,{fallback:(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500"})}),children:(0,t.jsx)(Q,{})})}e.s(["default",()=>U,"dynamic",0,"force-dynamic"],910361)}]);