# PSR Code Security System

## Overview

PSR (Poornasree Secure Registry) codes are encrypted identifiers that securely encode machine information. The codes are generated during API Management setup and validated by the .NET API to ensure only authorized machines can perform operations.

## PSR Code Format

### Encrypted Structure
```
PSR-{CHECKSUM}-{ENCODED_DATA}
```

**Example:**
```
PSR-8471-eyJzaWQiOiJTT0MwMDEiLCJtb2RlbCI6ImxhY3Rvc3VyZSIsIm1pZCI6Ik0wMDEiLCJ0cyI6MTY5NTk5MDA5ODY1NH0=
```

### Components

1. **Prefix**: `PSR-` - Identifies this as a PSR code
2. **Checksum**: 4-digit verification code (e.g., `8471`)
   - Calculated from the encoded data
   - Prevents tampering
3. **Encoded Data**: Base64-encoded JSON containing:
   - `sid`: Society ID
   - `model`: Machine model (lowercase)
   - `mid`: Machine ID
   - `ts`: Timestamp (milliseconds since epoch)

## Security Features

### 1. Encryption
- Data is JSON-encoded and Base64-encrypted
- Not human-readable without decoding
- Prevents easy forgery

### 2. Checksum Validation
- 4-digit checksum calculated from encoded data
- Verifies data integrity
- Detects tampering attempts

### 3. Timestamp
- Records when the code was generated
- Can be used for expiration policies
- Audit trail for code generation

### 4. Multi-Factor Validation
The .NET API validates:
- ✅ Checksum matches encoded data
- ✅ Society ID matches configuration
- ✅ Machine model matches configuration
- ✅ Machine ID matches request
- ✅ PSR code exists in mappings

## Generation Process

### Frontend (Next.js)
```javascript
const generatePSRCode = (societyId, machineModel, machineId) => {
  // Create data object
  const data = {
    sid: societyId.toUpperCase(),
    model: machineModel.toLowerCase(),
    mid: machineId.toUpperCase(),
    ts: Date.now()
  };
  
  // Encode to JSON and Base64
  const jsonString = JSON.stringify(data);
  const encoded = btoa(jsonString);
  
  // Calculate checksum
  const checksum = encoded.split('')
    .reduce((acc, char) => acc + char.charCodeAt(0), 0) % 9999;
  
  return `PSR-${checksum.toString().padStart(4, '0')}-${encoded}`;
};
```

## Decoding Process

### Backend (.NET)
```csharp
public PSRCodeData? DecodePSRCode(string psrCode)
{
    // Format validation
    if (!psrCode.StartsWith("PSR-")) return null;
    
    // Parse components
    var parts = psrCode.Split('-');
    var checksum = parts[1];
    var encodedData = parts[2];
    
    // Verify checksum
    var calculatedChecksum = encodedData.ToCharArray()
        .Aggregate(0, (acc, c) => acc + (int)c) % 9999;
    if (calculatedChecksum.ToString() != checksum) return null;
    
    // Decode Base64
    var jsonBytes = Convert.FromBase64String(encodedData);
    var jsonString = Encoding.UTF8.GetString(jsonBytes);
    
    // Parse JSON
    return JsonSerializer.Deserialize<PSRCodeData>(jsonString);
}
```

## API Endpoints

### 1. Decode PSR Code
**POST** `/api/psr/decode`

**Request:**
```json
{
  "psrCode": "PSR-8471-eyJzaWQiOiJTT0MwMDEiLC..."
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "societyId": "SOC001",
    "machineModel": "lactosure",
    "machineId": "M001",
    "timestamp": 1695990098654,
    "generatedDate": "2024-01-28 10:30:45"
  },
  "message": "PSR code decoded successfully"
}
```

### 2. Validate PSR Code
**POST** `/api/psr/validate`

**Request:**
```json
{
  "machineId": "M001",
  "psrCode": "PSR-8471-eyJzaWQiOiJTT0MwMDEiLC..."
}
```

**Response:**
```json
{
  "valid": true,
  "machineId": "M001",
  "psrCode": "PSR-8471-...",
  "message": "PSR code is valid"
}
```

## Usage in Machine Operations

All machine endpoints require a valid PSR code in the header:

```http
POST /api/collections
Headers:
  X-Machine-ID: M001
  X-PSR-Code: PSR-8471-eyJzaWQiOiJTT0MwMDEiLC...
```

### Validation Flow
1. Extract `X-Machine-ID` and `X-PSR-Code` from headers
2. Decode PSR code
3. Validate:
   - Checksum matches
   - Society ID matches configuration
   - Machine model matches configuration
   - Machine ID matches decoded value
   - Machine ID exists in mappings
4. If valid → Process request
5. If invalid → Return 401 Unauthorized

## Configuration

### psr-config.json
Generated during API Management setup:

```json
{
  "societyId": "SOC001",
  "machineModel": "lactosure",
  "machines": [
    {
      "machineId": "M001",
      "psrCode": "PSR-8471-eyJzaWQiOiJTT0MwMDEiLC...",
      "model": "lactosure"
    }
  ],
  "generatedAt": "2024-01-28T10:30:45.123Z"
}
```

### Deployment
The `psr-config.json` file is:
- Generated by the superadmin API Management interface
- Included in the .NET API publish package
- Loaded at application startup
- Cached in memory for fast validation

## Security Best Practices

### ✅ DO
- Keep PSR codes confidential
- Rotate codes periodically
- Monitor for validation failures
- Log all PSR code usage
- Use HTTPS for all API calls

### ❌ DON'T
- Share PSR codes in public channels
- Store codes in client-side code
- Log full PSR codes in public logs
- Transmit codes over unencrypted connections
- Reuse codes across different societies

## Troubleshooting

### Invalid Checksum
**Cause:** PSR code was modified or corrupted
**Solution:** Regenerate PSR code in API Management

### Society ID Mismatch
**Cause:** PSR code from different society
**Solution:** Use correct PSR code for this society

### Machine ID Not Found
**Cause:** Machine not in configuration
**Solution:** Add machine in API Management

### Decoding Failed
**Cause:** Invalid Base64 or corrupted data
**Solution:** Regenerate PSR code

## Monitoring

### Log Patterns
```
✅ Valid: "PSR code validated successfully for M001"
❌ Invalid: "Society ID mismatch. Expected: SOC001, Got: SOC002"
❌ Invalid: "Invalid PSR code checksum"
❌ Invalid: "Failed to decode PSR code"
```

### Metrics to Track
- Total PSR validations per hour
- Failed validation rate
- Most active machines
- Validation response time
- Decoded code cache hit rate

## API Response Codes

| Code | Meaning | Action |
|------|---------|--------|
| 200 | Valid PSR code | Continue operation |
| 400 | Malformed PSR code | Check code format |
| 401 | Invalid PSR code | Regenerate code |
| 403 | Machine not authorized | Check configuration |
| 500 | Server error | Contact support |

## Migration from Old Format

### Old Format (Insecure)
```
PSR-SOC001-LACT-M001
```

### New Format (Secure)
```
PSR-8471-eyJzaWQiOiJTT0MwMDEiLCJtb2RlbCI6ImxhY3Rvc3VyZSIsIm1pZCI6Ik0wMDEiLCJ0cyI6MTY5NTk5MDA5ODY1NH0=
```

**Migration Steps:**
1. Generate new PSR codes via API Management
2. Update all machines with new codes
3. Deploy updated API package
4. Verify all machines working
5. Remove old code support

## Support

For issues with PSR codes:
1. Check API Management logs
2. Verify psr-config.json is correct
3. Test with decode endpoint
4. Check .NET API logs
5. Contact system administrator
